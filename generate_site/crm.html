<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Управление</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --sidebar-width: 240px;
            --header-height: 56px;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-primary); }
        .layout { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: #020617; border-right: 1px solid var(--border-color); position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h1 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .sidebar-header h1 i { color: var(--primary); }
        .nav-section { padding: 16px 0; }
        .nav-title { padding: 8px 16px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: var(--text-secondary); cursor: pointer; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(59,130,246,0.1); color: var(--text-primary); }
        .nav-item.active { background: rgba(59,130,246,0.15); color: var(--primary); border-left-color: var(--primary); }
        .nav-item i { width: 20px; text-align: center; }
        .nav-item .badge { margin-left: auto; background: var(--primary); padding: 2px 8px; border-radius: 10px; font-size: 11px; }

        /* Main */
        .main { flex: 1; margin-left: var(--sidebar-width); }
        .header { height: var(--header-height); background: var(--bg-card); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: sticky; top: 0; z-index: 50; }
        .header h2 { font-size: 18px; }
        .header-actions { display: flex; gap: 12px; }
        .content { padding: 24px; }

        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        .stat-card .value { font-size: 28px; font-weight: 600; margin-bottom: 4px; }
        .stat-card .label { color: var(--text-secondary); font-size: 14px; }
        .stat-card.primary .value { color: var(--primary); }
        .stat-card.success .value { color: var(--success); }
        .stat-card.warning .value { color: var(--warning); }

        /* Table */
        .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .card-header h3 { font-size: 16px; }
        .card-body { padding: 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 20px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 500; color: var(--text-secondary); font-size: 13px; background: rgba(0,0,0,0.2); }
        tr:hover { background: rgba(59,130,246,0.05); }
        tr:last-child td { border-bottom: none; }

        /* Badges */
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .badge-new { background: rgba(59,130,246,0.2); color: var(--primary); }
        .badge-success { background: rgba(16,185,129,0.2); color: var(--success); }
        .badge-warning { background: rgba(245,158,11,0.2); color: var(--warning); }
        .badge-danger { background: rgba(239,68,68,0.2); color: var(--danger); }

        /* Kanban */
        .kanban { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; }
        .kanban-column { min-width: 300px; max-width: 300px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); }
        .kanban-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .kanban-header h4 { font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .kanban-header .dot { width: 8px; height: 8px; border-radius: 50%; }
        .kanban-header .count { color: var(--text-muted); font-weight: normal; }
        .kanban-body { padding: 12px; min-height: 200px; max-height: 500px; overflow-y: auto; }
        .kanban-card { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: grab; }
        .kanban-card:hover { border-color: var(--primary); }
        .kanban-card-title { font-weight: 500; margin-bottom: 8px; }
        .kanban-card-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; }
        .kanban-add { padding: 8px 12px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .kanban-add:hover { color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .tab { padding: 12px 20px; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; margin-bottom: -1px; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Search & Filters */
        .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { width: 100%; padding: 10px 16px 10px 40px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); }
        .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .filter-select { padding: 10px 16px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); min-width: 150px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-card); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 14px; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        /* Empty state */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { margin-bottom: 8px; color: var(--text-secondary); }

        /* Section visibility */
        .section { display: none; }
        .section.active { display: block; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-chart-line"></i> CRM</h1>
            </div>
            <nav class="nav-section">
                <div class="nav-title">Главное</div>
                <div class="nav-item active" data-section="dashboard"><i class="fas fa-home"></i> Дашборд</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Продажи</div>
                <div class="nav-item" data-section="funnels"><i class="fas fa-filter"></i> Воронки</div>
                <div class="nav-item" data-section="deals"><i class="fas fa-handshake"></i> Сделки</div>
                <div class="nav-item" data-section="calls"><i class="fas fa-phone"></i> Звонки</div>
                <div class="nav-item" data-section="regulations"><i class="fas fa-clock"></i> Регламенты</div>
                <div class="nav-item" data-section="goals"><i class="fas fa-bullseye"></i> KPI/Цели</div>
                <div class="nav-item" data-section="lead-distribution"><i class="fas fa-random"></i> Распределение</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Клиенты</div>
                <div class="nav-item" data-section="clients"><i class="fas fa-users"></i> Клиенты</div>
                <div class="nav-item" data-section="segments"><i class="fas fa-layer-group"></i> Сегменты</div>
                <div class="nav-item" data-section="tags"><i class="fas fa-tags"></i> Теги</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Команда</div>
                <div class="nav-item" data-section="employees"><i class="fas fa-user-tie"></i> Сотрудники</div>
                <div class="nav-item" data-section="tasks"><i class="fas fa-tasks"></i> Задачи</div>
                <div class="nav-item" data-section="employee-analytics"><i class="fas fa-chart-bar"></i> Аналитика</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Заказы</div>
                <div class="nav-item" data-section="orders"><i class="fas fa-shopping-cart"></i> Заказы</div>
                <div class="nav-item" data-section="payments"><i class="fas fa-credit-card"></i> Платежи</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Каталог</div>
                <div class="nav-item" data-section="products"><i class="fas fa-box"></i> Товары</div>
                <div class="nav-item" data-section="categories"><i class="fas fa-folder"></i> Категории</div>
                <div class="nav-item" data-section="product-filters"><i class="fas fa-sliders-h"></i> Фильтры</div>
                <div class="nav-item" data-section="selections"><i class="fas fa-star"></i> Подборки</div>
                <div class="nav-item" data-section="promo-codes"><i class="fas fa-percent"></i> Промокоды</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Услуги</div>
                <div class="nav-item" data-section="services"><i class="fas fa-concierge-bell"></i> Услуги</div>
                <div class="nav-item" data-section="specialists"><i class="fas fa-user-md"></i> Специалисты</div>
                <div class="nav-item" data-section="rooms"><i class="fas fa-door-open"></i> Помещения</div>
                <div class="nav-item" data-section="bookings"><i class="fas fa-calendar-check"></i> Записи</div>
                <div class="nav-item" data-section="schedules"><i class="fas fa-calendar-alt"></i> Расписание</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Обучение</div>
                <div class="nav-item" data-section="trainings"><i class="fas fa-graduation-cap"></i> Тренинги</div>
                <div class="nav-item" data-section="lessons"><i class="fas fa-book-open"></i> Уроки</div>
                <div class="nav-item" data-section="webinars"><i class="fas fa-video"></i> Вебинары</div>
                <div class="nav-item" data-section="quizzes"><i class="fas fa-question-circle"></i> Тесты</div>
                <div class="nav-item" data-section="certificates"><i class="fas fa-certificate"></i> Сертификаты</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Настройки</div>
                <div class="nav-item" data-section="integrations"><i class="fas fa-plug"></i> Интеграции</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-item" onclick="location.href='admin.html'"><i class="fas fa-arrow-left"></i> Назад в CMS</div>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main">
            <header class="header">
                <h2 id="pageTitle">Дашборд</h2>
                <div class="header-actions">
                    <button class="btn btn-primary" id="mainAction" style="display:none;">
                        <i class="fas fa-plus"></i> <span>Добавить</span>
                    </button>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard -->
                <div class="section active" id="section-dashboard">
                    <!-- Main Stats Row -->
                    <div class="stats-grid">
                        <div class="stat-card primary" onclick="switchSection('deals')" style="cursor:pointer;">
                            <div class="value" id="stat-deals">0</div>
                            <div class="label">Активные сделки</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="stat-won">₽0</div>
                            <div class="label">Выиграно за месяц</div>
                        </div>
                        <div class="stat-card warning" onclick="switchSection('clients')" style="cursor:pointer;">
                            <div class="value" id="stat-clients">0</div>
                            <div class="label">Клиентов</div>
                        </div>
                        <div class="stat-card" onclick="switchSection('orders')" style="cursor:pointer;">
                            <div class="value" id="stat-orders">0</div>
                            <div class="label">Заказов за месяц</div>
                        </div>
                        <div class="stat-card" onclick="switchSection('tasks')" style="cursor:pointer;">
                            <div class="value" id="stat-tasks">0</div>
                            <div class="label">Задач в работе</div>
                        </div>
                        <div class="stat-card" style="border-left: 3px solid var(--danger);">
                            <div class="value" id="stat-overdue" style="color: var(--danger);">0</div>
                            <div class="label">Просрочено</div>
                        </div>
                    </div>

                    <!-- Extended Stats Row -->
                    <div class="stats-grid" style="margin-top:16px;">
                        <div class="stat-card" onclick="switchSection('bookings')" style="cursor:pointer;">
                            <div class="value" id="stat-bookings">0</div>
                            <div class="label"><i class="fas fa-calendar-check"></i> Записей сегодня</div>
                        </div>
                        <div class="stat-card" onclick="switchSection('courses')" style="cursor:pointer;">
                            <div class="value" id="stat-students">0</div>
                            <div class="label"><i class="fas fa-graduation-cap"></i> Студентов</div>
                        </div>
                        <div class="stat-card" onclick="switchSection('webinars')" style="cursor:pointer;">
                            <div class="value" id="stat-webinars">0</div>
                            <div class="label"><i class="fas fa-video"></i> Вебинаров</div>
                        </div>
                        <div class="stat-card" onclick="switchSection('calls')" style="cursor:pointer;">
                            <div class="value" id="stat-calls">0</div>
                            <div class="label"><i class="fas fa-phone"></i> Звонков сегодня</div>
                        </div>
                        <div class="stat-card" onclick="switchSection('products')" style="cursor:pointer;">
                            <div class="value" id="stat-products">0</div>
                            <div class="label"><i class="fas fa-box"></i> Товаров</div>
                        </div>
                        <div class="stat-card" onclick="switchSection('promo-codes')" style="cursor:pointer;">
                            <div class="value" id="stat-promos">0</div>
                            <div class="label"><i class="fas fa-percent"></i> Промокодов</div>
                        </div>
                    </div>

                    <!-- AI Insights -->
                    <div class="card" style="margin: 24px 0;">
                        <div class="card-header">
                            <h3><i class="fas fa-robot" style="color: var(--primary); margin-right: 8px;"></i>AI-рекомендации</h3>
                            <button class="btn btn-sm btn-outline" onclick="loadAIInsights()"><i class="fas fa-sync"></i></button>
                        </div>
                        <div class="card-body" style="padding: 16px;">
                            <div id="aiInsights" class="stats-grid" style="gap: 12px;"></div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div class="card">
                            <div class="card-header">
                                <h3>Последние сделки</h3>
                                <a href="#deals" onclick="switchSection('deals')" style="color:var(--primary);font-size:13px;">Все →</a>
                            </div>
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Сделка</th>
                                            <th>Клиент</th>
                                            <th>Сумма</th>
                                            <th>Этап</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentDeals">
                                        <tr><td colspan="4"><div class="empty-state"><i class="fas fa-handshake"></i><h3>Нет сделок</h3></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Записи на сегодня</h3>
                                <a href="#bookings" onclick="switchSection('bookings')" style="color:var(--primary);font-size:13px;">Все →</a>
                            </div>
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Время</th>
                                            <th>Клиент</th>
                                            <th>Услуга</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody id="todayBookings">
                                        <tr><td colspan="4"><div class="empty-state"><i class="fas fa-calendar-check"></i><h3>Нет записей</h3></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top:24px;">
                        <div class="card">
                            <div class="card-header">
                                <h3>Последние заказы</h3>
                                <a href="#orders" onclick="switchSection('orders')" style="color:var(--primary);font-size:13px;">Все →</a>
                            </div>
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Заказ</th>
                                            <th>Сумма</th>
                                            <th>Статус</th>
                                            <th>Дата</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOrders">
                                        <tr><td colspan="4"><div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>Нет заказов</h3></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Активность курсов</h3>
                                <a href="#courses" onclick="switchSection('courses')" style="color:var(--primary);font-size:13px;">Все →</a>
                            </div>
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Курс</th>
                                            <th>Студентов</th>
                                            <th>Прогресс</th>
                                            <th>Завершили</th>
                                        </tr>
                                    </thead>
                                    <tbody id="courseActivity">
                                        <tr><td colspan="4"><div class="empty-state"><i class="fas fa-graduation-cap"></i><h3>Нет курсов</h3></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Funnels -->
                <div class="section" id="section-funnels">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('funnelModal')"><i class="fas fa-plus"></i> Создать воронку</button>
                    </div>
                    <div id="funnelsList"></div>
                </div>

                <!-- Deals -->
                <div class="section" id="section-deals">
                    <div class="toolbar" style="flex-wrap:wrap;">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchDeals" placeholder="Поиск сделок..." oninput="filterDeals()">
                        </div>
                        <select class="filter-select" id="filterFunnel" onchange="loadDealsKanban()">
                            <option value="">Все воронки</option>
                        </select>
                        <select class="filter-select" id="filterDealEmployee" onchange="loadDealsKanban()">
                            <option value="">Все менеджеры</option>
                        </select>
                        <select class="filter-select" id="filterDealTag" onchange="loadDealsKanban()">
                            <option value="">Все теги</option>
                        </select>
                        <select class="filter-select" id="filterDealSource" onchange="loadDealsKanban()">
                            <option value="">Все источники</option>
                            <option value="website">Сайт</option>
                            <option value="phone">Телефон</option>
                            <option value="referral">Реферал</option>
                            <option value="social">Соцсети</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('dealModal')"><i class="fas fa-plus"></i> Новая сделка</button>
                    </div>
                    <div class="kanban" id="dealsKanban"></div>
                </div>

                <!-- Clients -->
                <div class="section" id="section-clients">
                    <div class="toolbar" style="flex-wrap:wrap;">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchClients" placeholder="Поиск клиентов..." oninput="filterClients()">
                        </div>
                        <select class="filter-select" id="filterClientTag" onchange="filterClients()">
                            <option value="">Все теги</option>
                        </select>
                        <select class="filter-select" id="filterClientCourse" onchange="filterClients()">
                            <option value="">Все курсы</option>
                            <option value="has_course">Есть доступ к курсу</option>
                            <option value="no_course">Нет курсов</option>
                            <option value="completed_course">Прошёл курс</option>
                            <option value="in_progress">Проходит курс</option>
                        </select>
                        <select class="filter-select" id="filterClientBooking" onchange="filterClients()">
                            <option value="">Все записи</option>
                            <option value="has_booking">Есть записи</option>
                            <option value="no_booking">Нет записей</option>
                            <option value="upcoming">Предстоящая запись</option>
                            <option value="visited">Был на визите</option>
                        </select>
                        <select class="filter-select" id="filterClientOrder" onchange="filterClients()">
                            <option value="">Все заказы</option>
                            <option value="has_order">Есть заказы</option>
                            <option value="no_order">Нет заказов</option>
                            <option value="repeat">Повторные покупки</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('clientModal')"><i class="fas fa-plus"></i> Добавить</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:16px;">
                        <div class="stat-card"><div class="value" id="clientsTotal">0</div><div class="label">Всего клиентов</div></div>
                        <div class="stat-card primary"><div class="value" id="clientsWithCourses">0</div><div class="label">С курсами</div></div>
                        <div class="stat-card success"><div class="value" id="clientsWithBookings">0</div><div class="label">С записями</div></div>
                        <div class="stat-card warning"><div class="value" id="clientsWithOrders">0</div><div class="label">С заказами</div></div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Клиент</th>
                                        <th>Контакты</th>
                                        <th>Теги</th>
                                        <th>Курсы</th>
                                        <th>Записи</th>
                                        <th>Заказы</th>
                                        <th>Сумма</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="clientsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Segments -->
                <div class="section" id="section-segments">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('segmentModal')"><i class="fas fa-plus"></i> Создать сегмент</button>
                    </div>
                    <div id="segmentsList" class="stats-grid"></div>
                </div>

                <!-- Employees -->
                <div class="section" id="section-employees">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('employeeModal')"><i class="fas fa-plus"></i> Добавить сотрудника</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Должность</th>
                                        <th>Email</th>
                                        <th>Роль</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tasks -->
                <div class="section" id="section-tasks">
                    <div class="toolbar">
                        <select class="filter-select" id="filterTaskStatus" onchange="loadTasks()">
                            <option value="">Все задачи</option>
                            <option value="pending">Ожидают</option>
                            <option value="in_progress">В работе</option>
                            <option value="completed">Завершены</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('taskModal')"><i class="fas fa-plus"></i> Создать задачу</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Задача</th>
                                        <th>Исполнитель</th>
                                        <th>Приоритет</th>
                                        <th>Срок</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Orders -->
                <div class="section" id="section-orders">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchOrders" placeholder="Поиск заказов..." oninput="searchOrders()">
                        </div>
                        <select class="filter-select" id="filterOrderStatus" onchange="loadOrders()">
                            <option value="">Все статусы</option>
                            <option value="new">Новые</option>
                            <option value="processing">В обработке</option>
                            <option value="shipped">Отправлены</option>
                            <option value="completed">Завершены</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('orderModal')"><i class="fas fa-plus"></i> Создать заказ</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>№ заказа</th>
                                        <th>Клиент</th>
                                        <th>Сумма</th>
                                        <th>Статус</th>
                                        <th>Оплата</th>
                                        <th>Дата</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payments -->
                <div class="section" id="section-payments">
                    <div class="toolbar">
                        <select class="filter-select" id="filterPaymentStatus" onchange="loadPayments()">
                            <option value="">Все платежи</option>
                            <option value="completed">Успешные</option>
                            <option value="pending">Ожидают</option>
                            <option value="failed">Неуспешные</option>
                        </select>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Заказ</th>
                                        <th>Сумма</th>
                                        <th>Метод</th>
                                        <th>Статус</th>
                                        <th>Дата</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Products -->
                <div class="section" id="section-products">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchProducts" placeholder="Поиск товаров..." oninput="searchProducts()">
                        </div>
                        <select class="filter-select" id="filterProductCategory" onchange="filterProducts()">
                            <option value="">Все категории</option>
                        </select>
                        <select class="filter-select" id="filterProductType" onchange="filterProducts()">
                            <option value="">Все типы</option>
                            <option value="physical">Физический товар</option>
                            <option value="digital">Цифровой товар</option>
                            <option value="online">Онлайн-продукт</option>
                        </select>
                        <button class="btn btn-outline" onclick="openModal('importXmlModal')"><i class="fas fa-file-import"></i> Импорт XML</button>
                        <button class="btn btn-primary" onclick="openModal('productModal')"><i class="fas fa-plus"></i> Добавить товар</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Товар</th>
                                        <th>Артикул</th>
                                        <th>Категория</th>
                                        <th>Тип</th>
                                        <th>Цена</th>
                                        <th>Остаток</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="productsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Categories -->
                <div class="section" id="section-categories">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('categoryModal')"><i class="fas fa-plus"></i> Добавить категорию</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div id="categoriesTree" class="categories-tree"></div>
                        </div>
                    </div>
                </div>

                <!-- Product Filters -->
                <div class="section" id="section-product-filters">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('productFilterModal')"><i class="fas fa-plus"></i> Добавить фильтр</button>
                    </div>
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                        <div class="card" style="cursor:pointer;" onclick="openFilterEditor('size')">
                            <div class="card-body">
                                <h4><i class="fas fa-ruler"></i> Размер</h4>
                                <p style="color:var(--text-muted);">XS, S, M, L, XL, XXL</p>
                            </div>
                        </div>
                        <div class="card" style="cursor:pointer;" onclick="openFilterEditor('color')">
                            <div class="card-body">
                                <h4><i class="fas fa-palette"></i> Цвет</h4>
                                <p style="color:var(--text-muted);">Белый, Чёрный, Красный, Синий...</p>
                            </div>
                        </div>
                        <div class="card" style="cursor:pointer;" onclick="openFilterEditor('material')">
                            <div class="card-body">
                                <h4><i class="fas fa-tshirt"></i> Материал</h4>
                                <p style="color:var(--text-muted);">Хлопок, Полиэстер, Шерсть...</p>
                            </div>
                        </div>
                        <div class="card" style="cursor:pointer;" onclick="openFilterEditor('brand')">
                            <div class="card-body">
                                <h4><i class="fas fa-building"></i> Бренд</h4>
                                <p style="color:var(--text-muted);">Добавьте бренды товаров</p>
                            </div>
                        </div>
                        <div id="customFiltersGrid"></div>
                    </div>
                </div>

                <!-- Selections (former Collections) -->
                <div class="section" id="section-selections">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('selectionModal')"><i class="fas fa-plus"></i> Создать подборку</button>
                    </div>
                    <div id="selectionsList" class="stats-grid"></div>
                </div>

                <!-- Services -->
                <div class="section" id="section-services">
                    <div class="toolbar">
                        <select class="filter-select" id="filterServiceType" onchange="filterServices()">
                            <option value="">Все типы</option>
                            <option value="individual">Индивидуальные</option>
                            <option value="group">Групповые</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('serviceModal')"><i class="fas fa-plus"></i> Добавить услугу</button>
                    </div>
                    <div id="servicesList" class="stats-grid"></div>
                </div>

                <!-- Specialists -->
                <div class="section" id="section-specialists">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('specialistModal')"><i class="fas fa-plus"></i> Добавить специалиста</button>
                    </div>
                    <div id="specialistsList" class="stats-grid"></div>
                </div>

                <!-- Rooms -->
                <div class="section" id="section-rooms">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('roomModal')"><i class="fas fa-plus"></i> Добавить помещение</button>
                    </div>
                    <div id="roomsList" class="stats-grid"></div>
                </div>

                <!-- Trainings (former Courses) -->
                <div class="section" id="section-trainings">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchTrainings" placeholder="Поиск тренингов...">
                        </div>
                        <select class="filter-select" id="filterTrainingAccess">
                            <option value="">Все типы доступа</option>
                            <option value="purchase">После покупки</option>
                            <option value="group">По группе</option>
                            <option value="free">Бесплатный</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('trainingModal')"><i class="fas fa-plus"></i> Создать тренинг</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="trainingsTotal">0</div>
                            <div class="label">Тренингов</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="trainingsStudents">0</div>
                            <div class="label">Учеников</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="trainingsCompletion">0%</div>
                            <div class="label">Ср. прохождение</div>
                        </div>
                    </div>
                    <div id="trainingsList" class="stats-grid"></div>
                </div>

                <!-- Lessons -->
                <div class="section" id="section-lessons">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchLessons" placeholder="Поиск уроков...">
                        </div>
                        <select class="filter-select" id="filterLessonTraining">
                            <option value="">Все тренинги</option>
                        </select>
                        <select class="filter-select" id="filterLessonType">
                            <option value="">Все типы</option>
                            <option value="video">Видео</option>
                            <option value="text">Текст</option>
                            <option value="quiz">Тест</option>
                            <option value="homework">Домашнее задание</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('lessonModal')"><i class="fas fa-plus"></i> Создать урок</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>№</th>
                                        <th>Урок</th>
                                        <th>Тренинг</th>
                                        <th>Тип</th>
                                        <th>Длительность</th>
                                        <th>Прошли</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="lessonsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Calls (amoCRM) -->
                <div class="section" id="section-calls">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchCalls" placeholder="Поиск звонков...">
                        </div>
                        <select class="filter-select" id="callsDirection">
                            <option value="">Все направления</option>
                            <option value="incoming">Входящие</option>
                            <option value="outgoing">Исходящие</option>
                        </select>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="value" id="callsTotal">0</div>
                            <div class="label">Всего звонков</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="callsAnswered">0</div>
                            <div class="label">Отвечено</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="callsMissed">0</div>
                            <div class="label">Пропущено</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="callsDuration">0:00</div>
                            <div class="label">Ср. длительность</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Журнал звонков</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Направление</th>
                                        <th>Клиент</th>
                                        <th>Менеджер</th>
                                        <th>Длительность</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="callsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Regulations (SLA) -->
                <div class="section" id="section-regulations">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('regulationModal')"><i class="fas fa-plus"></i> Добавить регламент</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Регламенты SLA</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Условие</th>
                                        <th>Действие</th>
                                        <th>Воронка</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="regulationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Goals (KPI) -->
                <div class="section" id="section-goals">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('goalModal')"><i class="fas fa-plus"></i> Создать цель</button>
                        <select class="filter-select" id="goalsPeriod">
                            <option value="month">Этот месяц</option>
                            <option value="quarter">Квартал</option>
                            <option value="year">Год</option>
                        </select>
                    </div>
                    <div class="stats-grid" id="goalsList"></div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Лидерборд</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Сотрудник</th>
                                        <th>Выручка</th>
                                        <th>Сделок</th>
                                        <th>Конверсия</th>
                                        <th>Прогресс</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Lead Distribution -->
                <div class="section" id="section-lead-distribution">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('distributionModal')"><i class="fas fa-cog"></i> Настройки</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="value" id="leadsInQueue">0</div>
                            <div class="label">В очереди</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="leadsAssigned">0</div>
                            <div class="label">Распределено сегодня</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="leadsExpired">0</div>
                            <div class="label">Просрочено</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Очередь лидов</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Сделка</th>
                                        <th>Источник</th>
                                        <th>Назначен</th>
                                        <th>Истекает</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="leadQueueTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tags -->
                <div class="section" id="section-tags">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('tagModal')"><i class="fas fa-plus"></i> Создать тег</button>
                        <select class="filter-select" id="tagsEntity">
                            <option value="deal">Для сделок</option>
                            <option value="client">Для клиентов</option>
                        </select>
                    </div>
                    <div class="stats-grid" id="tagsList"></div>
                </div>

                <!-- Employee Analytics -->
                <div class="section" id="section-employee-analytics">
                    <div class="toolbar">
                        <select class="filter-select" id="analyticsPeriod">
                            <option value="today">Сегодня</option>
                            <option value="week">Неделя</option>
                            <option value="month" selected>Месяц</option>
                        </select>
                        <select class="filter-select" id="analyticsEmployee">
                            <option value="">Все сотрудники</option>
                        </select>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="value" id="analyticsDeals">0</div>
                            <div class="label">Сделок закрыто</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="analyticsRevenue">0 ₽</div>
                            <div class="label">Выручка</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="analyticsCalls">0</div>
                            <div class="label">Звонков</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="analyticsConversion">0%</div>
                            <div class="label">Конверсия</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Активность сотрудников</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Статус</th>
                                        <th>Сделок</th>
                                        <th>Звонков</th>
                                        <th>Конверсия</th>
                                        <th>Последняя активность</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeAnalyticsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Brands (InSales) -->
                <div class="section" id="section-brands">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('brandModal')"><i class="fas fa-plus"></i> Добавить бренд</button>
                    </div>
                    <div class="stats-grid" id="brandsList"></div>
                </div>

                <!-- Promo Codes (InSales) - Extended -->
                <div class="section" id="section-promo-codes">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchPromo" placeholder="Поиск промокода..." oninput="filterPromoCodes()">
                        </div>
                        <select class="filter-select" id="filterPromoStatus" onchange="filterPromoCodes()">
                            <option value="">Все статусы</option>
                            <option value="active">Активные</option>
                            <option value="expired">Истёкшие</option>
                            <option value="disabled">Отключённые</option>
                        </select>
                        <button class="btn btn-outline" onclick="generateBulkPromos()"><i class="fas fa-magic"></i> Генератор</button>
                        <button class="btn btn-primary" onclick="openModal('promoModal')"><i class="fas fa-plus"></i> Создать промокод</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="promosActive">0</div>
                            <div class="label">Активных</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="promosUsed">0</div>
                            <div class="label">Использовано</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="promosSaved">0 ₽</div>
                            <div class="label">Сумма скидок</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Промокоды</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Код</th>
                                        <th>Тип</th>
                                        <th>Скидка</th>
                                        <th>Использовано</th>
                                        <th>Лимит</th>
                                        <th>Мин. сумма</th>
                                        <th>Период</th>
                                        <th>Товары</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="promoCodesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Collections (InSales) -->
                <div class="section" id="section-collections">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('collectionModal')"><i class="fas fa-plus"></i> Создать коллекцию</button>
                    </div>
                    <div class="stats-grid" id="collectionsList"></div>
                </div>

                <!-- Bookings (YClients) -->
                <div class="section" id="section-bookings">
                    <div class="toolbar">
                        <select class="filter-select" id="filterBookingSpecialist" onchange="loadBookingsCalendar()">
                            <option value="">Все специалисты</option>
                        </select>
                        <select class="filter-select" id="filterBookingService" onchange="loadBookingsCalendar()">
                            <option value="">Все услуги</option>
                        </select>
                        <select class="filter-select" id="filterBookingBranch" onchange="loadBookingsCalendar()">
                            <option value="">Все филиалы</option>
                        </select>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button class="btn btn-outline btn-sm" onclick="moveBookingsWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                            <input type="date" class="filter-select" id="bookingsWeekStart" style="min-width:140px;" onchange="loadBookingsCalendar()">
                            <button class="btn btn-outline btn-sm" onclick="moveBookingsWeek(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('bookingModal')"><i class="fas fa-plus"></i> Новая запись</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="bookingsToday">0</div>
                            <div class="label">Записей сегодня</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="bookingsConfirmed">0</div>
                            <div class="label">Подтверждено</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="bookingsPending">0</div>
                            <div class="label">Ожидает</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="bookingsRevenue">0 ₽</div>
                            <div class="label">Выручка за неделю</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" style="overflow-x:auto;">
                            <table class="bookings-calendar" id="bookingsCalendarTable">
                                <thead>
                                    <tr id="bookingsCalendarHeader">
                                        <th style="width:60px;">Время</th>
                                        <!-- Days will be generated dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="bookingsCalendarBody">
                                    <!-- Time slots will be generated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Schedules (YClients) -->
                <div class="section" id="section-schedules">
                    <div class="toolbar">
                        <select class="filter-select" id="scheduleEmployee">
                            <option value="">Все сотрудники</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('scheduleModal')"><i class="fas fa-plus"></i> Настроить расписание</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Расписание сотрудников</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Пн</th>
                                        <th>Вт</th>
                                        <th>Ср</th>
                                        <th>Чт</th>
                                        <th>Пт</th>
                                        <th>Сб</th>
                                        <th>Вс</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="schedulesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Webinars (GetCourse) -->
                <div class="section" id="section-webinars">
                    <div class="toolbar">
                        <select class="filter-select" id="filterWebinarType" onchange="filterWebinars()">
                            <option value="">Все типы</option>
                            <option value="live">Живой вебинар</option>
                            <option value="auto">Автовебинар</option>
                        </select>
                        <select class="filter-select" id="filterWebinarStatus" onchange="filterWebinars()">
                            <option value="">Все статусы</option>
                            <option value="scheduled">Запланирован</option>
                            <option value="live">Идёт сейчас</option>
                            <option value="completed">Завершён</option>
                        </select>
                        <button class="btn btn-outline" onclick="openModal('autoWebinarModal')"><i class="fas fa-robot"></i> Создать автовебинар</button>
                        <button class="btn btn-primary" onclick="openModal('webinarModal')"><i class="fas fa-video"></i> Создать вебинар</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="webinarsUpcoming">0</div>
                            <div class="label">Запланировано</div>
                        </div>
                        <div class="stat-card success" style="cursor:pointer;" onclick="filterWebinarsByStatus('live')">
                            <div class="value" id="webinarsLive">0</div>
                            <div class="label">Сейчас в эфире</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="webinarsCompleted">0</div>
                            <div class="label">Проведено</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="webinarsParticipants">0</div>
                            <div class="label">Всего участников</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>Вебинарные комнаты</h3>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Тип</th>
                                        <th>Дата/Время</th>
                                        <th>Ведущий</th>
                                        <th>Регистраций</th>
                                        <th>Ссылка</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="webinarsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Quizzes (GetCourse) -->
                <div class="section" id="section-quizzes">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('quizModal')"><i class="fas fa-plus"></i> Создать тест</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Тесты и квизы</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Курс</th>
                                        <th>Вопросов</th>
                                        <th>Попыток</th>
                                        <th>Ср. балл</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="quizzesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Certificates (GetCourse) -->
                <div class="section" id="section-certificates">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchCertificates" placeholder="Поиск по номеру или имени...">
                        </div>
                        <button class="btn btn-outline" onclick="openModal('certificateTemplateModal')"><i class="fas fa-paint-brush"></i> Редактор шаблонов</button>
                        <button class="btn btn-primary" onclick="openModal('issueCertificateModal')"><i class="fas fa-plus"></i> Выдать сертификат</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="certificatesIssued">0</div>
                            <div class="label">Выдано сертификатов</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="certificateTemplates">0</div>
                            <div class="label">Шаблонов</div>
                        </div>
                    </div>

                    <!-- Certificate Templates -->
                    <div class="card" style="margin-bottom:20px;">
                        <div class="card-header"><h3>Шаблоны сертификатов</h3></div>
                        <div class="card-body">
                            <div class="stats-grid" id="certificateTemplatesList" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                                <div class="template-card" onclick="openModal('certificateTemplateModal')" style="border:2px dashed var(--border-color);padding:40px;text-align:center;cursor:pointer;border-radius:8px;">
                                    <i class="fas fa-plus" style="font-size:24px;color:var(--text-muted);"></i>
                                    <p style="color:var(--text-muted);margin-top:10px;">Создать шаблон</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Issued Certificates -->
                    <div class="card">
                        <div class="card-header"><h3>Выданные сертификаты</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Номер</th>
                                        <th>Студент</th>
                                        <th>Тренинг</th>
                                        <th>Шаблон</th>
                                        <th>Дата выдачи</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="certificatesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Integrations -->
                <div class="section" id="section-integrations">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('integrationModal')"><i class="fas fa-plus"></i> Добавить интеграцию</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="value" id="integrationsActive">0</div>
                            <div class="label">Активных интеграций</div>
                        </div>
                        <div class="stat-card primary">
                            <div class="value" id="integrationsWebhooks">0</div>
                            <div class="label">Вебхуков</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="integrationsForms">0</div>
                            <div class="label">Веб-форм</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Интеграции</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Тип</th>
                                        <th>Лидов</th>
                                        <th>Последний запрос</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="integrationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Deal Modal -->
    <div class="modal-overlay" id="dealModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая сделка</h3>
                <button class="modal-close" onclick="closeModal('dealModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название сделки *</label>
                    <input type="text" id="dealName" placeholder="Продажа услуги">
                </div>
                <div class="form-group">
                    <label>Клиент</label>
                    <select id="dealClient"><option value="">Выберите клиента</option></select>
                </div>
                <div class="form-group">
                    <label>Сумма</label>
                    <input type="number" id="dealAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Воронка</label>
                    <select id="dealFunnel" onchange="loadDealStages()"><option value="">Выберите воронку</option></select>
                </div>
                <div class="form-group">
                    <label>Этап</label>
                    <select id="dealStage"><option value="">Выберите этап</option></select>
                </div>
                <div class="form-group">
                    <label>Ответственный</label>
                    <select id="dealAssignee"><option value="">Выберите сотрудника</option></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('dealModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveDeal()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый клиент</h3>
                <button class="modal-close" onclick="closeModal('clientModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Имя *</label>
                    <input type="text" id="clientFirstName" placeholder="Иван">
                </div>
                <div class="form-group">
                    <label>Фамилия</label>
                    <input type="text" id="clientLastName" placeholder="Иванов">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>Телефон</label>
                    <input type="tel" id="clientPhone" placeholder="+7 999 123-45-67">
                </div>
                <div class="form-group">
                    <label>Компания</label>
                    <input type="text" id="clientCompany" placeholder="ООО Компания">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('clientModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveClient()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Funnel Modal -->
    <div class="modal-overlay" id="funnelModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая воронка</h3>
                <button class="modal-close" onclick="closeModal('funnelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название воронки *</label>
                    <input type="text" id="funnelName" placeholder="Продажи B2B">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="funnelDescription" rows="3" placeholder="Описание воронки"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('funnelModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveFunnel()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div class="modal-overlay" id="employeeModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый сотрудник</h3>
                <button class="modal-close" onclick="closeModal('employeeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Имя *</label>
                    <input type="text" id="employeeFirstName" placeholder="Иван">
                </div>
                <div class="form-group">
                    <label>Фамилия *</label>
                    <input type="text" id="employeeLastName" placeholder="Иванов">
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="employeeEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>Должность</label>
                    <input type="text" id="employeePosition" placeholder="Менеджер">
                </div>
                <div class="form-group">
                    <label>Роль</label>
                    <select id="employeeRole">
                        <option value="manager">Менеджер</option>
                        <option value="admin">Администратор</option>
                        <option value="support">Поддержка</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('employeeModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveEmployee()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая задача</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название задачи *</label>
                    <input type="text" id="taskTitle" placeholder="Позвонить клиенту">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="taskDescription" rows="3" placeholder="Подробности задачи"></textarea>
                </div>
                <div class="form-group">
                    <label>Исполнитель</label>
                    <select id="taskAssignee"><option value="">Выберите сотрудника</option></select>
                </div>
                <div class="form-group">
                    <label>Приоритет</label>
                    <select id="taskPriority">
                        <option value="normal">Обычный</option>
                        <option value="high">Высокий</option>
                        <option value="urgent">Срочный</option>
                        <option value="low">Низкий</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Срок</label>
                    <input type="date" id="taskDueDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('taskModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveTask()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="productModalTitle">Новый товар</h3>
                <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Product Type -->
                <div class="form-group" style="margin-bottom:20px;">
                    <label>Тип товара</label>
                    <div class="product-type-selector" style="display:flex;gap:10px;">
                        <label class="type-option" style="flex:1;padding:15px;background:var(--bg-input);border:2px solid var(--border-color);border-radius:8px;cursor:pointer;text-align:center;">
                            <input type="radio" name="productType" value="physical" checked style="display:none;">
                            <i class="fas fa-box" style="font-size:24px;display:block;margin-bottom:8px;"></i>
                            <span>Физический</span>
                        </label>
                        <label class="type-option" style="flex:1;padding:15px;background:var(--bg-input);border:2px solid var(--border-color);border-radius:8px;cursor:pointer;text-align:center;">
                            <input type="radio" name="productType" value="digital" style="display:none;">
                            <i class="fas fa-file-download" style="font-size:24px;display:block;margin-bottom:8px;"></i>
                            <span>Цифровой</span>
                        </label>
                        <label class="type-option" style="flex:1;padding:15px;background:var(--bg-input);border:2px solid var(--border-color);border-radius:8px;cursor:pointer;text-align:center;">
                            <input type="radio" name="productType" value="online" style="display:none;">
                            <i class="fas fa-graduation-cap" style="font-size:24px;display:block;margin-bottom:8px;"></i>
                            <span>Онлайн-продукт</span>
                        </label>
                    </div>
                </div>

                <!-- Online Product Access (shown only for online type) -->
                <div id="onlineProductAccess" style="display:none;background:#1e293b;border-radius:8px;padding:15px;margin-bottom:20px;">
                    <h4 style="margin:0 0 15px 0;color:var(--accent);"><i class="fas fa-key"></i> Доступ при покупке</h4>
                    <div class="form-group">
                        <label>Тип доступа</label>
                        <select id="productAccessType" onchange="toggleProductAccessOptions()">
                            <option value="">— Выберите —</option>
                            <option value="training">Доступ к тренингу</option>
                            <option value="lesson">Доступ к уроку</option>
                            <option value="group">Добавление в группу</option>
                        </select>
                    </div>
                    <div id="accessTrainingSelect" style="display:none;" class="form-group">
                        <label>Выберите тренинг</label>
                        <select id="productAccessTraining"></select>
                    </div>
                    <div id="accessLessonSelect" style="display:none;" class="form-group">
                        <label>Выберите урок</label>
                        <select id="productAccessLesson"></select>
                    </div>
                    <div id="accessGroupSelect" style="display:none;" class="form-group">
                        <label>Выберите группу</label>
                        <select id="productAccessGroup"></select>
                    </div>
                </div>

                <!-- Basic Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Название товара *</label>
                        <input type="text" id="productName" placeholder="Название товара">
                    </div>
                    <div class="form-group">
                        <label>Артикул (SKU)</label>
                        <input type="text" id="productSku" placeholder="ART-001">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Цена *</label>
                        <input type="number" id="productPrice" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Старая цена</label>
                        <input type="number" id="productOldPrice" placeholder="0">
                    </div>
                    <div class="form-group" id="productStockGroup">
                        <label>Остаток</label>
                        <input type="number" id="productStock" placeholder="0">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Категория</label>
                        <select id="productCategory">
                            <option value="">— Без категории —</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Бренд</label>
                        <input type="text" id="productBrand" placeholder="Название бренда">
                    </div>
                </div>

                <!-- Description with AI -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; justify-content: space-between;">
                        <span>Описание</span>
                        <button type="button" class="btn-ai-small" onclick="generateProductDescription()" title="Сгенерировать описание с помощью AI">
                            <i class="fas fa-magic"></i> AI описание
                        </button>
                    </label>
                    <textarea id="productDescription" rows="4" placeholder="Описание товара..."></textarea>
                    <div id="productDescLoading" style="display: none; color: #f59e0b; font-size: 12px; margin-top: 5px;">
                        <i class="fas fa-spinner fa-spin"></i> Генерация описания...
                    </div>
                </div>

                <!-- SEO Section -->
                <div style="background: #1e293b; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #e2e8f0;"><i class="fas fa-search"></i> SEO настройки</span>
                        <button type="button" class="btn-ai-small" onclick="generateProductMeta()" title="Сгенерировать мета-теги с помощью AI">
                            <i class="fas fa-magic"></i> AI мета-теги
                        </button>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Meta Title</label>
                        <input type="text" id="productMetaTitle" placeholder="SEO заголовок (до 60 символов)" maxlength="60">
                        <div style="font-size: 11px; color: #64748b; text-align: right;"><span id="metaTitleCount">0</span>/60</div>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Meta Description</label>
                        <textarea id="productMetaDesc" rows="2" placeholder="SEO описание (до 160 символов)" maxlength="160"></textarea>
                        <div style="font-size: 11px; color: #64748b; text-align: right;"><span id="metaDescCount">0</span>/160</div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">URL (slug)</label>
                        <input type="text" id="productSlug" placeholder="url-tovara">
                    </div>
                    <div id="productMetaLoading" style="display: none; color: #f59e0b; font-size: 12px; margin-top: 10px;">
                        <i class="fas fa-spinner fa-spin"></i> Генерация мета-тегов...
                    </div>
                </div>

                <!-- Physical Properties -->
                <div style="margin-top: 15px;">
                    <details>
                        <summary style="cursor: pointer; color: #94a3b8; font-size: 13px;">
                            <i class="fas fa-ruler-combined"></i> Габариты и вес
                        </summary>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                            <div class="form-group">
                                <label style="font-size: 12px;">Вес (кг)</label>
                                <input type="number" id="productWeight" placeholder="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">Длина (см)</label>
                                <input type="number" id="productLength" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">Ширина (см)</label>
                                <input type="number" id="productWidth" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">Высота (см)</label>
                                <input type="number" id="productHeight" placeholder="0">
                            </div>
                        </div>
                    </details>
                </div>

                <!-- AI Card Generation Button -->
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f59e0b20, #ea580c20); border: 1px solid #f59e0b40; border-radius: 8px;">
                    <button type="button" class="btn" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #ea580c); border: none;" onclick="generateProductCard()">
                        <i class="fas fa-magic"></i> Сгенерировать карточку товара
                    </button>
                    <p style="font-size: 11px; color: #94a3b8; text-align: center; margin-top: 8px; margin-bottom: 0;">
                        AI создаст изображения, описание и мета-теги
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('productModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveProduct()" id="productSaveBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <style>
        .btn-ai-small {
            background: linear-gradient(135deg, #f59e0b, #ea580c);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .btn-ai-small:hover {
            opacity: 0.9;
        }
        .btn-ai-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>

    <!-- Segment Modal -->
    <div class="modal-overlay" id="segmentModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый сегмент</h3>
                <button class="modal-close" onclick="closeModal('segmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название сегмента *</label>
                    <input type="text" id="segmentName" placeholder="VIP клиенты">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="segmentDescription" rows="2" placeholder="Описание сегмента"></textarea>
                </div>
                <div class="form-group">
                    <label>Цвет</label>
                    <input type="color" id="segmentColor" value="#6366f1">
                </div>
                <div class="form-group">
                    <label>Динамический сегмент</label>
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                        <input type="checkbox" id="segmentDynamic"> Автоматически добавлять клиентов по правилам
                    </label>
                </div>
                <div id="segmentRulesContainer" style="display: none;">
                    <label>Правила</label>
                    <div class="form-group" style="display: flex; gap: 8px;">
                        <select id="ruleField" style="flex: 1;">
                            <option value="total_orders">Количество заказов</option>
                            <option value="total_spent">Сумма покупок</option>
                            <option value="last_order_days">Дней с последнего заказа</option>
                            <option value="loyalty_points">Бонусные баллы</option>
                        </select>
                        <select id="ruleOperator" style="width: 100px;">
                            <option value="gt">Больше</option>
                            <option value="lt">Меньше</option>
                            <option value="eq">Равно</option>
                        </select>
                        <input type="number" id="ruleValue" placeholder="Значение" style="width: 100px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('segmentModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveSegment()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый заказ</h3>
                <button class="modal-close" onclick="closeModal('orderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Клиент *</label>
                    <select id="orderClient"><option value="">Выберите клиента</option></select>
                </div>
                <div class="form-group">
                    <label>Сумма заказа *</label>
                    <input type="number" id="orderAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Статус</label>
                    <select id="orderStatus">
                        <option value="new">Новый</option>
                        <option value="processing">В обработке</option>
                        <option value="shipped">Отправлен</option>
                        <option value="completed">Завершен</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Статус оплаты</label>
                    <select id="orderPaymentStatus">
                        <option value="pending">Ожидает оплаты</option>
                        <option value="paid">Оплачен</option>
                        <option value="partial">Частично оплачен</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Адрес доставки</label>
                    <textarea id="orderAddress" rows="2" placeholder="Адрес доставки"></textarea>
                </div>
                <div class="form-group">
                    <label>Комментарий</label>
                    <textarea id="orderNotes" rows="2" placeholder="Примечания к заказу"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('orderModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveOrder()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Service Modal - Extended for Bookings -->
    <div class="modal-overlay" id="serviceModal">
        <div class="modal" style="max-width:650px;">
            <div class="modal-header">
                <h3>Новая услуга</h3>
                <button class="modal-close" onclick="closeModal('serviceModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div class="form-group">
                    <label>Название услуги *</label>
                    <input type="text" id="serviceName" placeholder="Стрижка, Массаж, Консультация...">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Тип услуги</label>
                        <select id="serviceType" onchange="toggleServiceGroup()">
                            <option value="individual">Индивидуальная</option>
                            <option value="group">Групповая</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Категория</label>
                        <input type="text" id="serviceCategory" placeholder="Парикмахерские услуги">
                    </div>
                </div>
                <div id="serviceGroupSettings" style="display:none;background:#1e293b;padding:15px;border-radius:8px;margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0;font-size:14px;"><i class="fas fa-users"></i> Настройки группы</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Макс. участников</label>
                            <input type="number" id="serviceMaxClients" placeholder="10" value="10">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Мин. участников</label>
                            <input type="number" id="serviceMinClients" placeholder="3" value="1">
                        </div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Цена</label>
                        <input type="number" id="servicePrice" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Длительность (мин)</label>
                        <input type="number" id="serviceDuration" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label>Буфер (мин)</label>
                        <input type="number" id="serviceBuffer" placeholder="0" value="0">
                        <div style="font-size:11px;color:var(--text-muted);">Перерыв между записями</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Специалисты, оказывающие услугу</label>
                    <select id="serviceSpecialists" multiple style="height:80px;"></select>
                </div>
                <div class="form-group">
                    <label>Помещение</label>
                    <select id="serviceRoom">
                        <option value="">— Любое доступное —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="serviceDescription" rows="3" placeholder="Описание услуги для клиентов"></textarea>
                </div>
                <div style="margin-top:15px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="serviceOnlineBooking" checked> Доступна для онлайн-записи
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('serviceModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveService()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Course Modal -->
    <div class="modal-overlay" id="courseModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый курс</h3>
                <button class="modal-close" onclick="closeModal('courseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название курса *</label>
                    <input type="text" id="courseName" placeholder="Курс по маркетингу">
                </div>
                <div class="form-group">
                    <label>Цена</label>
                    <input type="number" id="coursePrice" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Уровень</label>
                    <select id="courseLevel">
                        <option value="beginner">Начинающий</option>
                        <option value="intermediate">Средний</option>
                        <option value="advanced">Продвинутый</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Длительность (часов)</label>
                    <input type="number" id="courseDuration" placeholder="10">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="courseDescription" rows="3" placeholder="Описание курса"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('courseModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveCourse()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Regulation Modal (SLA) -->
    <div class="modal-overlay" id="regulationModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый регламент</h3>
                <button class="modal-close" onclick="closeModal('regulationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="regulationName" placeholder="Ответ на заявку">
                </div>
                <div class="form-group">
                    <label>Воронка</label>
                    <select id="regulationFunnel"><option value="">Все воронки</option></select>
                </div>
                <div class="form-group">
                    <label>Условие срабатывания</label>
                    <select id="regulationCondition">
                        <option value="time_in_stage">Время на этапе</option>
                        <option value="no_activity">Нет активности</option>
                        <option value="no_tasks">Нет задач</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Значение *</label>
                        <input type="number" id="regulationValue" placeholder="24" value="24">
                    </div>
                    <div class="form-group">
                        <label>Единица</label>
                        <select id="regulationUnit">
                            <option value="hours">Часов</option>
                            <option value="minutes">Минут</option>
                            <option value="days">Дней</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Действие</label>
                    <select id="regulationAction">
                        <option value="notify">Уведомить менеджера</option>
                        <option value="create_task">Создать задачу</option>
                        <option value="move_stage">Переместить на этап</option>
                        <option value="add_tag">Добавить тег</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('regulationModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveRegulation()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Goal Modal (KPI) -->
    <div class="modal-overlay" id="goalModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая цель</h3>
                <button class="modal-close" onclick="closeModal('goalModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Сотрудник</label>
                    <select id="goalEmployee"><option value="">Общая цель (все)</option></select>
                </div>
                <div class="form-group">
                    <label>Метрика *</label>
                    <select id="goalMetric">
                        <option value="revenue">Выручка</option>
                        <option value="deals_won">Закрытых сделок</option>
                        <option value="calls">Звонков</option>
                        <option value="conversion_rate">Конверсия %</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Целевое значение *</label>
                    <input type="number" id="goalTarget" placeholder="100000">
                </div>
                <div class="form-group">
                    <label>Период</label>
                    <select id="goalPeriodType">
                        <option value="month">Месяц</option>
                        <option value="quarter">Квартал</option>
                        <option value="year">Год</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Начало</label>
                        <input type="date" id="goalStart">
                    </div>
                    <div class="form-group">
                        <label>Конец</label>
                        <input type="date" id="goalEnd">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('goalModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveGoal()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Distribution Settings Modal -->
    <div class="modal-overlay" id="distributionModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Настройки распределения</h3>
                <button class="modal-close" onclick="closeModal('distributionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Воронка</label>
                    <select id="distFunnel"><option value="">Все воронки</option></select>
                </div>
                <div class="form-group">
                    <label>Тип распределения</label>
                    <select id="distType">
                        <option value="round_robin">По очереди (Round Robin)</option>
                        <option value="load_balanced">По нагрузке</option>
                        <option value="random">Случайно</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Таймаут ответа (минут)</label>
                    <input type="number" id="distTimeout" value="30" placeholder="30">
                </div>
                <div class="form-group">
                    <label>Макс. лидов на сотрудника</label>
                    <input type="number" id="distMaxLeads" placeholder="Без лимита">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="distAutoReassign" checked> Авто-переназначение при таймауте</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="distWorkingHours" checked> Только в рабочее время</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('distributionModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveDistributionSettings()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="modal-overlay" id="tagModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>Новый тег</h3>
                <button class="modal-close" onclick="closeModal('tagModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="tagName" placeholder="VIP клиент">
                </div>
                <div class="form-group">
                    <label>Цвет</label>
                    <input type="color" id="tagColor" value="#3b82f6" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer;">
                </div>
                <div class="form-group">
                    <label>Для сущности</label>
                    <select id="tagEntityType">
                        <option value="deal">Сделки</option>
                        <option value="client">Клиенты</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('tagModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveTag()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Brand Modal -->
    <div class="modal-overlay" id="brandModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>Новый бренд</h3>
                <button class="modal-close" onclick="closeModal('brandModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="brandName" placeholder="Nike">
                </div>
                <div class="form-group">
                    <label>Логотип (URL)</label>
                    <input type="text" id="brandLogo" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Сайт</label>
                    <input type="text" id="brandWebsite" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="brandDescription" rows="2" placeholder="Описание бренда"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('brandModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveBrand()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Promo Code Modal - Extended -->
    <div class="modal-overlay" id="promoModal">
        <div class="modal" style="max-width:650px;">
            <div class="modal-header">
                <h3>Новый промокод</h3>
                <button class="modal-close" onclick="closeModal('promoModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Код *</label>
                        <div style="display:flex;gap:8px;">
                            <input type="text" id="promoCode" placeholder="SALE20" style="text-transform:uppercase;flex:1;">
                            <button class="btn btn-outline btn-sm" onclick="generatePromoCode()"><i class="fas fa-random"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Статус</label>
                        <select id="promoStatus">
                            <option value="active">Активен</option>
                            <option value="disabled">Отключён</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Тип скидки</label>
                        <select id="promoType">
                            <option value="percent">Процент (%)</option>
                            <option value="fixed">Фикс. сумма (₽)</option>
                            <option value="free_shipping">Бесп. доставка</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Значение *</label>
                        <input type="number" id="promoValue" placeholder="20">
                    </div>
                    <div class="form-group">
                        <label>Макс. скидка (₽)</label>
                        <input type="number" id="promoMaxDiscount" placeholder="Без лимита">
                    </div>
                </div>

                <div style="background:#1e293b;border-radius:8px;padding:15px;margin:15px 0;">
                    <h4 style="margin:0 0 15px 0;font-size:14px;"><i class="fas fa-cog"></i> Условия применения</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Мин. сумма заказа</label>
                            <input type="number" id="promoMinOrder" placeholder="0">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Лимит использований</label>
                            <input type="number" id="promoMaxUses" placeholder="Без лимита">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>На клиента (раз)</label>
                            <input type="number" id="promoPerClient" placeholder="Без лимита">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Мин. кол-во товаров</label>
                            <input type="number" id="promoMinItems" placeholder="1" value="1">
                        </div>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Дата начала</label>
                        <input type="date" id="promoStart">
                    </div>
                    <div class="form-group">
                        <label>Дата окончания</label>
                        <input type="date" id="promoEnd">
                    </div>
                </div>

                <div class="form-group">
                    <label>Применяется к</label>
                    <select id="promoAppliesTo" onchange="togglePromoProducts()">
                        <option value="all">Всем товарам</option>
                        <option value="categories">Категориям</option>
                        <option value="products">Конкретным товарам</option>
                        <option value="first_order">Только первый заказ</option>
                    </select>
                </div>
                <div id="promoProductsGroup" style="display:none;" class="form-group">
                    <label>Выберите товары/категории</label>
                    <select id="promoProducts" multiple style="height:100px;"></select>
                </div>

                <div style="margin-top:15px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="promoExcludeSale"> Не применять к товарам со скидкой
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;margin-top:8px;">
                        <input type="checkbox" id="promoCombine"> Можно комбинировать с другими скидками
                    </label>
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label>Описание (для внутреннего использования)</label>
                    <textarea id="promoDescription" rows="2" placeholder="Зачем создан этот промокод..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('promoModal')">Отмена</button>
                <button class="btn btn-primary" onclick="savePromoCode()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Collection Modal -->
    <div class="modal-overlay" id="collectionModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>Новая коллекция</h3>
                <button class="modal-close" onclick="closeModal('collectionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="collectionName" placeholder="Новинки сезона">
                </div>
                <div class="form-group">
                    <label>Изображение (URL)</label>
                    <input type="text" id="collectionImage" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Тип</label>
                    <select id="collectionType">
                        <option value="manual">Ручная (выбираю товары)</option>
                        <option value="auto">Автоматическая (по правилам)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="collectionDescription" rows="2" placeholder="Описание коллекции"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('collectionModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveCollection()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая запись</h3>
                <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Услуга *</label>
                    <select id="bookingService"><option value="">Выберите услугу</option></select>
                </div>
                <div class="form-group">
                    <label>Мастер</label>
                    <select id="bookingEmployee"><option value="">Любой свободный</option></select>
                </div>
                <div class="form-group">
                    <label>Клиент</label>
                    <select id="bookingClient"><option value="">Выберите или создайте</option></select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Дата *</label>
                        <input type="date" id="bookingDate">
                    </div>
                    <div class="form-group">
                        <label>Время *</label>
                        <input type="time" id="bookingTime">
                    </div>
                </div>
                <div class="form-group">
                    <label>Имя клиента (если новый)</label>
                    <input type="text" id="bookingClientName" placeholder="Иван Иванов">
                </div>
                <div class="form-group">
                    <label>Телефон клиента</label>
                    <input type="tel" id="bookingClientPhone" placeholder="+7 999 123-45-67">
                </div>
                <div class="form-group">
                    <label>Комментарий</label>
                    <textarea id="bookingComment" rows="2" placeholder="Примечание к записи"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bookingModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveBooking()">Записать</button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3>Расписание сотрудника</h3>
                <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Сотрудник *</label>
                    <select id="scheduleEmployee"><option value="">Выберите сотрудника</option></select>
                </div>
                <div style="margin-top:16px;">
                    <table style="width:100%;font-size:13px;">
                        <tr><th>День</th><th>Работает</th><th>Начало</th><th>Конец</th></tr>
                        <tr><td>Понедельник</td><td><input type="checkbox" id="schedMon" checked></td><td><input type="time" id="schedMonStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedMonEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Вторник</td><td><input type="checkbox" id="schedTue" checked></td><td><input type="time" id="schedTueStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedTueEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Среда</td><td><input type="checkbox" id="schedWed" checked></td><td><input type="time" id="schedWedStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedWedEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Четверг</td><td><input type="checkbox" id="schedThu" checked></td><td><input type="time" id="schedThuStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedThuEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Пятница</td><td><input type="checkbox" id="schedFri" checked></td><td><input type="time" id="schedFriStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedFriEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Суббота</td><td><input type="checkbox" id="schedSat"></td><td><input type="time" id="schedSatStart" value="10:00" style="width:100px;"></td><td><input type="time" id="schedSatEnd" value="16:00" style="width:100px;"></td></tr>
                        <tr><td>Воскресенье</td><td><input type="checkbox" id="schedSun"></td><td><input type="time" id="schedSunStart" value="10:00" style="width:100px;"></td><td><input type="time" id="schedSunEnd" value="16:00" style="width:100px;"></td></tr>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('scheduleModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveSchedule()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Webinar Modal -->
    <div class="modal-overlay" id="webinarModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый вебинар</h3>
                <button class="modal-close" onclick="closeModal('webinarModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="webinarTitle" placeholder="Вебинар по продажам">
                </div>
                <div class="form-group">
                    <label>Курс (опционально)</label>
                    <select id="webinarCourse"><option value="">Без курса</option></select>
                </div>
                <div class="form-group">
                    <label>Ведущий</label>
                    <select id="webinarHost"><option value="">Выберите ведущего</option></select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Дата и время *</label>
                        <input type="datetime-local" id="webinarDate">
                    </div>
                    <div class="form-group">
                        <label>Длительность (мин)</label>
                        <input type="number" id="webinarDuration" value="60" placeholder="60">
                    </div>
                </div>
                <div class="form-group">
                    <label>Платформа</label>
                    <select id="webinarPlatform">
                        <option value="zoom">Zoom</option>
                        <option value="youtube">YouTube Live</option>
                        <option value="custom">Своя ссылка</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="webinarDescription" rows="3" placeholder="О чём вебинар"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('webinarModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveWebinar()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal-overlay" id="quizModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый тест</h3>
                <button class="modal-close" onclick="closeModal('quizModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="quizTitle" placeholder="Тест по модулю 1">
                </div>
                <div class="form-group">
                    <label>Курс *</label>
                    <select id="quizCourse"><option value="">Выберите курс</option></select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Проходной балл (%)</label>
                        <input type="number" id="quizPassingScore" value="70" placeholder="70">
                    </div>
                    <div class="form-group">
                        <label>Лимит времени (мин)</label>
                        <input type="number" id="quizTimeLimit" placeholder="Без лимита">
                    </div>
                </div>
                <div class="form-group">
                    <label>Попыток</label>
                    <input type="number" id="quizAttempts" value="3" placeholder="3">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="quizShuffle"> Перемешивать вопросы</label>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="quizDescription" rows="2" placeholder="Инструкция к тесту"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('quizModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveQuiz()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Integration Modal -->
    <div class="modal-overlay" id="integrationModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая интеграция</h3>
                <button class="modal-close" onclick="closeModal('integrationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="integrationName" placeholder="Форма с сайта">
                </div>
                <div class="form-group">
                    <label>Тип *</label>
                    <select id="integrationType" onchange="toggleIntegrationFields()">
                        <option value="web_form">Веб-форма</option>
                        <option value="webhook">Входящий вебхук</option>
                        <option value="widget">Виджет на сайт</option>
                        <option value="telegram">Telegram бот</option>
                        <option value="email">Email парсинг</option>
                    </select>
                </div>
                <div class="form-group" id="integrationFunnelGroup">
                    <label>Воронка для лидов</label>
                    <select id="integrationFunnel"><option value="">По умолчанию</option></select>
                </div>
                <div class="form-group" id="integrationUrlGroup" style="display:none;">
                    <label>URL для отправки данных</label>
                    <input type="text" id="integrationUrl" readonly style="background:#1e293b;">
                    <div class="form-hint">Скопируйте этот URL в настройки вашей формы</div>
                </div>
                <div class="form-group" id="integrationWidgetGroup" style="display:none;">
                    <label>Код виджета</label>
                    <textarea id="integrationWidget" rows="4" readonly style="background:#1e293b;font-family:monospace;font-size:12px;"></textarea>
                    <div class="form-hint">Вставьте этот код на ваш сайт перед &lt;/body&gt;</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('integrationModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveIntegration()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3>Новая категория</h3>
                <button class="modal-close" onclick="closeModal('categoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название категории *</label>
                    <input type="text" id="categoryName" placeholder="Название категории">
                </div>
                <div class="form-group">
                    <label>Родительская категория</label>
                    <select id="categoryParent">
                        <option value="">— Корневая категория —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="categoryDescription" rows="2" placeholder="Описание категории"></textarea>
                </div>
                <div class="form-group">
                    <label>Изображение</label>
                    <input type="file" id="categoryImage" accept="image/*">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('categoryModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveCategory()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Product Filter Modal -->
    <div class="modal-overlay" id="productFilterModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3>Добавить фильтр</h3>
                <button class="modal-close" onclick="closeModal('productFilterModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Выберите тип фильтра или создайте свой</label>
                    <select id="filterType" onchange="toggleCustomFilter()">
                        <option value="size">Размер</option>
                        <option value="color">Цвет</option>
                        <option value="material">Материал</option>
                        <option value="brand">Бренд</option>
                        <option value="season">Сезон</option>
                        <option value="gender">Пол</option>
                        <option value="custom">Свой фильтр...</option>
                    </select>
                </div>
                <div id="customFilterName" style="display:none;" class="form-group">
                    <label>Название фильтра</label>
                    <input type="text" id="filterCustomName" placeholder="Например: Страна производства">
                </div>
                <div class="form-group">
                    <label>Значения фильтра (по одному на строку)</label>
                    <textarea id="filterValues" rows="6" placeholder="Например:
XS
S
M
L
XL"></textarea>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="filterMultiple"> Множественный выбор
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('productFilterModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveProductFilter()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Selection Modal -->
    <div class="modal-overlay" id="selectionModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3>Новая подборка</h3>
                <button class="modal-close" onclick="closeModal('selectionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название подборки *</label>
                    <input type="text" id="selectionName" placeholder="Хиты продаж">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="selectionDescription" rows="2" placeholder="Описание подборки"></textarea>
                </div>
                <div class="form-group">
                    <label>Тип подборки</label>
                    <select id="selectionType">
                        <option value="manual">Ручная (выбор товаров)</option>
                        <option value="auto">Автоматическая (по правилам)</option>
                    </select>
                </div>
                <div id="selectionProductsGroup" class="form-group">
                    <label>Товары</label>
                    <select id="selectionProducts" multiple style="height:150px;"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('selectionModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveSelection()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Import XML Modal -->
    <div class="modal-overlay" id="importXmlModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3>Импорт товаров из XML</h3>
                <button class="modal-close" onclick="closeModal('importXmlModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>XML файл *</label>
                    <input type="file" id="xmlFile" accept=".xml">
                </div>
                <div class="form-group">
                    <label>Или укажите URL</label>
                    <input type="text" id="xmlUrl" placeholder="https://example.com/products.xml">
                </div>
                <div class="form-group">
                    <label>Формат</label>
                    <select id="xmlFormat">
                        <option value="yandex">Яндекс.Маркет (YML)</option>
                        <option value="insales">InSales</option>
                        <option value="1c">1C CommerceML</option>
                        <option value="custom">Другой</option>
                    </select>
                </div>
                <div style="background:#1e293b;padding:15px;border-radius:8px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="xmlUpdateExisting"> Обновить существующие товары
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;margin-top:10px;">
                        <input type="checkbox" id="xmlCreateCategories" checked> Создать категории
                    </label>
                </div>
                <div id="xmlProgress" style="display:none;margin-top:15px;">
                    <div style="background:var(--border-color);border-radius:4px;overflow:hidden;">
                        <div id="xmlProgressBar" style="width:0%;height:8px;background:var(--accent);transition:width 0.3s;"></div>
                    </div>
                    <p id="xmlProgressText" style="text-align:center;margin-top:8px;font-size:13px;"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('importXmlModal')">Отмена</button>
                <button class="btn btn-primary" onclick="importXml()"><i class="fas fa-upload"></i> Импортировать</button>
            </div>
        </div>
    </div>

    <!-- Specialist Modal -->
    <div class="modal-overlay" id="specialistModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3>Добавить специалиста</h3>
                <button class="modal-close" onclick="closeModal('specialistModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Имя *</label>
                        <input type="text" id="specialistFirstName" placeholder="Имя">
                    </div>
                    <div class="form-group">
                        <label>Фамилия</label>
                        <input type="text" id="specialistLastName" placeholder="Фамилия">
                    </div>
                </div>
                <div class="form-group">
                    <label>Должность</label>
                    <input type="text" id="specialistPosition" placeholder="Мастер-стилист">
                </div>
                <div class="form-group">
                    <label>Услуги</label>
                    <select id="specialistServices" multiple style="height:100px;"></select>
                </div>
                <div class="form-group">
                    <label>Описание / Опыт</label>
                    <textarea id="specialistBio" rows="3" placeholder="Опыт работы, сертификаты..."></textarea>
                </div>
                <div class="form-group">
                    <label>Филиал</label>
                    <select id="specialistBranch">
                        <option value="">— Основной —</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('specialistModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveSpecialist()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Room Modal -->
    <div class="modal-overlay" id="roomModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3>Добавить помещение</h3>
                <button class="modal-close" onclick="closeModal('roomModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="roomName" placeholder="Кабинет №1">
                </div>
                <div class="form-group">
                    <label>Вместимость</label>
                    <input type="number" id="roomCapacity" placeholder="1" value="1">
                </div>
                <div class="form-group">
                    <label>Услуги, доступные в помещении</label>
                    <select id="roomServices" multiple style="height:100px;"></select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="roomDescription" rows="2" placeholder="Описание помещения"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('roomModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveRoom()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Training Modal -->
    <div class="modal-overlay" id="trainingModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>Новый тренинг</h3>
                <button class="modal-close" onclick="closeModal('trainingModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div class="form-group">
                    <label>Название тренинга *</label>
                    <input type="text" id="trainingName" placeholder="Основы программирования">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="trainingDescription" rows="3" placeholder="Описание тренинга"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Тип доступа</label>
                        <select id="trainingAccessType">
                            <option value="purchase">После покупки продукта</option>
                            <option value="group">По группе</option>
                            <option value="free">Бесплатный</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Продукт для покупки</label>
                        <select id="trainingProduct">
                            <option value="">— Не требуется —</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Дни доступа</label>
                        <input type="number" id="trainingAccessDays" placeholder="0 = бессрочно" value="0">
                    </div>
                    <div class="form-group">
                        <label>Drip-контент</label>
                        <select id="trainingDrip">
                            <option value="0">Весь сразу</option>
                            <option value="1">1 урок в день</option>
                            <option value="2">1 урок в 2 дня</option>
                            <option value="7">1 урок в неделю</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="trainingCertificate"> Выдавать сертификат по завершении
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('trainingModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveTraining()">Создать тренинг</button>
            </div>
        </div>
    </div>

    <!-- Lesson Modal -->
    <div class="modal-overlay" id="lessonModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>Новый урок</h3>
                <button class="modal-close" onclick="closeModal('lessonModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div class="form-group">
                    <label>Тренинг *</label>
                    <select id="lessonTraining">
                        <option value="">— Выберите тренинг —</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:3fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Название урока *</label>
                        <input type="text" id="lessonName" placeholder="Введение">
                    </div>
                    <div class="form-group">
                        <label>Порядок</label>
                        <input type="number" id="lessonOrder" value="1" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Тип урока</label>
                    <select id="lessonType" onchange="toggleLessonContent()">
                        <option value="video">Видео</option>
                        <option value="text">Текст</option>
                        <option value="quiz">Тест</option>
                        <option value="homework">Домашнее задание</option>
                    </select>
                </div>
                <div id="lessonVideoGroup" class="form-group">
                    <label>Видео URL (YouTube, Vimeo, MP4)</label>
                    <input type="text" id="lessonVideoUrl" placeholder="https://youtube.com/watch?v=...">
                </div>
                <div id="lessonTextGroup" class="form-group" style="display:none;">
                    <label>Контент урока</label>
                    <textarea id="lessonContent" rows="10" placeholder="Содержимое урока..."></textarea>
                </div>
                <div class="form-group">
                    <label>Длительность (мин)</label>
                    <input type="number" id="lessonDuration" placeholder="15">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('lessonModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveLesson()">Создать урок</button>
            </div>
        </div>
    </div>

    <!-- Autowebinar Modal -->
    <div class="modal-overlay" id="autoWebinarModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>Создать автовебинар</h3>
                <button class="modal-close" onclick="closeModal('autoWebinarModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div class="form-group">
                    <label>Название автовебинара *</label>
                    <input type="text" id="autoWebinarName" placeholder="Как начать бизнес с нуля">
                </div>
                <div class="form-group">
                    <label>Видео записи вебинара *</label>
                    <input type="text" id="autoWebinarVideo" placeholder="https://youtube.com/watch?v=...">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Длительность (мин)</label>
                        <input type="number" id="autoWebinarDuration" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label>Тренинг (опционально)</label>
                        <select id="autoWebinarTraining">
                            <option value="">— Не привязан —</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Расписание показов</label>
                    <div style="background:#1e293b;padding:15px;border-radius:8px;">
                        <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                            <input type="checkbox" id="autoWebinarScheduled"> По расписанию
                        </label>
                        <div id="autoWebinarSchedule" style="margin-top:15px;display:none;">
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                                <input type="time" id="autoWebinarTime1" class="filter-select">
                                <input type="time" id="autoWebinarTime2" class="filter-select">
                                <input type="time" id="autoWebinarTime3" class="filter-select">
                            </div>
                            <p style="font-size:12px;color:var(--text-muted);margin-top:10px;">Укажите время показов (по Москве)</p>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Симуляция чата</label>
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="autoWebinarChat" checked> Включить имитацию сообщений в чате
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('autoWebinarModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveAutoWebinar()">Создать автовебинар</button>
            </div>
        </div>
    </div>

    <!-- Certificate Template Modal -->
    <div class="modal-overlay" id="certificateTemplateModal">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <h3>Редактор шаблона сертификата</h3>
                <button class="modal-close" onclick="closeModal('certificateTemplateModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
                <div style="display:grid;grid-template-columns:1fr 2fr;gap:20px;">
                    <!-- Settings Panel -->
                    <div>
                        <div class="form-group">
                            <label>Название шаблона *</label>
                            <input type="text" id="certTemplateName" placeholder="Стандартный сертификат">
                        </div>
                        <div class="form-group">
                            <label>Фон (подложка)</label>
                            <input type="file" id="certTemplateBackground" accept="image/*">
                            <div id="certBgPreview" style="margin-top:10px;"></div>
                        </div>
                        <div class="form-group">
                            <label>Тренинг</label>
                            <select id="certTemplateTraining">
                                <option value="">— Для всех —</option>
                            </select>
                        </div>
                        <hr style="border-color:var(--border-color);margin:20px 0;">
                        <h4 style="margin-bottom:15px;">Элементы</h4>
                        <div class="cert-elements">
                            <div class="cert-element-item" draggable="true" data-element="name">
                                <i class="fas fa-user"></i> Имя студента
                            </div>
                            <div class="cert-element-item" draggable="true" data-element="training">
                                <i class="fas fa-graduation-cap"></i> Название тренинга
                            </div>
                            <div class="cert-element-item" draggable="true" data-element="number">
                                <i class="fas fa-hashtag"></i> Номер сертификата
                            </div>
                            <div class="cert-element-item" draggable="true" data-element="date">
                                <i class="fas fa-calendar"></i> Дата выдачи
                            </div>
                            <div class="cert-element-item" draggable="true" data-element="signature">
                                <i class="fas fa-signature"></i> Подпись
                            </div>
                        </div>
                    </div>
                    <!-- Preview Canvas -->
                    <div>
                        <div id="certPreviewCanvas" style="background:#fff;border-radius:8px;aspect-ratio:1.414;position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ccc;text-align:center;">
                                <i class="fas fa-image" style="font-size:48px;"></i>
                                <p>Загрузите фон</p>
                            </div>
                            <!-- Draggable elements will be placed here -->
                            <div id="certElementName" class="cert-draggable" style="position:absolute;top:40%;left:50%;transform:translateX(-50%);font-size:24px;color:#333;font-weight:bold;">
                                {ИМЯ СТУДЕНТА}
                            </div>
                            <div id="certElementTraining" class="cert-draggable" style="position:absolute;top:50%;left:50%;transform:translateX(-50%);font-size:18px;color:#333;">
                                {НАЗВАНИЕ ТРЕНИНГА}
                            </div>
                            <div id="certElementNumber" class="cert-draggable" style="position:absolute;top:75%;left:20%;font-size:12px;color:#666;">
                                №{НОМЕР}
                            </div>
                            <div id="certElementDate" class="cert-draggable" style="position:absolute;top:75%;right:20%;font-size:12px;color:#666;">
                                {ДАТА}
                            </div>
                        </div>
                        <p style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:10px;">
                            Перетаскивайте элементы для позиционирования
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('certificateTemplateModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveCertificateTemplate()">Сохранить шаблон</button>
            </div>
        </div>
    </div>

    <!-- Issue Certificate Modal -->
    <div class="modal-overlay" id="issueCertificateModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3>Выдать сертификат</h3>
                <button class="modal-close" onclick="closeModal('issueCertificateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Студент *</label>
                    <select id="certStudent">
                        <option value="">— Выберите студента —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Тренинг *</label>
                    <select id="certTraining">
                        <option value="">— Выберите тренинг —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Шаблон сертификата</label>
                    <select id="certTemplate">
                        <option value="">— По умолчанию —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Номер сертификата</label>
                    <input type="text" id="certNumber" placeholder="Авто-генерация" readonly style="background:#1e293b;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('issueCertificateModal')">Отмена</button>
                <button class="btn btn-primary" onclick="issueCertificate()">Выдать</button>
            </div>
        </div>
    </div>

    <style>
        .cert-element-item {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .cert-element-item:hover {
            background: var(--border-color);
        }
        .cert-draggable {
            cursor: move;
            user-select: none;
        }
        .cert-draggable:hover {
            outline: 2px dashed var(--accent);
        }
        .type-option:has(input:checked) {
            border-color: var(--accent) !important;
            background: rgba(99, 102, 241, 0.1) !important;
        }
        .bookings-calendar {
            width: 100%;
            border-collapse: collapse;
        }
        .bookings-calendar th,
        .bookings-calendar td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
            min-width: 100px;
        }
        .bookings-calendar th {
            background: var(--bg-input);
        }
        .bookings-calendar .time-cell {
            background: var(--bg-input);
            font-weight: 500;
        }
        .bookings-calendar .slot-cell {
            cursor: pointer;
            transition: background 0.2s;
            min-height: 40px;
            vertical-align: top;
        }
        .bookings-calendar .slot-cell:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .bookings-calendar .slot-booked {
            background: rgba(99, 102, 241, 0.2);
        }
        .booking-item {
            font-size: 11px;
            padding: 4px 6px;
            background: var(--accent);
            color: white;
            border-radius: 4px;
            margin-bottom: 2px;
            cursor: pointer;
        }
        .categories-tree {
            padding: 10px;
        }
        .category-item {
            padding: 10px 15px;
            margin: 5px 0;
            background: var(--bg-input);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .category-item:hover {
            background: var(--border-color);
        }
        .category-children {
            margin-left: 25px;
            border-left: 2px solid var(--border-color);
            padding-left: 15px;
        }
    </style>

    <script>
        // Config
        const API_BASE = '/api';
        let projectId = null;
        let funnels = [], clients = [], employees = [], deals = [], orders = [], tasks = [], products = [];

        // API Helper
        async function api(method, endpoint, data = null) {
            const token = localStorage.getItem('cms_token');
            const opts = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (token) opts.headers['Authorization'] = 'Bearer ' + token;
            if (data) opts.body = JSON.stringify(data);

            const res = await fetch(API_BASE + endpoint, opts);
            return res.json();
        }

        // Init
        async function init() {
            // Get project from localStorage or redirect to login
            const projects = JSON.parse(localStorage.getItem('cms_projects') || '[]');
            if (projects.length === 0) {
                alert('Сначала войдите в систему');
                location.href = 'admin.html';
                return;
            }
            projectId = projects[0].id;

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['bookingsDate', 'bookingDate', 'goalStart', 'promoStart'];
            dateInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.value) el.value = today;
            });

            // Set default end dates (end of month)
            const endOfMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString().split('T')[0];
            ['goalEnd', 'promoEnd'].forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.value) el.value = endOfMonth;
            });

            setupNavigation();
            await loadAllData();

            // Handle hash-based navigation from admin.html
            const hash = location.hash.replace('#', '');
            if (hash && document.getElementById('section-' + hash)) {
                switchSection(hash);
            } else {
                renderDashboard();
            }
        }

        async function loadAllData() {
            await Promise.all([
                loadFunnels(),
                loadClients(),
                loadEmployees(),
                loadOrders(),
                loadProducts(),
                loadSegments()
            ]);
            updateOrderClientSelect();
            populateSelects();
            loadServicesForBooking();
            loadCoursesForModals();
        }

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.addEventListener('click', () => switchSection(item.dataset.section));
            });
        }

        function switchSection(section) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-section="${section}"]`)?.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + section)?.classList.add('active');

            const titles = {
                dashboard: 'Дашборд', funnels: 'Воронки продаж', deals: 'Сделки',
                clients: 'Клиенты', segments: 'Сегменты', employees: 'Сотрудники',
                tasks: 'Задачи', orders: 'Заказы', payments: 'Платежи',
                products: 'Товары', services: 'Услуги', courses: 'Курсы',
                // amoCRM
                calls: 'Звонки', regulations: 'Регламенты SLA', goals: 'KPI и Цели',
                'lead-distribution': 'Распределение лидов', tags: 'Теги',
                'employee-analytics': 'Аналитика сотрудников',
                // InSales
                brands: 'Бренды', 'promo-codes': 'Промокоды', collections: 'Коллекции',
                // YClients
                bookings: 'Записи на услуги', schedules: 'Расписание',
                // GetCourse
                webinars: 'Вебинары', quizzes: 'Тесты и квизы', certificates: 'Сертификаты',
                // Settings
                integrations: 'Интеграции'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;

            // Load section-specific data
            if (section === 'deals') loadDealsKanban();
            if (section === 'tasks') loadTasks();
            if (section === 'orders') loadOrders();
            if (section === 'products') loadProducts();
            if (section === 'segments') loadSegments();
            if (section === 'services') loadServices();
            if (section === 'courses') loadCourses();
            if (section === 'payments') loadPayments();
            // amoCRM
            if (section === 'calls') loadCalls();
            if (section === 'regulations') loadRegulations();
            if (section === 'goals') loadGoals();
            if (section === 'lead-distribution') loadLeadDistribution();
            if (section === 'tags') loadTags();
            if (section === 'employee-analytics') loadEmployeeAnalytics();
            // InSales
            if (section === 'brands') loadBrands();
            if (section === 'promo-codes') loadPromoCodes();
            if (section === 'collections') loadCollections();
            // YClients
            if (section === 'bookings') loadBookings();
            if (section === 'schedules') loadSchedules();
            // GetCourse
            if (section === 'webinars') loadWebinars();
            if (section === 'quizzes') loadQuizzes();
            if (section === 'certificates') loadCertificates();
            // Settings
            if (section === 'integrations') loadIntegrations();
        }

        // Modal
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        // Funnels
        async function loadFunnels() {
            const res = await api('GET', `/funnels/${projectId}`);
            if (res.success) {
                funnels = res.funnels;
                renderFunnels();
                updateFunnelSelects();
            }
        }

        function renderFunnels() {
            const el = document.getElementById('funnelsList');
            if (!funnels.length) {
                el.innerHTML = '<div class="empty-state"><i class="fas fa-filter"></i><h3>Нет воронок</h3><p>Создайте первую воронку продаж</p></div>';
                return;
            }

            el.innerHTML = funnels.map(f => `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-header">
                        <h3>${escapeHtml(f.name)}</h3>
                        <div>
                            <span class="badge badge-new">${f.stages?.length || 0} этапов</span>
                            <span class="badge">${f.deals_count || 0} сделок</span>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 16px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${(f.stages || []).map(s => `
                                <div style="padding: 8px 16px; background: ${s.color}20; border-radius: 8px; border-left: 3px solid ${s.color};">
                                    <div style="font-weight: 500;">${escapeHtml(s.name)}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${s.deals_count || 0} сделок</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function saveFunnel() {
            const name = document.getElementById('funnelName').value;
            const description = document.getElementById('funnelDescription').value;

            if (!name) return alert('Введите название воронки');

            const res = await api('POST', `/funnels/${projectId}`, { name, description });
            if (res.success) {
                closeModal('funnelModal');
                document.getElementById('funnelName').value = '';
                document.getElementById('funnelDescription').value = '';
                loadFunnels();
            } else {
                alert(res.error || 'Ошибка создания воронки');
            }
        }

        function updateFunnelSelects() {
            const options = '<option value="">Выберите воронку</option>' + funnels.map(f => `<option value="${f.id}">${escapeHtml(f.name)}</option>`).join('');
            document.getElementById('filterFunnel').innerHTML = '<option value="">Все воронки</option>' + funnels.map(f => `<option value="${f.id}">${escapeHtml(f.name)}</option>`).join('');
            document.getElementById('dealFunnel').innerHTML = options;
        }

        function loadDealStages() {
            const funnelId = document.getElementById('dealFunnel').value;
            const funnel = funnels.find(f => f.id === funnelId);
            const stages = funnel?.stages || [];
            document.getElementById('dealStage').innerHTML = '<option value="">Выберите этап</option>' + stages.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
        }

        // Deals Kanban
        async function loadDealsKanban() {
            const funnelId = document.getElementById('filterFunnel').value;
            if (!funnelId && funnels.length) {
                document.getElementById('filterFunnel').value = funnels[0].id;
            }
            const selectedFunnelId = document.getElementById('filterFunnel').value || funnels[0]?.id;
            if (!selectedFunnelId) return;

            const res = await api('GET', `/funnels/${projectId}/${selectedFunnelId}`);
            if (res.success) {
                renderKanban(res.funnel);
            }
        }

        function renderKanban(funnel) {
            const kanban = document.getElementById('dealsKanban');
            kanban.innerHTML = (funnel.stages || []).map(stage => `
                <div class="kanban-column" data-stage="${stage.id}">
                    <div class="kanban-header">
                        <h4><span class="dot" style="background: ${stage.color}"></span> ${escapeHtml(stage.name)} <span class="count">(${stage.deals?.length || 0})</span></h4>
                    </div>
                    <div class="kanban-body" ondragover="event.preventDefault()" ondrop="dropDeal(event, '${stage.id}')">
                        ${(stage.deals || []).map(deal => `
                            <div class="kanban-card" draggable="true" ondragstart="dragDeal(event, '${deal.id}')" data-deal="${deal.id}">
                                <div class="kanban-card-title">${escapeHtml(deal.name)}</div>
                                <div class="kanban-card-meta">
                                    <span><i class="fas fa-ruble-sign"></i> ${formatMoney(deal.amount)}</span>
                                    ${deal.client_first_name ? `<span><i class="fas fa-user"></i> ${escapeHtml(deal.client_first_name)}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="kanban-add" onclick="quickAddDeal('${stage.id}')">
                        <i class="fas fa-plus"></i> Добавить сделку
                    </div>
                </div>
            `).join('');
        }

        let draggedDealId = null;
        function dragDeal(e, dealId) { draggedDealId = dealId; }
        async function dropDeal(e, stageId) {
            e.preventDefault();
            if (!draggedDealId) return;

            await api('POST', `/funnels/${projectId}/deals/${draggedDealId}/move`, { stage_id: stageId });
            draggedDealId = null;
            loadDealsKanban();
        }

        async function saveDeal() {
            const name = document.getElementById('dealName').value;
            const client_id = document.getElementById('dealClient').value;
            const amount = document.getElementById('dealAmount').value;
            const funnel_id = document.getElementById('dealFunnel').value;
            const stage_id = document.getElementById('dealStage').value;
            const assigned_to = document.getElementById('dealAssignee').value;

            if (!name) return alert('Введите название сделки');

            const res = await api('POST', `/funnels/${projectId}/deals`, {
                name, client_id: client_id || null, amount: parseFloat(amount) || 0,
                funnel_id: funnel_id || null, stage_id: stage_id || null,
                assigned_to: assigned_to || null
            });

            if (res.success) {
                closeModal('dealModal');
                ['dealName', 'dealClient', 'dealAmount', 'dealFunnel', 'dealStage', 'dealAssignee'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadDealsKanban();
                loadFunnels();
            } else {
                alert(res.error || 'Ошибка создания сделки');
            }
        }

        // Clients
        async function loadClients() {
            const res = await api('GET', `/clients/${projectId}`);
            if (res.success) {
                clients = res.clients;
                renderClients();
                updateClientSelects();
            }
        }

        function renderClients(filteredClients = null) {
            const data = filteredClients || clients;
            const tbody = document.getElementById('clientsTable');

            // Update stats
            document.getElementById('clientsTotal').textContent = clients.length;
            document.getElementById('clientsWithCourses').textContent = clients.filter(c => c.courses_count > 0).length;
            document.getElementById('clientsWithBookings').textContent = clients.filter(c => c.bookings_count > 0).length;
            document.getElementById('clientsWithOrders').textContent = clients.filter(c => c.total_orders > 0).length;

            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-users"></i><h3>Нет клиентов</h3></div></td></tr>';
                return;
            }

            tbody.innerHTML = data.map(c => {
                const tags = JSON.parse(c.tags || '[]');
                return `
                <tr onclick="openClientCard('${c.id}')" style="cursor:pointer;">
                    <td><strong>${escapeHtml(c.first_name || '')} ${escapeHtml(c.last_name || '')}</strong></td>
                    <td>
                        ${c.email ? `<div style="font-size:12px;">${escapeHtml(c.email)}</div>` : ''}
                        ${c.phone ? `<div style="color: var(--text-muted);font-size:12px;">${escapeHtml(c.phone)}</div>` : ''}
                    </td>
                    <td>${tags.length ? tags.slice(0, 2).map(t => `<span class="badge" style="margin-right:4px;">${escapeHtml(t)}</span>`).join('') : '-'}</td>
                    <td>${c.courses_count || 0} <span style="color:var(--text-muted);font-size:11px;">курс.</span></td>
                    <td>${c.bookings_count || 0} <span style="color:var(--text-muted);font-size:11px;">зап.</span></td>
                    <td>${c.total_orders || 0}</td>
                    <td>${formatMoney(c.total_spent || 0)}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn btn-sm btn-outline" onclick="editClient('${c.id}')"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        let clientsCache = [];
        async function filterClients() {
            const search = document.getElementById('searchClients')?.value.toLowerCase() || '';
            const tagFilter = document.getElementById('filterClientTag')?.value || '';
            const courseFilter = document.getElementById('filterClientCourse')?.value || '';
            const bookingFilter = document.getElementById('filterClientBooking')?.value || '';
            const orderFilter = document.getElementById('filterClientOrder')?.value || '';

            // Get extended client data if needed
            if (!clientsCache.length || clientsCache.length !== clients.length) {
                try {
                    const res = await api('GET', `/clients/${projectId}?extended=1`);
                    if (res.success) {
                        clientsCache = res.clients;
                        clients = res.clients;
                    }
                } catch (e) { clientsCache = clients; }
            }

            let filtered = clientsCache;

            // Search filter
            if (search) {
                filtered = filtered.filter(c =>
                    (c.first_name || '').toLowerCase().includes(search) ||
                    (c.last_name || '').toLowerCase().includes(search) ||
                    (c.email || '').toLowerCase().includes(search) ||
                    (c.phone || '').includes(search) ||
                    (c.company || '').toLowerCase().includes(search)
                );
            }

            // Tag filter
            if (tagFilter) {
                filtered = filtered.filter(c => {
                    const tags = JSON.parse(c.tags || '[]');
                    return tags.includes(tagFilter);
                });
            }

            // Course filter
            if (courseFilter) {
                if (courseFilter === 'has_course') filtered = filtered.filter(c => c.courses_count > 0);
                else if (courseFilter === 'no_course') filtered = filtered.filter(c => !c.courses_count);
                else if (courseFilter === 'completed_course') filtered = filtered.filter(c => c.completed_courses > 0);
                else if (courseFilter === 'in_progress') filtered = filtered.filter(c => c.courses_count > 0 && c.completed_courses < c.courses_count);
            }

            // Booking filter
            if (bookingFilter) {
                if (bookingFilter === 'has_booking') filtered = filtered.filter(c => c.bookings_count > 0);
                else if (bookingFilter === 'no_booking') filtered = filtered.filter(c => !c.bookings_count);
                else if (bookingFilter === 'upcoming') filtered = filtered.filter(c => c.upcoming_bookings > 0);
                else if (bookingFilter === 'visited') filtered = filtered.filter(c => c.visits_count > 0);
            }

            // Order filter
            if (orderFilter) {
                if (orderFilter === 'has_order') filtered = filtered.filter(c => c.total_orders > 0);
                else if (orderFilter === 'no_order') filtered = filtered.filter(c => !c.total_orders);
                else if (orderFilter === 'repeat') filtered = filtered.filter(c => c.total_orders > 1);
            }

            renderClients(filtered);
        }

        async function openClientCard(clientId) {
            // Load full client details with cross-references
            try {
                const res = await api('GET', `/clients/${projectId}/${clientId}?full=1`);
                if (res.success && res.client) {
                    showClientCardModal(res.client);
                }
            } catch (e) {
                console.error('Failed to load client details', e);
            }
        }

        function showClientCardModal(client) {
            const tags = JSON.parse(client.tags || '[]');
            const modal = document.createElement('div');
            modal.className = 'modal-overlay open';
            modal.id = 'clientCardModal';
            modal.innerHTML = `
                <div class="modal" style="max-width:800px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-user" style="margin-right:8px;"></i>${escapeHtml(client.first_name || '')} ${escapeHtml(client.last_name || '')}</h3>
                        <button class="modal-close" onclick="document.getElementById('clientCardModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <div style="color:var(--text-muted);font-size:12px;">Email</div>
                                <div>${escapeHtml(client.email || '-')}</div>
                            </div>
                            <div>
                                <div style="color:var(--text-muted);font-size:12px;">Телефон</div>
                                <div>${escapeHtml(client.phone || '-')}</div>
                            </div>
                            <div>
                                <div style="color:var(--text-muted);font-size:12px;">Компания</div>
                                <div>${escapeHtml(client.company || '-')}</div>
                            </div>
                            <div>
                                <div style="color:var(--text-muted);font-size:12px;">Источник</div>
                                <div>${escapeHtml(client.source || '-')}</div>
                            </div>
                        </div>

                        <div style="margin-bottom:16px;">
                            <div style="color:var(--text-muted);font-size:12px;margin-bottom:4px;">Теги</div>
                            <div>${tags.length ? tags.map(t => `<span class="badge" style="margin-right:4px;">${escapeHtml(t)}</span>`).join('') : '-'}</div>
                        </div>

                        <div class="tabs" style="margin-bottom:0;">
                            <div class="tab active" onclick="showClientTab('orders', this)">Заказы (${client.orders?.length || 0})</div>
                            <div class="tab" onclick="showClientTab('deals', this)">Сделки (${client.deals?.length || 0})</div>
                            <div class="tab" onclick="showClientTab('courses', this)">Курсы (${client.courses?.length || 0})</div>
                            <div class="tab" onclick="showClientTab('bookings', this)">Записи (${client.bookings?.length || 0})</div>
                        </div>

                        <div id="clientTabOrders" class="tab-content active" style="padding:16px 0;">
                            ${(client.orders || []).length ? client.orders.map(o => `
                                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
                                    <span><strong>${escapeHtml(o.order_number)}</strong></span>
                                    <span>${formatMoney(o.total)}</span>
                                    <span class="badge">${o.status}</span>
                                    <span style="color:var(--text-muted);">${new Date(o.created_at).toLocaleDateString('ru')}</span>
                                </div>
                            `).join('') : '<div style="color:var(--text-muted);text-align:center;padding:20px;">Нет заказов</div>'}
                        </div>

                        <div id="clientTabDeals" class="tab-content" style="padding:16px 0;display:none;">
                            ${(client.deals || []).length ? client.deals.map(d => `
                                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
                                    <span><strong>${escapeHtml(d.name)}</strong></span>
                                    <span>${formatMoney(d.amount)}</span>
                                    <span class="badge badge-new">${escapeHtml(d.stage_name || '-')}</span>
                                </div>
                            `).join('') : '<div style="color:var(--text-muted);text-align:center;padding:20px;">Нет сделок</div>'}
                        </div>

                        <div id="clientTabCourses" class="tab-content" style="padding:16px 0;display:none;">
                            ${(client.courses || []).length ? client.courses.map(c => `
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border-color);">
                                    <span><strong>${escapeHtml(c.name)}</strong></span>
                                    <div style="width:100px;">
                                        <div style="background:#334155;border-radius:4px;height:6px;">
                                            <div style="width:${c.progress || 0}%;height:100%;background:var(--primary);border-radius:4px;"></div>
                                        </div>
                                    </div>
                                    <span>${c.progress || 0}%</span>
                                </div>
                            `).join('') : '<div style="color:var(--text-muted);text-align:center;padding:20px;">Нет курсов</div>'}
                        </div>

                        <div id="clientTabBookings" class="tab-content" style="padding:16px 0;display:none;">
                            ${(client.bookings || []).length ? client.bookings.map(b => `
                                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
                                    <span><strong>${b.booking_date} ${b.start_time}</strong></span>
                                    <span>${escapeHtml(b.service_name || '-')}</span>
                                    <span class="badge">${b.status}</span>
                                </div>
                            `).join('') : '<div style="color:var(--text-muted);text-align:center;padding:20px;">Нет записей</div>'}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="document.getElementById('clientCardModal').remove()">Закрыть</button>
                        <button class="btn btn-primary" onclick="editClient('${client.id}');document.getElementById('clientCardModal').remove();">Редактировать</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showClientTab(tab, el) {
            document.querySelectorAll('#clientCardModal .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#clientCardModal .tab-content').forEach(c => c.style.display = 'none');
            el.classList.add('active');
            document.getElementById('clientTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.display = 'block';
        }

        async function saveClient() {
            const first_name = document.getElementById('clientFirstName').value;
            const last_name = document.getElementById('clientLastName').value;
            const email = document.getElementById('clientEmail').value;
            const phone = document.getElementById('clientPhone').value;
            const company = document.getElementById('clientCompany').value;

            if (!first_name) return alert('Введите имя клиента');

            const res = await api('POST', `/clients/${projectId}`, { first_name, last_name, email, phone, company });
            if (res.success) {
                closeModal('clientModal');
                ['clientFirstName', 'clientLastName', 'clientEmail', 'clientPhone', 'clientCompany'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadClients();
            } else {
                alert(res.error || 'Ошибка добавления клиента');
            }
        }

        function updateClientSelects() {
            const options = '<option value="">Выберите клиента</option>' + clients.map(c => `<option value="${c.id}">${escapeHtml(c.first_name || '')} ${escapeHtml(c.last_name || '')} ${c.company ? '(' + escapeHtml(c.company) + ')' : ''}</option>`).join('');
            document.getElementById('dealClient').innerHTML = options;
        }

        // Employees
        async function loadEmployees() {
            const res = await api('GET', `/employees/${projectId}`);
            if (res.success) {
                employees = res.employees;
                renderEmployees();
                updateEmployeeSelects();
            }
        }

        function renderEmployees() {
            const tbody = document.getElementById('employeesTable');
            if (!employees.length) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-user-tie"></i><h3>Нет сотрудников</h3></div></td></tr>';
                return;
            }

            const roles = { admin: 'Админ', manager: 'Менеджер', support: 'Поддержка' };
            tbody.innerHTML = employees.map(e => `
                <tr>
                    <td><strong>${escapeHtml(e.first_name)} ${escapeHtml(e.last_name)}</strong></td>
                    <td>${escapeHtml(e.position || '-')}</td>
                    <td>${escapeHtml(e.email)}</td>
                    <td><span class="badge badge-new">${roles[e.role] || e.role}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="editEmployee('${e.id}')"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveEmployee() {
            const first_name = document.getElementById('employeeFirstName').value;
            const last_name = document.getElementById('employeeLastName').value;
            const email = document.getElementById('employeeEmail').value;
            const position = document.getElementById('employeePosition').value;
            const role = document.getElementById('employeeRole').value;

            if (!first_name || !last_name || !email) return alert('Заполните обязательные поля');

            const res = await api('POST', `/employees/${projectId}`, { first_name, last_name, email, position, role });
            if (res.success) {
                closeModal('employeeModal');
                ['employeeFirstName', 'employeeLastName', 'employeeEmail', 'employeePosition'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadEmployees();
            } else {
                alert(res.error || 'Ошибка добавления сотрудника');
            }
        }

        function updateEmployeeSelects() {
            const options = '<option value="">Выберите сотрудника</option>' + employees.map(e => `<option value="${e.id}">${escapeHtml(e.first_name)} ${escapeHtml(e.last_name)}</option>`).join('');
            document.getElementById('dealAssignee').innerHTML = options;
            document.getElementById('taskAssignee').innerHTML = options;
        }

        // Tasks
        async function loadTasks() {
            const status = document.getElementById('filterTaskStatus').value;
            const params = status ? `?status=${status}` : '';
            const res = await api('GET', `/employees/${projectId}/tasks/list${params}`);
            if (res.success) {
                tasks = res.tasks;
                renderTasks();
            }
        }

        function renderTasks() {
            const tbody = document.getElementById('tasksTable');
            if (!tasks.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-tasks"></i><h3>Нет задач</h3></div></td></tr>';
                return;
            }

            const priorities = { low: ['Низкий', 'badge'], normal: ['Обычный', 'badge badge-new'], high: ['Высокий', 'badge badge-warning'], urgent: ['Срочный', 'badge badge-danger'] };
            const statuses = { pending: ['Ожидает', 'badge'], in_progress: ['В работе', 'badge badge-warning'], completed: ['Готово', 'badge badge-success'] };

            tbody.innerHTML = tasks.map(t => `
                <tr>
                    <td><strong>${escapeHtml(t.title)}</strong></td>
                    <td>${t.assignee_first_name ? escapeHtml(t.assignee_first_name + ' ' + (t.assignee_last_name || '')) : '-'}</td>
                    <td><span class="${priorities[t.priority]?.[1] || 'badge'}">${priorities[t.priority]?.[0] || t.priority}</span></td>
                    <td>${t.due_date ? new Date(t.due_date).toLocaleDateString('ru') : '-'}</td>
                    <td><span class="${statuses[t.status]?.[1] || 'badge'}">${statuses[t.status]?.[0] || t.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="toggleTaskStatus('${t.id}', '${t.status}')">
                            <i class="fas fa-${t.status === 'completed' ? 'undo' : 'check'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const assignee_id = document.getElementById('taskAssignee').value;
            const priority = document.getElementById('taskPriority').value;
            const due_date = document.getElementById('taskDueDate').value;

            if (!title) return alert('Введите название задачи');

            const res = await api('POST', `/employees/${projectId}/tasks`, {
                title, description, assignee_id: assignee_id || null, priority, due_date: due_date || null
            });

            if (res.success) {
                closeModal('taskModal');
                ['taskTitle', 'taskDescription', 'taskAssignee', 'taskDueDate'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadTasks();
            } else {
                alert(res.error || 'Ошибка создания задачи');
            }
        }

        async function toggleTaskStatus(id, current) {
            const newStatus = current === 'completed' ? 'pending' : 'completed';
            await api('PUT', `/employees/${projectId}/tasks/${id}`, { status: newStatus });
            loadTasks();
        }

        // Orders
        async function loadOrders() {
            const status = document.getElementById('filterOrderStatus')?.value;
            const params = status ? `?status=${status}` : '';
            const res = await api('GET', `/orders/${projectId}${params}`);
            if (res.success) {
                orders = res.orders;
                renderOrders();
            }
        }

        function renderOrders() {
            const tbody = document.getElementById('ordersTable');
            if (!orders.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>Нет заказов</h3></div></td></tr>';
                return;
            }

            const statuses = { new: ['Новый', 'badge badge-new'], processing: ['В обработке', 'badge badge-warning'], shipped: ['Отправлен', 'badge badge-new'], completed: ['Завершён', 'badge badge-success'], cancelled: ['Отменён', 'badge badge-danger'] };
            const paymentStatuses = { pending: ['Ожидает', 'badge badge-warning'], paid: ['Оплачен', 'badge badge-success'], refunded: ['Возврат', 'badge badge-danger'] };

            tbody.innerHTML = orders.map(o => `
                <tr>
                    <td><strong>${escapeHtml(o.order_number)}</strong></td>
                    <td>${escapeHtml(o.customer_name || o.customer_email || '-')}</td>
                    <td>${formatMoney(o.total)}</td>
                    <td><span class="${statuses[o.status]?.[1] || 'badge'}">${statuses[o.status]?.[0] || o.status}</span></td>
                    <td><span class="${paymentStatuses[o.payment_status]?.[1] || 'badge'}">${paymentStatuses[o.payment_status]?.[0] || o.payment_status}</span></td>
                    <td>${new Date(o.created_at).toLocaleDateString('ru')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewOrder('${o.id}')"><i class="fas fa-eye"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // Products
        async function loadProducts() {
            const res = await api('GET', `/products/${projectId}`);
            if (res.success) {
                products = res.products || [];
            }
            renderProducts();
        }

        function renderProducts() {
            const tbody = document.getElementById('productsTable');
            if (!products.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-box"></i><h3>Нет товаров</h3><p>Добавьте первый товар</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: var(--bg-input); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-box" style="color: var(--text-muted);"></i>
                            </div>
                            <strong>${escapeHtml(p.name)}</strong>
                        </div>
                    </td>
                    <td>${escapeHtml(p.sku || '-')}</td>
                    <td>${formatMoney(p.price)}</td>
                    <td>${p.stock || 0}</td>
                    <td><span class="badge ${p.is_active ? 'badge-success' : 'badge-danger'}">${p.is_active ? 'Активен' : 'Скрыт'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="editProduct('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // AI Backend URL
        const AI_API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000'
            : 'https://ai-tools-backend-d3zr.onrender.com';

        let editingProductId = null;

        async function saveProduct() {
            const name = document.getElementById('productName').value;
            const sku = document.getElementById('productSku').value;
            const price = document.getElementById('productPrice').value;
            const old_price = document.getElementById('productOldPrice').value;
            const stock = document.getElementById('productStock').value;
            const description = document.getElementById('productDescription').value;
            const category_id = document.getElementById('productCategory').value;
            const meta_title = document.getElementById('productMetaTitle').value;
            const meta_description = document.getElementById('productMetaDesc').value;
            const url_slug = document.getElementById('productSlug').value;
            const weight = document.getElementById('productWeight').value;
            const length = document.getElementById('productLength').value;
            const width = document.getElementById('productWidth').value;
            const height = document.getElementById('productHeight').value;

            if (!name || !price) return alert('Заполните название и цену');

            const productData = {
                name, sku, price: parseFloat(price), old_price: parseFloat(old_price) || null,
                stock: parseInt(stock) || 0, description, is_active: true,
                category_id: category_id || null,
                meta_title, meta_description, url_slug,
                weight: parseFloat(weight) || null,
                length: parseFloat(length) || null,
                width: parseFloat(width) || null,
                height: parseFloat(height) || null
            };

            const method = editingProductId ? 'PUT' : 'POST';
            const url = editingProductId
                ? `/products/${projectId}/${editingProductId}`
                : `/products/${projectId}`;

            const res = await api(method, url, productData);

            if (res.success) {
                closeModal('productModal');
                clearProductForm();
                loadProducts();
            } else {
                alert(res.error || 'Ошибка сохранения товара');
            }
        }

        function clearProductForm() {
            editingProductId = null;
            document.getElementById('productModalTitle').textContent = 'Новый товар';
            document.getElementById('productSaveBtn').textContent = 'Сохранить';
            ['productName', 'productSku', 'productPrice', 'productOldPrice', 'productStock',
             'productDescription', 'productMetaTitle', 'productMetaDesc', 'productSlug',
             'productWeight', 'productLength', 'productWidth', 'productHeight'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('productCategory').value = '';
            updateMetaCounters();
        }

        async function editProduct(id) {
            const res = await api('GET', `/products/${projectId}/${id}`);
            if (!res.success) return alert('Ошибка загрузки товара');

            const p = res.product;
            editingProductId = id;

            document.getElementById('productModalTitle').textContent = 'Редактировать товар';
            document.getElementById('productSaveBtn').textContent = 'Сохранить';
            document.getElementById('productName').value = p.name || '';
            document.getElementById('productSku').value = p.sku || '';
            document.getElementById('productPrice').value = p.price || '';
            document.getElementById('productOldPrice').value = p.old_price || '';
            document.getElementById('productStock').value = p.stock || 0;
            document.getElementById('productDescription').value = p.description || '';
            document.getElementById('productCategory').value = p.category_id || '';
            document.getElementById('productMetaTitle').value = p.meta_title || '';
            document.getElementById('productMetaDesc').value = p.meta_description || '';
            document.getElementById('productSlug').value = p.url_slug || '';
            document.getElementById('productWeight').value = p.weight || '';
            document.getElementById('productLength').value = p.length || '';
            document.getElementById('productWidth').value = p.width || '';
            document.getElementById('productHeight').value = p.height || '';

            updateMetaCounters();
            openModal('productModal');
        }

        function updateMetaCounters() {
            const titleEl = document.getElementById('productMetaTitle');
            const descEl = document.getElementById('productMetaDesc');
            document.getElementById('metaTitleCount').textContent = titleEl?.value?.length || 0;
            document.getElementById('metaDescCount').textContent = descEl?.value?.length || 0;
        }

        // Setup meta counter listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('productMetaTitle')?.addEventListener('input', updateMetaCounters);
            document.getElementById('productMetaDesc')?.addEventListener('input', updateMetaCounters);
        });

        // ===== AI Generation Functions =====

        async function generateProductDescription() {
            const name = document.getElementById('productName').value;
            if (!name) return alert('Сначала введите название товара');

            const btn = event.target.closest('button');
            const loader = document.getElementById('productDescLoading');

            btn.disabled = true;
            loader.style.display = 'block';

            try {
                const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';
                const price = document.getElementById('productPrice').value;

                const response = await fetch(`${AI_API}/api/ai/product-description`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        category: category !== '— Без категории —' ? category : null,
                        price: parseFloat(price) || null,
                        tone: 'professional'
                    })
                });

                const data = await response.json();

                if (data.success && data.description) {
                    document.getElementById('productDescription').value = data.description;
                } else {
                    alert(data.detail || 'Ошибка генерации описания');
                }
            } catch (error) {
                console.error('AI Description error:', error);
                alert('Ошибка подключения к AI сервису');
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }

        async function generateProductMeta() {
            const name = document.getElementById('productName').value;
            if (!name) return alert('Сначала введите название товара');

            const btn = event.target.closest('button');
            const loader = document.getElementById('productMetaLoading');

            btn.disabled = true;
            loader.style.display = 'block';

            try {
                const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';
                const description = document.getElementById('productDescription').value;

                const response = await fetch(`${AI_API}/api/ai/product-meta`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        category: category !== '— Без категории —' ? category : null,
                        existing_description: description || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('productMetaTitle').value = data.meta_title || '';
                    document.getElementById('productMetaDesc').value = data.meta_description || '';

                    // Auto-generate slug from name if not present
                    if (!document.getElementById('productSlug').value) {
                        document.getElementById('productSlug').value = name
                            .toLowerCase()
                            .replace(/[^a-zа-яё0-9\s]/gi, '')
                            .replace(/\s+/g, '-')
                            .substring(0, 50);
                    }

                    updateMetaCounters();
                } else {
                    alert(data.detail || 'Ошибка генерации мета-тегов');
                }
            } catch (error) {
                console.error('AI Meta error:', error);
                alert('Ошибка подключения к AI сервису');
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }

        async function generateProductCard() {
            const name = document.getElementById('productName').value;
            if (!name) return alert('Сначала введите название товара');

            try {
                const response = await fetch(`${AI_API}/api/ai/product-card`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();

                if (data.status === 'placeholder') {
                    alert(`${data.message}\n\nПланируется:\n• ${data.features_planned.join('\n• ')}`);
                }
            } catch (error) {
                alert('Функция генерации карточки будет доступна в следующем обновлении');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Удалить товар?')) return;
            await api('DELETE', `/products/${projectId}/${id}`);
            loadProducts();
        }

        function searchProducts() {
            // Simple client-side filter
            const query = document.getElementById('searchProducts').value.toLowerCase();
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(query) ||
                (p.sku && p.sku.toLowerCase().includes(query))
            );
            // Re-render with filtered list
            const originalProducts = products;
            products = filtered;
            renderProducts();
            products = originalProducts;
        }

        // Dashboard
        async function renderDashboard() {
            // Basic stats
            document.getElementById('stat-deals').textContent = funnels.reduce((sum, f) => sum + (f.deals_count || 0), 0);
            document.getElementById('stat-clients').textContent = clients.length;
            document.getElementById('stat-orders').textContent = orders.length;
            document.getElementById('stat-products').textContent = products.length;

            const wonAmount = funnels.reduce((sum, f) => sum + (f.won_amount || 0), 0);
            document.getElementById('stat-won').textContent = formatMoney(wonAmount);

            // Load additional stats from various modules
            try {
                const statsRes = await api('GET', `/analytics/${projectId}/dashboard`);
                if (statsRes.success) {
                    document.getElementById('stat-tasks').textContent = statsRes.stats.tasks?.total || 0;
                    document.getElementById('stat-overdue').textContent = statsRes.stats.overdueTasks?.total || 0;
                }
            } catch (e) { console.log('Stats load failed', e); }

            // Load bookings count for today
            try {
                const today = new Date().toISOString().split('T')[0];
                const bookingsRes = await api('GET', `/bookings/${projectId}?date=${today}`);
                if (bookingsRes.success) {
                    document.getElementById('stat-bookings').textContent = bookingsRes.bookings?.length || 0;
                    renderTodayBookings(bookingsRes.bookings || []);
                }
            } catch (e) { console.log('Bookings load failed', e); }

            // Load calls count for today
            try {
                const callsRes = await api('GET', `/calls/${projectId}?today=1`);
                if (callsRes.success) {
                    document.getElementById('stat-calls').textContent = callsRes.calls?.length || 0;
                }
            } catch (e) { document.getElementById('stat-calls').textContent = '0'; }

            // Load webinars count
            try {
                const webinarsRes = await api('GET', `/learning/${projectId}/webinars?status=scheduled`);
                if (webinarsRes.success) {
                    document.getElementById('stat-webinars').textContent = webinarsRes.webinars?.length || 0;
                }
            } catch (e) { document.getElementById('stat-webinars').textContent = '0'; }

            // Load students count
            try {
                const accessRes = await api('GET', `/learning/${projectId}/access`);
                if (accessRes.success) {
                    document.getElementById('stat-students').textContent = accessRes.access?.length || 0;
                }
            } catch (e) { document.getElementById('stat-students').textContent = '0'; }

            // Load promo codes count
            try {
                const promosRes = await api('GET', `/ecommerce/${projectId}/promo-codes?active=1`);
                if (promosRes.success) {
                    document.getElementById('stat-promos').textContent = promosRes.promo_codes?.length || 0;
                }
            } catch (e) { document.getElementById('stat-promos').textContent = '0'; }

            // Recent deals
            const recentDeals = [];
            funnels.forEach(f => {
                (f.stages || []).forEach(s => {
                    (s.deals || []).forEach(d => recentDeals.push({ ...d, stage_name: s.name, funnel_name: f.name }));
                });
            });

            const tbody = document.getElementById('recentDeals');
            if (!recentDeals.length) {
                tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-handshake"></i><h3>Нет сделок</h3></div></td></tr>';
            } else {
                tbody.innerHTML = recentDeals.slice(0, 5).map(d => `
                    <tr onclick="openDealDetails('${d.id}')" style="cursor:pointer;">
                        <td><strong>${escapeHtml(d.name)}</strong></td>
                        <td>${d.client_first_name ? escapeHtml(d.client_first_name) : '-'}</td>
                        <td>${formatMoney(d.amount)}</td>
                        <td><span class="badge badge-new">${escapeHtml(d.stage_name || '-')}</span></td>
                    </tr>
                `).join('');
            }

            // Recent orders
            const ordersBody = document.getElementById('recentOrders');
            if (ordersBody) {
                const statuses = { new: ['Новый', 'badge badge-new'], processing: ['В работе', 'badge badge-warning'], shipped: ['Отправлен', 'badge badge-new'], completed: ['Готов', 'badge badge-success'] };
                if (!orders.length) {
                    ordersBody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>Нет заказов</h3></div></td></tr>';
                } else {
                    ordersBody.innerHTML = orders.slice(0, 5).map(o => `
                        <tr onclick="openOrderDetails('${o.id}')" style="cursor:pointer;">
                            <td><strong>${escapeHtml(o.order_number)}</strong></td>
                            <td>${formatMoney(o.total)}</td>
                            <td><span class="${statuses[o.status]?.[1] || 'badge'}">${statuses[o.status]?.[0] || o.status}</span></td>
                            <td>${new Date(o.created_at).toLocaleDateString('ru')}</td>
                        </tr>
                    `).join('');
                }
            }

            // Course activity
            loadCourseActivity();

            // Load AI insights
            loadAIInsights();
        }

        function renderTodayBookings(bookings) {
            const tbody = document.getElementById('todayBookings');
            if (!tbody) return;
            const statuses = { pending: ['Ожидает', 'badge-warning'], confirmed: ['Подтв.', 'badge-success'], completed: ['Завершено', 'badge-success'], cancelled: ['Отменено', 'badge-danger'] };
            if (!bookings.length) {
                tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-calendar-check"></i><h3>Нет записей</h3></div></td></tr>';
            } else {
                tbody.innerHTML = bookings.slice(0, 5).map(b => `
                    <tr onclick="switchSection('bookings')" style="cursor:pointer;">
                        <td><strong>${b.start_time}</strong></td>
                        <td>${escapeHtml(b.client_name || '-')}</td>
                        <td>${escapeHtml(b.service_name || '-')}</td>
                        <td><span class="badge ${statuses[b.status]?.[1] || ''}">${statuses[b.status]?.[0] || b.status}</span></td>
                    </tr>
                `).join('');
            }
        }

        async function loadCourseActivity() {
            const tbody = document.getElementById('courseActivity');
            if (!tbody) return;
            try {
                const res = await api('GET', `/courses/${projectId}`);
                if (!res.success || !res.courses?.length) {
                    tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-graduation-cap"></i><h3>Нет курсов</h3></div></td></tr>';
                    return;
                }
                tbody.innerHTML = res.courses.slice(0, 5).map(c => `
                    <tr onclick="switchSection('courses')" style="cursor:pointer;">
                        <td><strong>${escapeHtml(c.name)}</strong></td>
                        <td>${c.students_count || 0}</td>
                        <td>
                            <div style="background:#334155;border-radius:4px;height:6px;width:80px;display:inline-block;">
                                <div style="width:${c.avg_progress || 0}%;height:100%;background:var(--primary);border-radius:4px;"></div>
                            </div>
                            <span style="font-size:11px;margin-left:4px;">${c.avg_progress || 0}%</span>
                        </td>
                        <td>${c.completed_count || 0}</td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><p>Ошибка загрузки</p></div></td></tr>';
            }
        }

        function openDealDetails(dealId) {
            // TODO: Open deal detail modal
            console.log('Open deal:', dealId);
        }

        function openOrderDetails(orderId) {
            // TODO: Open order detail modal
            console.log('Open order:', orderId);
        }

        async function loadAIInsights() {
            const container = document.getElementById('aiInsights');
            if (!container) return;

            container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Анализ данных...</div>';

            try {
                const res = await api('GET', `/analytics/${projectId}/ai-insights`);
                if (res.success && res.insights.length > 0) {
                    const icons = { success: 'check-circle', warning: 'exclamation-triangle', danger: 'times-circle', info: 'info-circle' };
                    const colors = { success: 'var(--success)', warning: 'var(--warning)', danger: 'var(--danger)', info: 'var(--primary)' };

                    container.innerHTML = res.insights.map(i => `
                        <div style="background: var(--bg-dark); padding: 16px; border-radius: 8px; border-left: 3px solid ${colors[i.type]};">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <i class="fas fa-${icons[i.type]}" style="color: ${colors[i.type]};"></i>
                                <strong>${escapeHtml(i.title)}</strong>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">${escapeHtml(i.description)}</p>
                            ${i.action ? `<button class="btn btn-sm btn-outline" style="margin-top: 12px;" onclick="alert('${escapeHtml(i.action)}')">${escapeHtml(i.action)}</button>` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted);"><i class="fas fa-check-circle" style="color: var(--success);"></i> Все показатели в норме</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="grid-column: 1/-1; color: var(--text-muted);">Не удалось загрузить рекомендации</div>';
            }
        }

        // Helpers
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(amount || 0);
        }

        // Orders additional functions
        async function saveOrder() {
            const client_id = document.getElementById('orderClient').value;
            const total_amount = document.getElementById('orderAmount').value;
            const status = document.getElementById('orderStatus').value;
            const payment_status = document.getElementById('orderPaymentStatus').value;
            const shipping_address = document.getElementById('orderAddress').value;
            const notes = document.getElementById('orderNotes').value;

            if (!client_id || !total_amount) return alert('Заполните клиента и сумму');

            const res = await api('POST', `/orders/${projectId}`, {
                client_id, total_amount: parseFloat(total_amount), status, payment_status, shipping_address, notes
            });

            if (res.success) {
                closeModal('orderModal');
                ['orderAmount', 'orderAddress', 'orderNotes'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadOrders();
            } else {
                alert(res.error || 'Ошибка создания заказа');
            }
        }

        function viewOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            alert(`Заказ: ${order.order_number}\nСумма: ${formatMoney(order.total)}\nСтатус: ${order.status}\nОплата: ${order.payment_status}`);
        }

        function searchOrders() {
            const query = document.getElementById('searchOrders').value.toLowerCase();
            const filtered = orders.filter(o =>
                (o.order_number && o.order_number.toLowerCase().includes(query)) ||
                (o.customer_name && o.customer_name.toLowerCase().includes(query)) ||
                (o.customer_email && o.customer_email.toLowerCase().includes(query))
            );
            const originalOrders = orders;
            orders = filtered;
            renderOrders();
            orders = originalOrders;
        }

        // Segments
        let segments = [];

        async function loadSegments() {
            const res = await api('GET', `/segments/${projectId}`);
            if (res.success) {
                segments = res.segments;
                renderSegments();
            }
        }

        function renderSegments() {
            const container = document.getElementById('segmentsList');
            if (!segments.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-layer-group"></i><h3>Нет сегментов</h3><p>Создайте первый сегмент для группировки клиентов</p></div>';
                return;
            }

            container.innerHTML = segments.map(s => `
                <div class="stat-card" style="border-left: 4px solid ${s.color || '#6366f1'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <h4>${escapeHtml(s.name)}</h4>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteSegment('${s.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="value" style="font-size: 24px;">${s.members_count || 0}</div>
                    <div class="label">клиентов</div>
                    ${s.is_dynamic ? '<span class="badge badge-new" style="margin-top: 8px;">Динамический</span>' : ''}
                </div>
            `).join('');
        }

        async function saveSegment() {
            const name = document.getElementById('segmentName').value;
            const description = document.getElementById('segmentDescription').value;
            const color = document.getElementById('segmentColor').value;
            const is_dynamic = document.getElementById('segmentDynamic').checked;

            if (!name) return alert('Введите название сегмента');

            let rules = [];
            if (is_dynamic) {
                const field = document.getElementById('ruleField').value;
                const operator = document.getElementById('ruleOperator').value;
                const value = document.getElementById('ruleValue').value;
                if (value) rules.push({ field, operator, value: parseInt(value) });
            }

            const res = await api('POST', `/segments/${projectId}`, {
                name, description, color, is_dynamic, rules
            });

            if (res.success) {
                closeModal('segmentModal');
                ['segmentName', 'segmentDescription'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('segmentDynamic').checked = false;
                loadSegments();
            } else {
                alert(res.error || 'Ошибка создания сегмента');
            }
        }

        async function deleteSegment(id) {
            if (!confirm('Удалить сегмент?')) return;
            await api('DELETE', `/segments/${projectId}/${id}`);
            loadSegments();
        }

        // Services
        let services = [];

        async function loadServices() {
            const res = await api('GET', `/services/${projectId}`);
            if (res.success) {
                services = res.services;
                renderServices();
            }
        }

        function renderServices() {
            const container = document.getElementById('servicesList');
            if (!container) return;
            if (!services.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-concierge-bell"></i><h3>Нет услуг</h3><p>Добавьте первую услугу</p></div>';
                return;
            }

            container.innerHTML = services.map(s => `
                <div class="stat-card">
                    <h4 style="margin-bottom: 8px;">${escapeHtml(s.name)}</h4>
                    <div class="value primary">${formatMoney(s.price)}</div>
                    <div class="label">${s.duration ? s.duration + ' ч' : 'Не указано'}</div>
                    ${s.category ? '<span class="badge badge-new" style="margin-top: 8px;">' + escapeHtml(s.category) + '</span>' : ''}
                    <div style="margin-top: 12px;">
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteService('${s.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function toggleServiceGroup() {
            const type = document.getElementById('serviceType').value;
            document.getElementById('serviceGroupSettings').style.display = type === 'group' ? 'block' : 'none';
        }

        function togglePromoProducts() {
            const appliesTo = document.getElementById('promoAppliesTo').value;
            document.getElementById('promoProductsGroup').style.display =
                (appliesTo === 'categories' || appliesTo === 'products') ? 'block' : 'none';
        }

        function generatePromoCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('promoCode').value = code;
        }

        function generateBulkPromos() {
            const count = prompt('Сколько промокодов сгенерировать?', '10');
            if (count && parseInt(count) > 0) {
                alert(`Будет сгенерировано ${count} промокодов`);
                // TODO: Implement bulk generation
            }
        }

        async function saveService() {
            const name = document.getElementById('serviceName').value;
            const category = document.getElementById('serviceCategory').value;
            const price = document.getElementById('servicePrice').value;
            const duration = document.getElementById('serviceDuration').value;
            const description = document.getElementById('serviceDescription').value;
            const type = document.getElementById('serviceType')?.value || 'individual';
            const buffer_time = document.getElementById('serviceBuffer')?.value || 0;
            const max_clients = document.getElementById('serviceMaxClients')?.value || 1;
            const online_booking = document.getElementById('serviceOnlineBooking')?.checked ?? true;

            if (!name) return alert('Введите название услуги');

            const res = await api('POST', `/services/${projectId}`, {
                name, category,
                price: parseFloat(price) || 0,
                duration: parseInt(duration) || 60,
                description, type,
                buffer_time: parseInt(buffer_time) || 0,
                max_clients: type === 'group' ? parseInt(max_clients) : 1,
                online_booking
            });

            if (res.success) {
                closeModal('serviceModal');
                ['serviceName', 'serviceCategory', 'servicePrice', 'serviceDuration', 'serviceDescription'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                loadServices();
            } else {
                alert(res.error || 'Ошибка добавления услуги');
            }
        }

        async function deleteService(id) {
            if (!confirm('Удалить услугу?')) return;
            await api('DELETE', `/services/${projectId}/${id}`);
            loadServices();
        }

        // Courses
        let courses = [];

        async function loadCourses() {
            const res = await api('GET', `/courses/${projectId}`);
            if (res.success) {
                courses = res.courses;
                renderCourses();
            }
        }

        function renderCourses() {
            const container = document.getElementById('coursesList');
            if (!container) return;
            if (!courses.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-graduation-cap"></i><h3>Нет курсов</h3><p>Создайте первый курс</p></div>';
                return;
            }

            const levels = { beginner: 'Начинающий', intermediate: 'Средний', advanced: 'Продвинутый' };

            container.innerHTML = courses.map(c => `
                <div class="stat-card">
                    <h4 style="margin-bottom: 8px;">${escapeHtml(c.name)}</h4>
                    <div class="value success">${formatMoney(c.price)}</div>
                    <div class="label">${c.duration ? c.duration + ' ч' : 'Не указано'}</div>
                    <span class="badge badge-new" style="margin-top: 8px;">${levels[c.level] || c.level}</span>
                    <div style="margin-top: 12px;">
                        <button class="btn btn-sm btn-outline" onclick="editCourse('${c.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteCourse('${c.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function saveCourse() {
            const name = document.getElementById('courseName').value;
            const price = document.getElementById('coursePrice').value;
            const level = document.getElementById('courseLevel').value;
            const duration = document.getElementById('courseDuration').value;
            const description = document.getElementById('courseDescription').value;

            if (!name) return alert('Введите название курса');

            const res = await api('POST', `/courses/${projectId}`, {
                name, price: parseFloat(price) || 0, level, duration: parseInt(duration) || null, description
            });

            if (res.success) {
                closeModal('courseModal');
                ['courseName', 'coursePrice', 'courseDuration', 'courseDescription'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadCourses();
            } else {
                alert(res.error || 'Ошибка создания курса');
            }
        }

        function editCourse(id) {
            alert('Редактирование курса: ' + id);
        }

        async function deleteCourse(id) {
            if (!confirm('Удалить курс?')) return;
            await api('DELETE', `/courses/${projectId}/${id}`);
            loadCourses();
        }

        // Payments
        let payments = [];

        async function loadPayments() {
            const status = document.getElementById('filterPaymentStatus')?.value;
            const params = status ? `?status=${status}` : '';
            const res = await api('GET', `/payments/${projectId}${params}`);
            if (res.success) {
                payments = res.payments;
                renderPayments();
            }
        }

        function renderPayments() {
            const tbody = document.getElementById('paymentsTable');
            if (!tbody) return;
            if (!payments.length) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-credit-card"></i><h3>Нет платежей</h3></div></td></tr>';
                return;
            }

            const statuses = { pending: ['Ожидает', 'badge badge-warning'], completed: ['Успешно', 'badge badge-success'], failed: ['Ошибка', 'badge badge-danger'], refunded: ['Возврат', 'badge badge-danger'] };

            tbody.innerHTML = payments.map(p => `
                <tr>
                    <td><strong>${p.id.slice(0, 8)}</strong></td>
                    <td>${p.order_number || '-'}</td>
                    <td>${formatMoney(p.amount)}</td>
                    <td><span class="${statuses[p.status]?.[1] || 'badge'}">${statuses[p.status]?.[0] || p.status}</span></td>
                    <td>${new Date(p.created_at).toLocaleDateString('ru')}</td>
                </tr>
            `).join('');
        }

        // Segment modal toggle
        document.getElementById('segmentDynamic')?.addEventListener('change', function() {
            document.getElementById('segmentRulesContainer').style.display = this.checked ? 'block' : 'none';
        });

        // Update select options for order modal
        function updateOrderClientSelect() {
            document.getElementById('orderClient').innerHTML = '<option value="">Выберите клиента</option>' +
                clients.map(c => `<option value="${c.id}">${escapeHtml(c.first_name)} ${escapeHtml(c.last_name || '')}</option>`).join('');
        }

        // ============================================================
        // amoCRM-like Features
        // ============================================================

        // Calls
        async function loadCalls() {
            const res = await api('GET', `/calls/${projectId}`);
            if (res.success) {
                renderCalls(res.calls || []);
                // Update stats
                const total = res.calls?.length || 0;
                const answered = res.calls?.filter(c => c.status === 'completed').length || 0;
                const missed = res.calls?.filter(c => c.status === 'missed').length || 0;
                const avgDuration = total > 0 ? Math.round(res.calls.reduce((sum, c) => sum + (c.duration || 0), 0) / total) : 0;
                document.getElementById('callsTotal').textContent = total;
                document.getElementById('callsAnswered').textContent = answered;
                document.getElementById('callsMissed').textContent = missed;
                document.getElementById('callsDuration').textContent = formatDuration(avgDuration);
            }
        }

        function renderCalls(calls) {
            const tbody = document.getElementById('callsTable');
            if (!calls.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-phone"></i><h3>Нет звонков</h3></div></td></tr>';
                return;
            }
            const statuses = { completed: ['Завершён', 'badge-success'], missed: ['Пропущен', 'badge-danger'], initiated: ['Инициирован', 'badge-warning'] };
            tbody.innerHTML = calls.map(c => `
                <tr>
                    <td>${new Date(c.created_at).toLocaleString('ru')}</td>
                    <td><span class="badge ${c.direction === 'incoming' ? 'badge-new' : ''}">${c.direction === 'incoming' ? '↓ Входящий' : '↑ Исходящий'}</span></td>
                    <td>${c.client_first_name || c.phone_to || '-'}</td>
                    <td>${c.employee_first_name || '-'}</td>
                    <td>${formatDuration(c.duration || 0)}</td>
                    <td><span class="badge ${statuses[c.status]?.[1] || ''}">${statuses[c.status]?.[0] || c.status}</span></td>
                    <td>${c.recording_url ? `<button class="btn btn-sm btn-outline" onclick="window.open('${c.recording_url}')"><i class="fas fa-play"></i></button>` : ''}</td>
                </tr>
            `).join('');
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Regulations (SLA)
        async function loadRegulations() {
            const res = await api('GET', `/regulations/${projectId}`);
            if (res.success) {
                renderRegulations(res.regulations || []);
            }
        }

        function renderRegulations(regulations) {
            const tbody = document.getElementById('regulationsTable');
            if (!regulations.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-clock"></i><h3>Нет регламентов</h3><p>Создайте правила SLA для автоматизации</p></div></td></tr>';
                return;
            }
            const conditions = { time_in_stage: 'Время на этапе', no_activity: 'Нет активности', no_tasks: 'Нет задач' };
            const actions = { notify: 'Уведомление', create_task: 'Создать задачу', move_stage: 'Переместить', add_tag: 'Добавить тег' };
            tbody.innerHTML = regulations.map(r => `
                <tr>
                    <td><strong>${escapeHtml(r.name)}</strong></td>
                    <td>${conditions[r.condition_type] || r.condition_type} &gt; ${r.condition_value} ${r.condition_unit}</td>
                    <td>${actions[r.action_type] || r.action_type}</td>
                    <td>${r.funnel_name || 'Все'}</td>
                    <td><span class="badge ${r.is_active ? 'badge-success' : ''}">${r.is_active ? 'Активен' : 'Выключен'}</span></td>
                    <td><button class="btn btn-sm btn-outline" onclick="deleteRegulation('${r.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deleteRegulation(id) {
            if (!confirm('Удалить регламент?')) return;
            await api('DELETE', `/regulations/${projectId}/${id}`);
            loadRegulations();
        }

        // Goals (KPI)
        async function loadGoals() {
            const period = document.getElementById('goalsPeriod')?.value || 'month';
            const res = await api('GET', `/goals/${projectId}?period_type=${period}`);
            if (res.success) {
                renderGoals(res.goals || []);
            }
            // Load leaderboard
            const leaderRes = await api('GET', `/goals/${projectId}/leaderboard?metric=revenue`);
            if (leaderRes.success) {
                renderLeaderboard(leaderRes.leaderboard || []);
            }
        }

        function renderGoals(goals) {
            const el = document.getElementById('goalsList');
            if (!goals.length) {
                el.innerHTML = '<div class="stat-card"><div class="empty-state" style="padding:20px;"><i class="fas fa-bullseye"></i><p>Нет целей на этот период</p></div></div>';
                return;
            }
            el.innerHTML = goals.map(g => {
                const percent = g.target_value > 0 ? Math.round((g.current_value / g.target_value) * 100) : 0;
                return `
                    <div class="stat-card">
                        <div class="value">${percent}%</div>
                        <div class="label">${escapeHtml(g.employee_first_name || 'Общая цель')}</div>
                        <div style="margin-top:10px; background:#334155; border-radius:4px; height:8px; overflow:hidden;">
                            <div style="width:${Math.min(percent, 100)}%; height:100%; background:${percent >= 100 ? 'var(--success)' : 'var(--primary)'}"></div>
                        </div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">${formatMoney(g.current_value)} / ${formatMoney(g.target_value)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderLeaderboard(leaders) {
            const tbody = document.getElementById('leaderboardTable');
            if (!leaders.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state" style="padding:20px;"><p>Нет данных</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = leaders.map((l, i) => `
                <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td>${escapeHtml(l.first_name)} ${escapeHtml(l.last_name || '')}</td>
                    <td>${formatMoney(l.revenue || 0)}</td>
                    <td>${l.deals_won || 0}</td>
                    <td>${l.conversion || 0}%</td>
                    <td>
                        <div style="background:#334155; border-radius:4px; height:8px; width:100px;">
                            <div style="width:${l.progress || 0}%; height:100%; background:var(--primary);"></div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Lead Distribution
        async function loadLeadDistribution() {
            const res = await api('GET', `/lead-distribution/${projectId}/queue`);
            if (res.success) {
                renderLeadQueue(res.queue || []);
                document.getElementById('leadsInQueue').textContent = res.queue?.filter(q => q.status === 'pending').length || 0;
                document.getElementById('leadsAssigned').textContent = res.queue?.filter(q => q.status === 'assigned').length || 0;
                document.getElementById('leadsExpired').textContent = res.queue?.filter(q => q.status === 'expired').length || 0;
            }
        }

        function renderLeadQueue(queue) {
            const tbody = document.getElementById('leadQueueTable');
            if (!queue.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-random"></i><h3>Очередь пуста</h3></div></td></tr>';
                return;
            }
            const statuses = { pending: ['В очереди', 'badge-warning'], assigned: ['Назначен', 'badge-success'], expired: ['Просрочен', 'badge-danger'] };
            tbody.innerHTML = queue.map(q => `
                <tr>
                    <td>${escapeHtml(q.deal_name || q.deal_id)}</td>
                    <td>${q.source || '-'}</td>
                    <td>${q.assigned_to_name || '-'}</td>
                    <td>${q.expires_at ? new Date(q.expires_at).toLocaleString('ru') : '-'}</td>
                    <td><span class="badge ${statuses[q.status]?.[1] || ''}">${statuses[q.status]?.[0] || q.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="assignLead('${q.id}')"><i class="fas fa-user-plus"></i></button></td>
                </tr>
            `).join('');
        }

        async function assignLead(queueId) {
            const res = await api('POST', `/lead-distribution/${projectId}/assign`);
            if (res.success) {
                loadLeadDistribution();
            }
        }

        // Tags
        async function loadTags() {
            const entityType = document.getElementById('tagsEntity')?.value || 'deal';
            const res = await api('GET', `/tags/${projectId}?entity_type=${entityType}`);
            if (res.success) {
                renderTags(res.tags || []);
            }
        }

        function renderTags(tags) {
            const el = document.getElementById('tagsList');
            if (!tags.length) {
                el.innerHTML = '<div class="stat-card"><div class="empty-state" style="padding:20px;"><i class="fas fa-tags"></i><p>Нет тегов</p></div></div>';
                return;
            }
            el.innerHTML = tags.map(t => `
                <div class="stat-card" style="cursor:pointer; border-left: 4px solid ${t.color || '#94a3b8'};">
                    <div class="value" style="font-size:18px;">${escapeHtml(t.name)}</div>
                    <div class="label">${t.usage_count || 0} использований</div>
                    <button class="btn btn-sm btn-outline" style="margin-top:10px;" onclick="deleteTag('${t.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function deleteTag(id) {
            if (!confirm('Удалить тег?')) return;
            await api('DELETE', `/tags/${projectId}/${id}`);
            loadTags();
        }

        // Employee Analytics
        async function loadEmployeeAnalytics() {
            const period = document.getElementById('analyticsPeriod')?.value || 'month';
            const res = await api('GET', `/employee-analytics/${projectId}/dashboard?period=${period}`);
            if (res.success && res.stats) {
                document.getElementById('analyticsDeals').textContent = res.stats.deals_closed || 0;
                document.getElementById('analyticsRevenue').textContent = formatMoney(res.stats.revenue || 0);
                document.getElementById('analyticsCalls').textContent = res.stats.calls || 0;
                document.getElementById('analyticsConversion').textContent = (res.stats.conversion || 0) + '%';
            }
            // Load employee list
            const empRes = await api('GET', `/employee-analytics/${projectId}/performance`);
            if (empRes.success) {
                renderEmployeeAnalytics(empRes.employees || []);
            }
        }

        function renderEmployeeAnalytics(emps) {
            const tbody = document.getElementById('employeeAnalyticsTable');
            if (!emps.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><p>Нет данных</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = emps.map(e => `
                <tr>
                    <td>${escapeHtml(e.first_name)} ${escapeHtml(e.last_name || '')}</td>
                    <td><span class="badge ${e.status === 'online' ? 'badge-success' : ''}">${e.status || 'offline'}</span></td>
                    <td>${e.deals_count || 0}</td>
                    <td>${e.calls_count || 0}</td>
                    <td>${e.conversion || 0}%</td>
                    <td>${e.last_activity ? new Date(e.last_activity).toLocaleString('ru') : '-'}</td>
                </tr>
            `).join('');
        }

        // ============================================================
        // InSales-like Features
        // ============================================================

        // Brands
        async function loadBrands() {
            const res = await api('GET', `/ecommerce/${projectId}/brands`);
            if (res.success) {
                renderBrands(res.brands || []);
            }
        }

        function renderBrands(brands) {
            const el = document.getElementById('brandsList');
            if (!brands.length) {
                el.innerHTML = '<div class="stat-card"><div class="empty-state" style="padding:20px;"><i class="fas fa-building"></i><p>Нет брендов</p></div></div>';
                return;
            }
            el.innerHTML = brands.map(b => `
                <div class="stat-card">
                    ${b.logo ? `<img src="${b.logo}" style="width:60px;height:60px;object-fit:contain;margin-bottom:10px;">` : '<i class="fas fa-building" style="font-size:40px;opacity:0.3;margin-bottom:10px;"></i>'}
                    <div class="value" style="font-size:16px;">${escapeHtml(b.name)}</div>
                    <div class="label">${b.products_count || 0} товаров</div>
                    <button class="btn btn-sm btn-outline" style="margin-top:10px;" onclick="deleteBrand('${b.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function deleteBrand(id) {
            if (!confirm('Удалить бренд?')) return;
            await api('DELETE', `/ecommerce/${projectId}/brands/${id}`);
            loadBrands();
        }

        // Promo Codes
        async function loadPromoCodes() {
            const res = await api('GET', `/ecommerce/${projectId}/promo-codes`);
            if (res.success) {
                renderPromoCodes(res.promo_codes || []);
            }
        }

        function renderPromoCodes(codes) {
            const tbody = document.getElementById('promoCodesTable');
            if (!codes.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-percent"></i><h3>Нет промокодов</h3></div></td></tr>';
                return;
            }
            tbody.innerHTML = codes.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.code)}</strong></td>
                    <td>${c.type === 'percent' ? c.value + '%' : formatMoney(c.value)}</td>
                    <td>${c.uses_count || 0}</td>
                    <td>${c.max_uses || '∞'}</td>
                    <td>${c.start_date ? new Date(c.start_date).toLocaleDateString('ru') : '-'} - ${c.end_date ? new Date(c.end_date).toLocaleDateString('ru') : '∞'}</td>
                    <td><span class="badge ${c.is_active ? 'badge-success' : ''}">${c.is_active ? 'Активен' : 'Выключен'}</span></td>
                    <td><button class="btn btn-sm btn-outline" onclick="deletePromoCode('${c.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deletePromoCode(id) {
            if (!confirm('Удалить промокод?')) return;
            await api('DELETE', `/ecommerce/${projectId}/promo-codes/${id}`);
            loadPromoCodes();
        }

        // Collections
        async function loadCollections() {
            const res = await api('GET', `/ecommerce/${projectId}/collections`);
            if (res.success) {
                renderCollections(res.collections || []);
            }
        }

        function renderCollections(collections) {
            const el = document.getElementById('collectionsList');
            if (!collections.length) {
                el.innerHTML = '<div class="stat-card"><div class="empty-state" style="padding:20px;"><i class="fas fa-th-large"></i><p>Нет коллекций</p></div></div>';
                return;
            }
            el.innerHTML = collections.map(c => `
                <div class="stat-card">
                    ${c.image ? `<img src="${c.image}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;margin-bottom:10px;">` : ''}
                    <div class="value" style="font-size:16px;">${escapeHtml(c.name)}</div>
                    <div class="label">${c.products_count || 0} товаров</div>
                    <button class="btn btn-sm btn-outline" style="margin-top:10px;" onclick="deleteCollection('${c.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function deleteCollection(id) {
            if (!confirm('Удалить коллекцию?')) return;
            await api('DELETE', `/ecommerce/${projectId}/collections/${id}`);
            loadCollections();
        }

        // ============================================================
        // YClients-like Features
        // ============================================================

        // Bookings
        async function loadBookings() {
            const date = document.getElementById('bookingsDate')?.value || new Date().toISOString().split('T')[0];
            const res = await api('GET', `/bookings/${projectId}?date=${date}`);
            if (res.success) {
                renderBookings(res.bookings || []);
                document.getElementById('bookingsToday').textContent = res.bookings?.length || 0;
                document.getElementById('bookingsConfirmed').textContent = res.bookings?.filter(b => b.status === 'confirmed').length || 0;
                document.getElementById('bookingsPending').textContent = res.bookings?.filter(b => b.status === 'pending').length || 0;
            }
        }

        function renderBookings(bookings) {
            const tbody = document.getElementById('bookingsTable');
            if (!bookings.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-calendar-check"></i><h3>Нет записей</h3></div></td></tr>';
                return;
            }
            const statuses = { pending: ['Ожидает', 'badge-warning'], confirmed: ['Подтв.', 'badge-success'], completed: ['Завершено', 'badge-success'], cancelled: ['Отменено', 'badge-danger'] };
            tbody.innerHTML = bookings.map(b => `
                <tr>
                    <td>${b.booking_date} ${b.start_time}</td>
                    <td>${escapeHtml(b.client_name || '-')}</td>
                    <td>${escapeHtml(b.service_name || '-')}</td>
                    <td>${escapeHtml(b.employee_name || '-')}</td>
                    <td>${b.price ? formatMoney(b.price) : '-'}</td>
                    <td><span class="badge ${statuses[b.status]?.[1] || ''}">${statuses[b.status]?.[0] || b.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="confirmBooking('${b.id}')"><i class="fas fa-check"></i></button>
                        <button class="btn btn-sm btn-outline" onclick="cancelBooking('${b.id}')"><i class="fas fa-times"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function confirmBooking(id) {
            await api('PUT', `/bookings/${projectId}/${id}`, { status: 'confirmed' });
            loadBookings();
        }

        async function cancelBooking(id) {
            if (!confirm('Отменить запись?')) return;
            await api('PUT', `/bookings/${projectId}/${id}`, { status: 'cancelled' });
            loadBookings();
        }

        // Schedules
        async function loadSchedules() {
            const res = await api('GET', `/bookings/${projectId}/schedules`);
            if (res.success) {
                renderSchedules(res.schedules || []);
            }
        }

        function renderSchedules(schedules) {
            const tbody = document.getElementById('schedulesTable');
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            // Group by employee
            const byEmployee = {};
            schedules.forEach(s => {
                if (!byEmployee[s.employee_id]) byEmployee[s.employee_id] = { name: s.employee_name, days: {} };
                byEmployee[s.employee_id].days[s.day_of_week] = s;
            });

            if (!Object.keys(byEmployee).length) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-calendar-alt"></i><h3>Нет расписаний</h3></div></td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(byEmployee).map(([empId, emp]) => `
                <tr>
                    <td>${escapeHtml(emp.name || 'Сотрудник')}</td>
                    ${[1,2,3,4,5,6,7].map(d => {
                        const sched = emp.days[d];
                        return `<td style="font-size:12px;">${sched && sched.is_working ? sched.start_time + '-' + sched.end_time : '<span style="color:var(--text-muted)">-</span>'}</td>`;
                    }).join('')}
                    <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');
        }

        // ============================================================
        // GetCourse-like Features
        // ============================================================

        // Webinars
        async function loadWebinars() {
            const res = await api('GET', `/learning/${projectId}/webinars`);
            if (res.success) {
                renderWebinars(res.webinars || []);
                document.getElementById('webinarsUpcoming').textContent = res.webinars?.filter(w => w.status === 'scheduled').length || 0;
                document.getElementById('webinarsCompleted').textContent = res.webinars?.filter(w => w.status === 'completed').length || 0;
                document.getElementById('webinarsParticipants').textContent = res.webinars?.reduce((sum, w) => sum + (w.registrations_count || 0), 0) || 0;
            }
        }

        function renderWebinars(webinars) {
            const tbody = document.getElementById('webinarsTable');
            if (!webinars.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-video"></i><h3>Нет вебинаров</h3></div></td></tr>';
                return;
            }
            const statuses = { scheduled: ['Запланирован', 'badge-warning'], live: ['В эфире', 'badge-danger'], completed: ['Завершён', 'badge-success'] };
            tbody.innerHTML = webinars.map(w => `
                <tr>
                    <td><strong>${escapeHtml(w.title)}</strong></td>
                    <td>${new Date(w.scheduled_at).toLocaleString('ru')}</td>
                    <td>${escapeHtml(w.host_name || '-')}</td>
                    <td>${w.registrations_count || 0}</td>
                    <td><span class="badge ${statuses[w.status]?.[1] || ''}">${statuses[w.status]?.[0] || w.status}</span></td>
                    <td><button class="btn btn-sm btn-outline" onclick="deleteWebinar('${w.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deleteWebinar(id) {
            if (!confirm('Удалить вебинар?')) return;
            await api('DELETE', `/learning/${projectId}/webinars/${id}`);
            loadWebinars();
        }

        // Quizzes
        async function loadQuizzes() {
            const res = await api('GET', `/learning/${projectId}/quizzes`);
            if (res.success) {
                renderQuizzes(res.quizzes || []);
            }
        }

        function renderQuizzes(quizzes) {
            const tbody = document.getElementById('quizzesTable');
            if (!quizzes.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-question-circle"></i><h3>Нет тестов</h3></div></td></tr>';
                return;
            }
            tbody.innerHTML = quizzes.map(q => `
                <tr>
                    <td><strong>${escapeHtml(q.title)}</strong></td>
                    <td>${escapeHtml(q.course_name || '-')}</td>
                    <td>${q.questions_count || 0}</td>
                    <td>${q.attempts_count || 0}</td>
                    <td>${q.avg_score || 0}%</td>
                    <td><button class="btn btn-sm btn-outline" onclick="deleteQuiz('${q.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deleteQuiz(id) {
            if (!confirm('Удалить тест?')) return;
            await api('DELETE', `/learning/${projectId}/quizzes/${id}`);
            loadQuizzes();
        }

        // Certificates
        async function loadCertificates() {
            const res = await api('GET', `/learning/${projectId}/certificates`);
            if (res.success) {
                renderCertificates(res.certificates || []);
                document.getElementById('certificatesIssued').textContent = res.certificates?.length || 0;
            }
        }

        function renderCertificates(certs) {
            const tbody = document.getElementById('certificatesTable');
            if (!certs.length) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-certificate"></i><h3>Нет сертификатов</h3></div></td></tr>';
                return;
            }
            tbody.innerHTML = certs.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.certificate_number || c.id.slice(0,8))}</strong></td>
                    <td>${escapeHtml(c.client_name || '-')}</td>
                    <td>${escapeHtml(c.course_name || '-')}</td>
                    <td>${new Date(c.issued_at).toLocaleDateString('ru')}</td>
                    <td>${c.pdf_url ? `<a href="${c.pdf_url}" target="_blank" class="btn btn-sm btn-outline"><i class="fas fa-download"></i></a>` : '-'}</td>
                </tr>
            `).join('');
        }

        // ============================================================
        // Integrations
        // ============================================================

        async function loadIntegrations() {
            const res = await api('GET', `/integrations/${projectId}`);
            if (res.success) {
                renderIntegrations(res.integrations || []);
                document.getElementById('integrationsActive').textContent = res.integrations?.filter(i => i.is_active).length || 0;
                document.getElementById('integrationsWebhooks').textContent = res.integrations?.filter(i => i.type === 'webhook').length || 0;
                document.getElementById('integrationsForms').textContent = res.integrations?.filter(i => i.type === 'web_form').length || 0;
            }
        }

        function renderIntegrations(integrations) {
            const tbody = document.getElementById('integrationsTable');
            if (!integrations.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-plug"></i><h3>Нет интеграций</h3></div></td></tr>';
                return;
            }
            const types = { webhook: 'Вебхук', web_form: 'Веб-форма', widget: 'Виджет', telegram: 'Telegram', email: 'Email' };
            tbody.innerHTML = integrations.map(i => `
                <tr>
                    <td><strong>${escapeHtml(i.name)}</strong></td>
                    <td>${types[i.type] || i.type}</td>
                    <td>${i.stats_leads || 0}</td>
                    <td>${i.last_request_at ? new Date(i.last_request_at).toLocaleString('ru') : '-'}</td>
                    <td><span class="badge ${i.is_active ? 'badge-success' : ''}">${i.is_active ? 'Активна' : 'Выключена'}</span></td>
                    <td><button class="btn btn-sm btn-outline" onclick="deleteIntegration('${i.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deleteIntegration(id) {
            if (!confirm('Удалить интеграцию?')) return;
            await api('DELETE', `/integrations/${projectId}/${id}`);
            loadIntegrations();
        }

        // ============================================================
        // Save Functions for All Modals
        // ============================================================

        // Save Regulation (SLA)
        async function saveRegulation() {
            const name = document.getElementById('regulationName').value;
            const funnel_id = document.getElementById('regulationFunnel').value;
            const condition_type = document.getElementById('regulationCondition').value;
            const condition_value = document.getElementById('regulationValue').value;
            const condition_unit = document.getElementById('regulationUnit').value;
            const action_type = document.getElementById('regulationAction').value;

            if (!name || !condition_value) return alert('Заполните обязательные поля');

            const res = await api('POST', `/regulations/${projectId}`, {
                name, funnel_id: funnel_id || null, condition_type,
                condition_value: parseInt(condition_value), condition_unit, action_type
            });

            if (res.success) {
                closeModal('regulationModal');
                document.getElementById('regulationName').value = '';
                document.getElementById('regulationValue').value = '24';
                loadRegulations();
            } else {
                alert(res.error || 'Ошибка создания регламента');
            }
        }

        // Save Goal (KPI)
        async function saveGoal() {
            const employee_id = document.getElementById('goalEmployee').value;
            const metric_type = document.getElementById('goalMetric').value;
            const target_value = document.getElementById('goalTarget').value;
            const period_type = document.getElementById('goalPeriodType').value;
            const period_start = document.getElementById('goalStart').value;
            const period_end = document.getElementById('goalEnd').value;

            if (!target_value) return alert('Введите целевое значение');

            // Default dates for period
            let start = period_start, end = period_end;
            if (!start || !end) {
                const now = new Date();
                if (period_type === 'month') {
                    start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                } else if (period_type === 'quarter') {
                    const q = Math.floor(now.getMonth() / 3);
                    start = new Date(now.getFullYear(), q * 3, 1).toISOString().split('T')[0];
                    end = new Date(now.getFullYear(), q * 3 + 3, 0).toISOString().split('T')[0];
                } else {
                    start = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                    end = new Date(now.getFullYear(), 11, 31).toISOString().split('T')[0];
                }
            }

            const res = await api('POST', `/goals/${projectId}`, {
                employee_id: employee_id || null, metric_type,
                target_value: parseFloat(target_value), period_type, period_start: start, period_end: end
            });

            if (res.success) {
                closeModal('goalModal');
                document.getElementById('goalTarget').value = '';
                loadGoals();
            } else {
                alert(res.error || 'Ошибка создания цели');
            }
        }

        // Save Distribution Settings
        async function saveDistributionSettings() {
            const funnel_id = document.getElementById('distFunnel').value;
            const distribution_type = document.getElementById('distType').value;
            const response_timeout_minutes = document.getElementById('distTimeout').value;
            const max_leads_per_employee = document.getElementById('distMaxLeads').value;
            const auto_reassign = document.getElementById('distAutoReassign').checked ? 1 : 0;
            const working_hours_only = document.getElementById('distWorkingHours').checked ? 1 : 0;

            const res = await api('POST', `/lead-distribution/${projectId}/settings`, {
                funnel_id: funnel_id || null, distribution_type,
                response_timeout_minutes: parseInt(response_timeout_minutes) || 30,
                max_leads_per_employee: max_leads_per_employee ? parseInt(max_leads_per_employee) : null,
                auto_reassign, working_hours_only
            });

            if (res.success) {
                closeModal('distributionModal');
                loadLeadDistribution();
                alert('Настройки сохранены');
            } else {
                alert(res.error || 'Ошибка сохранения');
            }
        }

        // Save Tag
        async function saveTag() {
            const name = document.getElementById('tagName').value;
            const color = document.getElementById('tagColor').value;
            const entity_type = document.getElementById('tagEntityType').value;

            if (!name) return alert('Введите название тега');

            const res = await api('POST', `/tags/${projectId}`, { name, color, entity_type });

            if (res.success) {
                closeModal('tagModal');
                document.getElementById('tagName').value = '';
                loadTags();
            } else {
                alert(res.error || 'Ошибка создания тега');
            }
        }

        // Save Brand
        async function saveBrand() {
            const name = document.getElementById('brandName').value;
            const logo = document.getElementById('brandLogo').value;
            const website = document.getElementById('brandWebsite').value;
            const description = document.getElementById('brandDescription').value;

            if (!name) return alert('Введите название бренда');

            const res = await api('POST', `/ecommerce/${projectId}/brands`, { name, logo, website, description });

            if (res.success) {
                closeModal('brandModal');
                ['brandName', 'brandLogo', 'brandWebsite', 'brandDescription'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadBrands();
            } else {
                alert(res.error || 'Ошибка создания бренда');
            }
        }

        // Save Promo Code
        async function savePromoCode() {
            const code = document.getElementById('promoCode').value.toUpperCase();
            const type = document.getElementById('promoType').value;
            const value = document.getElementById('promoValue').value;
            const min_order_amount = document.getElementById('promoMinOrder').value;
            const max_uses = document.getElementById('promoMaxUses').value;
            const start_date = document.getElementById('promoStart').value;
            const end_date = document.getElementById('promoEnd').value;

            if (!code || !value) return alert('Введите код и значение скидки');

            const res = await api('POST', `/ecommerce/${projectId}/promo-codes`, {
                code, type, value: parseFloat(value),
                min_order_amount: parseFloat(min_order_amount) || 0,
                max_uses: max_uses ? parseInt(max_uses) : null,
                start_date: start_date || null, end_date: end_date || null
            });

            if (res.success) {
                closeModal('promoModal');
                ['promoCode', 'promoValue', 'promoMinOrder', 'promoMaxUses', 'promoStart', 'promoEnd'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadPromoCodes();
            } else {
                alert(res.error || 'Ошибка создания промокода');
            }
        }

        // Save Collection
        async function saveCollection() {
            const name = document.getElementById('collectionName').value;
            const image = document.getElementById('collectionImage').value;
            const type = document.getElementById('collectionType').value;
            const description = document.getElementById('collectionDescription').value;

            if (!name) return alert('Введите название коллекции');

            const res = await api('POST', `/ecommerce/${projectId}/collections`, { name, image, type, description });

            if (res.success) {
                closeModal('collectionModal');
                ['collectionName', 'collectionImage', 'collectionDescription'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadCollections();
            } else {
                alert(res.error || 'Ошибка создания коллекции');
            }
        }

        // Save Booking
        async function saveBooking() {
            const service_id = document.getElementById('bookingService').value;
            const employee_id = document.getElementById('bookingEmployee').value;
            const client_id = document.getElementById('bookingClient').value;
            const booking_date = document.getElementById('bookingDate').value;
            const start_time = document.getElementById('bookingTime').value;
            const client_name = document.getElementById('bookingClientName').value;
            const client_phone = document.getElementById('bookingClientPhone').value;
            const comment = document.getElementById('bookingComment').value;

            if (!service_id || !booking_date || !start_time) {
                return alert('Выберите услугу, дату и время');
            }

            const res = await api('POST', `/bookings/${projectId}`, {
                service_id, employee_id: employee_id || null, client_id: client_id || null,
                booking_date, start_time, client_name, client_phone, comment
            });

            if (res.success) {
                closeModal('bookingModal');
                ['bookingDate', 'bookingTime', 'bookingClientName', 'bookingClientPhone', 'bookingComment'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadBookings();
            } else {
                alert(res.error || 'Ошибка создания записи');
            }
        }

        // Save Schedule
        async function saveSchedule() {
            const employee_id = document.getElementById('scheduleEmployee').value;
            if (!employee_id) return alert('Выберите сотрудника');

            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const schedules = [];

            days.forEach((day, index) => {
                const is_working = document.getElementById('sched' + day).checked ? 1 : 0;
                const start_time = document.getElementById('sched' + day + 'Start').value;
                const end_time = document.getElementById('sched' + day + 'End').value;
                schedules.push({ day_of_week: index + 1, is_working, start_time, end_time });
            });

            const res = await api('POST', `/bookings/${projectId}/schedules`, {
                employee_id, schedules
            });

            if (res.success) {
                closeModal('scheduleModal');
                loadSchedules();
            } else {
                alert(res.error || 'Ошибка сохранения расписания');
            }
        }

        // Save Webinar
        async function saveWebinar() {
            const title = document.getElementById('webinarTitle').value;
            const course_id = document.getElementById('webinarCourse').value;
            const host_id = document.getElementById('webinarHost').value;
            const scheduled_at = document.getElementById('webinarDate').value;
            const duration_minutes = document.getElementById('webinarDuration').value;
            const platform = document.getElementById('webinarPlatform').value;
            const description = document.getElementById('webinarDescription').value;

            if (!title || !scheduled_at) return alert('Введите название и дату');

            const res = await api('POST', `/learning/${projectId}/webinars`, {
                title, course_id: course_id || null, host_id: host_id || null,
                scheduled_at, duration_minutes: parseInt(duration_minutes) || 60, platform, description
            });

            if (res.success) {
                closeModal('webinarModal');
                ['webinarTitle', 'webinarDate', 'webinarDescription'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                loadWebinars();
            } else {
                alert(res.error || 'Ошибка создания вебинара');
            }
        }

        // Save Quiz
        async function saveQuiz() {
            const title = document.getElementById('quizTitle').value;
            const course_id = document.getElementById('quizCourse').value;
            const passing_score = document.getElementById('quizPassingScore').value;
            const time_limit_minutes = document.getElementById('quizTimeLimit').value;
            const attempts_allowed = document.getElementById('quizAttempts').value;
            const shuffle_questions = document.getElementById('quizShuffle').checked ? 1 : 0;
            const description = document.getElementById('quizDescription').value;

            if (!title || !course_id) return alert('Введите название и выберите курс');

            const res = await api('POST', `/learning/${projectId}/quizzes`, {
                title, course_id, passing_score: parseInt(passing_score) || 70,
                time_limit_minutes: time_limit_minutes ? parseInt(time_limit_minutes) : null,
                attempts_allowed: parseInt(attempts_allowed) || 3, shuffle_questions, description
            });

            if (res.success) {
                closeModal('quizModal');
                document.getElementById('quizTitle').value = '';
                document.getElementById('quizDescription').value = '';
                loadQuizzes();
            } else {
                alert(res.error || 'Ошибка создания теста');
            }
        }

        // Save Integration
        async function saveIntegration() {
            const name = document.getElementById('integrationName').value;
            const type = document.getElementById('integrationType').value;
            const funnel_id = document.getElementById('integrationFunnel').value;

            if (!name) return alert('Введите название интеграции');

            const res = await api('POST', `/integrations/${projectId}`, {
                name, type, settings: { funnel_id: funnel_id || null }
            });

            if (res.success) {
                closeModal('integrationModal');
                document.getElementById('integrationName').value = '';
                loadIntegrations();

                // Show webhook URL or widget code for user
                if (res.integration) {
                    if (type === 'webhook' || type === 'web_form') {
                        alert('Интеграция создана!\n\nURL для отправки данных:\n' + window.location.origin + '/api/integrations/' + projectId + '/incoming/' + res.integration.id);
                    } else if (type === 'widget') {
                        alert('Интеграция создана!\n\nКод виджета доступен в настройках интеграции.');
                    }
                }
            } else {
                alert(res.error || 'Ошибка создания интеграции');
            }
        }

        // Toggle integration fields based on type
        function toggleIntegrationFields() {
            const type = document.getElementById('integrationType').value;
            document.getElementById('integrationUrlGroup').style.display = (type === 'webhook' || type === 'web_form') ? 'block' : 'none';
            document.getElementById('integrationWidgetGroup').style.display = type === 'widget' ? 'block' : 'none';
        }

        // ============================================================
        // Populate Select Dropdowns
        // ============================================================

        function populateSelects() {
            // Funnels
            const funnelOptions = '<option value="">Все воронки</option>' + funnels.map(f => `<option value="${f.id}">${escapeHtml(f.name)}</option>`).join('');
            ['regulationFunnel', 'distFunnel', 'integrationFunnel'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = funnelOptions;
            });

            // Employees for forms
            const empOptions = '<option value="">Выберите сотрудника</option>' + employees.map(e => `<option value="${e.id}">${escapeHtml(e.first_name)} ${escapeHtml(e.last_name || '')}</option>`).join('');
            ['goalEmployee', 'bookingEmployee', 'scheduleEmployee', 'webinarHost'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = (id === 'goalEmployee' ? '<option value="">Общая цель (все)</option>' : '<option value="">Выберите</option>') +
                    employees.map(e => `<option value="${e.id}">${escapeHtml(e.first_name)} ${escapeHtml(e.last_name || '')}</option>`).join('');
            });

            // Employees for filters
            const empFilterOptions = '<option value="">Все менеджеры</option>' + employees.map(e => `<option value="${e.id}">${escapeHtml(e.first_name)} ${escapeHtml(e.last_name || '')}</option>`).join('');
            ['filterDealEmployee', 'scheduleEmployee', 'analyticsEmployee'].forEach(id => {
                const el = document.getElementById(id);
                if (el && id.includes('filter')) el.innerHTML = empFilterOptions;
            });
            const filterDealEmp = document.getElementById('filterDealEmployee');
            if (filterDealEmp) filterDealEmp.innerHTML = empFilterOptions;

            // Clients
            const clientOptions = '<option value="">Выберите клиента</option>' + clients.map(c => `<option value="${c.id}">${escapeHtml(c.first_name)} ${escapeHtml(c.last_name || '')}</option>`).join('');
            ['bookingClient'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = clientOptions;
            });

            // Load tags for filters
            loadTagsForFilters();
        }

        async function loadTagsForFilters() {
            try {
                // Client tags
                const clientTagsRes = await api('GET', `/tags/${projectId}?entity_type=client`);
                if (clientTagsRes.success) {
                    const el = document.getElementById('filterClientTag');
                    if (el) {
                        el.innerHTML = '<option value="">Все теги</option>' +
                            (clientTagsRes.tags || []).map(t => `<option value="${escapeHtml(t.name)}">${escapeHtml(t.name)}</option>`).join('');
                    }
                }

                // Deal tags
                const dealTagsRes = await api('GET', `/tags/${projectId}?entity_type=deal`);
                if (dealTagsRes.success) {
                    const el = document.getElementById('filterDealTag');
                    if (el) {
                        el.innerHTML = '<option value="">Все теги</option>' +
                            (dealTagsRes.tags || []).map(t => `<option value="${escapeHtml(t.name)}">${escapeHtml(t.name)}</option>`).join('');
                    }
                }
            } catch (e) { console.log('Tags load failed', e); }
        }

        // Load services for booking modal
        async function loadServicesForBooking() {
            const res = await api('GET', `/services/${projectId}`);
            if (res.success) {
                const el = document.getElementById('bookingService');
                if (el) {
                    el.innerHTML = '<option value="">Выберите услугу</option>' +
                        (res.services || []).map(s => `<option value="${s.id}">${escapeHtml(s.name)} - ${formatMoney(s.price || 0)}</option>`).join('');
                }
            }
        }

        // Load courses for quiz/webinar modals
        async function loadCoursesForModals() {
            const res = await api('GET', `/courses/${projectId}`);
            if (res.success) {
                const courseOptions = '<option value="">Выберите курс</option>' +
                    (res.courses || []).map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
                ['quizCourse', 'webinarCourse'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = id === 'webinarCourse' ? '<option value="">Без курса</option>' +
                        (res.courses || []).map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('') : courseOptions;
                });
            }
        }

        // ============================================================
        // NEW SECTIONS: Categories, Filters, Selections, Specialists, Rooms, Trainings, Lessons
        // ============================================================

        // Product Type Toggle
        document.querySelectorAll('input[name="productType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const onlineSection = document.getElementById('onlineProductAccess');
                const stockGroup = document.getElementById('productStockGroup');
                if (this.value === 'online') {
                    onlineSection.style.display = 'block';
                    stockGroup.style.display = 'none';
                } else {
                    onlineSection.style.display = 'none';
                    stockGroup.style.display = 'block';
                }
            });
        });

        function toggleProductAccessOptions() {
            const type = document.getElementById('productAccessType').value;
            document.getElementById('accessTrainingSelect').style.display = type === 'training' ? 'block' : 'none';
            document.getElementById('accessLessonSelect').style.display = type === 'lesson' ? 'block' : 'none';
            document.getElementById('accessGroupSelect').style.display = type === 'group' ? 'block' : 'none';
        }

        // Categories
        let categories = [];
        async function loadCategories() {
            const res = await api('GET', `/ecommerce/${projectId}/categories`);
            if (res.success) {
                categories = res.categories || [];
                renderCategories();
                populateCategorySelects();
            }
        }

        function renderCategories() {
            const container = document.getElementById('categoriesTree');
            if (!container) return;

            const buildTree = (parentId = null) => {
                const children = categories.filter(c => c.parent_id === parentId);
                if (!children.length) return '';
                return children.map(cat => `
                    <div class="category-item" onclick="editCategory('${cat.id}')">
                        <span><i class="fas fa-folder"></i> ${escapeHtml(cat.name)}</span>
                        <span class="badge">${categories.filter(c => c.parent_id === cat.id).length} подкат.</span>
                    </div>
                    <div class="category-children">${buildTree(cat.id)}</div>
                `).join('');
            };
            container.innerHTML = buildTree() || '<p style="color:var(--text-muted);">Нет категорий. Нажмите "Добавить категорию"</p>';
        }

        function populateCategorySelects() {
            const options = '<option value="">— Без категории —</option>' +
                categories.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
            ['productCategory', 'categoryParent', 'filterProductCategory'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = options;
            });
        }

        async function saveCategory() {
            const name = document.getElementById('categoryName').value;
            if (!name) return alert('Введите название категории');

            const res = await api('POST', `/ecommerce/${projectId}/categories`, {
                name,
                parent_id: document.getElementById('categoryParent').value || null,
                description: document.getElementById('categoryDescription').value
            });

            if (res.success) {
                closeModal('categoryModal');
                loadCategories();
            } else {
                alert(res.error || 'Ошибка создания категории');
            }
        }

        // Product Filters
        let productFilters = [];
        async function loadProductFilters() {
            // Load from localStorage for now
            productFilters = JSON.parse(localStorage.getItem(`filters_${projectId}`) || '[]');
            renderProductFilters();
        }

        function renderProductFilters() {
            const grid = document.getElementById('customFiltersGrid');
            if (!grid) return;
            grid.innerHTML = productFilters.map(f => `
                <div class="card" style="cursor:pointer;" onclick="openFilterEditor('${f.id}')">
                    <div class="card-body">
                        <h4><i class="fas fa-sliders-h"></i> ${escapeHtml(f.name)}</h4>
                        <p style="color:var(--text-muted);">${f.values?.length || 0} значений</p>
                    </div>
                </div>
            `).join('');
        }

        function toggleCustomFilter() {
            const isCustom = document.getElementById('filterType').value === 'custom';
            document.getElementById('customFilterName').style.display = isCustom ? 'block' : 'none';
        }

        function saveProductFilter() {
            const type = document.getElementById('filterType').value;
            const name = type === 'custom' ? document.getElementById('filterCustomName').value : type;
            const values = document.getElementById('filterValues').value.split('\n').filter(v => v.trim());

            if (!name) return alert('Введите название фильтра');

            const filter = {
                id: Date.now().toString(),
                name,
                values,
                multiple: document.getElementById('filterMultiple').checked
            };

            productFilters.push(filter);
            localStorage.setItem(`filters_${projectId}`, JSON.stringify(productFilters));
            closeModal('productFilterModal');
            loadProductFilters();
        }

        // Selections (former Collections)
        let selections = [];
        async function loadSelections() {
            const res = await api('GET', `/ecommerce/${projectId}/collections`);
            if (res.success) {
                selections = res.collections || [];
                renderSelections();
            }
        }

        function renderSelections() {
            const container = document.getElementById('selectionsList');
            if (!container) return;
            container.innerHTML = selections.map(s => `
                <div class="stat-card" onclick="editSelection('${s.id}')" style="cursor:pointer;">
                    <div class="value">${s.products_count || 0}</div>
                    <div class="label">${escapeHtml(s.name)}</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted);">Нет подборок</p>';
        }

        async function saveSelection() {
            const name = document.getElementById('selectionName').value;
            if (!name) return alert('Введите название подборки');

            const res = await api('POST', `/ecommerce/${projectId}/collections`, {
                name,
                description: document.getElementById('selectionDescription').value,
                type: document.getElementById('selectionType').value
            });

            if (res.success) {
                closeModal('selectionModal');
                loadSelections();
            } else {
                alert(res.error || 'Ошибка создания подборки');
            }
        }

        // Specialists
        let specialists = [];
        async function loadSpecialists() {
            const res = await api('GET', `/bookings/${projectId}/employees`);
            if (res.success) {
                specialists = res.employees || [];
                renderSpecialists();
                populateSpecialistSelects();
            }
        }

        function renderSpecialists() {
            const container = document.getElementById('specialistsList');
            if (!container) return;
            container.innerHTML = specialists.map(s => `
                <div class="stat-card" onclick="editSpecialist('${s.id}')" style="cursor:pointer;">
                    <div style="font-size:32px;margin-bottom:10px;"><i class="fas fa-user-md"></i></div>
                    <div class="label">${escapeHtml(s.name || s.first_name + ' ' + (s.last_name || ''))}</div>
                    <div style="font-size:12px;color:var(--text-muted);">${escapeHtml(s.position || '')}</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted);">Нет специалистов</p>';
        }

        function populateSpecialistSelects() {
            const options = '<option value="">Все специалисты</option>' +
                specialists.map(s => `<option value="${s.id}">${escapeHtml(s.name || s.first_name)}</option>`).join('');
            ['filterBookingSpecialist', 'scheduleEmployee'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = options;
            });
        }

        async function saveSpecialist() {
            const first_name = document.getElementById('specialistFirstName').value;
            if (!first_name) return alert('Введите имя специалиста');

            const res = await api('POST', `/employees/${projectId}`, {
                first_name,
                last_name: document.getElementById('specialistLastName').value,
                position: document.getElementById('specialistPosition').value,
                department: 'services'
            });

            if (res.success) {
                closeModal('specialistModal');
                loadSpecialists();
                loadEmployees();
            } else {
                alert(res.error || 'Ошибка добавления специалиста');
            }
        }

        // Rooms
        let rooms = [];
        async function loadRooms() {
            rooms = JSON.parse(localStorage.getItem(`rooms_${projectId}`) || '[]');
            renderRooms();
        }

        function renderRooms() {
            const container = document.getElementById('roomsList');
            if (!container) return;
            container.innerHTML = rooms.map(r => `
                <div class="stat-card" onclick="editRoom('${r.id}')" style="cursor:pointer;">
                    <div style="font-size:32px;margin-bottom:10px;"><i class="fas fa-door-open"></i></div>
                    <div class="label">${escapeHtml(r.name)}</div>
                    <div style="font-size:12px;color:var(--text-muted);">Вместимость: ${r.capacity}</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted);">Нет помещений</p>';
        }

        function saveRoom() {
            const name = document.getElementById('roomName').value;
            if (!name) return alert('Введите название помещения');

            rooms.push({
                id: Date.now().toString(),
                name,
                capacity: document.getElementById('roomCapacity').value || 1,
                description: document.getElementById('roomDescription').value
            });
            localStorage.setItem(`rooms_${projectId}`, JSON.stringify(rooms));
            closeModal('roomModal');
            loadRooms();
        }

        // Trainings (courses restructured)
        let trainings = [];
        async function loadTrainings() {
            const res = await api('GET', `/courses/${projectId}`);
            if (res.success) {
                trainings = res.courses || [];
                renderTrainings();
                populateTrainingSelects();
                document.getElementById('trainingsTotal').textContent = trainings.length;
                document.getElementById('trainingsStudents').textContent =
                    trainings.reduce((sum, t) => sum + (t.students_count || 0), 0);
            }
        }

        function renderTrainings() {
            const container = document.getElementById('trainingsList');
            if (!container) return;
            container.innerHTML = trainings.map(t => `
                <div class="stat-card" onclick="editTraining('${t.id}')" style="cursor:pointer;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <span class="badge ${t.is_published ? 'success' : ''}">${t.is_published ? 'Опубликован' : 'Черновик'}</span>
                        <span style="font-size:12px;color:var(--text-muted);">${t.lessons_count || 0} уроков</span>
                    </div>
                    <div class="label" style="font-size:16px;font-weight:600;">${escapeHtml(t.name)}</div>
                    <div style="margin-top:10px;display:flex;justify-content:space-between;font-size:12px;">
                        <span><i class="fas fa-users"></i> ${t.students_count || 0}</span>
                        <span><i class="fas fa-chart-line"></i> ${t.avg_progress || 0}%</span>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted);">Нет тренингов</p>';
        }

        function populateTrainingSelects() {
            const options = trainings.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
            ['lessonTraining', 'filterLessonTraining', 'certTemplateTraining', 'certTraining',
             'productAccessTraining', 'autoWebinarTraining'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<option value="">— Выберите —</option>' + options;
            });
        }

        async function saveTraining() {
            const name = document.getElementById('trainingName').value;
            if (!name) return alert('Введите название тренинга');

            const res = await api('POST', `/courses/${projectId}`, {
                name,
                description: document.getElementById('trainingDescription').value,
                type: document.getElementById('trainingAccessType').value,
                access_days: document.getElementById('trainingAccessDays').value || 0,
                drip_content: document.getElementById('trainingDrip').value,
                certificate_enabled: document.getElementById('trainingCertificate').checked
            });

            if (res.success) {
                closeModal('trainingModal');
                loadTrainings();
            } else {
                alert(res.error || 'Ошибка создания тренинга');
            }
        }

        // Lessons
        let lessons = [];
        async function loadLessons() {
            const res = await api('GET', `/learning/${projectId}/lessons`);
            if (res.success) {
                lessons = res.lessons || [];
                renderLessons();
            }
        }

        function renderLessons() {
            const tbody = document.getElementById('lessonsTable');
            if (!tbody) return;
            tbody.innerHTML = lessons.map((l, i) => {
                const training = trainings.find(t => t.id === l.course_id);
                return `
                <tr onclick="editLesson('${l.id}')" style="cursor:pointer;">
                    <td>${l.order_index || i + 1}</td>
                    <td>${escapeHtml(l.title)}</td>
                    <td>${training ? escapeHtml(training.name) : '-'}</td>
                    <td><span class="badge">${l.type || 'video'}</span></td>
                    <td>${l.duration || '-'} мин</td>
                    <td>${l.completed_count || 0}</td>
                    <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                </tr>
            `}).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);">Нет уроков</td></tr>';
        }

        function toggleLessonContent() {
            const type = document.getElementById('lessonType').value;
            document.getElementById('lessonVideoGroup').style.display = type === 'video' ? 'block' : 'none';
            document.getElementById('lessonTextGroup').style.display = (type === 'text' || type === 'homework') ? 'block' : 'none';
        }

        async function saveLesson() {
            const training = document.getElementById('lessonTraining').value;
            const name = document.getElementById('lessonName').value;
            if (!training || !name) return alert('Заполните обязательные поля');

            const res = await api('POST', `/learning/${projectId}/lessons`, {
                course_id: training,
                title: name,
                type: document.getElementById('lessonType').value,
                content: document.getElementById('lessonContent').value,
                video_url: document.getElementById('lessonVideoUrl').value,
                duration: document.getElementById('lessonDuration').value,
                order_index: document.getElementById('lessonOrder').value
            });

            if (res.success) {
                closeModal('lessonModal');
                loadLessons();
            } else {
                alert(res.error || 'Ошибка создания урока');
            }
        }

        // Bookings Calendar
        let bookingsWeekStart = new Date();
        bookingsWeekStart.setDate(bookingsWeekStart.getDate() - bookingsWeekStart.getDay() + 1);

        function loadBookingsCalendar() {
            const header = document.getElementById('bookingsCalendarHeader');
            const body = document.getElementById('bookingsCalendarBody');
            if (!header || !body) return;

            // Set date input
            const dateInput = document.getElementById('bookingsWeekStart');
            if (dateInput) dateInput.value = bookingsWeekStart.toISOString().split('T')[0];

            // Generate header with dates
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            header.innerHTML = '<th style="width:60px;">Время</th>' +
                days.map((d, i) => {
                    const date = new Date(bookingsWeekStart);
                    date.setDate(date.getDate() + i);
                    return `<th>${d}<br><small>${date.getDate()}.${date.getMonth()+1}</small></th>`;
                }).join('');

            // Generate time slots (9:00 - 21:00)
            let rows = '';
            for (let hour = 9; hour <= 20; hour++) {
                rows += `<tr>
                    <td class="time-cell">${hour}:00</td>
                    ${days.map((_, i) => `<td class="slot-cell" onclick="openBookingSlot(${hour}, ${i})"></td>`).join('')}
                </tr>`;
            }
            body.innerHTML = rows;
        }

        function moveBookingsWeek(direction) {
            bookingsWeekStart.setDate(bookingsWeekStart.getDate() + (direction * 7));
            loadBookingsCalendar();
        }

        function openBookingSlot(hour, dayIndex) {
            const date = new Date(bookingsWeekStart);
            date.setDate(date.getDate() + dayIndex);
            date.setHours(hour, 0, 0, 0);

            // Pre-fill booking modal
            openModal('bookingModal');
            // Set date/time if fields exist
        }

        // Webinars
        async function loadWebinars() {
            const res = await api('GET', `/learning/${projectId}/webinars`);
            if (res.success) {
                const webinars = res.webinars || [];
                document.getElementById('webinarsUpcoming').textContent = webinars.filter(w => w.status === 'scheduled').length;
                document.getElementById('webinarsLive').textContent = webinars.filter(w => w.status === 'live').length;
                document.getElementById('webinarsCompleted').textContent = webinars.filter(w => w.status === 'completed').length;

                const tbody = document.getElementById('webinarsTable');
                if (tbody) {
                    tbody.innerHTML = webinars.map(w => `
                        <tr>
                            <td>${escapeHtml(w.title)}</td>
                            <td><span class="badge">${w.type === 'auto' ? 'Авто' : 'Живой'}</span></td>
                            <td>${formatDate(w.start_time)}</td>
                            <td>${escapeHtml(w.host_name || '-')}</td>
                            <td>${w.registrations || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="copyWebinarLink('${w.id}')">
                                    <i class="fas fa-link"></i>
                                </button>
                            </td>
                            <td><span class="badge ${w.status === 'live' ? 'success' : ''}">${w.status}</span></td>
                            <td>
                                ${w.status === 'scheduled' ? `<button class="btn btn-sm btn-primary" onclick="startWebinar('${w.id}')">Запустить</button>` : ''}
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }

        function copyWebinarLink(id) {
            const url = `${location.origin}/webinar/${id}`;
            navigator.clipboard.writeText(url);
            alert('Ссылка скопирована');
        }

        async function saveAutoWebinar() {
            const name = document.getElementById('autoWebinarName').value;
            const video = document.getElementById('autoWebinarVideo').value;
            if (!name || !video) return alert('Заполните обязательные поля');

            const res = await api('POST', `/learning/${projectId}/webinars`, {
                title: name,
                type: 'auto',
                video_url: video,
                duration: document.getElementById('autoWebinarDuration').value,
                chat_simulation: document.getElementById('autoWebinarChat').checked
            });

            if (res.success) {
                closeModal('autoWebinarModal');
                loadWebinars();
            } else {
                alert(res.error || 'Ошибка создания автовебинара');
            }
        }

        // Certificates
        async function loadCertificates() {
            const res = await api('GET', `/learning/${projectId}/certificates`);
            if (res.success) {
                const certs = res.certificates || [];
                document.getElementById('certificatesIssued').textContent = certs.length;

                const tbody = document.getElementById('certificatesTable');
                if (tbody) {
                    tbody.innerHTML = certs.map(c => `
                        <tr>
                            <td>${escapeHtml(c.number)}</td>
                            <td>${escapeHtml(c.student_name)}</td>
                            <td>${escapeHtml(c.course_name || '-')}</td>
                            <td>${escapeHtml(c.template_name || 'По умолчанию')}</td>
                            <td>${formatDate(c.issued_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="downloadCertificate('${c.id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }

        function saveCertificateTemplate() {
            const name = document.getElementById('certTemplateName').value;
            if (!name) return alert('Введите название шаблона');

            // Save template to localStorage for now
            const templates = JSON.parse(localStorage.getItem(`cert_templates_${projectId}`) || '[]');
            templates.push({
                id: Date.now().toString(),
                name,
                training_id: document.getElementById('certTemplateTraining').value
            });
            localStorage.setItem(`cert_templates_${projectId}`, JSON.stringify(templates));
            closeModal('certificateTemplateModal');
            alert('Шаблон сохранён');
        }

        async function issueCertificate() {
            const student = document.getElementById('certStudent').value;
            const training = document.getElementById('certTraining').value;
            if (!student || !training) return alert('Выберите студента и тренинг');

            const res = await api('POST', `/learning/${projectId}/certificates`, {
                client_id: student,
                course_id: training,
                template_id: document.getElementById('certTemplate').value
            });

            if (res.success) {
                closeModal('issueCertificateModal');
                loadCertificates();
            } else {
                alert(res.error || 'Ошибка выдачи сертификата');
            }
        }

        // XML Import
        async function importXml() {
            const file = document.getElementById('xmlFile').files[0];
            const url = document.getElementById('xmlUrl').value;

            if (!file && !url) return alert('Выберите файл или укажите URL');

            const progress = document.getElementById('xmlProgress');
            const bar = document.getElementById('xmlProgressBar');
            const text = document.getElementById('xmlProgressText');

            progress.style.display = 'block';
            bar.style.width = '10%';
            text.textContent = 'Загрузка...';

            // Simulate progress for now
            setTimeout(() => { bar.style.width = '30%'; text.textContent = 'Парсинг XML...'; }, 500);
            setTimeout(() => { bar.style.width = '60%'; text.textContent = 'Импорт товаров...'; }, 1500);
            setTimeout(() => {
                bar.style.width = '100%';
                text.textContent = 'Готово!';
                setTimeout(() => {
                    closeModal('importXmlModal');
                    progress.style.display = 'none';
                    bar.style.width = '0';
                    loadProducts();
                }, 1000);
            }, 3000);
        }

        // Update Promo Codes table with more features
        function renderPromoCodesExtended() {
            const tbody = document.getElementById('promoCodesTable');
            if (!tbody) return;
            // Extended promo codes rendering handled by existing loadPromoCodes
        }

        // Extend section loading
        const originalSwitchSection = typeof switchSection !== 'undefined' ? switchSection : null;
        if (originalSwitchSection) {
            const extendedSwitchSection = function(section) {
                originalSwitchSection(section);
                switch(section) {
                    case 'categories': loadCategories(); break;
                    case 'product-filters': loadProductFilters(); break;
                    case 'selections': loadSelections(); break;
                    case 'specialists': loadSpecialists(); break;
                    case 'rooms': loadRooms(); break;
                    case 'trainings': loadTrainings(); break;
                    case 'lessons': loadLessons(); break;
                    case 'bookings': loadBookingsCalendar(); break;
                }
            };
            window.switchSection = extendedSwitchSection;
        }

        // Event listeners for filters
        document.getElementById('tagsEntity')?.addEventListener('change', loadTags);
        document.getElementById('analyticsPeriod')?.addEventListener('change', loadEmployeeAnalytics);
        document.getElementById('goalsPeriod')?.addEventListener('change', loadGoals);
        document.getElementById('bookingsDate')?.addEventListener('change', loadBookings);

        // Initialize new sections
        document.getElementById('autoWebinarScheduled')?.addEventListener('change', function() {
            document.getElementById('autoWebinarSchedule').style.display = this.checked ? 'block' : 'none';
        });

        // Start
        init();
    </script>
</body>
</html>
