<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PK Business - CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --sidebar-width: 240px;
            --header-height: 56px;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --accent: #6366f1;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 14px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: toastIn 0.3s ease;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }
        .toast-close {
            margin-left: auto;
            cursor: pointer;
            opacity: 0.8;
            padding: 4px;
        }
        .toast-close:hover { opacity: 1; }
        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toastOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Contenteditable placeholder */
        [contenteditable=true]:empty:before {
            content: attr(placeholder);
            color: var(--text-muted);
            pointer-events: none;
        }
        [contenteditable=true]:focus {
            border-color: var(--primary) !important;
        }
        [contenteditable=true] h1 { font-size: 24px; margin: 8px 0; }
        [contenteditable=true] h2 { font-size: 20px; margin: 6px 0; }
        [contenteditable=true] h3 { font-size: 16px; margin: 4px 0; }
        [contenteditable=true] blockquote { border-left: 3px solid var(--primary); padding-left: 12px; margin: 8px 0; color: var(--text-secondary); }
        [contenteditable=true] pre { background: var(--bg-dark); padding: 12px; border-radius: 6px; font-family: monospace; font-size: 13px; }
        [contenteditable=true] ul, [contenteditable=true] ol { padding-left: 20px; margin: 8px 0; }

        /* Confirm Dialog */
        .confirm-dialog {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            text-align: center;
        }
        .confirm-dialog h3 { margin-bottom: 12px; }
        .confirm-dialog p { color: var(--text-muted); margin-bottom: 20px; }
        .confirm-dialog .actions { display: flex; gap: 12px; justify-content: center; }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar .fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }
        .progress-bar.success .fill { background: var(--success); }
        .progress-bar.warning .fill { background: var(--warning); }
        .progress-bar.danger .fill { background: var(--danger); }

        /* Improved Form Validation */
        input:invalid:not(:placeholder-shown),
        select:invalid:not(:placeholder-shown),
        textarea:invalid:not(:placeholder-shown) {
            border-color: var(--danger);
        }
        .form-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 4px;
        }
        .form-success {
            color: var(--success);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Stat Trends */
        .stat-trend {
            font-size: 11px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .stat-trend.up { color: var(--success); }
        .stat-trend.down { color: var(--danger); }

        /* Chart Bars */
        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, var(--primary) 0%, rgba(59,130,246,0.5) 100%);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.5s ease;
            position: relative;
        }
        .chart-bar:hover {
            background: var(--primary-hover);
        }
        .chart-bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            display: none;
            border: 1px solid var(--border-color);
        }
        .chart-bar:hover .chart-bar-tooltip {
            display: block;
        }

        /* Funnel Chart */
        .funnel-stage {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        .funnel-stage-bg {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--primary);
            opacity: 0.2;
            transition: width 0.5s ease;
        }
        .funnel-stage-content {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .funnel-stage-name { font-weight: 500; }
        .funnel-stage-value { font-weight: 600; color: var(--primary); }
        .funnel-stage-percent { font-size: 12px; color: var(--text-muted); }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 20px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        .timeline-dot {
            position: absolute;
            left: -20px;
            top: 0;
            width: 14px;
            height: 14px;
            background: var(--primary);
            border-radius: 50%;
            border: 2px solid var(--bg-card);
        }
        .timeline-dot.success { background: var(--success); }
        .timeline-dot.warning { background: var(--warning); }
        .timeline-dot.danger { background: var(--danger); }
        .timeline-content {
            padding-left: 10px;
        }
        .timeline-date {
            font-size: 11px;
            color: var(--text-muted);
        }
        .timeline-title {
            font-weight: 500;
            margin: 2px 0;
        }
        .timeline-desc {
            font-size: 13px;
            color: var(--text-muted);
        }
        .timeline-content p {
            margin: 4px 0 0;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0;
        }
        .tab-btn {
            padding: 10px 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            color: var(--text-primary);
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-content {
            padding-top: 20px;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-primary); }
        .layout { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: #020617; border-right: 1px solid var(--border-color); position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h1 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .sidebar-header h1 i { color: var(--primary); }
        .nav-section { padding: 16px 0; }
        .nav-title { padding: 8px 16px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: var(--text-secondary); cursor: pointer; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(59,130,246,0.1); color: var(--text-primary); }
        .nav-item.active { background: rgba(59,130,246,0.15); color: var(--primary); border-left-color: var(--primary); }
        .nav-item i { width: 20px; text-align: center; }
        .nav-item .badge { margin-left: auto; background: var(--primary); padding: 2px 8px; border-radius: 10px; font-size: 11px; }

        /* Main */
        .main { flex: 1; margin-left: var(--sidebar-width); }
        .header { height: var(--header-height); background: var(--bg-card); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; position: sticky; top: 0; z-index: 50; }
        .header h2 { font-size: 18px; }
        .header-actions { display: flex; gap: 12px; }
        .content { padding: 24px; }

        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        .stat-card .value { font-size: 28px; font-weight: 600; margin-bottom: 4px; }
        .stat-card .label { color: var(--text-secondary); font-size: 14px; }
        .stat-card.primary .value { color: var(--primary); }
        .stat-card.success .value { color: var(--success); }
        .stat-card.warning .value { color: var(--warning); }

        /* Table */
        .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .card-header h3 { font-size: 16px; }
        .card-body { padding: 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 20px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 500; color: var(--text-secondary); font-size: 13px; background: rgba(0,0,0,0.2); }
        tr:hover { background: rgba(59,130,246,0.05); }
        tr:last-child td { border-bottom: none; }

        /* Badges */
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .badge-new { background: rgba(59,130,246,0.2); color: var(--primary); }
        .badge-success { background: rgba(16,185,129,0.2); color: var(--success); }
        .badge-warning { background: rgba(245,158,11,0.2); color: var(--warning); }
        .badge-danger { background: rgba(239,68,68,0.2); color: var(--danger); }
        .badge-info { background: rgba(59,130,246,0.2); color: var(--info); }
        .badge-muted { background: rgba(100,116,139,0.2); color: var(--text-muted); }
        .specialist-services-checkboxes { max-height: 150px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; padding: 8px; background: var(--bg-input); border-radius: 8px; }
        .specialist-services-checkboxes label { display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .specialist-services-checkboxes label:hover { background: rgba(255,255,255,0.05); }

        /* Kanban */
        .kanban { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; }
        .kanban-column { min-width: 300px; max-width: 300px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); }
        .kanban-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .kanban-header h4 { font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .kanban-header .dot { width: 8px; height: 8px; border-radius: 50%; }
        .kanban-header .count { color: var(--text-muted); font-weight: normal; }
        .kanban-body { padding: 12px; min-height: 200px; max-height: 500px; overflow-y: auto; }
        .kanban-card { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: grab; }
        .kanban-card:hover { border-color: var(--primary); }
        .kanban-card-title { font-weight: 500; margin-bottom: 8px; }
        .kanban-card-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; }
        .kanban-add { padding: 8px 12px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .kanban-add:hover { color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .tab { padding: 12px 20px; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; margin-bottom: -1px; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Search & Filters */
        .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { width: 100%; padding: 10px 16px 10px 40px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); }
        .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .filter-select { padding: 10px 16px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); min-width: 150px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-card); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 14px; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        /* Empty state */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { margin-bottom: 8px; color: var(--text-secondary); }

        /* Section visibility */
        .section { display: none; }
        .section.active { display: block; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main { margin-left: 0; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Call Widget -->
    <div id="callWidgetBtn" onclick="toggleCallWidget()" style="position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:999;box-shadow:0 4px 20px rgba(59,130,246,0.4);transition:transform 0.2s;">
        <i class="fas fa-phone" style="color:#fff;font-size:20px;"></i>
    </div>
    <div id="callWidgetPanel" style="display:none;position:fixed;bottom:90px;right:24px;width:320px;background:var(--bg-card);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.4);z-index:999;overflow:hidden;">
        <div style="padding:16px;background:var(--primary);color:#fff;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <strong>Телефон</strong>
                <button onclick="toggleCallWidget()" style="background:none;border:none;color:#fff;cursor:pointer;font-size:16px;"><i class="fas fa-times"></i></button>
            </div>
            <div id="callActiveInfo" style="display:none;margin-top:12px;">
                <div id="callActiveName" style="font-size:14px;"></div>
                <div id="callActiveTimer" style="font-size:24px;font-weight:700;margin-top:4px;">0:00</div>
            </div>
        </div>
        <div style="padding:16px;">
            <div id="callWidgetDialer">
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input type="text" id="callWidgetPhone" placeholder="+7 (___) ___-__-__" style="flex:1;background:var(--bg-input);border:1px solid var(--border-color);border-radius:8px;padding:10px 12px;color:var(--text-primary);">
                    <button onclick="makeCallFromWidget()" style="background:var(--success);border:none;color:#fff;width:44px;border-radius:8px;cursor:pointer;font-size:16px;"><i class="fas fa-phone"></i></button>
                </div>
            </div>
            <div id="callWidgetEndBtn" style="display:none;text-align:center;margin-bottom:12px;">
                <button onclick="endCall()" style="background:var(--danger);border:none;color:#fff;padding:12px 32px;border-radius:24px;cursor:pointer;font-size:14px;"><i class="fas fa-phone-slash"></i> Завершить</button>
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Недавние</div>
            <div id="callWidgetRecent" style="max-height:200px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Incoming Call Popup -->
    <div id="incomingCallPopup" style="display:none;position:fixed;top:80px;right:24px;width:300px;background:var(--bg-card);border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.4);z-index:1000;overflow:hidden;animation:toastIn 0.3s ease;">
        <div style="padding:16px;background:var(--success);">
            <div style="display:flex;align-items:center;gap:8px;color:#fff;">
                <i class="fas fa-phone-volume"></i>
                <strong>Входящий звонок</strong>
            </div>
        </div>
        <div style="padding:16px;text-align:center;">
            <div id="incomingCallerName" style="font-size:16px;font-weight:600;margin-bottom:4px;"></div>
            <div id="incomingCallerPhone" style="color:var(--text-muted);font-size:14px;margin-bottom:16px;"></div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button onclick="answerIncomingCall()" style="background:var(--success);border:none;color:#fff;padding:10px 24px;border-radius:8px;cursor:pointer;"><i class="fas fa-phone"></i> Принять</button>
                <button onclick="rejectIncomingCall()" style="background:var(--danger);border:none;color:#fff;padding:10px 24px;border-radius:8px;cursor:pointer;"><i class="fas fa-phone-slash"></i> Отклонить</button>
            </div>
        </div>
    </div>

    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header" style="display:flex;align-items:center;justify-content:space-between;">
                <h1><i class="fas fa-cubes"></i> PK Business</h1>
                <button onclick="openModuleSettings()" title="Настройка модулей" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:4px 8px;border-radius:6px;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-muted)'"><i class="fas fa-cog"></i></button>
            </div>
            <nav class="nav-section">
                <div class="nav-title">Главное</div>
                <div class="nav-item active" data-section="dashboard"><i class="fas fa-home"></i> Дашборд</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Продажи</div>
                <div class="nav-item" data-section="sales"><i class="fas fa-handshake"></i> Продажи</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Клиенты</div>
                <div class="nav-item" data-section="clients"><i class="fas fa-users"></i> Клиенты</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Команда</div>
                <div class="nav-item" data-section="team"><i class="fas fa-user-tie"></i> Команда</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Магазин</div>
                <div class="nav-item" data-section="shop-orders"><i class="fas fa-shopping-cart"></i> Заказы</div>
                <div class="nav-item" data-section="catalog"><i class="fas fa-box"></i> Каталог</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Услуги</div>
                <div class="nav-item" data-section="appointments"><i class="fas fa-calendar-check"></i> Записи</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Обучение</div>
                <div class="nav-item" data-section="learning"><i class="fas fa-graduation-cap"></i> Обучение</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">Настройки</div>
                <div class="nav-item" data-section="integrations"><i class="fas fa-plug"></i> Интеграции</div>
            </nav>
            <nav class="nav-section">
                <div class="nav-item" onclick="location.href='admin.html'"><i class="fas fa-arrow-left"></i> Назад в панель</div>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main">
            <header class="header">
                <h2 id="pageTitle">Дашборд</h2>
                <div class="header-actions">
                    <button class="btn btn-primary" id="mainAction" style="display:none;">
                        <i class="fas fa-plus"></i> <span>Добавить</span>
                    </button>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard -->
                <div class="section active" id="section-dashboard">
                    <!-- Dashboard Header with Date Range -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm" onclick="setDashboardPeriod('today')" id="periodToday">Сегодня</button>
                            <button class="btn btn-sm btn-outline" onclick="setDashboardPeriod('week')" id="periodWeek">Неделя</button>
                            <button class="btn btn-sm btn-outline" onclick="setDashboardPeriod('month')" id="periodMonth">Месяц</button>
                            <button class="btn btn-sm btn-outline" onclick="setDashboardPeriod('year')" id="periodYear">Год</button>
                        </div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <input type="date" id="dashboardDateFrom" class="filter-select" style="padding:8px;">
                            <span>—</span>
                            <input type="date" id="dashboardDateTo" class="filter-select" style="padding:8px;">
                            <button class="btn btn-outline btn-sm" onclick="exportDashboard()"><i class="fas fa-download"></i> Экспорт</button>
                            <button class="btn btn-sm btn-outline" onclick="refreshDashboard()"><i class="fas fa-sync"></i></button>
                        </div>
                    </div>

                    <!-- Main Stats Row -->
                    <div class="stats-grid">
                        <div class="stat-card primary" data-module="sales" onclick="switchSection('sales')" style="cursor:pointer;">
                            <div class="value" id="stat-deals">0</div>
                            <div class="label">Активные сделки</div>
                            <div class="stat-trend up" id="trend-deals"><i class="fas fa-arrow-up"></i> +12%</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="stat-won">₽0</div>
                            <div class="label">Выиграно</div>
                            <div class="stat-trend up" id="trend-won"><i class="fas fa-arrow-up"></i> +8%</div>
                        </div>
                        <div class="stat-card warning" data-module="clients" onclick="switchSection('clients')" style="cursor:pointer;">
                            <div class="value" id="stat-clients">0</div>
                            <div class="label">Клиентов</div>
                            <div class="stat-trend up" id="trend-clients"><i class="fas fa-arrow-up"></i> +5%</div>
                        </div>
                        <div class="stat-card" data-module="orders" onclick="switchSection('shop-orders')" style="cursor:pointer;">
                            <div class="value" id="stat-orders">0</div>
                            <div class="label">Заказов</div>
                            <div class="stat-trend" id="trend-orders">—</div>
                        </div>
                        <div class="stat-card" data-module="team" onclick="switchSection('team'); switchSectionTab('team','tasks')" style="cursor:pointer;">
                            <div class="value" id="stat-tasks">0</div>
                            <div class="label">Задач в работе</div>
                        </div>
                        <div class="stat-card" style="border-left: 3px solid var(--danger);">
                            <div class="value" id="stat-overdue" style="color: var(--danger);">0</div>
                            <div class="label">Просрочено</div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-top:24px;">
                        <!-- Revenue Chart -->
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-line"></i> Выручка</h3>
                            </div>
                            <div class="card-body">
                                <div id="revenueChart" style="height:200px;display:flex;align-items:flex-end;gap:4px;padding:10px 0;">
                                    <!-- Chart bars will be rendered here -->
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-top:8px;">
                                    <span>Пн</span><span>Вт</span><span>Ср</span><span>Чт</span><span>Пт</span><span>Сб</span><span>Вс</span>
                                </div>
                            </div>
                        </div>
                        <!-- Funnel Visualization -->
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-filter"></i> Воронка</h3>
                            </div>
                            <div class="card-body">
                                <div id="funnelChart" style="padding:10px;">
                                    <!-- Funnel stages will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Extended Stats Row -->
                    <div class="stats-grid" style="margin-top:16px;">
                        <div class="stat-card" data-module="bookings" onclick="switchSection('appointments')" style="cursor:pointer;">
                            <div class="value" id="stat-bookings">0</div>
                            <div class="label"><i class="fas fa-calendar-check"></i> Записей сегодня</div>
                        </div>
                        <div class="stat-card" data-module="learning" onclick="switchSection('learning')" style="cursor:pointer;">
                            <div class="value" id="stat-students">0</div>
                            <div class="label"><i class="fas fa-graduation-cap"></i> Студентов</div>
                        </div>
                        <div class="stat-card" data-module="learning" onclick="switchSection('learning'); switchSectionTab('learning','webinars')" style="cursor:pointer;">
                            <div class="value" id="stat-webinars">0</div>
                            <div class="label"><i class="fas fa-video"></i> Вебинаров</div>
                        </div>
                        <div class="stat-card" data-module="sales" onclick="switchSection('sales'); switchSectionTab('sales','calls')" style="cursor:pointer;">
                            <div class="value" id="stat-calls">0</div>
                            <div class="label"><i class="fas fa-phone"></i> Звонков сегодня</div>
                        </div>
                        <div class="stat-card" data-module="catalog" onclick="switchSection('catalog')" style="cursor:pointer;">
                            <div class="value" id="stat-products">0</div>
                            <div class="label"><i class="fas fa-box"></i> Товаров</div>
                        </div>
                        <div class="stat-card" onclick="switchSection('catalog'); switchSectionTab('catalog','promos')" style="cursor:pointer;">
                            <div class="value" id="stat-promos">0</div>
                            <div class="label"><i class="fas fa-percent"></i> Промокодов</div>
                        </div>
                    </div>

                    <!-- AI Insights -->
                    <div class="card" style="margin: 24px 0;">
                        <div class="card-header">
                            <h3><i class="fas fa-robot" style="color: var(--primary); margin-right: 8px;"></i>AI-рекомендации</h3>
                            <button class="btn btn-sm btn-outline" onclick="loadAIInsights()"><i class="fas fa-sync"></i></button>
                        </div>
                        <div class="card-body" style="padding: 16px;">
                            <div id="aiInsights" class="stats-grid" style="gap: 12px;"></div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div class="card">
                            <div class="card-header">
                                <h3>Последние сделки</h3>
                                <a href="#deals" onclick="switchSection('sales')" style="color:var(--primary);font-size:13px;">Все →</a>
                            </div>
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Сделка</th>
                                            <th>Клиент</th>
                                            <th>Сумма</th>
                                            <th>Этап</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentDeals">
                                        <tr><td colspan="4"><div class="empty-state"><i class="fas fa-handshake"></i><h3>Нет сделок</h3></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Записи на сегодня</h3>
                                <a href="#bookings" onclick="switchSection('appointments')" style="color:var(--primary);font-size:13px;">Все →</a>
                            </div>
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Время</th>
                                            <th>Клиент</th>
                                            <th>Услуга</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody id="todayBookings">
                                        <tr><td colspan="4"><div class="empty-state"><i class="fas fa-calendar-check"></i><h3>Нет записей</h3></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top:24px;">
                        <div class="card">
                            <div class="card-header">
                                <h3>Последние заказы</h3>
                                <a href="#orders" onclick="switchSection('shop-orders')" style="color:var(--primary);font-size:13px;">Все →</a>
                            </div>
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Заказ</th>
                                            <th>Сумма</th>
                                            <th>Статус</th>
                                            <th>Дата</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentOrders">
                                        <tr><td colspan="4"><div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>Нет заказов</h3></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Активность курсов</h3>
                                <a href="#courses" onclick="switchSection('learning')" style="color:var(--primary);font-size:13px;">Все →</a>
                            </div>
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Курс</th>
                                            <th>Студентов</th>
                                            <th>Прогресс</th>
                                            <th>Завершили</th>
                                        </tr>
                                    </thead>
                                    <tbody id="courseActivity">
                                        <tr><td colspan="4"><div class="empty-state"><i class="fas fa-graduation-cap"></i><h3>Нет курсов</h3></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales -->
                <div class="section" id="section-sales">
                    <div class="section-tabs">
                        <button class="section-tab-btn active" id="salesTab_deals" onclick="switchSectionTab('sales','deals')"><i class="fas fa-filter"></i> Воронки</button>
                        <button class="section-tab-btn" id="salesTab_calls" onclick="switchSectionTab('sales','calls')"><i class="fas fa-phone"></i> Звонки</button>
                        <button class="section-tab-btn" id="salesTab_regulations" onclick="switchSectionTab('sales','regulations')"><i class="fas fa-clock"></i> Регламенты</button>
                        <button class="section-tab-btn" id="salesTab_goals" onclick="switchSectionTab('sales','goals')"><i class="fas fa-bullseye"></i> KPI/Цели</button>
                        <button class="section-tab-btn" id="salesTab_distribution" onclick="switchSectionTab('sales','distribution')"><i class="fas fa-random"></i> Распределение</button>
                    </div>
                    <div id="salesTabPanel_deals">
                    <!-- Funnel selector + stats row -->
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
                        <select class="filter-select" id="filterFunnel" onchange="loadDealsKanban()" style="font-size:15px;font-weight:600;min-width:200px;padding:10px 14px;">
                            <option value="">Выберите воронку</option>
                        </select>
                        <button class="btn btn-sm btn-outline" onclick="openModal('funnelModal')" title="Создать воронку"><i class="fas fa-plus"></i> Воронка</button>
                        <button class="btn btn-sm btn-outline" onclick="openAddStageModal()" title="Добавить этап"><i class="fas fa-columns"></i> Этап</button>
                        <button class="btn btn-sm btn-outline btn-danger" id="deleteFunnelBtn" onclick="deleteCurrentFunnel()" title="Удалить воронку" style="display:none;"><i class="fas fa-trash"></i></button>
                        <div style="flex:1;"></div>
                        <div style="display:flex;gap:16px;font-size:13px;color:var(--text-muted);">
                            <span><b id="salesStat-count">0</b> сделок</span>
                            <span>Воронка: <b id="salesStat-pipeline">₽0</b></span>
                            <span>Win: <b id="salesStat-winRate">0%</b></span>
                        </div>
                    </div>
                    <!-- Filters row -->
                    <div class="toolbar" style="flex-wrap:wrap;margin-bottom:12px;">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchDeals" placeholder="Поиск сделок..." oninput="filterDeals()">
                        </div>
                        <select class="filter-select" id="filterDealEmployee" onchange="loadDealsKanban()">
                            <option value="">Все менеджеры</option>
                        </select>
                        <select class="filter-select" id="filterDealSource" onchange="loadDealsKanban()">
                            <option value="">Все источники</option>
                            <option value="website">Сайт</option>
                            <option value="phone">Телефон</option>
                            <option value="referral">Реферал</option>
                            <option value="social">Соцсети</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('dealModal')"><i class="fas fa-plus"></i> Новая сделка</button>
                    </div>
                    <!-- Kanban board -->
                    <div class="kanban" id="dealsKanban"></div>
                    </div>
                    <div id="salesTabPanel_calls" style="display:none;">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchCalls" placeholder="Поиск звонков...">
                        </div>
                        <select class="filter-select" id="callsDirection">
                            <option value="">Все направления</option>
                            <option value="incoming">Входящие</option>
                            <option value="outgoing">Исходящие</option>
                        </select>
                    </div>

                    <!-- UIS Integration Settings -->
                    <div class="card" style="margin-bottom:20px;">
                        <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
                            <h3><i class="fas fa-headset"></i> UIS Телефония</h3>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <span id="uisConnectionStatus" style="display:flex;align-items:center;gap:6px;font-size:12px;">
                                    <i class="fas fa-circle" style="font-size:8px;color:var(--text-muted);"></i> Не подключено
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                                <div class="form-group">
                                    <label>API ключ</label>
                                    <input type="password" id="uisApiKey" placeholder="Введите API ключ UIS">
                                </div>
                                <div class="form-group">
                                    <label>Виртуальный номер</label>
                                    <input type="text" id="uisVirtualNumber" placeholder="+7 (XXX) XXX-XX-XX">
                                </div>
                                <div class="form-group">
                                    <label>Webhook URL</label>
                                    <input type="text" id="uisWebhookUrl" readonly style="background:var(--bg-dark);font-size:11px;" value="">
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;margin-top:8px;">
                                <button class="btn btn-primary btn-sm" onclick="connectUIS()"><i class="fas fa-plug"></i> Подключить</button>
                                <button class="btn btn-outline btn-sm" onclick="disconnectUIS()" id="uisDisconnectBtn" style="display:none;"><i class="fas fa-unlink"></i> Отключить</button>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="value" id="callsTotal">0</div>
                            <div class="label">Всего звонков</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="callsAnswered">0</div>
                            <div class="label">Отвечено</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="callsMissed">0</div>
                            <div class="label">Пропущено</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="callsDuration">0:00</div>
                            <div class="label">Ср. длительность</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Журнал звонков</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Направление</th>
                                        <th>Клиент</th>
                                        <th>Менеджер</th>
                                        <th>Длительность</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="callsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="salesTabPanel_regulations" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openRegulationEditor()"><i class="fas fa-plus"></i> Новый регламент</button>
                    </div>
                    <div class="stats-grid" id="regulationsGrid" style="grid-template-columns:repeat(auto-fill,minmax(280px,1fr));">
                        <!-- Rendered by JS -->
                    </div>
                    </div>
                    <div id="salesTabPanel_goals" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('goalModal')"><i class="fas fa-plus"></i> Создать цель</button>
                        <select class="filter-select" id="goalsPeriod">
                            <option value="month">Этот месяц</option>
                            <option value="quarter">Квартал</option>
                            <option value="year">Год</option>
                        </select>
                    </div>
                    <div class="stats-grid" id="goalsList"></div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Лидерборд</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Сотрудник</th>
                                        <th>Выручка</th>
                                        <th>Сделок</th>
                                        <th>Конверсия</th>
                                        <th>Прогресс</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="salesTabPanel_distribution" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('distributionModal')"><i class="fas fa-cog"></i> Настройки</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="value" id="leadsInQueue">0</div>
                            <div class="label">В очереди</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="leadsAssigned">0</div>
                            <div class="label">Распределено сегодня</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="leadsExpired">0</div>
                            <div class="label">Просрочено</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Очередь лидов</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Сделка</th>
                                        <th>Источник</th>
                                        <th>Назначен</th>
                                        <th>Истекает</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="leadQueueTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>



                <!-- Clients -->
                <div class="section" id="section-clients">
                    <!-- Tabs -->
                    <div class="section-tabs">
                        <button class="section-tab-btn active" onclick="switchClientsTab('users')" id="clientsTabUsers"><i class="fas fa-users"></i> Пользователи</button>
                        <button class="section-tab-btn" onclick="switchClientsTab('segments')" id="clientsTabSegments"><i class="fas fa-layer-group"></i> Сегменты</button>
                        <button class="section-tab-btn" onclick="switchClientsTab('groups')" id="clientsTabGroups"><i class="fas fa-object-group"></i> Группы</button>
                        <button class="section-tab-btn" onclick="switchClientsTab('tags')" id="clientsTabTags"><i class="fas fa-tags"></i> Теги</button>
                    </div>

                    <!-- Tab: Users -->
                    <div id="clientsTabPanelUsers">
                        <div class="toolbar" style="flex-wrap:wrap;">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchClients" placeholder="Поиск клиентов..." oninput="filterClients()">
                            </div>
                            <select class="filter-select" id="filterClientTag" onchange="filterClients()">
                                <option value="">Все теги</option>
                            </select>
                            <select class="filter-select" id="filterClientCourse" onchange="filterClients()">
                                <option value="">Все курсы</option>
                                <option value="has_course">Есть доступ к курсу</option>
                                <option value="no_course">Нет курсов</option>
                                <option value="completed_course">Прошёл курс</option>
                                <option value="in_progress">Проходит курс</option>
                            </select>
                            <select class="filter-select" id="filterClientBooking" onchange="filterClients()">
                                <option value="">Все записи</option>
                                <option value="has_booking">Есть записи</option>
                                <option value="no_booking">Нет записей</option>
                                <option value="upcoming">Предстоящая запись</option>
                                <option value="visited">Был на визите</option>
                            </select>
                            <select class="filter-select" id="filterClientOrder" onchange="filterClients()">
                                <option value="">Все заказы</option>
                                <option value="has_order">Есть заказы</option>
                                <option value="no_order">Нет заказов</option>
                                <option value="repeat">Повторные покупки</option>
                            </select>
                            <button class="btn btn-outline" onclick="openModal('importClientsModal')"><i class="fas fa-file-import"></i> Импорт</button>
                            <button class="btn btn-outline" onclick="exportClients()"><i class="fas fa-download"></i> Экспорт</button>
                            <button class="btn btn-primary" onclick="openModal('clientModal')"><i class="fas fa-plus"></i> Добавить</button>
                        </div>
                        <div class="stats-grid" style="margin-bottom:16px;">
                            <div class="stat-card"><div class="value" id="clientsTotal">0</div><div class="label">Всего клиентов</div></div>
                            <div class="stat-card primary"><div class="value" id="clientsWithCourses">0</div><div class="label">С курсами</div></div>
                            <div class="stat-card success"><div class="value" id="clientsWithBookings">0</div><div class="label">С записями</div></div>
                            <div class="stat-card warning"><div class="value" id="clientsWithOrders">0</div><div class="label">С заказами</div></div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Клиент</th>
                                            <th>Контакты</th>
                                            <th>Источник</th>
                                            <th>Теги</th>
                                            <th>Курсы</th>
                                            <th>Записи</th>
                                            <th>Заказы</th>
                                            <th>Сумма</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Segments -->
                    <div id="clientsTabPanelSegments" style="display:none;">
                        <div class="toolbar">
                            <button class="btn btn-primary" onclick="openModal('segmentModal')"><i class="fas fa-plus"></i> Создать сегмент</button>
                        </div>
                        <div id="segmentsList" class="stats-grid"></div>
                    </div>

                    <!-- Tab: Groups -->
                    <div id="clientsTabPanelGroups" style="display:none;">
                        <div class="toolbar">
                            <button class="btn btn-primary" onclick="openModal('groupModal')"><i class="fas fa-plus"></i> Создать группу</button>
                        </div>
                        <div id="groupsList" class="stats-grid"></div>
                    </div>

                    <!-- Tab: Tags -->
                    <div id="clientsTabPanelTags" style="display:none;">
                        <div class="toolbar">
                            <button class="btn btn-primary" onclick="openModal('tagModal')"><i class="fas fa-plus"></i> Создать тег</button>
                            <select class="filter-select" id="tagsEntity" onchange="loadTags()">
                                <option value="deal">Для сделок</option>
                                <option value="client">Для клиентов</option>
                            </select>
                        </div>
                        <div id="tagsList" class="stats-grid"></div>
                    </div>
                </div>


                <!-- Team -->
                <div class="section" id="section-team">
                    <div class="section-tabs">
                        <button class="section-tab-btn active" id="teamTab_employees" onclick="switchSectionTab('team','employees')"><i class="fas fa-user-tie"></i> Сотрудники</button>
                        <button class="section-tab-btn" id="teamTab_tasks" onclick="switchSectionTab('team','tasks')"><i class="fas fa-tasks"></i> Задачи</button>
                        <button class="section-tab-btn" id="teamTab_analytics" onclick="switchSectionTab('team','analytics')"><i class="fas fa-chart-bar"></i> Аналитика</button>
                    </div>
                    <div id="teamTabPanel_employees">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('employeeModal')"><i class="fas fa-plus"></i> Добавить сотрудника</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Должность</th>
                                        <th>Email</th>
                                        <th>Роль</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="teamTabPanel_tasks" style="display:none;">
                    <div class="toolbar">
                        <select class="filter-select" id="filterTaskStatus" onchange="loadTasks()">
                            <option value="">Все задачи</option>
                            <option value="pending">Ожидают</option>
                            <option value="in_progress">В работе</option>
                            <option value="completed">Завершены</option>
                        </select>
                        <div style="display:flex;gap:4px;">
                            <button class="btn btn-sm" id="taskViewList" onclick="switchTaskView('list')" style="background:var(--primary);color:#fff;"><i class="fas fa-list"></i></button>
                            <button class="btn btn-sm btn-outline" id="taskViewCalendar" onclick="switchTaskView('calendar')"><i class="fas fa-calendar-alt"></i></button>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('taskModal')"><i class="fas fa-plus"></i> Создать задачу</button>
                    </div>
                    <div id="tasksListView">
                        <div class="card">
                            <div class="card-body">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Задача</th>
                                            <th>Исполнитель</th>
                                            <th>Приоритет</th>
                                            <th>Срок</th>
                                            <th>Статус</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tasksTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="tasksCalendarView" style="display:none;">
                        <div class="card">
                            <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
                                <button class="btn btn-outline btn-sm" onclick="moveTaskCalendar(-1)"><i class="fas fa-chevron-left"></i></button>
                                <h3 id="taskCalendarMonth"></h3>
                                <button class="btn btn-outline btn-sm" onclick="moveTaskCalendar(1)"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="card-body">
                                <div id="taskCalendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;"></div>
                            </div>
                        </div>
                    </div>
                    </div>
                    <div id="teamTabPanel_analytics" style="display:none;">
                    <div class="toolbar">
                        <select class="filter-select" id="analyticsPeriod">
                            <option value="today">Сегодня</option>
                            <option value="week">Неделя</option>
                            <option value="month" selected>Месяц</option>
                        </select>
                        <select class="filter-select" id="analyticsEmployee">
                            <option value="">Все сотрудники</option>
                        </select>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="value" id="analyticsDeals">0</div>
                            <div class="label">Сделок закрыто</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="analyticsRevenue">0 ₽</div>
                            <div class="label">Выручка</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="analyticsCalls">0</div>
                            <div class="label">Звонков</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="analyticsConversion">0%</div>
                            <div class="label">Конверсия</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Активность сотрудников</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Статус</th>
                                        <th>Сделок</th>
                                        <th>Звонков</th>
                                        <th>Конверсия</th>
                                        <th>Последняя активность</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeAnalyticsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>


                <!-- Orders -->
                <div class="section" id="section-shop-orders">
                    <div class="section-tabs">
                        <button class="section-tab-btn active" id="ordersTab_orders" onclick="switchSectionTab('orders','orders')"><i class="fas fa-shopping-cart"></i> Заказы</button>
                        <button class="section-tab-btn" id="ordersTab_payments" onclick="switchSectionTab('orders','payments')"><i class="fas fa-credit-card"></i> Платежи</button>
                    </div>
                    <div id="ordersTabPanel_orders">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchOrders" placeholder="Поиск заказов..." oninput="searchOrders()">
                        </div>
                        <select class="filter-select" id="filterOrderStatus" onchange="loadOrders()">
                            <option value="">Все статусы</option>
                            <option value="new">Новый</option>
                            <option value="processing">В обработке</option>
                            <option value="confirmed">Согласован</option>
                            <option value="assembled">Собран</option>
                            <option value="shipped">Отправлен</option>
                            <option value="delivered">Доставлен</option>
                            <option value="cancelled">Отменён</option>
                            <option value="refund">Возврат</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('orderModal')"><i class="fas fa-plus"></i> Создать заказ</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>№ заказа</th>
                                        <th>Клиент</th>
                                        <th>Сумма</th>
                                        <th>Статус</th>
                                        <th>Оплата</th>
                                        <th>Дата</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="ordersTabPanel_payments" style="display:none;">
                    <div class="toolbar">
                        <select class="filter-select" id="filterPaymentStatus" onchange="loadPayments()">
                            <option value="">Все платежи</option>
                            <option value="completed">Успешные</option>
                            <option value="pending">Ожидают</option>
                            <option value="failed">Неуспешные</option>
                        </select>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Заказ</th>
                                        <th>Сумма</th>
                                        <th>Метод</th>
                                        <th>Статус</th>
                                        <th>Дата</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>


                <!-- Catalog -->
                <div class="section" id="section-catalog">
                    <div class="section-tabs">
                        <button class="section-tab-btn active" id="catalogTab_products" onclick="switchSectionTab('catalog','products')"><i class="fas fa-box"></i> Товары</button>
                        <button class="section-tab-btn" id="catalogTab_categories" onclick="switchSectionTab('catalog','categories')"><i class="fas fa-folder"></i> Категории</button>
                        <button class="section-tab-btn" id="catalogTab_selections" onclick="switchSectionTab('catalog','selections')"><i class="fas fa-star"></i> Подборки</button>
                        <button class="section-tab-btn" id="catalogTab_promos" onclick="switchSectionTab('catalog','promos')"><i class="fas fa-percent"></i> Промокоды</button>
                        <button class="section-tab-btn" id="catalogTab_filters" onclick="switchSectionTab('catalog','filters')"><i class="fas fa-sliders-h"></i> Фильтры</button>
                    </div>
                    <div id="catalogTabPanel_products">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchProducts" placeholder="Поиск товаров..." oninput="searchProducts()">
                        </div>
                        <select class="filter-select" id="filterProductCategory" onchange="filterProducts()">
                            <option value="">Все категории</option>
                        </select>
                        <select class="filter-select" id="filterProductType" onchange="filterProducts()">
                            <option value="">Все типы</option>
                            <option value="physical">Физический товар</option>
                            <option value="digital">Цифровой товар</option>
                            <option value="online">Онлайн-продукт</option>
                        </select>
                        <button class="btn btn-outline" onclick="openModal('importXmlModal')"><i class="fas fa-file-import"></i> Импорт XML</button>
                        <button class="btn btn-primary" onclick="openModal('productModal')"><i class="fas fa-plus"></i> Добавить товар</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Товар</th>
                                        <th>Артикул</th>
                                        <th>Цена</th>
                                        <th>Остаток</th>
                                        <th>Статус</th>
                                        <th>Ссылка</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="productsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="catalogTabPanel_categories" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('categoryModal')"><i class="fas fa-plus"></i> Добавить категорию</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div id="categoriesTree" class="categories-tree"></div>
                        </div>
                    </div>
                    </div>
                    <div id="catalogTabPanel_selections" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('selectionModal')"><i class="fas fa-plus"></i> Создать подборку</button>
                    </div>
                    <div id="selectionsList" class="stats-grid"></div>
                    </div>
                    <div id="catalogTabPanel_promos" style="display:none;">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchPromo" placeholder="Поиск промокода..." oninput="filterPromoCodes()">
                        </div>
                        <select class="filter-select" id="filterPromoStatus" onchange="filterPromoCodes()">
                            <option value="">Все статусы</option>
                            <option value="active">Активные</option>
                            <option value="expired">Истёкшие</option>
                            <option value="disabled">Отключённые</option>
                        </select>
                        <button class="btn btn-outline" onclick="generateBulkPromos()"><i class="fas fa-magic"></i> Генератор</button>
                        <button class="btn btn-primary" onclick="openModal('promoModal')"><i class="fas fa-plus"></i> Создать промокод</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="promosActive">0</div>
                            <div class="label">Активных</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="promosUsed">0</div>
                            <div class="label">Использовано</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="promosSaved">0 ₽</div>
                            <div class="label">Сумма скидок</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Промокоды</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Код</th>
                                        <th>Тип</th>
                                        <th>Скидка</th>
                                        <th>Использовано</th>
                                        <th>Лимит</th>
                                        <th>Мин. сумма</th>
                                        <th>Период</th>
                                        <th>Товары</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="promoCodesTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="catalogTabPanel_filters" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('productFilterModal')"><i class="fas fa-plus"></i> Добавить фильтр</button>
                    </div>
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                        <div class="card" style="cursor:pointer;" onclick="openFilterEditor('size')">
                            <div class="card-body">
                                <h4><i class="fas fa-ruler"></i> Размер</h4>
                                <p style="color:var(--text-muted);">XS, S, M, L, XL, XXL</p>
                            </div>
                        </div>
                        <div class="card" style="cursor:pointer;" onclick="openFilterEditor('color')">
                            <div class="card-body">
                                <h4><i class="fas fa-palette"></i> Цвет</h4>
                                <p style="color:var(--text-muted);">Белый, Чёрный, Красный, Синий...</p>
                            </div>
                        </div>
                        <div class="card" style="cursor:pointer;" onclick="openFilterEditor('material')">
                            <div class="card-body">
                                <h4><i class="fas fa-tshirt"></i> Материал</h4>
                                <p style="color:var(--text-muted);">Хлопок, Полиэстер, Шерсть...</p>
                            </div>
                        </div>
                        <div class="card" style="cursor:pointer;" onclick="openFilterEditor('brand')">
                            <div class="card-body">
                                <h4><i class="fas fa-building"></i> Бренд</h4>
                                <p style="color:var(--text-muted);">Добавьте бренды товаров</p>
                            </div>
                        </div>
                        <div id="customFiltersGrid"></div>
                    </div>
                    </div>
                </div>


                <!-- Appointments -->
                <div class="section" id="section-appointments">
                    <div class="section-tabs">
                        <button class="section-tab-btn active" id="bookingsTab_calendar" onclick="switchSectionTab('bookings','calendar')"><i class="fas fa-calendar-check"></i> Календарь</button>
                        <button class="section-tab-btn" id="bookingsTab_services" onclick="switchSectionTab('bookings','services')"><i class="fas fa-concierge-bell"></i> Услуги</button>
                        <button class="section-tab-btn" id="bookingsTab_specialists" onclick="switchSectionTab('bookings','specialists')"><i class="fas fa-user-md"></i> Специалисты</button>
                        <button class="section-tab-btn" id="bookingsTab_rooms" onclick="switchSectionTab('bookings','rooms')"><i class="fas fa-door-open"></i> Помещения</button>
                        <button class="section-tab-btn" id="bookingsTab_schedules" onclick="switchSectionTab('bookings','schedules')"><i class="fas fa-calendar-alt"></i> Расписание</button>
                    </div>
                    <div id="bookingsTabPanel_calendar">
                    <div class="toolbar">
                        <select class="filter-select" id="filterBookingSpecialist" onchange="loadBookingsCalendar()">
                            <option value="">Все специалисты</option>
                        </select>
                        <select class="filter-select" id="filterBookingService" onchange="loadBookingsCalendar()">
                            <option value="">Все услуги</option>
                        </select>
                        <select class="filter-select" id="filterBookingBranch" onchange="loadBookingsCalendar()">
                            <option value="">Все филиалы</option>
                        </select>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button class="btn btn-outline btn-sm" onclick="moveBookingsWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                            <input type="date" class="filter-select" id="bookingsWeekStart" style="min-width:140px;" onchange="loadBookingsCalendar()">
                            <button class="btn btn-outline btn-sm" onclick="moveBookingsWeek(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <button class="btn btn-primary" onclick="openNewBookingModal()"><i class="fas fa-plus"></i> Новая запись</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="bookingsToday">0</div>
                            <div class="label">Записей сегодня</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="bookingsConfirmed">0</div>
                            <div class="label">Подтверждено</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="bookingsPending">0</div>
                            <div class="label">Ожидает</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="bookingsRevenue">0 ₽</div>
                            <div class="label">Выручка за неделю</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" style="overflow-x:auto;">
                            <table class="bookings-calendar" id="bookingsCalendarTable">
                                <thead>
                                    <tr id="bookingsCalendarHeader">
                                        <th style="width:60px;">Время</th>
                                        <!-- Days will be generated dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="bookingsCalendarBody">
                                    <!-- Time slots will be generated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="bookingsTabPanel_services" style="display:none;">
                    <div class="toolbar">
                        <select class="filter-select" id="filterServiceType" onchange="filterServices()">
                            <option value="">Все типы</option>
                            <option value="individual">Индивидуальные</option>
                            <option value="group">Групповые</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('serviceModal')"><i class="fas fa-plus"></i> Добавить услугу</button>
                    </div>
                    <div id="servicesList" class="stats-grid"></div>
                    </div>
                    <div id="bookingsTabPanel_specialists" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('specialistModal')"><i class="fas fa-plus"></i> Добавить специалиста</button>
                    </div>
                    <div id="specialistsList" class="stats-grid"></div>
                    </div>
                    <div id="bookingsTabPanel_rooms" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('roomModal')"><i class="fas fa-plus"></i> Добавить помещение</button>
                    </div>
                    <div id="roomsList" class="stats-grid"></div>
                    </div>
                    <div id="bookingsTabPanel_schedules" style="display:none;">
                    <div class="toolbar">
                        <select class="filter-select" id="scheduleEmployee">
                            <option value="">Все сотрудники</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('scheduleModal')"><i class="fas fa-plus"></i> Настроить расписание</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Расписание сотрудников</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Пн</th>
                                        <th>Вт</th>
                                        <th>Ср</th>
                                        <th>Чт</th>
                                        <th>Пт</th>
                                        <th>Сб</th>
                                        <th>Вс</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="schedulesTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>


                <!-- Learning -->
                <div class="section" id="section-learning">
                    <div class="section-tabs">
                        <button class="section-tab-btn active" id="learningTab_trainings" onclick="switchSectionTab('learning','trainings')"><i class="fas fa-graduation-cap"></i> Курсы</button>
                        <button class="section-tab-btn" id="learningTab_lessons" onclick="switchSectionTab('learning','lessons')"><i class="fas fa-book-open"></i> Уроки</button>
                        <button class="section-tab-btn" id="learningTab_webinars" onclick="switchSectionTab('learning','webinars')"><i class="fas fa-video"></i> Вебинары</button>
                        <button class="section-tab-btn" id="learningTab_quizzes" onclick="switchSectionTab('learning','quizzes')"><i class="fas fa-question-circle"></i> Тесты</button>
                        <button class="section-tab-btn" id="learningTab_certificates" onclick="switchSectionTab('learning','certificates')"><i class="fas fa-certificate"></i> Сертификаты</button>
                    </div>
                    <div id="learningTabPanel_trainings">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchTrainings" placeholder="Поиск тренингов...">
                        </div>
                        <select class="filter-select" id="filterTrainingAccess">
                            <option value="">Все типы доступа</option>
                            <option value="purchase">После покупки</option>
                            <option value="group">По группе</option>
                            <option value="free">Бесплатный</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('trainingModal')"><i class="fas fa-plus"></i> Создать тренинг</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="trainingsTotal">0</div>
                            <div class="label">Тренингов</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="trainingsStudents">0</div>
                            <div class="label">Учеников</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="trainingsCompletion">0%</div>
                            <div class="label">Ср. прохождение</div>
                        </div>
                    </div>
                    <div id="trainingsList" class="stats-grid"></div>
                    </div>
                    <div id="learningTabPanel_lessons" style="display:none;">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchLessons" placeholder="Поиск уроков...">
                        </div>
                        <select class="filter-select" id="filterLessonTraining">
                            <option value="">Все тренинги</option>
                        </select>
                        <select class="filter-select" id="filterLessonType">
                            <option value="">Все типы</option>
                            <option value="video">Видео</option>
                            <option value="text">Текст</option>
                            <option value="quiz">Тест</option>
                            <option value="homework">Домашнее задание</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('lessonModal')"><i class="fas fa-plus"></i> Создать урок</button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>№</th>
                                        <th>Урок</th>
                                        <th>Тренинг</th>
                                        <th>Тип</th>
                                        <th>Длительность</th>
                                        <th>Прошли</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="lessonsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="learningTabPanel_webinars" style="display:none;">
                    <div class="toolbar">
                        <select class="filter-select" id="filterWebinarType" onchange="filterWebinars()">
                            <option value="">Все типы</option>
                            <option value="live">Живой вебинар</option>
                            <option value="auto">Автовебинар</option>
                        </select>
                        <select class="filter-select" id="filterWebinarStatus" onchange="filterWebinars()">
                            <option value="">Все статусы</option>
                            <option value="scheduled">Запланирован</option>
                            <option value="live">Идёт сейчас</option>
                            <option value="completed">Завершён</option>
                        </select>
                        <button class="btn btn-outline" onclick="openModal('autoWebinarModal')"><i class="fas fa-robot"></i> Создать автовебинар</button>
                        <button class="btn btn-primary" onclick="openModal('webinarModal')"><i class="fas fa-video"></i> Создать вебинар</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="webinarsUpcoming">0</div>
                            <div class="label">Запланировано</div>
                        </div>
                        <div class="stat-card success" style="cursor:pointer;" onclick="filterWebinarsByStatus('live')">
                            <div class="value" id="webinarsLive">0</div>
                            <div class="label">Сейчас в эфире</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="webinarsCompleted">0</div>
                            <div class="label">Проведено</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="value" id="webinarsParticipants">0</div>
                            <div class="label">Всего участников</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>Вебинарные комнаты</h3>
                        </div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Тип</th>
                                        <th>Дата/Время</th>
                                        <th>Ведущий</th>
                                        <th>Регистраций</th>
                                        <th>Ссылка</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="webinarsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="learningTabPanel_quizzes" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('quizModal')"><i class="fas fa-plus"></i> Создать тест</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Тесты и квизы</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Курс</th>
                                        <th>Вопросов</th>
                                        <th>Попыток</th>
                                        <th>Ср. балл</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="quizzesTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                    <div id="learningTabPanel_certificates" style="display:none;">
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchCertificates" placeholder="Поиск по номеру или имени...">
                        </div>
                        <button class="btn btn-outline" onclick="openModal('certificateTemplateModal')"><i class="fas fa-paint-brush"></i> Редактор шаблонов</button>
                        <button class="btn btn-primary" onclick="openModal('issueCertificateModal')"><i class="fas fa-plus"></i> Выдать сертификат</button>
                    </div>
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card primary">
                            <div class="value" id="certificatesIssued">0</div>
                            <div class="label">Выдано сертификатов</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="certificateTemplates">0</div>
                            <div class="label">Шаблонов</div>
                        </div>
                    </div>

                    <!-- Certificate Templates -->
                    <div class="card" style="margin-bottom:20px;">
                        <div class="card-header"><h3>Шаблоны сертификатов</h3></div>
                        <div class="card-body">
                            <div class="stats-grid" id="certificateTemplatesList" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                                <div class="template-card" onclick="openModal('certificateTemplateModal')" style="border:2px dashed var(--border-color);padding:40px;text-align:center;cursor:pointer;border-radius:8px;">
                                    <i class="fas fa-plus" style="font-size:24px;color:var(--text-muted);"></i>
                                    <p style="color:var(--text-muted);margin-top:10px;">Создать шаблон</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Issued Certificates -->
                    <div class="card">
                        <div class="card-header"><h3>Выданные сертификаты</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Номер</th>
                                        <th>Студент</th>
                                        <th>Тренинг</th>
                                        <th>Шаблон</th>
                                        <th>Дата выдачи</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="certificatesTable"></tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>


                <!-- Integrations -->
                <div class="section" id="section-integrations">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openModal('integrationModal')"><i class="fas fa-plus"></i> Добавить интеграцию</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="value" id="integrationsActive">0</div>
                            <div class="label">Активных интеграций</div>
                        </div>
                        <div class="stat-card primary">
                            <div class="value" id="integrationsWebhooks">0</div>
                            <div class="label">Вебхуков</div>
                        </div>
                        <div class="stat-card success">
                            <div class="value" id="integrationsForms">0</div>
                            <div class="label">Веб-форм</div>
                        </div>
                    </div>
                    <!-- Delivery Providers -->
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3><i class="fas fa-truck"></i> Службы доставки</h3></div>
                        <div class="card-body">
                            <div class="stats-grid" id="deliveryProvidersGrid">
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('delivery','pochta')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#1a5276;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">📦</div>
                                        <div>
                                            <strong>Почта России</strong>
                                            <div id="deliveryStatus_pochta" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('delivery','cdek')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#00b33c;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">📦</div>
                                        <div>
                                            <strong>СДЭК</strong>
                                            <div id="deliveryStatus_cdek" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('delivery','boxberry')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#e74c3c;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">📦</div>
                                        <div>
                                            <strong>Boxberry</strong>
                                            <div id="deliveryStatus_boxberry" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('delivery','dpd')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#c0392b;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">📦</div>
                                        <div>
                                            <strong>DPD</strong>
                                            <div id="deliveryStatus_dpd" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Providers -->
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3><i class="fas fa-credit-card"></i> Платёжные системы</h3></div>
                        <div class="card-body">
                            <div class="stats-grid" id="paymentProvidersGrid">
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('payment','yoomoney')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#8b3ffd;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">💳</div>
                                        <div>
                                            <strong>ЮMoney</strong>
                                            <div id="paymentStatus_yoomoney" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('payment','yokassa')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#0055ff;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">💳</div>
                                        <div>
                                            <strong>ЮKassa</strong>
                                            <div id="paymentStatus_yokassa" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('payment','tinkoff')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#ffdd2d;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">💳</div>
                                        <div>
                                            <strong>Тинькофф</strong>
                                            <div id="paymentStatus_tinkoff" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('payment','robokassa')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#f39c12;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">💳</div>
                                        <div>
                                            <strong>Робокасса</strong>
                                            <div id="paymentStatus_robokassa" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card" style="cursor:pointer;" onclick="openProviderSettings('payment','prodamus')">
                                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                                        <div style="width:40px;height:40px;background:#2ecc71;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;">💳</div>
                                        <div>
                                            <strong>Продамус</strong>
                                            <div id="paymentStatus_prodamus" style="font-size:11px;color:var(--text-muted);">Не подключено</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Integrations Table -->
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header"><h3>Интеграции</h3></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Тип</th>
                                        <th>Лидов</th>
                                        <th>Последний запрос</th>
                                        <th>Статус</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="integrationsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Module Settings Modal -->
    <div class="modal-overlay" id="moduleSettingsModal">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h2><i class="fas fa-puzzle-piece"></i> Настройка модулей</h2>
                <button class="modal-close" onclick="closeModal('moduleSettingsModal')">&times;</button>
            </div>
            <div class="modal-body" id="moduleSettingsBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('moduleSettingsModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveModuleSettings()"><i class="fas fa-save"></i> Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Deal Modal -->
    <div class="modal-overlay" id="dealModal">
        <div class="modal" style="max-width:650px;">
            <div class="modal-header">
                <h3 id="dealModalTitle">Новая сделка</h3>
                <button class="modal-close" onclick="closeModal('dealModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <input type="hidden" id="dealEditId">
                <div class="form-group">
                    <label>Название сделки *</label>
                    <input type="text" id="dealName" placeholder="Продажа услуги">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Клиент</label>
                        <select id="dealClient"><option value="">Выберите клиента</option></select>
                    </div>
                    <div class="form-group">
                        <label>Ответственный</label>
                        <select id="dealAssignee"><option value="">Выберите сотрудника</option></select>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Сумма</label>
                        <input type="number" id="dealAmount" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Вероятность (%)</label>
                        <input type="number" id="dealProbability" placeholder="50" min="0" max="100" value="50">
                    </div>
                    <div class="form-group">
                        <label>Ожид. закрытие</label>
                        <input type="date" id="dealExpectedClose">
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Воронка</label>
                        <select id="dealFunnel" onchange="loadDealStages()"><option value="">Выберите воронку</option></select>
                    </div>
                    <div class="form-group">
                        <label>Этап</label>
                        <select id="dealStage"><option value="">Выберите этап</option></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Источник</label>
                    <select id="dealSource">
                        <option value="">— Не указан —</option>
                        <option value="website">Сайт</option>
                        <option value="referral">Рекомендация</option>
                        <option value="cold_call">Холодный звонок</option>
                        <option value="social">Соцсети</option>
                        <option value="ads">Реклама</option>
                        <option value="email">Email</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Примечание</label>
                    <textarea id="dealNotes" rows="2" placeholder="Дополнительная информация..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('dealModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveDeal()" id="dealSaveBtn">Создать</button>
            </div>
        </div>
    </div>

    <!-- Deal Details Modal -->
    <div class="modal-overlay" id="dealDetailsModal">
        <div class="modal" style="max-width:800px;">
            <div class="modal-header">
                <h3 id="dealDetailsTitle">Сделка</h3>
                <button class="modal-close" onclick="closeModal('dealDetailsModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;">
                    <!-- Main Info -->
                    <div>
                        <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:20px;">
                            <div class="stat-card">
                                <div class="value" id="dealDetailAmount">₽0</div>
                                <div class="label">Сумма сделки</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="dealDetailProbability">50%</div>
                                <div class="label">Вероятность</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="dealDetailDays">0</div>
                                <div class="label">Дней в работе</div>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-history"></i> История</h4>
                            </div>
                            <div class="card-body">
                                <div id="dealTimeline" class="timeline">
                                    <div class="timeline-item">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-content">
                                            <span class="timeline-date">Сегодня</span>
                                            <p>Сделка создана</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tasks -->
                        <div class="card" style="margin-top:15px;">
                            <div class="card-header">
                                <h4><i class="fas fa-tasks"></i> Задачи</h4>
                                <button class="btn btn-sm btn-outline" onclick="addDealTask()"><i class="fas fa-plus"></i></button>
                            </div>
                            <div class="card-body">
                                <div id="dealTasks">
                                    <p style="color:var(--text-muted);text-align:center;">Нет задач</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div>
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group" style="margin-bottom:15px;">
                                    <label style="font-size:12px;color:var(--text-muted);">Клиент</label>
                                    <div id="dealDetailClient" style="font-weight:500;">—</div>
                                </div>
                                <div class="form-group" style="margin-bottom:15px;">
                                    <label style="font-size:12px;color:var(--text-muted);">Ответственный</label>
                                    <div id="dealDetailAssignee" style="font-weight:500;">—</div>
                                </div>
                                <div class="form-group" style="margin-bottom:15px;">
                                    <label style="font-size:12px;color:var(--text-muted);">Этап</label>
                                    <div id="dealDetailStage"><span class="badge">—</span></div>
                                </div>
                                <div class="form-group" style="margin-bottom:15px;">
                                    <label style="font-size:12px;color:var(--text-muted);">Источник</label>
                                    <div id="dealDetailSource">—</div>
                                </div>
                                <div class="form-group" style="margin-bottom:15px;">
                                    <label style="font-size:12px;color:var(--text-muted);">Ожид. закрытие</label>
                                    <div id="dealDetailExpectedClose">—</div>
                                </div>
                                <div class="form-group" style="margin-bottom:0;">
                                    <label style="font-size:12px;color:var(--text-muted);">Создана</label>
                                    <div id="dealDetailCreated">—</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:15px;display:flex;flex-direction:column;gap:8px;">
                            <button class="btn btn-primary" onclick="editCurrentDeal()"><i class="fas fa-edit"></i> Редактировать</button>
                            <button class="btn btn-success" onclick="markDealWon()"><i class="fas fa-trophy"></i> Выиграна</button>
                            <button class="btn btn-danger" onclick="markDealLost()"><i class="fas fa-times"></i> Проиграна</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h3 id="clientModalTitle">Новый клиент</h3>
                <button class="modal-close" onclick="closeModal('clientModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="clientEditId">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Имя *</label>
                        <input type="text" id="clientFirstName" placeholder="Иван">
                    </div>
                    <div class="form-group">
                        <label>Фамилия</label>
                        <input type="text" id="clientLastName" placeholder="Иванов">
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Телефон</label>
                        <input type="tel" id="clientPhone" placeholder="+7 999 123-45-67">
                    </div>
                </div>
                <div class="form-group">
                    <label>Компания</label>
                    <input type="text" id="clientCompany" placeholder="ООО Компания">
                </div>
                <div class="form-group">
                    <label>Источник</label>
                    <select id="clientSource">
                        <option value="">— Не указан —</option>
                        <option value="vk">ВКонтакте</option>
                        <option value="telegram_bot">Телеграм-бот</option>
                        <option value="telegram_account">Телеграм аккаунт</option>
                        <option value="max_bot">МАКС-бот</option>
                        <option value="max_account">МАКС аккаунт</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="tiktok">TikTok</option>
                        <option value="instagram">Instagram</option>
                        <option value="website">Сайт</option>
                        <option value="referral">Рекомендация</option>
                        <option value="ads">Реклама</option>
                        <option value="other">Другой</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Заметки</label>
                    <textarea id="clientNotes" rows="2" placeholder="Заметки о клиенте..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('clientModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveClient()" id="clientSaveBtn">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Client Profile Modal -->
    <div class="modal-overlay" id="clientProfileModal">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <h3 id="clientProfileName">Клиент</h3>
                <button class="modal-close" onclick="closeModal('clientProfileModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;">
                    <!-- Main Content -->
                    <div>
                        <!-- Tabs -->
                        <div class="tabs" style="margin-bottom:20px;">
                            <button class="tab-btn active" onclick="switchClientTab('info')">Информация</button>
                            <button class="tab-btn" onclick="switchClientTab('orders')">Заказы</button>
                            <button class="tab-btn" onclick="switchClientTab('bookings')">Записи</button>
                            <button class="tab-btn" onclick="switchClientTab('trainings')">Обучение</button>
                            <button class="tab-btn" onclick="switchClientTab('activity')">Активность</button>
                        </div>

                        <!-- Tab Content -->
                        <div id="clientTabInfo" class="tab-content active">
                            <div class="card">
                                <div class="card-body">
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                                        <div>
                                            <p style="color:var(--text-muted);font-size:12px;">Email</p>
                                            <p id="profileEmail" style="font-weight:500;">—</p>
                                        </div>
                                        <div>
                                            <p style="color:var(--text-muted);font-size:12px;">Телефон</p>
                                            <p id="profilePhone" style="font-weight:500;">—</p>
                                        </div>
                                        <div>
                                            <p style="color:var(--text-muted);font-size:12px;">Компания</p>
                                            <p id="profileCompany" style="font-weight:500;">—</p>
                                        </div>
                                        <div>
                                            <p style="color:var(--text-muted);font-size:12px;">Источник</p>
                                            <p id="profileSource" style="font-weight:500;">—</p>
                                        </div>
                                    </div>
                                    <div style="margin-top:15px;">
                                        <p style="color:var(--text-muted);font-size:12px;">Теги</p>
                                        <p id="profileTags">—</p>
                                    </div>
                                    <div style="margin-top:15px;">
                                        <p style="color:var(--text-muted);font-size:12px;">Заметки</p>
                                        <p id="profileNotes">—</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="clientTabOrders" class="tab-content" style="display:none;">
                            <table>
                                <thead><tr><th>Заказ</th><th>Сумма</th><th>Статус</th><th>Дата</th></tr></thead>
                                <tbody id="profileOrdersTable"></tbody>
                            </table>
                        </div>

                        <div id="clientTabBookings" class="tab-content" style="display:none;">
                            <table>
                                <thead><tr><th>Услуга</th><th>Дата</th><th>Время</th><th>Статус</th></tr></thead>
                                <tbody id="profileBookingsTable"></tbody>
                            </table>
                        </div>

                        <div id="clientTabTrainings" class="tab-content" style="display:none;">
                            <table>
                                <thead><tr><th>Тренинг</th><th>Прогресс</th><th>Статус</th></tr></thead>
                                <tbody id="profileTrainingsTable"></tbody>
                            </table>
                        </div>

                        <div id="clientTabActivity" class="tab-content" style="display:none;">
                            <div id="profileActivityTimeline" class="timeline">
                                <p style="color:var(--text-muted);text-align:center;">Нет активности</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div>
                        <div class="stats-grid" style="grid-template-columns:1fr;gap:10px;margin-bottom:20px;">
                            <div class="stat-card success">
                                <div class="value" id="profileLTV">₽0</div>
                                <div class="label">LTV (за всё время)</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="profileOrdersCount">0</div>
                                <div class="label">Заказов</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="profileBookingsCount">0</div>
                                <div class="label">Записей</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <p style="color:var(--text-muted);font-size:12px;">Клиент с</p>
                                <p id="profileCreatedAt" style="font-weight:500;">—</p>
                                <p style="color:var(--text-muted);font-size:12px;margin-top:15px;">Последняя активность</p>
                                <p id="profileLastActivity" style="font-weight:500;">—</p>
                            </div>
                        </div>

                        <div style="margin-top:15px;display:flex;flex-direction:column;gap:8px;">
                            <button class="btn btn-primary" onclick="editClientFromProfile()"><i class="fas fa-edit"></i> Редактировать</button>
                            <button class="btn btn-outline" onclick="createDealForClient()"><i class="fas fa-handshake"></i> Создать сделку</button>
                            <button class="btn btn-outline" onclick="createBookingForClient()"><i class="fas fa-calendar-plus"></i> Записать</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Clients Modal -->
    <div class="modal-overlay" id="importClientsModal">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h3>Импорт клиентов</h3>
                <button class="modal-close" onclick="closeModal('importClientsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>CSV файл *</label>
                    <input type="file" id="importClientsFile" accept=".csv">
                </div>
                <div style="background:#1e293b;padding:15px;border-radius:8px;margin-top:15px;">
                    <p style="font-size:13px;margin-bottom:10px;"><strong>Формат CSV:</strong></p>
                    <code style="font-size:12px;color:var(--text-muted);">first_name,last_name,email,phone,company</code>
                    <p style="font-size:12px;color:var(--text-muted);margin-top:10px;">Первая строка - заголовки колонок</p>
                </div>
                <div class="form-group" style="margin-top:15px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="importSkipDuplicates" checked> Пропускать дубликаты (по email/телефону)
                    </label>
                </div>
                <div id="importClientsProgress" style="display:none;margin-top:15px;">
                    <div class="progress-bar"><div class="fill" id="importClientsBar" style="width:0%;"></div></div>
                    <p id="importClientsStatus" style="text-align:center;margin-top:8px;font-size:13px;"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('importClientsModal')">Отмена</button>
                <button class="btn btn-primary" onclick="importClients()"><i class="fas fa-upload"></i> Импортировать</button>
            </div>
        </div>
    </div>

    <!-- Funnel Modal -->
    <div class="modal-overlay" id="funnelModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая воронка</h3>
                <button class="modal-close" onclick="closeModal('funnelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название воронки *</label>
                    <input type="text" id="funnelName" placeholder="Продажи B2B">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="funnelDescription" rows="3" placeholder="Описание воронки"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('funnelModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveFunnel()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Stage Modal -->
    <div class="modal-overlay" id="stageModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>Новый этап</h3>
                <button class="modal-close" onclick="closeModal('stageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название этапа *</label>
                    <input type="text" id="stageName" placeholder="Переговоры">
                </div>
                <div class="form-group">
                    <label>Цвет</label>
                    <input type="color" id="stageColor" value="#3b82f6" style="width:60px;height:36px;padding:2px;">
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="stageIsWon"> Этап "Выиграна"
                    </label>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="stageIsLost"> Этап "Проиграна"
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('stageModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveStage()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div class="modal-overlay" id="employeeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="employeeModalTitle">Новый сотрудник</h3>
                <button class="modal-close" onclick="closeModal('employeeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="employeeEditId">
                <div class="form-group">
                    <label>Имя *</label>
                    <input type="text" id="employeeFirstName" placeholder="Иван">
                </div>
                <div class="form-group">
                    <label>Фамилия *</label>
                    <input type="text" id="employeeLastName" placeholder="Иванов">
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="employeeEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>Должность</label>
                    <input type="text" id="employeePosition" placeholder="Менеджер">
                </div>
                <div class="form-group">
                    <label>Роль</label>
                    <select id="employeeRole">
                        <option value="manager">Менеджер</option>
                        <option value="admin">Администратор</option>
                        <option value="support">Поддержка</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('employeeModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveEmployee()" id="employeeSaveBtn">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая задача</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название задачи *</label>
                    <input type="text" id="taskTitle" placeholder="Позвонить клиенту">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="taskDescription" rows="3" placeholder="Подробности задачи"></textarea>
                </div>
                <div class="form-group">
                    <label>Исполнитель</label>
                    <select id="taskAssignee"><option value="">Выберите сотрудника</option></select>
                </div>
                <div class="form-group">
                    <label>Приоритет</label>
                    <select id="taskPriority">
                        <option value="normal">Обычный</option>
                        <option value="high">Высокий</option>
                        <option value="urgent">Срочный</option>
                        <option value="low">Низкий</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Срок</label>
                    <input type="date" id="taskDueDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('taskModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveTask()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="productModalTitle">Новый товар</h3>
                <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Product Type -->
                <div class="form-group" style="margin-bottom:20px;">
                    <label>Тип товара</label>
                    <div class="product-type-selector" style="display:flex;gap:10px;">
                        <label class="type-option" style="flex:1;padding:15px;background:var(--bg-input);border:2px solid var(--border-color);border-radius:8px;cursor:pointer;text-align:center;">
                            <input type="radio" name="productType" value="physical" checked style="display:none;">
                            <i class="fas fa-box" style="font-size:24px;display:block;margin-bottom:8px;"></i>
                            <span>Физический</span>
                        </label>
                        <label class="type-option" style="flex:1;padding:15px;background:var(--bg-input);border:2px solid var(--border-color);border-radius:8px;cursor:pointer;text-align:center;">
                            <input type="radio" name="productType" value="digital" style="display:none;">
                            <i class="fas fa-file-download" style="font-size:24px;display:block;margin-bottom:8px;"></i>
                            <span>Цифровой</span>
                        </label>
                        <label class="type-option" style="flex:1;padding:15px;background:var(--bg-input);border:2px solid var(--border-color);border-radius:8px;cursor:pointer;text-align:center;">
                            <input type="radio" name="productType" value="online" style="display:none;">
                            <i class="fas fa-graduation-cap" style="font-size:24px;display:block;margin-bottom:8px;"></i>
                            <span>Онлайн-продукт</span>
                        </label>
                    </div>
                </div>

                <!-- Online Product Access (shown only for online type) -->
                <div id="onlineProductAccess" style="display:none;background:#1e293b;border-radius:8px;padding:15px;margin-bottom:20px;">
                    <h4 style="margin:0 0 15px 0;color:var(--accent);"><i class="fas fa-key"></i> Доступ при покупке</h4>
                    <div class="form-group">
                        <label>Тип доступа</label>
                        <select id="productAccessType" onchange="toggleProductAccessOptions()">
                            <option value="">— Выберите —</option>
                            <option value="training">Доступ к тренингу</option>
                            <option value="lesson">Доступ к уроку</option>
                            <option value="group">Добавление в группу</option>
                        </select>
                    </div>
                    <div id="accessTrainingSelect" style="display:none;" class="form-group">
                        <label>Выберите тренинг</label>
                        <select id="productAccessTraining"></select>
                    </div>
                    <div id="accessLessonSelect" style="display:none;" class="form-group">
                        <label>Выберите урок</label>
                        <select id="productAccessLesson"></select>
                    </div>
                    <div id="accessGroupSelect" style="display:none;" class="form-group">
                        <label>Выберите группу</label>
                        <select id="productAccessGroup"></select>
                    </div>
                </div>

                <!-- Basic Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Название товара *</label>
                        <input type="text" id="productName" placeholder="Название товара">
                    </div>
                    <div class="form-group">
                        <label>Артикул (SKU)</label>
                        <input type="text" id="productSku" placeholder="ART-001">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Цена *</label>
                        <input type="number" id="productPrice" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Старая цена</label>
                        <input type="number" id="productOldPrice" placeholder="0">
                    </div>
                    <div class="form-group" id="productStockGroup">
                        <label>Остаток</label>
                        <input type="number" id="productStock" placeholder="0">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Категория</label>
                        <select id="productCategory">
                            <option value="">— Без категории —</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Бренд</label>
                        <input type="text" id="productBrand" placeholder="Название бренда">
                    </div>
                </div>

                <!-- Description with AI -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; justify-content: space-between;">
                        <span>Описание</span>
                        <button type="button" class="btn-ai-small" onclick="generateProductDescription()" title="Сгенерировать описание с помощью AI">
                            <i class="fas fa-magic"></i> AI описание
                        </button>
                    </label>
                    <textarea id="productDescription" rows="4" placeholder="Описание товара..."></textarea>
                    <div id="productDescLoading" style="display: none; color: #f59e0b; font-size: 12px; margin-top: 5px;">
                        <i class="fas fa-spinner fa-spin"></i> Генерация описания...
                    </div>
                </div>

                <!-- SEO Section -->
                <div style="background: #1e293b; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #e2e8f0;"><i class="fas fa-search"></i> SEO настройки</span>
                        <button type="button" class="btn-ai-small" onclick="generateProductMeta()" title="Сгенерировать мета-теги с помощью AI">
                            <i class="fas fa-magic"></i> AI мета-теги
                        </button>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Meta Title</label>
                        <input type="text" id="productMetaTitle" placeholder="SEO заголовок (до 60 символов)" maxlength="60">
                        <div style="font-size: 11px; color: #64748b; text-align: right;"><span id="metaTitleCount">0</span>/60</div>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Meta Description</label>
                        <textarea id="productMetaDesc" rows="2" placeholder="SEO описание (до 160 символов)" maxlength="160"></textarea>
                        <div style="font-size: 11px; color: #64748b; text-align: right;"><span id="metaDescCount">0</span>/160</div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">URL (slug)</label>
                        <input type="text" id="productSlug" placeholder="url-tovara">
                    </div>
                    <div id="productMetaLoading" style="display: none; color: #f59e0b; font-size: 12px; margin-top: 10px;">
                        <i class="fas fa-spinner fa-spin"></i> Генерация мета-тегов...
                    </div>
                </div>

                <!-- Product Images -->
                <div style="background: #1e293b; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #e2e8f0;"><i class="fas fa-images"></i> Изображения</span>
                        <button type="button" class="btn btn-sm btn-outline" onclick="addProductImage()">
                            <i class="fas fa-plus"></i> Добавить
                        </button>
                    </div>
                    <div id="productImagesContainer" style="display:flex;flex-wrap:wrap;gap:10px;min-height:60px;">
                        <div class="image-placeholder" style="width:80px;height:80px;border:2px dashed var(--border-color);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);cursor:pointer;" onclick="addProductImage()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    <input type="file" id="productImageInput" style="display:none;" accept="image/*" onchange="handleProductImage(this)">
                    <p style="font-size: 11px; color: #64748b; margin-top: 8px; margin-bottom: 0;">
                        Перетащите для изменения порядка. Первое изображение — основное.
                    </p>
                </div>

                <!-- Product Variants -->
                <div style="margin-top: 15px;">
                    <details id="productVariantsSection">
                        <summary style="cursor: pointer; color: #94a3b8; font-size: 13px;">
                            <i class="fas fa-layer-group"></i> Варианты товара
                        </summary>
                        <div style="padding: 15px 0;">
                            <div id="productVariantsContainer">
                                <!-- Variants will be added here -->
                            </div>
                            <button type="button" class="btn btn-outline btn-sm" onclick="addProductVariant()" style="margin-top:10px;">
                                <i class="fas fa-plus"></i> Добавить вариант
                            </button>
                        </div>
                    </details>
                </div>

                <!-- Inventory Tracking -->
                <div style="margin-top: 15px;">
                    <details>
                        <summary style="cursor: pointer; color: #94a3b8; font-size: 13px;">
                            <i class="fas fa-warehouse"></i> Складской учёт
                        </summary>
                        <div style="padding: 15px 0;">
                            <div class="form-group" style="margin-bottom:10px;">
                                <label style="display:flex;align-items:center;gap:8px;">
                                    <input type="checkbox" id="productTrackInventory" onchange="toggleInventoryOptions()">
                                    <span style="font-size:13px;">Отслеживать остатки</span>
                                </label>
                            </div>
                            <div id="inventoryOptions" style="display:none;">
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                    <div class="form-group">
                                        <label style="font-size:12px;">Минимальный остаток</label>
                                        <input type="number" id="productMinStock" placeholder="5" value="5">
                                    </div>
                                    <div class="form-group">
                                        <label style="font-size:12px;">Склад</label>
                                        <select id="productWarehouse">
                                            <option value="">Основной</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom:0;">
                                    <label style="display:flex;align-items:center;gap:8px;">
                                        <input type="checkbox" id="productBackorder">
                                        <span style="font-size:13px;">Разрешить заказ при нулевом остатке</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- Physical Properties -->
                <div style="margin-top: 15px;">
                    <details>
                        <summary style="cursor: pointer; color: #94a3b8; font-size: 13px;">
                            <i class="fas fa-ruler-combined"></i> Габариты и вес
                        </summary>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                            <div class="form-group">
                                <label style="font-size: 12px;">Вес (кг)</label>
                                <input type="number" id="productWeight" placeholder="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">Длина (см)</label>
                                <input type="number" id="productLength" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">Ширина (см)</label>
                                <input type="number" id="productWidth" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label style="font-size: 12px;">Высота (см)</label>
                                <input type="number" id="productHeight" placeholder="0">
                            </div>
                        </div>
                    </details>
                </div>

                <!-- AI Card Generation Button -->
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f59e0b20, #ea580c20); border: 1px solid #f59e0b40; border-radius: 8px;">
                    <button type="button" class="btn" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #ea580c); border: none;" onclick="generateProductCard()">
                        <i class="fas fa-magic"></i> Сгенерировать карточку товара
                    </button>
                    <p style="font-size: 11px; color: #94a3b8; text-align: center; margin-top: 8px; margin-bottom: 0;">
                        AI создаст изображения, описание и мета-теги
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('productModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveProduct()" id="productSaveBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <style>
        .btn-ai-small {
            background: linear-gradient(135deg, #f59e0b, #ea580c);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .btn-ai-small:hover {
            opacity: 0.9;
        }
        .btn-ai-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>

    <!-- Segment Modal -->
    <div class="modal-overlay" id="segmentModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый сегмент</h3>
                <button class="modal-close" onclick="closeModal('segmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название сегмента *</label>
                    <input type="text" id="segmentName" placeholder="VIP клиенты">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="segmentDescription" rows="2" placeholder="Описание сегмента"></textarea>
                </div>
                <div class="form-group">
                    <label>Цвет</label>
                    <input type="color" id="segmentColor" value="#6366f1">
                </div>
                <div class="form-group">
                    <label>Динамический сегмент</label>
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                        <input type="checkbox" id="segmentDynamic"> Автоматически добавлять клиентов по правилам
                    </label>
                </div>
                <div id="segmentRulesContainer" style="display: none;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <label style="margin:0;">Условия</label>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:12px;color:var(--text-muted);">Логика:</span>
                            <select id="segmentLogic" style="width:80px;padding:4px 8px;font-size:12px;">
                                <option value="and">И (AND)</option>
                                <option value="or">ИЛИ (OR)</option>
                            </select>
                        </div>
                    </div>
                    <div id="segmentConditions"></div>
                    <button type="button" class="btn btn-sm btn-outline" onclick="addSegmentCondition()" style="margin-top:8px;">
                        <i class="fas fa-plus"></i> Добавить условие
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('segmentModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveSegment()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Group Modal -->
    <div class="modal-overlay" id="groupModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая группа</h3>
                <button class="modal-close" onclick="closeModal('groupModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название группы *</label>
                    <input type="text" id="groupName" placeholder="VIP-клиенты">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="groupDescription" rows="2" placeholder="Описание группы"></textarea>
                </div>
                <div class="form-group">
                    <label>Цвет</label>
                    <input type="color" id="groupColor" value="#6366f1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('groupModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveClientGroup()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый заказ</h3>
                <button class="modal-close" onclick="closeModal('orderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Клиент *</label>
                    <select id="orderClient"><option value="">Выберите клиента</option></select>
                </div>
                <div class="form-group">
                    <label>Сумма заказа *</label>
                    <input type="number" id="orderAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Статус</label>
                    <select id="orderStatus">
                        <option value="new">Новый</option>
                        <option value="processing">В обработке</option>
                        <option value="shipped">Отправлен</option>
                        <option value="completed">Завершен</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Статус оплаты</label>
                    <select id="orderPaymentStatus">
                        <option value="pending">Ожидает оплаты</option>
                        <option value="paid">Оплачен</option>
                        <option value="partial">Частично оплачен</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Адрес доставки</label>
                    <textarea id="orderAddress" rows="2" placeholder="Адрес доставки"></textarea>
                </div>
                <div class="form-group">
                    <label>Комментарий</label>
                    <textarea id="orderNotes" rows="2" placeholder="Примечания к заказу"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('orderModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveOrder()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Service Modal - Extended for Bookings -->
    <div class="modal-overlay" id="serviceModal">
        <div class="modal" style="max-width:650px;">
            <div class="modal-header">
                <h3>Новая услуга</h3>
                <button class="modal-close" onclick="closeModal('serviceModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div class="form-group">
                    <label>Название услуги *</label>
                    <input type="text" id="serviceName" placeholder="Стрижка, Массаж, Консультация...">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Тип услуги</label>
                        <select id="serviceType" onchange="toggleServiceGroup()">
                            <option value="individual">Индивидуальная</option>
                            <option value="group">Групповая</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Категория</label>
                        <input type="text" id="serviceCategory" placeholder="Парикмахерские услуги">
                    </div>
                </div>
                <div id="serviceGroupSettings" style="display:none;background:#1e293b;padding:15px;border-radius:8px;margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0;font-size:14px;"><i class="fas fa-users"></i> Настройки группы</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Макс. участников</label>
                            <input type="number" id="serviceMaxClients" placeholder="10" value="10">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Мин. участников</label>
                            <input type="number" id="serviceMinClients" placeholder="3" value="1">
                        </div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Цена</label>
                        <input type="number" id="servicePrice" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Длительность (мин)</label>
                        <input type="number" id="serviceDuration" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label>Буфер (мин)</label>
                        <input type="number" id="serviceBuffer" placeholder="0" value="0">
                        <div style="font-size:11px;color:var(--text-muted);">Перерыв между записями</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Специалисты, оказывающие услугу</label>
                    <select id="serviceSpecialists" multiple style="height:80px;"></select>
                </div>
                <div class="form-group">
                    <label>Помещение</label>
                    <select id="serviceRoom">
                        <option value="">— Любое доступное —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="serviceDescription" rows="3" placeholder="Описание услуги для клиентов"></textarea>
                </div>
                <div style="margin-top:15px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="serviceOnlineBooking" checked> Доступна для онлайн-записи
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('serviceModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveService()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Course Modal -->
    <div class="modal-overlay" id="courseModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="courseModalTitle">Новый курс</h3>
                <button class="modal-close" onclick="closeModal('courseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="courseEditId">
                <div class="form-group">
                    <label>Название курса *</label>
                    <input type="text" id="courseName" placeholder="Курс по маркетингу">
                </div>
                <div class="form-group">
                    <label>Цена</label>
                    <input type="number" id="coursePrice" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Уровень</label>
                    <select id="courseLevel">
                        <option value="beginner">Начинающий</option>
                        <option value="intermediate">Средний</option>
                        <option value="advanced">Продвинутый</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Длительность (часов)</label>
                    <input type="number" id="courseDuration" placeholder="10">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="courseDescription" rows="3" placeholder="Описание курса"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('courseModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveCourse()" id="courseSaveBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Regulation Modal (SLA) -->
    <!-- Regulation Editor Modal -->
    <div class="modal-overlay" id="regulationEditorModal">
        <div class="modal" style="max-width:800px;height:85vh;display:flex;flex-direction:column;">
            <div class="modal-header" style="flex-shrink:0;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                    <h3 id="regEditorTitle">Новый регламент</h3>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="btn btn-sm btn-outline" onclick="switchRegTab('content')" id="regTabContent" style="background:var(--primary);color:#fff;">Содержание</button>
                    <button class="btn btn-sm btn-outline" onclick="switchRegTab('access')" id="regTabAccess">Доступ</button>
                    <button class="modal-close" onclick="closeModal('regulationEditorModal')">&times;</button>
                </div>
            </div>
            <div class="modal-body" style="flex:1;overflow-y:auto;padding:0;">
                <!-- Content Tab -->
                <div id="regContentTab" style="padding:20px;">
                    <div class="form-group">
                        <input type="text" id="regEditorName" placeholder="Название регламента" style="font-size:20px;font-weight:700;border:none;background:transparent;padding:0;color:var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <textarea id="regEditorDescription" rows="2" placeholder="Краткое описание..." style="border:none;background:transparent;padding:0;color:var(--text-secondary);resize:none;"></textarea>
                    </div>
                    <!-- Block-based content -->
                    <div id="regEditorBlocks" style="min-height:200px;"></div>
                    <!-- Add block button -->
                    <div style="margin-top:12px;position:relative;">
                        <button type="button" class="btn btn-sm btn-outline" onclick="toggleRegBlockMenu()" id="regAddBlockBtn"><i class="fas fa-plus"></i> Добавить блок</button>
                        <div id="regBlockMenu" style="display:none;position:absolute;bottom:100%;left:0;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;padding:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);min-width:200px;margin-bottom:4px;max-height:360px;overflow-y:auto;">
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('text')"><i class="fas fa-paragraph" style="width:16px;text-align:center;"></i> Текст</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('heading')"><i class="fas fa-heading" style="width:16px;text-align:center;"></i> Заголовок</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('task')"><i class="fas fa-check-square" style="width:16px;text-align:center;"></i> Задача</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('checklist')"><i class="fas fa-tasks" style="width:16px;text-align:center;"></i> Чеклист</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('quote')"><i class="fas fa-quote-right" style="width:16px;text-align:center;"></i> Цитата</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('alert')"><i class="fas fa-exclamation-circle" style="width:16px;text-align:center;"></i> Уведомление</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('image')"><i class="fas fa-image" style="width:16px;text-align:center;"></i> Изображение</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('video')"><i class="fas fa-video" style="width:16px;text-align:center;"></i> Видео</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('table')"><i class="fas fa-table" style="width:16px;text-align:center;"></i> Таблица</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('file')"><i class="fas fa-paperclip" style="width:16px;text-align:center;"></i> Файл</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('code')"><i class="fas fa-code" style="width:16px;text-align:center;"></i> Код</div>
                            <div style="padding:8px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="addRegulationBlock('divider')"><i class="fas fa-minus" style="width:16px;text-align:center;"></i> Разделитель</div>
                        </div>
                    </div>
                </div>
                <!-- Access Tab -->
                <div id="regAccessTab" style="padding:20px;display:none;">
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                            <input type="checkbox" id="regAccessAll" onchange="toggleRegAccessAll()"> Все сотрудники
                        </label>
                    </div>
                    <div id="regAccessList"></div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink:0;">
                <input type="hidden" id="regEditorId">
                <button class="btn btn-outline" onclick="closeModal('regulationEditorModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveRegulationContent()"><i class="fas fa-save"></i> Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Goal Modal (KPI) -->
    <div class="modal-overlay" id="goalModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая цель</h3>
                <button class="modal-close" onclick="closeModal('goalModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Сотрудник</label>
                    <select id="goalEmployee"><option value="">Общая цель (все)</option></select>
                </div>
                <div class="form-group">
                    <label>Метрика *</label>
                    <select id="goalMetric">
                        <option value="revenue">Выручка</option>
                        <option value="deals_won">Закрытых сделок</option>
                        <option value="calls">Звонков</option>
                        <option value="conversion_rate">Конверсия %</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Целевое значение *</label>
                    <input type="number" id="goalTarget" placeholder="100000">
                </div>
                <div class="form-group">
                    <label>Период</label>
                    <select id="goalPeriodType">
                        <option value="month">Месяц</option>
                        <option value="quarter">Квартал</option>
                        <option value="year">Год</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Начало</label>
                        <input type="date" id="goalStart">
                    </div>
                    <div class="form-group">
                        <label>Конец</label>
                        <input type="date" id="goalEnd">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('goalModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveGoal()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Distribution Settings Modal -->
    <div class="modal-overlay" id="distributionModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Настройки распределения</h3>
                <button class="modal-close" onclick="closeModal('distributionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Воронка</label>
                    <select id="distFunnel"><option value="">Все воронки</option></select>
                </div>
                <div class="form-group">
                    <label>Тип распределения</label>
                    <select id="distType">
                        <option value="round_robin">По очереди (Round Robin)</option>
                        <option value="load_balanced">По нагрузке</option>
                        <option value="random">Случайно</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Таймаут ответа (минут)</label>
                    <input type="number" id="distTimeout" value="30" placeholder="30">
                </div>
                <div class="form-group">
                    <label>Макс. лидов на сотрудника</label>
                    <input type="number" id="distMaxLeads" placeholder="Без лимита">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="distAutoReassign" checked> Авто-переназначение при таймауте</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="distWorkingHours" checked> Только в рабочее время</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('distributionModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveDistributionSettings()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="modal-overlay" id="tagModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>Новый тег</h3>
                <button class="modal-close" onclick="closeModal('tagModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="tagName" placeholder="VIP клиент">
                </div>
                <div class="form-group">
                    <label>Цвет</label>
                    <input type="color" id="tagColor" value="#3b82f6" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer;">
                </div>
                <div class="form-group">
                    <label>Для сущности</label>
                    <select id="tagEntityType">
                        <option value="deal">Сделки</option>
                        <option value="client">Клиенты</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('tagModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveTag()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Brand Modal -->
    <div class="modal-overlay" id="brandModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>Новый бренд</h3>
                <button class="modal-close" onclick="closeModal('brandModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="brandName" placeholder="Nike">
                </div>
                <div class="form-group">
                    <label>Логотип (URL)</label>
                    <input type="text" id="brandLogo" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Сайт</label>
                    <input type="text" id="brandWebsite" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="brandDescription" rows="2" placeholder="Описание бренда"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('brandModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveBrand()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Promo Code Modal - Extended -->
    <div class="modal-overlay" id="promoModal">
        <div class="modal" style="max-width:650px;">
            <div class="modal-header">
                <h3>Новый промокод</h3>
                <button class="modal-close" onclick="closeModal('promoModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Код *</label>
                        <div style="display:flex;gap:8px;">
                            <input type="text" id="promoCode" placeholder="SALE20" style="text-transform:uppercase;flex:1;">
                            <button class="btn btn-outline btn-sm" onclick="generatePromoCode()"><i class="fas fa-random"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Статус</label>
                        <select id="promoStatus">
                            <option value="active">Активен</option>
                            <option value="disabled">Отключён</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Тип скидки</label>
                        <select id="promoType">
                            <option value="percent">Процент (%)</option>
                            <option value="fixed">Фикс. сумма (₽)</option>
                            <option value="free_shipping">Бесп. доставка</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Значение *</label>
                        <input type="number" id="promoValue" placeholder="20">
                    </div>
                    <div class="form-group">
                        <label>Макс. скидка (₽)</label>
                        <input type="number" id="promoMaxDiscount" placeholder="Без лимита">
                    </div>
                </div>

                <div style="background:#1e293b;border-radius:8px;padding:15px;margin:15px 0;">
                    <h4 style="margin:0 0 15px 0;font-size:14px;"><i class="fas fa-cog"></i> Условия применения</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Мин. сумма заказа</label>
                            <input type="number" id="promoMinOrder" placeholder="0">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Лимит использований</label>
                            <input type="number" id="promoMaxUses" placeholder="Без лимита">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>На клиента (раз)</label>
                            <input type="number" id="promoPerClient" placeholder="Без лимита">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Мин. кол-во товаров</label>
                            <input type="number" id="promoMinItems" placeholder="1" value="1">
                        </div>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Дата начала</label>
                        <input type="date" id="promoStart">
                    </div>
                    <div class="form-group">
                        <label>Дата окончания</label>
                        <input type="date" id="promoEnd">
                    </div>
                </div>

                <div class="form-group">
                    <label>Применяется к</label>
                    <select id="promoAppliesTo" onchange="togglePromoProducts()">
                        <option value="all">Всем товарам</option>
                        <option value="categories">Категориям</option>
                        <option value="products">Конкретным товарам</option>
                        <option value="first_order">Только первый заказ</option>
                    </select>
                </div>
                <div id="promoProductsGroup" style="display:none;" class="form-group">
                    <label>Выберите товары/категории</label>
                    <select id="promoProducts" multiple style="height:100px;"></select>
                </div>

                <div style="margin-top:15px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="promoExcludeSale"> Не применять к товарам со скидкой
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;margin-top:8px;">
                        <input type="checkbox" id="promoCombine"> Можно комбинировать с другими скидками
                    </label>
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label>Описание (для внутреннего использования)</label>
                    <textarea id="promoDescription" rows="2" placeholder="Зачем создан этот промокод..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('promoModal')">Отмена</button>
                <button class="btn btn-primary" onclick="savePromoCode()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Collection Modal -->
    <div class="modal-overlay" id="collectionModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h3>Новая коллекция</h3>
                <button class="modal-close" onclick="closeModal('collectionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="collectionName" placeholder="Новинки сезона">
                </div>
                <div class="form-group">
                    <label>Изображение (URL)</label>
                    <input type="text" id="collectionImage" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Тип</label>
                    <select id="collectionType">
                        <option value="manual">Ручная (выбираю товары)</option>
                        <option value="auto">Автоматическая (по правилам)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="collectionDescription" rows="2" placeholder="Описание коллекции"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('collectionModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveCollection()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h3 id="bookingModalTitle">Новая запись</h3>
                <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bookingEditId">
                <div class="form-group">
                    <label>Услуга *</label>
                    <select id="bookingService" onchange="updateBookingDuration()"><option value="">Выберите услугу</option></select>
                </div>
                <div class="form-group">
                    <label>Мастер</label>
                    <select id="bookingEmployee"><option value="">Любой свободный</option></select>
                </div>
                <div class="form-group">
                    <label>Клиент</label>
                    <select id="bookingClient" onchange="fillClientInfo()"><option value="">Выберите или создайте</option></select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Дата *</label>
                        <input type="date" id="bookingDate">
                    </div>
                    <div class="form-group">
                        <label>Время *</label>
                        <input type="time" id="bookingTime">
                    </div>
                    <div class="form-group">
                        <label>Длительность</label>
                        <select id="bookingDuration">
                            <option value="30">30 мин</option>
                            <option value="60" selected>1 час</option>
                            <option value="90">1.5 часа</option>
                            <option value="120">2 часа</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Имя клиента</label>
                        <input type="text" id="bookingClientName" placeholder="Иван Иванов">
                    </div>
                    <div class="form-group">
                        <label>Телефон клиента</label>
                        <input type="tel" id="bookingClientPhone" placeholder="+7 999 123-45-67">
                    </div>
                </div>
                <div class="form-group">
                    <label>Комментарий</label>
                    <textarea id="bookingComment" rows="2" placeholder="Примечание к записи"></textarea>
                </div>
                <div style="background:#1e293b;border-radius:8px;padding:12px;margin-top:12px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="bookingSendReminder" checked>
                        <span style="font-size:13px;"><i class="fas fa-bell"></i> Отправить напоминание</span>
                    </label>
                    <div id="reminderOptions" style="margin-top:10px;">
                        <select id="bookingReminderTime" style="width:100%;">
                            <option value="1h">За 1 час до визита</option>
                            <option value="3h" selected>За 3 часа до визита</option>
                            <option value="24h">За день до визита</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bookingModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveBooking()" id="bookingSaveBtn">Записать</button>
            </div>
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div class="modal-overlay" id="bookingDetailsModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3>Детали записи</h3>
                <button class="modal-close" onclick="closeModal('bookingDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
                    <div>
                        <p style="color:var(--text-muted);font-size:12px;">Клиент</p>
                        <p id="detailsClientName" style="font-weight:500;">—</p>
                    </div>
                    <div>
                        <p style="color:var(--text-muted);font-size:12px;">Телефон</p>
                        <p id="detailsClientPhone" style="font-weight:500;">—</p>
                    </div>
                    <div>
                        <p style="color:var(--text-muted);font-size:12px;">Услуга</p>
                        <p id="detailsService" style="font-weight:500;">—</p>
                    </div>
                    <div>
                        <p style="color:var(--text-muted);font-size:12px;">Мастер</p>
                        <p id="detailsEmployee" style="font-weight:500;">—</p>
                    </div>
                    <div>
                        <p style="color:var(--text-muted);font-size:12px;">Дата и время</p>
                        <p id="detailsDateTime" style="font-weight:500;">—</p>
                    </div>
                    <div>
                        <p style="color:var(--text-muted);font-size:12px;">Стоимость</p>
                        <p id="detailsPrice" style="font-weight:500;">—</p>
                    </div>
                </div>
                <div style="margin-bottom:15px;">
                    <p style="color:var(--text-muted);font-size:12px;">Статус</p>
                    <p id="detailsStatus">—</p>
                </div>
                <div style="margin-bottom:15px;">
                    <p style="color:var(--text-muted);font-size:12px;">Комментарий</p>
                    <p id="detailsComment" style="font-style:italic;">—</p>
                </div>
                <div class="stats-grid" style="grid-template-columns:1fr 1fr;gap:10px;">
                    <button class="btn btn-success" onclick="confirmCurrentBooking()"><i class="fas fa-check"></i> Подтвердить</button>
                    <button class="btn btn-outline" onclick="sendBookingReminder()"><i class="fas fa-bell"></i> Напомнить</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" style="color:#ef4444;" onclick="cancelCurrentBooking()"><i class="fas fa-times"></i> Отменить</button>
                <button class="btn btn-outline" onclick="editCurrentBooking()"><i class="fas fa-edit"></i> Изменить</button>
                <button class="btn btn-primary" onclick="completeCurrentBooking()"><i class="fas fa-check-double"></i> Завершить</button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3>Расписание сотрудника</h3>
                <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Сотрудник *</label>
                    <select id="scheduleEmployee"><option value="">Выберите сотрудника</option></select>
                </div>
                <div style="margin-top:16px;">
                    <table style="width:100%;font-size:13px;">
                        <tr><th>День</th><th>Работает</th><th>Начало</th><th>Конец</th></tr>
                        <tr><td>Понедельник</td><td><input type="checkbox" id="schedMon" checked></td><td><input type="time" id="schedMonStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedMonEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Вторник</td><td><input type="checkbox" id="schedTue" checked></td><td><input type="time" id="schedTueStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedTueEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Среда</td><td><input type="checkbox" id="schedWed" checked></td><td><input type="time" id="schedWedStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedWedEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Четверг</td><td><input type="checkbox" id="schedThu" checked></td><td><input type="time" id="schedThuStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedThuEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Пятница</td><td><input type="checkbox" id="schedFri" checked></td><td><input type="time" id="schedFriStart" value="09:00" style="width:100px;"></td><td><input type="time" id="schedFriEnd" value="18:00" style="width:100px;"></td></tr>
                        <tr><td>Суббота</td><td><input type="checkbox" id="schedSat"></td><td><input type="time" id="schedSatStart" value="10:00" style="width:100px;"></td><td><input type="time" id="schedSatEnd" value="16:00" style="width:100px;"></td></tr>
                        <tr><td>Воскресенье</td><td><input type="checkbox" id="schedSun"></td><td><input type="time" id="schedSunStart" value="10:00" style="width:100px;"></td><td><input type="time" id="schedSunEnd" value="16:00" style="width:100px;"></td></tr>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('scheduleModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveSchedule()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Webinar Modal -->
    <div class="modal-overlay" id="webinarModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый вебинар</h3>
                <button class="modal-close" onclick="closeModal('webinarModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="webinarTitle" placeholder="Вебинар по продажам">
                </div>
                <div class="form-group">
                    <label>Курс (опционально)</label>
                    <select id="webinarCourse"><option value="">Без курса</option></select>
                </div>
                <div class="form-group">
                    <label>Ведущий</label>
                    <select id="webinarHost"><option value="">Выберите ведущего</option></select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Дата и время *</label>
                        <input type="datetime-local" id="webinarDate">
                    </div>
                    <div class="form-group">
                        <label>Длительность (мин)</label>
                        <input type="number" id="webinarDuration" value="60" placeholder="60">
                    </div>
                </div>
                <div class="form-group">
                    <label>Платформа</label>
                    <select id="webinarPlatform">
                        <option value="zoom">Zoom</option>
                        <option value="youtube">YouTube Live</option>
                        <option value="custom">Своя ссылка</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="webinarDescription" rows="3" placeholder="О чём вебинар"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('webinarModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveWebinar()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal-overlay" id="quizModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новый тест</h3>
                <button class="modal-close" onclick="closeModal('quizModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="quizTitle" placeholder="Тест по модулю 1">
                </div>
                <div class="form-group">
                    <label>Курс *</label>
                    <select id="quizCourse"><option value="">Выберите курс</option></select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group">
                        <label>Проходной балл (%)</label>
                        <input type="number" id="quizPassingScore" value="70" placeholder="70">
                    </div>
                    <div class="form-group">
                        <label>Лимит времени (мин)</label>
                        <input type="number" id="quizTimeLimit" placeholder="Без лимита">
                    </div>
                </div>
                <div class="form-group">
                    <label>Попыток</label>
                    <input type="number" id="quizAttempts" value="3" placeholder="3">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="quizShuffle"> Перемешивать вопросы</label>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="quizDescription" rows="2" placeholder="Инструкция к тесту"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('quizModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveQuiz()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Integration Modal -->
    <div class="modal-overlay" id="integrationModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Новая интеграция</h3>
                <button class="modal-close" onclick="closeModal('integrationModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="integrationName" placeholder="Форма с сайта">
                </div>
                <div class="form-group">
                    <label>Тип *</label>
                    <select id="integrationType" onchange="toggleIntegrationFields()">
                        <option value="web_form">Веб-форма</option>
                        <option value="webhook">Входящий вебхук</option>
                        <option value="widget">Виджет на сайт</option>
                        <option value="telegram">Telegram бот</option>
                        <option value="email">Email парсинг</option>
                    </select>
                </div>
                <div class="form-group" id="integrationFunnelGroup">
                    <label>Воронка для лидов</label>
                    <select id="integrationFunnel"><option value="">По умолчанию</option></select>
                </div>
                <div class="form-group" id="integrationUrlGroup" style="display:none;">
                    <label>URL для отправки данных</label>
                    <input type="text" id="integrationUrl" readonly style="background:#1e293b;">
                    <div class="form-hint">Скопируйте этот URL в настройки вашей формы</div>
                </div>
                <div class="form-group" id="integrationWidgetGroup" style="display:none;">
                    <label>Код виджета</label>
                    <textarea id="integrationWidget" rows="4" readonly style="background:#1e293b;font-family:monospace;font-size:12px;"></textarea>
                    <div class="form-hint">Вставьте этот код на ваш сайт перед &lt;/body&gt;</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('integrationModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveIntegration()">Создать</button>
            </div>
        </div>
    </div>

    <!-- Provider Settings Modal -->
    <div class="modal-overlay" id="providerSettingsModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3 id="providerSettingsTitle">Настройки провайдера</h3>
                <button class="modal-close" onclick="closeModal('providerSettingsModal')">&times;</button>
            </div>
            <div class="modal-body" id="providerSettingsBody"></div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="testProviderConnection()" id="providerTestBtn"><i class="fas fa-plug"></i> Тест соединения</button>
                <button class="btn btn-outline" onclick="closeModal('providerSettingsModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveProviderSettings()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3 id="categoryModalTitle">Новая категория</h3>
                <button class="modal-close" onclick="closeModal('categoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="categoryEditId">
                <div class="form-group">
                    <label>Название категории *</label>
                    <input type="text" id="categoryName" placeholder="Название категории">
                </div>
                <div class="form-group">
                    <label>Родительская категория</label>
                    <select id="categoryParent">
                        <option value="">— Корневая категория —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="categoryDescription" rows="2" placeholder="Описание категории"></textarea>
                </div>
                <div class="form-group">
                    <label>Изображение</label>
                    <input type="file" id="categoryImage" accept="image/*">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('categoryModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveCategory()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Product Filter Modal -->
    <div class="modal-overlay" id="productFilterModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3>Добавить фильтр</h3>
                <button class="modal-close" onclick="closeModal('productFilterModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Выберите тип фильтра или создайте свой</label>
                    <select id="filterType" onchange="toggleCustomFilter()">
                        <option value="size">Размер</option>
                        <option value="color">Цвет</option>
                        <option value="material">Материал</option>
                        <option value="brand">Бренд</option>
                        <option value="season">Сезон</option>
                        <option value="gender">Пол</option>
                        <option value="custom">Свой фильтр...</option>
                    </select>
                </div>
                <div id="customFilterName" style="display:none;" class="form-group">
                    <label>Название фильтра</label>
                    <input type="text" id="filterCustomName" placeholder="Например: Страна производства">
                </div>
                <div class="form-group">
                    <label>Значения фильтра (по одному на строку)</label>
                    <textarea id="filterValues" rows="6" placeholder="Например:
XS
S
M
L
XL"></textarea>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="filterMultiple"> Множественный выбор
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('productFilterModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveProductFilter()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Selection Modal -->
    <div class="modal-overlay" id="selectionModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3 id="selectionModalTitle">Новая подборка</h3>
                <button class="modal-close" onclick="closeModal('selectionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="selectionEditId">
                <div class="form-group">
                    <label>Название подборки *</label>
                    <input type="text" id="selectionName" placeholder="Хиты продаж">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="selectionDescription" rows="2" placeholder="Описание подборки"></textarea>
                </div>
                <div class="form-group">
                    <label>Тип подборки</label>
                    <select id="selectionType">
                        <option value="manual">Ручная (выбор товаров)</option>
                        <option value="auto">Автоматическая (по правилам)</option>
                    </select>
                </div>
                <div id="selectionProductsGroup" class="form-group">
                    <label>Товары</label>
                    <select id="selectionProducts" multiple style="height:150px;"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('selectionModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveSelection()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Import XML Modal -->
    <div class="modal-overlay" id="importXmlModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3>Импорт товаров из XML</h3>
                <button class="modal-close" onclick="closeModal('importXmlModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>XML файл *</label>
                    <input type="file" id="xmlFile" accept=".xml">
                </div>
                <div class="form-group">
                    <label>Или укажите URL</label>
                    <input type="text" id="xmlUrl" placeholder="https://example.com/products.xml">
                </div>
                <div class="form-group">
                    <label>Формат</label>
                    <select id="xmlFormat">
                        <option value="yandex">Яндекс.Маркет (YML)</option>
                        <option value="insales">InSales</option>
                        <option value="1c">1C CommerceML</option>
                        <option value="custom">Другой</option>
                    </select>
                </div>
                <div style="background:#1e293b;padding:15px;border-radius:8px;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="xmlUpdateExisting"> Обновить существующие товары
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;margin-top:10px;">
                        <input type="checkbox" id="xmlCreateCategories" checked> Создать категории
                    </label>
                </div>
                <div id="xmlProgress" style="display:none;margin-top:15px;">
                    <div style="background:var(--border-color);border-radius:4px;overflow:hidden;">
                        <div id="xmlProgressBar" style="width:0%;height:8px;background:var(--accent);transition:width 0.3s;"></div>
                    </div>
                    <p id="xmlProgressText" style="text-align:center;margin-top:8px;font-size:13px;"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('importXmlModal')">Отмена</button>
                <button class="btn btn-primary" onclick="importXml()"><i class="fas fa-upload"></i> Импортировать</button>
            </div>
        </div>
    </div>

    <!-- Specialist Modal -->
    <div class="modal-overlay" id="specialistModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3 id="specialistModalTitle">Добавить специалиста</h3>
                <button class="modal-close" onclick="closeModal('specialistModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="specialistEditId">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Имя *</label>
                        <input type="text" id="specialistFirstName" placeholder="Имя">
                    </div>
                    <div class="form-group">
                        <label>Фамилия</label>
                        <input type="text" id="specialistLastName" placeholder="Фамилия">
                    </div>
                </div>
                <div class="form-group">
                    <label>Должность</label>
                    <input type="text" id="specialistPosition" placeholder="Мастер-стилист">
                </div>
                <div class="form-group">
                    <label>Услуги специалиста</label>
                    <div id="specialistServicesCheckboxes" class="specialist-services-checkboxes">
                        <span style="color:var(--text-muted);font-size:12px;">Загрузка...</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Описание / Опыт</label>
                    <textarea id="specialistBio" rows="3" placeholder="Опыт работы, сертификаты..."></textarea>
                </div>
                <div class="form-group">
                    <label>Филиал</label>
                    <select id="specialistBranch">
                        <option value="">— Основной —</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('specialistModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveSpecialist()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Room Modal -->
    <div class="modal-overlay" id="roomModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3 id="roomModalTitle">Добавить помещение</h3>
                <button class="modal-close" onclick="closeModal('roomModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="roomEditId">
                <div class="form-group">
                    <label>Название *</label>
                    <input type="text" id="roomName" placeholder="Кабинет №1">
                </div>
                <div class="form-group">
                    <label>Вместимость</label>
                    <input type="number" id="roomCapacity" placeholder="1" value="1">
                </div>
                <div class="form-group">
                    <label>Услуги, доступные в помещении</label>
                    <select id="roomServices" multiple style="height:100px;"></select>
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="roomDescription" rows="2" placeholder="Описание помещения"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('roomModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveRoom()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Training Modal -->
    <div class="modal-overlay" id="trainingModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3 id="trainingModalTitle">Новый тренинг</h3>
                <button class="modal-close" onclick="closeModal('trainingModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <input type="hidden" id="trainingEditId">
                <div class="form-group">
                    <label>Название тренинга *</label>
                    <input type="text" id="trainingName" placeholder="Основы программирования">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="trainingDescription" rows="3" placeholder="Описание тренинга"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Тип доступа</label>
                        <select id="trainingAccessType">
                            <option value="purchase">После покупки продукта</option>
                            <option value="group">По группе</option>
                            <option value="free">Бесплатный</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Продукт для покупки</label>
                        <select id="trainingProduct">
                            <option value="">— Не требуется —</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Дни доступа</label>
                        <input type="number" id="trainingAccessDays" placeholder="0 = бессрочно" value="0">
                    </div>
                    <div class="form-group">
                        <label>Drip-контент</label>
                        <select id="trainingDrip">
                            <option value="0">Весь сразу</option>
                            <option value="1">1 урок в день</option>
                            <option value="2">1 урок в 2 дня</option>
                            <option value="7">1 урок в неделю</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="trainingSequentialAccess"> Открывать уроки последовательно
                    </label>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;margin-left:26px;">Студенты смогут открыть следующий урок только после завершения предыдущего</div>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="trainingAutoCertificate" onchange="toggleAutoCertTemplate()"> Выдавать сертификат автоматически
                    </label>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;margin-left:26px;">Сертификат будет выдан автоматически при завершении всех уроков</div>
                </div>
                <div class="form-group" id="autoCertTemplateGroup" style="display:none;margin-left:26px;">
                    <label>Шаблон сертификата</label>
                    <select id="trainingCertTemplate">
                        <option value="">По умолчанию</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="trainingPublished"> Опубликован (доступен студентам)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('trainingModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveTraining()" id="trainingSaveBtn">Создать тренинг</button>
            </div>
        </div>
    </div>

    <!-- Training Details Modal -->
    <div class="modal-overlay" id="trainingDetailsModal">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <h3 id="trainingDetailsTitle">Тренинг</h3>
                <button class="modal-close" onclick="closeModal('trainingDetailsModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;">
                    <div>
                        <!-- Tabs -->
                        <div class="tabs" style="margin-bottom:20px;">
                            <button class="tab-btn active" onclick="switchTrainingTab('lessons')">Уроки</button>
                            <button class="tab-btn" onclick="switchTrainingTab('students')">Студенты</button>
                            <button class="tab-btn" onclick="switchTrainingTab('analytics')">Аналитика</button>
                        </div>

                        <!-- Lessons Tab -->
                        <div id="trainingTabLessons" class="tab-content active">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                                <h4 style="margin:0;">Уроки тренинга</h4>
                                <button class="btn btn-sm btn-primary" onclick="addLessonToTraining()"><i class="fas fa-plus"></i> Добавить урок</button>
                            </div>
                            <div id="trainingLessonsList"></div>
                        </div>

                        <!-- Students Tab -->
                        <div id="trainingTabStudents" class="tab-content" style="display:none;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                                <h4 style="margin:0;">Студенты</h4>
                                <button class="btn btn-sm btn-primary" onclick="enrollStudentModal()"><i class="fas fa-user-plus"></i> Записать</button>
                            </div>
                            <table>
                                <thead><tr><th>Студент</th><th>Прогресс</th><th>Дата записи</th><th>Последняя активность</th><th>Тест</th><th>Статус</th><th></th></tr></thead>
                                <tbody id="trainingStudentsTable"></tbody>
                            </table>
                        </div>

                        <!-- Analytics Tab -->
                        <div id="trainingTabAnalytics" class="tab-content" style="display:none;">
                            <div class="stats-grid" style="margin-bottom:20px;">
                                <div class="stat-card success">
                                    <div class="value" id="analyticsCompletionRate">0%</div>
                                    <div class="label">Завершили</div>
                                </div>
                                <div class="stat-card primary">
                                    <div class="value" id="analyticsAvgProgress">0%</div>
                                    <div class="label">Средний прогресс</div>
                                </div>
                                <div class="stat-card warning">
                                    <div class="value" id="analyticsDropoffRate">0%</div>
                                    <div class="label">Бросили</div>
                                </div>
                            </div>
                            <h4>Прогресс по урокам</h4>
                            <div id="lessonProgressChart" style="display:flex;flex-direction:column;gap:8px;"></div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div>
                        <div class="stats-grid" style="grid-template-columns:1fr;gap:10px;margin-bottom:20px;">
                            <div class="stat-card">
                                <div class="value" id="trainingStudentsCount">0</div>
                                <div class="label">Студентов</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="trainingLessonsCount">0</div>
                                <div class="label">Уроков</div>
                            </div>
                            <div class="stat-card success">
                                <div class="value" id="trainingCertificatesIssued">0</div>
                                <div class="label">Сертификатов</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <p style="color:var(--text-muted);font-size:12px;">Тип доступа</p>
                                <p id="trainingAccessInfo" style="font-weight:500;">—</p>
                                <p style="color:var(--text-muted);font-size:12px;margin-top:15px;">Статус</p>
                                <p id="trainingStatusInfo">—</p>
                            </div>
                        </div>

                        <div style="margin-top:15px;display:flex;flex-direction:column;gap:8px;">
                            <button class="btn btn-primary" onclick="editTrainingFromDetails()"><i class="fas fa-edit"></i> Редактировать</button>
                            <button class="btn btn-outline" onclick="duplicateTraining()"><i class="fas fa-copy"></i> Дублировать</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enroll Student Modal -->
    <div class="modal-overlay" id="enrollStudentModal">
        <div class="modal" style="max-width:450px;">
            <div class="modal-header">
                <h3>Записать на тренинг</h3>
                <button class="modal-close" onclick="closeModal('enrollStudentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Выберите клиента</label>
                    <select id="enrollClient">
                        <option value="">— Выберите —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Дата начала доступа</label>
                    <input type="date" id="enrollStartDate">
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="enrollSendNotification" checked>
                        Отправить уведомление о записи
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('enrollStudentModal')">Отмена</button>
                <button class="btn btn-primary" onclick="enrollStudent()">Записать</button>
            </div>
        </div>
    </div>

    <!-- Lesson Modal -->
    <div class="modal-overlay" id="lessonModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3 id="lessonModalTitle">Новый урок</h3>
                <button class="modal-close" onclick="closeModal('lessonModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <input type="hidden" id="lessonEditId">
                <div class="form-group">
                    <label>Тренинг *</label>
                    <select id="lessonTraining">
                        <option value="">— Выберите тренинг —</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:3fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Название урока *</label>
                        <input type="text" id="lessonName" placeholder="Введение">
                    </div>
                    <div class="form-group">
                        <label>Порядок</label>
                        <input type="number" id="lessonOrder" value="1" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Тип урока</label>
                    <select id="lessonType" onchange="toggleLessonContent()">
                        <option value="video">Видео</option>
                        <option value="text">Текст</option>
                        <option value="quiz">Тест</option>
                        <option value="homework">Домашнее задание</option>
                    </select>
                </div>
                <div id="lessonVideoGroup" class="form-group">
                    <label>Видео URL (YouTube, Vimeo, MP4)</label>
                    <input type="text" id="lessonVideoUrl" placeholder="https://youtube.com/watch?v=...">
                </div>
                <div id="lessonTextGroup" class="form-group" style="display:none;">
                    <label>Контент урока</label>
                    <textarea id="lessonContent" rows="10" placeholder="Содержимое урока..."></textarea>
                </div>
                <div class="form-group">
                    <label>Длительность (мин)</label>
                    <input type="number" id="lessonDuration" placeholder="15">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('lessonModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveLesson()" id="lessonSaveBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Autowebinar Modal -->
    <div class="modal-overlay" id="autoWebinarModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h3>Создать автовебинар</h3>
                <button class="modal-close" onclick="closeModal('autoWebinarModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div class="form-group">
                    <label>Название автовебинара *</label>
                    <input type="text" id="autoWebinarName" placeholder="Как начать бизнес с нуля">
                </div>
                <div class="form-group">
                    <label>Видео записи вебинара *</label>
                    <input type="text" id="autoWebinarVideo" placeholder="https://youtube.com/watch?v=...">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div class="form-group">
                        <label>Длительность (мин)</label>
                        <input type="number" id="autoWebinarDuration" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label>Тренинг (опционально)</label>
                        <select id="autoWebinarTraining">
                            <option value="">— Не привязан —</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Расписание показов</label>
                    <div style="background:#1e293b;padding:15px;border-radius:8px;">
                        <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                            <input type="checkbox" id="autoWebinarScheduled"> По расписанию
                        </label>
                        <div id="autoWebinarSchedule" style="margin-top:15px;display:none;">
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                                <input type="time" id="autoWebinarTime1" class="filter-select">
                                <input type="time" id="autoWebinarTime2" class="filter-select">
                                <input type="time" id="autoWebinarTime3" class="filter-select">
                            </div>
                            <p style="font-size:12px;color:var(--text-muted);margin-top:10px;">Укажите время показов (по Москве)</p>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Симуляция чата</label>
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="autoWebinarChat" checked> Включить имитацию сообщений в чате
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('autoWebinarModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveAutoWebinar()">Создать автовебинар</button>
            </div>
        </div>
    </div>

    <!-- Certificate Template Modal -->
    <div class="modal-overlay" id="certificateTemplateModal">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <h3>Редактор шаблона сертификата</h3>
                <button class="modal-close" onclick="closeModal('certificateTemplateModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
                <div style="display:grid;grid-template-columns:1fr 2fr;gap:20px;">
                    <!-- Settings Panel -->
                    <div>
                        <div class="form-group">
                            <label>Название шаблона *</label>
                            <input type="text" id="certTemplateName" placeholder="Стандартный сертификат">
                        </div>
                        <div class="form-group">
                            <label>Фон (подложка)</label>
                            <input type="file" id="certTemplateBackground" accept="image/*">
                            <div id="certBgPreview" style="margin-top:10px;"></div>
                        </div>
                        <div class="form-group">
                            <label>Тренинг</label>
                            <select id="certTemplateTraining">
                                <option value="">— Для всех —</option>
                            </select>
                        </div>
                        <hr style="border-color:var(--border-color);margin:20px 0;">
                        <h4 style="margin-bottom:10px;">Оформление</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:11px;">Цвет фона</label>
                                <input type="color" id="certTemplateBg" value="#1a1a2e" style="width:100%;height:36px;border:none;cursor:pointer;" onchange="updateCertPreview()">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:11px;">Цвет текста</label>
                                <input type="color" id="certTemplateText" value="#ffffff" style="width:100%;height:36px;border:none;cursor:pointer;" onchange="updateCertPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="font-size:11px;">Стиль рамки</label>
                            <select id="certTemplateBorder" onchange="updateCertPreview()">
                                <option value="classic">Классическая</option>
                                <option value="modern">Современная</option>
                                <option value="minimal">Минимализм</option>
                                <option value="gold">Золотая</option>
                            </select>
                        </div>
                        <hr style="border-color:var(--border-color);margin:20px 0;">
                        <h4 style="margin-bottom:15px;">Элементы</h4>
                        <div class="cert-elements">
                            <div class="cert-element-item" draggable="true" data-element="name">
                                <i class="fas fa-user"></i> Имя студента
                            </div>
                            <div class="cert-element-item" draggable="true" data-element="training">
                                <i class="fas fa-graduation-cap"></i> Название тренинга
                            </div>
                            <div class="cert-element-item" draggable="true" data-element="number">
                                <i class="fas fa-hashtag"></i> Номер сертификата
                            </div>
                            <div class="cert-element-item" draggable="true" data-element="date">
                                <i class="fas fa-calendar"></i> Дата выдачи
                            </div>
                            <div class="cert-element-item" draggable="true" data-element="signature">
                                <i class="fas fa-signature"></i> Подпись
                            </div>
                        </div>
                    </div>
                    <!-- Preview Canvas -->
                    <div>
                        <div id="certPreviewCanvas" style="background:#fff;border-radius:8px;aspect-ratio:1.414;position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ccc;text-align:center;">
                                <i class="fas fa-image" style="font-size:48px;"></i>
                                <p>Загрузите фон</p>
                            </div>
                            <!-- Draggable elements will be placed here -->
                            <div id="certElementName" class="cert-draggable" style="position:absolute;top:40%;left:50%;transform:translateX(-50%);font-size:24px;color:#333;font-weight:bold;">
                                {ИМЯ СТУДЕНТА}
                            </div>
                            <div id="certElementTraining" class="cert-draggable" style="position:absolute;top:50%;left:50%;transform:translateX(-50%);font-size:18px;color:#333;">
                                {НАЗВАНИЕ ТРЕНИНГА}
                            </div>
                            <div id="certElementNumber" class="cert-draggable" style="position:absolute;top:75%;left:20%;font-size:12px;color:#666;">
                                №{НОМЕР}
                            </div>
                            <div id="certElementDate" class="cert-draggable" style="position:absolute;top:75%;right:20%;font-size:12px;color:#666;">
                                {ДАТА}
                            </div>
                        </div>
                        <p style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:10px;">
                            Перетаскивайте элементы для позиционирования
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('certificateTemplateModal')">Отмена</button>
                <button class="btn btn-primary" onclick="saveCertificateTemplate()">Сохранить шаблон</button>
            </div>
        </div>
    </div>

    <!-- Issue Certificate Modal -->
    <div class="modal-overlay" id="issueCertificateModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3>Выдать сертификат</h3>
                <button class="modal-close" onclick="closeModal('issueCertificateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Студент *</label>
                    <select id="certStudent">
                        <option value="">— Выберите студента —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Тренинг *</label>
                    <select id="certTraining">
                        <option value="">— Выберите тренинг —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Шаблон сертификата</label>
                    <select id="certTemplate">
                        <option value="">— По умолчанию —</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Номер сертификата</label>
                    <div style="display:flex;gap:8px;">
                        <input type="text" id="certNumber" placeholder="CERT-0001" style="flex:1;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="generateCertNumber()">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:normal;">
                        <input type="checkbox" id="certSendEmail" checked>
                        Отправить сертификат на email студента
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('issueCertificateModal')">Отмена</button>
                <button class="btn btn-primary" onclick="issueCertificate()"><i class="fas fa-certificate"></i> Выдать</button>
            </div>
        </div>
    </div>

    <style>
        .cert-element-item {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .cert-element-item:hover {
            background: var(--border-color);
        }
        .cert-draggable {
            cursor: move;
            user-select: none;
        }
        .cert-draggable:hover {
            outline: 2px dashed var(--accent);
        }
        .type-option:has(input:checked) {
            border-color: var(--accent) !important;
            background: rgba(99, 102, 241, 0.1) !important;
        }
        .bookings-calendar {
            width: 100%;
            border-collapse: collapse;
        }
        .bookings-calendar th,
        .bookings-calendar td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
            min-width: 100px;
        }
        .bookings-calendar th {
            background: var(--bg-input);
        }
        .bookings-calendar .time-cell {
            background: var(--bg-input);
            font-weight: 500;
        }
        .bookings-calendar .slot-cell {
            cursor: pointer;
            transition: background 0.2s;
            min-height: 40px;
            vertical-align: top;
        }
        .bookings-calendar .slot-cell:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .bookings-calendar .slot-cell.booked {
            text-align: left;
            padding: 6px 8px;
        }
        .bookings-calendar .slot-cell.booked:hover {
            opacity: 0.9;
        }
        .bookings-calendar .slot-booked {
            background: rgba(99, 102, 241, 0.2);
        }
        .booking-item {
            font-size: 11px;
            padding: 4px 6px;
            background: var(--accent);
            color: white;
            border-radius: 4px;
            margin-bottom: 2px;
            cursor: pointer;
        }
        .categories-tree {
            padding: 10px;
        }
        .category-item {
            padding: 10px 15px;
            margin: 5px 0;
            background: var(--bg-input);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .category-item:hover {
            background: var(--border-color);
        }
        .category-children {
            margin-left: 25px;
            border-left: 2px solid var(--border-color);
            padding-left: 15px;
        }

        /* Section Tabs */
        /* Regulation block editor */
        .reg-block-wrapper { position: relative; margin-bottom: 8px; padding-left: 36px; }
        .reg-block-wrapper:hover .reg-block-actions { opacity: 1; }
        .reg-block-actions {
            position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 2px; opacity: 0; transition: opacity 0.15s;
        }
        .reg-block-actions button {
            width: 24px; height: 24px; border: 1px solid var(--border-color); border-radius: 4px;
            background: var(--bg-card); color: var(--text-muted); cursor: pointer; font-size: 11px;
            display: flex; align-items: center; justify-content: center; padding: 0;
        }
        .reg-block-actions button:hover { background: var(--primary); color: #fff; border-color: var(--primary); }
        .reg-block-insert-btn {
            position: absolute; left: 50%; transform: translateX(-50%); bottom: -14px;
            width: 24px; height: 24px; border-radius: 50%; border: 1px dashed var(--border-color);
            background: var(--bg-card); color: var(--text-muted); cursor: pointer; font-size: 12px;
            display: none; align-items: center; justify-content: center; z-index: 2; padding: 0;
        }
        .reg-block-wrapper:hover .reg-block-insert-btn { display: flex; }
        .reg-block-insert-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--bg-input); }
        .reg-checklist-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
        .reg-checklist-item input[type="checkbox"] { flex-shrink: 0; }
        .reg-checklist-item input[type="text"] { flex: 1; border: none; border-bottom: 1px solid var(--border-color); background: transparent; color: var(--text-primary); padding: 4px 0; outline: none; }
        .reg-checklist-item input[type="text"]:focus { border-color: var(--primary); }
        .reg-checklist-item button { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px 6px; font-size: 12px; }
        .reg-checklist-item button:hover { color: var(--danger); }

        .section-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .section-tabs::-webkit-scrollbar { display: none; }
        .section-tab-btn {
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            border-radius: 0;
            padding: 12px 20px;
            color: var(--text-muted);
            background: none;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
        }
        .section-tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        .section-tab-btn:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(59,130,246,0.05);
        }
        .section-tab-btn i { margin-right: 6px; }
    </style>

    <script>
        // ============================================================
        // GLOBAL UTILITIES
        // ============================================================

        // Toast Notifications
        function toast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const toastEl = document.createElement('div');
            toastEl.className = `toast ${type}`;
            toastEl.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <span>${message}</span>
                <span class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></span>
            `;
            container.appendChild(toastEl);

            setTimeout(() => {
                toastEl.style.animation = 'toastOut 0.3s ease forwards';
                setTimeout(() => toastEl.remove(), 300);
            }, duration);
        }

        // Loading Overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Confirmation Dialog
        function confirm(message, title = 'Подтверждение') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.style.display = 'flex';
                overlay.innerHTML = `
                    <div class="confirm-dialog">
                        <h3>${title}</h3>
                        <p>${message}</p>
                        <div class="actions">
                            <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove(); window._confirmResolve(false);">Отмена</button>
                            <button class="btn btn-danger" onclick="this.closest('.modal-overlay').remove(); window._confirmResolve(true);">Подтвердить</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                window._confirmResolve = resolve;
            });
        }

        // ============================================================
        // SECTION TAB SYSTEM
        // ============================================================
        const currentSectionTabs = {};
        const sectionTabConfigs = {
            sales: { tabs: ['deals','calls','regulations','goals','distribution'], default: 'deals' },
            team: { tabs: ['employees','tasks','analytics'], default: 'employees' },
            orders: { tabs: ['orders','payments'], default: 'orders' },
            catalog: { tabs: ['products','categories','selections','promos','filters'], default: 'products' },
            bookings: { tabs: ['calendar','services','specialists','rooms','schedules'], default: 'calendar' },
            learning: { tabs: ['trainings','lessons','webinars','quizzes','certificates'], default: 'trainings' }
        };

        function switchSectionTab(section, tab) {
            const config = sectionTabConfigs[section];
            if (!config) return;
            config.tabs.forEach(t => {
                const panel = document.getElementById(`${section}TabPanel_${t}`);
                const btn = document.getElementById(`${section}Tab_${t}`);
                if (panel) panel.style.display = t === tab ? 'block' : 'none';
                if (btn) {
                    if (t === tab) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });
            currentSectionTabs[section] = tab;
            loadTabData(section, tab);
        }

        function loadTabData(section, tab) {
            const loaders = {
                sales: { deals: loadDealsKanban, calls: () => { loadCalls(); initUIS(); }, regulations: loadRegulations, goals: loadGoals, distribution: loadLeadDistribution },
                team: { employees: loadEmployees, tasks: loadTasks, analytics: loadEmployeeAnalytics },
                orders: { orders: loadOrders, payments: loadPayments },
                catalog: { products: loadProducts, categories: loadCategories, selections: loadSelections, promos: loadPromoCodes, filters: loadProductFilters },
                bookings: { calendar: loadBookings, services: loadServices, specialists: loadSpecialists, rooms: loadRooms, schedules: loadSchedules },
                learning: { trainings: loadTrainings, lessons: loadLessons, webinars: loadWebinars, quizzes: loadQuizzes, certificates: loadCertificates }
            };
            if (loaders[section] && loaders[section][tab]) {
                try { loaders[section][tab](); } catch(e) { console.error(`Error loading ${section}/${tab}:`, e); }
            }
        }

        // Format helpers
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(amount || 0);
        }
        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(num || 0);
        }
        function formatPercent(value) {
            return Math.round(value || 0) + '%';
        }

        // Debounce for search inputs
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Copy to clipboard
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                toast('Скопировано в буфер обмена', 'success');
            } catch (e) {
                toast('Не удалось скопировать', 'error');
            }
        }

        // Generate random ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // ============================================================
        // CONFIG
        // ============================================================
        const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
            ? '/api'
            : 'https://cms-backend-34f8.onrender.com/api';
        let projectId = null;
        let funnels = [], clients = [], employees = [], deals = [], orders = [], tasks = [], products = [];

        // API Helper
        async function api(method, endpoint, data = null) {
            const token = localStorage.getItem('cms_token');
            const opts = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (token) opts.headers['Authorization'] = 'Bearer ' + token;
            if (data) opts.body = JSON.stringify(data);

            try {
                const res = await fetch(API_BASE + endpoint, opts);
                const json = await res.json();
                return json;
            } catch (err) {
                console.error('API error:', method, endpoint, err);
                return { success: false, error: 'Ошибка сети: сервер не отвечает' };
            }
        }

        // Init
        async function init() {
            // Get project from localStorage or redirect to login
            const projects = JSON.parse(localStorage.getItem('cms_projects') || '[]');
            if (projects.length === 0) {
                toast('Сначала войдите в систему', 'error');
                location.href = 'admin.html';
                return;
            }
            projectId = projects[0].id;

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['bookingsDate', 'bookingDate', 'goalStart', 'promoStart'];
            dateInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.value) el.value = today;
            });

            // Set default end dates (end of month)
            const endOfMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString().split('T')[0];
            ['goalEnd', 'promoEnd'].forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.value) el.value = endOfMonth;
            });

            setupNavigation();
            applyModuleVisibility();
            await loadAllData();

            // Handle hash-based navigation from admin.html
            const hash = location.hash.replace('#', '');
            if (hash && document.getElementById('section-' + hash)) {
                switchSection(hash);
            } else {
                renderDashboard();
            }
        }

        async function loadAllData() {
            await Promise.all([
                loadFunnels(),
                loadClients(),
                loadEmployees(),
                loadOrders(),
                loadProducts(),
                loadSegments()
            ]);
            updateOrderClientSelect();
            populateSelects();
            loadServicesForBooking();
            loadCoursesForModals();

            // Seed demo data if everything is empty (first launch)
            if (!funnels.length && !clients.length && !products.length) {
                seedDemoData();
            }
        }

        // ===== Demo / Template Data =====
        function seedDemoData() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const yesterday = new Date(now - 86400000).toISOString().split('T')[0];
            const weekAgo = new Date(now - 7 * 86400000).toISOString().split('T')[0];
            const monthAgo = new Date(now - 30 * 86400000).toISOString().split('T')[0];

            // === Funnels ===
            funnels = [{
                id: 'demo-f1', name: 'Основная воронка продаж',
                stages: [
                    { id: 'demo-s1', name: 'Новая заявка', color: '#3b82f6', order_index: 0, deals_count: 3 },
                    { id: 'demo-s2', name: 'Квалификация', color: '#f59e0b', order_index: 1, deals_count: 2 },
                    { id: 'demo-s3', name: 'Предложение', color: '#8b5cf6', order_index: 2, deals_count: 1 },
                    { id: 'demo-s4', name: 'Переговоры', color: '#06b6d4', order_index: 3, deals_count: 1 },
                    { id: 'demo-s5', name: 'Закрыто (выигрыш)', color: '#10b981', order_index: 4, deals_count: 2 }
                ],
                deals_count: 9
            }, {
                id: 'demo-f2', name: 'Вебинарная воронка',
                stages: [
                    { id: 'demo-s6', name: 'Регистрация', color: '#3b82f6', order_index: 0, deals_count: 5 },
                    { id: 'demo-s7', name: 'Посетил', color: '#f59e0b', order_index: 1, deals_count: 3 },
                    { id: 'demo-s8', name: 'Оставил заявку', color: '#10b981', order_index: 2, deals_count: 1 }
                ],
                deals_count: 9
            }];

            // === Clients ===
            clients = [
                { id: 'demo-c1', first_name: 'Анна', last_name: 'Петрова', email: 'anna@example.com', phone: '+7 916 123-45-67', company: 'ООО "Рассвет"', source: 'Сайт', tags: '["VIP","Постоянный"]', total_spent: 185000, total_orders: 5, courses_count: 2, bookings_count: 3, created_at: monthAgo },
                { id: 'demo-c2', first_name: 'Дмитрий', last_name: 'Козлов', email: 'dmitry.k@example.com', phone: '+7 926 987-65-43', company: 'ИП Козлов', source: 'Instagram', tags: '["Новый"]', total_spent: 42000, total_orders: 2, courses_count: 1, bookings_count: 1, created_at: weekAgo },
                { id: 'demo-c3', first_name: 'Елена', last_name: 'Сидорова', email: 'elena.s@example.com', phone: '+7 903 555-12-34', company: 'Фриланс', source: 'Рекомендация', tags: '["Активный"]', total_spent: 67500, total_orders: 3, courses_count: 1, bookings_count: 0, created_at: monthAgo },
                { id: 'demo-c4', first_name: 'Максим', last_name: 'Иванов', email: 'max.ivanov@example.com', phone: '+7 977 333-44-55', company: 'TechStart', source: 'Вебинар', tags: '["Лид"]', total_spent: 0, total_orders: 0, courses_count: 0, bookings_count: 0, created_at: yesterday }
            ];

            // === Employees ===
            employees = [
                { id: 'demo-e1', name: 'Мария Волкова', role: 'Менеджер', email: 'maria@company.com', phone: '+7 916 100-00-01', avatar: null },
                { id: 'demo-e2', name: 'Алексей Смирнов', role: 'Руководитель отдела', email: 'alexey@company.com', phone: '+7 916 100-00-02', avatar: null },
                { id: 'demo-e3', name: 'Ольга Кузнецова', role: 'Специалист поддержки', email: 'olga@company.com', phone: '+7 916 100-00-03', avatar: null }
            ];

            // === Deals ===
            deals = [
                { id: 'demo-d1', name: 'Разработка сайта для "Рассвет"', amount: 150000, stage_id: 'demo-s3', stage_name: 'Предложение', funnel_id: 'demo-f1', client_id: 'demo-c1', client_name: 'Анна Петрова', probability: 70, created_at: weekAgo },
                { id: 'demo-d2', name: 'Консультация по маркетингу', amount: 35000, stage_id: 'demo-s2', stage_name: 'Квалификация', funnel_id: 'demo-f1', client_id: 'demo-c2', client_name: 'Дмитрий Козлов', probability: 40, created_at: yesterday },
                { id: 'demo-d3', name: 'Внедрение CRM для TechStart', amount: 250000, stage_id: 'demo-s1', stage_name: 'Новая заявка', funnel_id: 'demo-f1', client_id: 'demo-c4', client_name: 'Максим Иванов', probability: 20, created_at: today },
                { id: 'demo-d4', name: 'Курс по SMM — Сидорова', amount: 15000, stage_id: 'demo-s5', stage_name: 'Закрыто (выигрыш)', funnel_id: 'demo-f1', client_id: 'demo-c3', client_name: 'Елена Сидорова', probability: 100, created_at: monthAgo }
            ];

            // === Orders ===
            orders = [
                { id: 'demo-o1', order_number: 'ORD-2026-001', client_id: 'demo-c1', client_name: 'Анна Петрова', total: 45000, status: 'completed', payment_status: 'paid', created_at: monthAgo },
                { id: 'demo-o2', order_number: 'ORD-2026-002', client_id: 'demo-c3', client_name: 'Елена Сидорова', total: 15000, status: 'completed', payment_status: 'paid', created_at: weekAgo },
                { id: 'demo-o3', order_number: 'ORD-2026-003', client_id: 'demo-c2', client_name: 'Дмитрий Козлов', total: 27000, status: 'processing', payment_status: 'pending', created_at: yesterday },
                { id: 'demo-o4', order_number: 'ORD-2026-004', client_id: 'demo-c1', client_name: 'Анна Петрова', total: 89000, status: 'new', payment_status: 'pending', created_at: today }
            ];

            // === Products ===
            products = [
                { id: 'demo-p1', name: 'Курс "Основы маркетинга"', sku: 'CRS-MRK-01', price: 15000, old_price: 25000, stock: 999, is_active: true, product_type: 'online', brand: null, images: [], variants: [], description: 'Полный курс по основам интернет-маркетинга' },
                { id: 'demo-p2', name: 'Рабочая тетрадь к курсу', sku: 'WB-MRK-01', price: 1500, old_price: null, stock: 45, is_active: true, product_type: 'physical', brand: 'StudyKit', images: [], variants: [{ name: 'A4', sku_suffix: '-A4', price_modifier: 0, stock: 30 }, { name: 'A5', sku_suffix: '-A5', price_modifier: -200, stock: 15 }] },
                { id: 'demo-p3', name: 'Шаблоны для соцсетей (100 шт)', sku: 'TPL-SOC-100', price: 3900, old_price: 5900, stock: 999, is_active: true, product_type: 'digital', brand: null, images: [], variants: [] },
                { id: 'demo-p4', name: 'Персональная консультация 1 час', sku: 'CONS-1H', price: 7500, old_price: null, stock: 10, is_active: true, product_type: 'online', brand: null, images: [], variants: [] }
            ];

            // === Tasks ===
            tasks = [
                { id: 'demo-t1', title: 'Подготовить КП для "Рассвет"', description: 'Коммерческое предложение на разработку сайта', assigned_to: 'demo-e1', assigned_name: 'Мария Волкова', due_date: today, status: 'in_progress', priority: 'high' },
                { id: 'demo-t2', title: 'Обзвонить новые лиды', description: 'Связаться с лидами за последнюю неделю', assigned_to: 'demo-e1', assigned_name: 'Мария Волкова', due_date: today, status: 'pending', priority: 'medium' },
                { id: 'demo-t3', title: 'Обновить контент на сайте', description: 'Обновить раздел "О нас" и портфолио', assigned_to: 'demo-e3', assigned_name: 'Ольга Кузнецова', due_date: yesterday, status: 'completed', priority: 'low' }
            ];

            // Render all primary sections
            renderFunnels();
            updateFunnelSelects();
            renderClients(clients);
            renderProducts();
            renderOrders();
            renderTasks();
            populateSelects();

            // === Services (YClients) ===
            if (typeof services !== 'undefined') {
                services = [
                    { id: 'demo-sv1', name: 'Стрижка женская', price: 2500, duration: 60, category: 'Парикмахерские услуги', is_active: true },
                    { id: 'demo-sv2', name: 'Маникюр классический', price: 1800, duration: 45, category: 'Ногтевой сервис', is_active: true },
                    { id: 'demo-sv3', name: 'Массаж спины', price: 3500, duration: 60, category: 'Массаж', is_active: true }
                ];
            }

            // === Specialists ===
            if (typeof specialists !== 'undefined') {
                specialists = [
                    { id: 'demo-sp1', first_name: 'Ирина', last_name: 'Белова', specialization: 'Стилист-парикмахер', phone: '+7 900 111-22-33', experience: '8 лет' },
                    { id: 'demo-sp2', first_name: 'Наталья', last_name: 'Морозова', specialization: 'Мастер маникюра', phone: '+7 900 444-55-66', experience: '5 лет' }
                ];
            }

            // === Rooms ===
            if (typeof rooms !== 'undefined') {
                rooms = [
                    { id: 'demo-r1', name: 'Кабинет №1 (VIP)', capacity: 1, equipment: 'Зеркало, кресло, мойка' },
                    { id: 'demo-r2', name: 'Кабинет №2', capacity: 2, equipment: 'Стол, лампа' }
                ];
                localStorage.setItem(`rooms_${projectId}`, JSON.stringify(rooms));
            }

            // === Trainings ===
            trainings = [
                { id: 'demo-tr1', name: 'Основы интернет-маркетинга', description: 'Полный курс для начинающих маркетологов', lessons_count: 12, students_count: 28, avg_progress: 65, is_published: true, type: 'purchase', certificate_enabled: true },
                { id: 'demo-tr2', name: 'Продвинутый SMM', description: 'Стратегии продвижения в социальных сетях', lessons_count: 8, students_count: 15, avg_progress: 42, is_published: true, type: 'purchase', certificate_enabled: true },
                { id: 'demo-tr3', name: 'Email-маркетинг (черновик)', description: 'Курс в разработке', lessons_count: 3, students_count: 0, avg_progress: 0, is_published: false, type: 'free', certificate_enabled: false }
            ];
            renderTrainings();
            populateTrainingSelects();
            document.getElementById('trainingsTotal').textContent = trainings.length;
            document.getElementById('trainingsStudents').textContent = trainings.reduce((s, t) => s + (t.students_count || 0), 0);

            // === Lessons ===
            lessons = [
                { id: 'demo-l1', title: 'Введение в маркетинг', course_id: 'demo-tr1', type: 'video', duration: 25, completed_count: 28, order_index: 1 },
                { id: 'demo-l2', title: 'Целевая аудитория', course_id: 'demo-tr1', type: 'video', duration: 35, completed_count: 24, order_index: 2 },
                { id: 'demo-l3', title: 'Каналы продвижения', course_id: 'demo-tr1', type: 'video', duration: 40, completed_count: 20, order_index: 3 },
                { id: 'demo-l4', title: 'Домашнее задание: анализ ЦА', course_id: 'demo-tr1', type: 'homework', duration: 0, completed_count: 18, order_index: 4 },
                { id: 'demo-l5', title: 'Стратегия контента для Instagram', course_id: 'demo-tr2', type: 'video', duration: 45, completed_count: 15, order_index: 1 },
                { id: 'demo-l6', title: 'Reels и короткие видео', course_id: 'demo-tr2', type: 'video', duration: 30, completed_count: 12, order_index: 2 }
            ];
            renderLessons();

            // === Webinars ===
            webinars = [
                { id: 'demo-w1', title: 'Бесплатный вебинар: Как запустить рекламу', type: 'live', scheduled_at: new Date(now.getTime() + 3 * 86400000).toISOString(), host_name: 'Алексей Смирнов', registrations: 47, registrations_count: 47, attendees_count: 0, status: 'scheduled', platform: 'zoom', duration_minutes: 90, description: 'Разберём запуск первой рекламной кампании' },
                { id: 'demo-w2', title: 'Автовебинар: 5 шагов к продажам', type: 'auto', scheduled_at: null, host_name: 'Мария Волкова', registrations: 120, registrations_count: 120, attendees_count: 85, status: 'completed', platform: 'youtube', duration_minutes: 60, description: 'Автоматический вебинар для новых лидов', recording_url: 'https://youtube.com/watch?v=example' }
            ];
            renderWebinars(webinars);
            document.getElementById('webinarsUpcoming').textContent = webinars.filter(w => w.status === 'scheduled').length;
            document.getElementById('webinarsLive').textContent = webinars.filter(w => w.status === 'live').length;
            document.getElementById('webinarsCompleted').textContent = webinars.filter(w => w.status === 'completed').length;
            document.getElementById('webinarsParticipants').textContent = webinars.reduce((s, w) => s + (w.registrations_count || 0), 0);

            // === Bookings ===
            const tomorrow = new Date(now.getTime() + 86400000).toISOString().split('T')[0];
            calendarBookings = [
                { id: 'demo-b1', booking_date: today, start_time: '10:00', client_name: 'Анна Петрова', client_phone: '+7 916 123-45-67', service_name: 'Стрижка женская', employee_name: 'Ирина Белова', price: 2500, status: 'confirmed', duration: 60 },
                { id: 'demo-b2', booking_date: today, start_time: '14:00', client_name: 'Елена Сидорова', client_phone: '+7 903 555-12-34', service_name: 'Маникюр классический', employee_name: 'Наталья Морозова', price: 1800, status: 'pending', duration: 45 },
                { id: 'demo-b3', booking_date: tomorrow, start_time: '11:00', client_name: 'Дмитрий Козлов', client_phone: '+7 926 987-65-43', service_name: 'Массаж спины', employee_name: 'Ирина Белова', price: 3500, status: 'confirmed', duration: 60 }
            ];
            document.getElementById('bookingsToday').textContent = calendarBookings.filter(b => b.booking_date === today).length;
            document.getElementById('bookingsConfirmed').textContent = calendarBookings.filter(b => b.status === 'confirmed').length;
            document.getElementById('bookingsPending').textContent = calendarBookings.filter(b => b.status === 'pending').length;
            document.getElementById('bookingsRevenue').textContent = formatMoney(calendarBookings.reduce((s, b) => s + (b.price || 0), 0));

            // === Certificates ===
            certificates = [
                { id: 'demo-cert1', certificate_number: 'CERT-2026-0001', client_name: 'Анна Петрова', course_name: 'Основы интернет-маркетинга', template_name: 'По умолчанию', issued_at: weekAgo },
                { id: 'demo-cert2', certificate_number: 'CERT-2026-0002', client_name: 'Елена Сидорова', course_name: 'Основы интернет-маркетинга', template_name: 'По умолчанию', issued_at: yesterday }
            ];
            renderCertificates(certificates);
            document.getElementById('certificatesIssued').textContent = certificates.length;

            // Render services, specialists, rooms
            if (typeof renderServices === 'function' && services.length) renderServices();
            if (typeof renderSpecialists === 'function' && specialists.length) renderSpecialists();
            if (typeof renderRooms === 'function' && rooms.length) renderRooms();
            if (typeof renderSegments === 'function' && segments.length) renderSegments();

            // === Categories ===
            if (typeof categories !== 'undefined') {
                categories = [
                    { id: 'demo-cat1', name: 'Онлайн-курсы', products_count: 1 },
                    { id: 'demo-cat2', name: 'Учебные материалы', products_count: 1 },
                    { id: 'demo-cat3', name: 'Шаблоны и ресурсы', products_count: 1 },
                    { id: 'demo-cat4', name: 'Консультации', products_count: 1 }
                ];
            }

            // === Segments ===
            if (typeof segments !== 'undefined') {
                segments = [
                    { id: 'demo-seg1', name: 'VIP клиенты', conditions: 'total_spent > 100000', clients_count: 1 },
                    { id: 'demo-seg2', name: 'Новые за неделю', conditions: 'created_at > 7_days', clients_count: 2 }
                ];
            }

            // === Promo Codes (rendered via loadPromoCodes) ===
            const promoTable = document.getElementById('promoCodesTable');
            if (promoTable) {
                promoTable.innerHTML = `
                    <tr>
                        <td><strong>WELCOME20</strong></td>
                        <td>percent</td>
                        <td>20%</td>
                        <td>0 / 100</td>
                        <td>${weekAgo} — ${new Date(now.getTime() + 30 * 86400000).toISOString().split('T')[0]}</td>
                        <td><span class="badge badge-success">Активен</span></td>
                        <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                    </tr>
                    <tr>
                        <td><strong>STUDENT500</strong></td>
                        <td>fixed</td>
                        <td>${formatMoney(500)}</td>
                        <td>12 / 50</td>
                        <td>${monthAgo} — ${today}</td>
                        <td><span class="badge badge-warning">Скоро истечёт</span></td>
                        <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                    </tr>
                `;
            }

            // === Integrations ===
            const intTable = document.getElementById('integrationsTable');
            if (intTable) {
                intTable.innerHTML = `
                    <tr>
                        <td><strong>Telegram бот</strong></td>
                        <td>Telegram</td>
                        <td>23</td>
                        <td>${yesterday}</td>
                        <td><span class="badge badge-success">Активна</span></td>
                        <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                    </tr>
                    <tr>
                        <td><strong>Форма на сайте</strong></td>
                        <td>Веб-форма</td>
                        <td>56</td>
                        <td>${today}</td>
                        <td><span class="badge badge-success">Активна</span></td>
                        <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                    </tr>
                `;
                document.getElementById('integrationsActive').textContent = 2;
                document.getElementById('integrationsWebhooks').textContent = 0;
                document.getElementById('integrationsForms').textContent = 1;
            }

            // === Tags ===
            const tagsList = document.getElementById('tagsList');
            if (tagsList) {
                tagsList.innerHTML = [
                    { name: 'VIP', color: '#3b82f6', count: 1 },
                    { name: 'Постоянный', color: '#10b981', count: 1 },
                    { name: 'Новый', color: '#f59e0b', count: 1 },
                    { name: 'Лид', color: '#8b5cf6', count: 1 },
                    { name: 'Активный', color: '#06b6d4', count: 1 }
                ].map(t => `
                    <div class="stat-card" style="text-align:center;">
                        <span class="badge" style="background:${t.color};font-size:14px;padding:6px 16px;">${t.name}</span>
                        <div class="label" style="margin-top:8px;">${t.count} клиент</div>
                    </div>
                `).join('');
            }

            // === Brands ===
            const brandsList = document.getElementById('brandsList');
            if (brandsList) {
                brandsList.innerHTML = `
                    <div class="stat-card">
                        <div class="value" style="font-size:18px;">StudyKit</div>
                        <div class="label">Учебные материалы · 1 товар</div>
                    </div>
                `;
            }

            // === Collections / Selections ===
            const collectionsEl = document.getElementById('collectionsList');
            if (collectionsEl) {
                collectionsEl.innerHTML = `
                    <div class="stat-card" style="cursor:pointer;">
                        <div class="value" style="font-size:18px;">Лучшее для новичков</div>
                        <div class="label">3 товара · Опубликовано</div>
                    </div>
                    <div class="stat-card" style="cursor:pointer;">
                        <div class="value" style="font-size:18px;">Скидки недели</div>
                        <div class="label">2 товара · Черновик</div>
                    </div>
                `;
            }

            // === Schedules ===
            const schedTable = document.getElementById('schedulesTable');
            if (schedTable) {
                schedTable.innerHTML = `
                    <tr>
                        <td><strong>Ирина Белова</strong></td>
                        <td><span class="badge badge-success">9-18</span></td>
                        <td><span class="badge badge-success">9-18</span></td>
                        <td><span class="badge badge-success">9-18</span></td>
                        <td><span class="badge badge-success">9-18</span></td>
                        <td><span class="badge badge-success">9-18</span></td>
                        <td><span class="badge badge-success">10-16</span></td>
                        <td><span class="badge">Вых</span></td>
                        <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                    </tr>
                    <tr>
                        <td><strong>Наталья Морозова</strong></td>
                        <td><span class="badge badge-success">10-19</span></td>
                        <td><span class="badge">Вых</span></td>
                        <td><span class="badge badge-success">10-19</span></td>
                        <td><span class="badge">Вых</span></td>
                        <td><span class="badge badge-success">10-19</span></td>
                        <td><span class="badge badge-success">10-17</span></td>
                        <td><span class="badge">Вых</span></td>
                        <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                    </tr>
                `;
            }

            // === Quizzes ===
            const quizTable = document.getElementById('quizzesTable');
            if (quizTable) {
                quizTable.innerHTML = `
                    <tr>
                        <td><strong>Тест: Основы маркетинга</strong></td>
                        <td>Основы интернет-маркетинга</td>
                        <td>15</td>
                        <td>24</td>
                        <td>78%</td>
                        <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                    </tr>
                `;
            }

            // === Goals ===
            const goalsList = document.getElementById('goalsList');
            if (goalsList) {
                goalsList.innerHTML = `
                    <div class="stat-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong>Выручка за февраль</strong>
                            <span class="badge badge-warning">В процессе</span>
                        </div>
                        <div class="value">${formatMoney(176000)} <span style="font-size:14px;color:var(--text-muted);">/ ${formatMoney(500000)}</span></div>
                        <div style="margin-top:10px;background:#334155;border-radius:4px;height:8px;">
                            <div style="width:35%;height:100%;background:var(--primary);border-radius:4px;"></div>
                        </div>
                        <div class="label" style="margin-top:8px;">35% выполнено · до ${new Date(now.getFullYear(), now.getMonth() + 1, 0).toLocaleDateString('ru')}</div>
                    </div>
                `;
            }

            // === Calls ===
            const callsTable = document.getElementById('callsTable');
            if (callsTable) {
                callsTable.innerHTML = `
                    <tr>
                        <td><i class="fas fa-phone-alt" style="color:var(--success);"></i> Исходящий</td>
                        <td>Анна Петрова</td>
                        <td>+7 916 123-45-67</td>
                        <td>5:23</td>
                        <td>Мария Волкова</td>
                        <td>${today} 10:30</td>
                        <td><span class="badge badge-success">Отвечен</span></td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-phone-alt" style="color:var(--primary);transform:rotate(180deg);"></i> Входящий</td>
                        <td>Дмитрий Козлов</td>
                        <td>+7 926 987-65-43</td>
                        <td>2:45</td>
                        <td>Мария Волкова</td>
                        <td>${yesterday} 15:10</td>
                        <td><span class="badge badge-success">Отвечен</span></td>
                    </tr>
                `;
            }

            // === Regulations ===
            const regsTable = document.getElementById('regulationsTable');
            if (regsTable) {
                regsTable.innerHTML = `
                    <tr>
                        <td><strong>Ответ на заявку</strong></td>
                        <td>Ответить клиенту в течение 15 минут</td>
                        <td>15 мин</td>
                        <td><span class="badge badge-success">Активен</span></td>
                        <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                    </tr>
                `;
            }

            // === Lead Distribution ===
            const leadQueueTable = document.getElementById('leadQueueTable');
            if (leadQueueTable) {
                leadQueueTable.innerHTML = `
                    <tr>
                        <td><strong>Мария Волкова</strong></td>
                        <td>3</td>
                        <td>Сайт, Instagram</td>
                        <td><span class="badge badge-success">Онлайн</span></td>
                    </tr>
                    <tr>
                        <td><strong>Алексей Смирнов</strong></td>
                        <td>2</td>
                        <td>Вебинар, Рекомендация</td>
                        <td><span class="badge badge-success">Онлайн</span></td>
                    </tr>
                `;
            }

            // === Employee Analytics ===
            const empAnalytics = document.getElementById('employeeAnalyticsTable');
            if (empAnalytics) {
                empAnalytics.innerHTML = `
                    <tr>
                        <td><strong>Мария Волкова</strong></td>
                        <td>12</td>
                        <td>${formatMoney(320000)}</td>
                        <td>45</td>
                        <td>92%</td>
                    </tr>
                    <tr>
                        <td><strong>Алексей Смирнов</strong></td>
                        <td>8</td>
                        <td>${formatMoney(480000)}</td>
                        <td>23</td>
                        <td>87%</td>
                    </tr>
                `;
            }

            // === Product Filters (stored in localStorage) ===
            productFilters = [
                { id: 'demo-pf1', name: 'Тип товара', values: ['Физический', 'Цифровой', 'Онлайн'], multiple: false },
                { id: 'demo-pf2', name: 'Ценовой диапазон', values: ['До 5 000', '5 000 — 15 000', 'Больше 15 000'], multiple: false }
            ];
            localStorage.setItem(`filters_${projectId}`, JSON.stringify(productFilters));
            if (typeof renderProductFilters === 'function') renderProductFilters();

            // === Categories ===
            const categoriesTree = document.getElementById('categoriesTree');
            if (categoriesTree && typeof categories !== 'undefined') {
                categoriesTree.innerHTML = categories.map(c => `
                    <div style="padding:12px;background:var(--bg-input);border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <i class="fas fa-folder" style="color:var(--primary);margin-right:8px;"></i>
                            <strong>${escapeHtml(c.name)}</strong>
                            <span style="color:var(--text-muted);font-size:12px;margin-left:8px;">${c.products_count || 0} товаров</span>
                        </div>
                        <button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button>
                    </div>
                `).join('');
            }

            // === Payments ===
            const paymentsTable = document.getElementById('paymentsTable');
            if (paymentsTable) {
                paymentsTable.innerHTML = `
                    <tr>
                        <td>PAY-001</td>
                        <td>ORD-2026-001</td>
                        <td>Анна Петрова</td>
                        <td>${formatMoney(45000)}</td>
                        <td><span class="badge">Карта</span></td>
                        <td><span class="badge badge-success">Оплачено</span></td>
                        <td>${formatDate(monthAgo)}</td>
                    </tr>
                    <tr>
                        <td>PAY-002</td>
                        <td>ORD-2026-002</td>
                        <td>Елена Сидорова</td>
                        <td>${formatMoney(15000)}</td>
                        <td><span class="badge">ЮKassa</span></td>
                        <td><span class="badge badge-success">Оплачено</span></td>
                        <td>${formatDate(weekAgo)}</td>
                    </tr>
                `;
            }

            // Update dashboard stats
            document.getElementById('totalClients')?.setAttribute('data-value', clients.length);
            if (document.getElementById('totalClients')) document.getElementById('totalClients').textContent = clients.length;
            if (document.getElementById('totalDeals')) document.getElementById('totalDeals').textContent = deals.length;
            if (document.getElementById('totalRevenue')) document.getElementById('totalRevenue').textContent = formatMoney(orders.reduce((s, o) => s + (o.total || 0), 0));

            toast('Загружены демо-данные для ознакомления', 'info', 5000);
        }

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.addEventListener('click', () => switchSection(item.dataset.section));
            });
        }

        function switchSection(section) {
            // Block navigation to disabled modules
            const moduleId = MODULE_SECTION_MAP[section];
            if (moduleId !== null && moduleId !== undefined) {
                const enabled = getEnabledModules();
                if (enabled.length > 0 && !enabled.includes(moduleId)) {
                    toast('Этот модуль отключён. Включите его в настройках модулей.', 'warning');
                    return;
                }
            }

            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-section="${section}"]`)?.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + section)?.classList.add('active');

            const titles = {
                dashboard: 'Дашборд',
                sales: 'Продажи',
                clients: 'Клиенты',
                team: 'Команда',
                'shop-orders': 'Заказы',
                catalog: 'Каталог',
                appointments: 'Записи',
                learning: 'Обучение',
                integrations: 'Интеграции'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;

            // Load data for tabbed sections
            if (section === 'sales') {
                const tab = currentSectionTabs.sales || sectionTabConfigs.sales.default;
                switchSectionTab('sales', tab);
            }
            if (section === 'clients') { loadSegments(); loadTags(); loadClientGroups(); }
            if (section === 'team') {
                const tab = currentSectionTabs.team || sectionTabConfigs.team.default;
                switchSectionTab('team', tab);
            }
            if (section === 'shop-orders') {
                const tab = currentSectionTabs.orders || sectionTabConfigs.orders.default;
                switchSectionTab('orders', tab);
            }
            if (section === 'catalog') {
                const tab = currentSectionTabs.catalog || sectionTabConfigs.catalog.default;
                switchSectionTab('catalog', tab);
            }
            if (section === 'appointments') {
                const tab = currentSectionTabs.bookings || sectionTabConfigs.bookings.default;
                switchSectionTab('bookings', tab);
            }
            if (section === 'learning') {
                const tab = currentSectionTabs.learning || sectionTabConfigs.learning.default;
                switchSectionTab('learning', tab);
            }
            if (section === 'integrations') { loadIntegrations(); initProviderStatuses(); }
        }

        // ============================================================
        // MODULE VISIBILITY
        // ============================================================
        const MODULE_SECTION_MAP = {
            'dashboard': null,       // always visible
            'sales': 'sales',
            'clients': 'clients',
            'team': 'team',
            'shop-orders': 'orders',
            'catalog': 'catalog',
            'appointments': 'bookings',
            'learning': 'learning',
            'integrations': 'integrations'
        };

        const MODULE_INFO = {
            sales: { name: 'Продажи', icon: 'fas fa-handshake' },
            clients: { name: 'Клиенты', icon: 'fas fa-users' },
            team: { name: 'Команда', icon: 'fas fa-user-tie' },
            orders: { name: 'Заказы', icon: 'fas fa-shopping-cart' },
            catalog: { name: 'Каталог', icon: 'fas fa-box' },
            bookings: { name: 'Записи', icon: 'fas fa-calendar-check' },
            learning: { name: 'Обучение', icon: 'fas fa-graduation-cap' },
            integrations: { name: 'Интеграции', icon: 'fas fa-plug' }
        };

        function getEnabledModules() {
            const projects = JSON.parse(localStorage.getItem('cms_projects') || '[]');
            if (projects.length === 0) return [];
            const proj = projects[0];
            try { return JSON.parse(proj.enabled_modules || '[]'); } catch(e) { return []; }
        }

        function applyModuleVisibility() {
            const enabled = getEnabledModules();
            const showAll = !enabled.length; // backward compat: empty = show all

            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                const section = item.dataset.section;
                const moduleId = MODULE_SECTION_MAP[section];
                if (moduleId === null) return; // always visible (dashboard)
                const parentNav = item.closest('.nav-section');
                if (showAll || enabled.includes(moduleId)) {
                    item.style.display = '';
                    if (parentNav) parentNav.style.display = '';
                } else {
                    item.style.display = 'none';
                    // Hide parent nav-section if all children hidden
                    if (parentNav) {
                        const visibleItems = parentNav.querySelectorAll('.nav-item[data-section]:not([style*="display: none"])');
                        if (visibleItems.length === 0) parentNav.style.display = 'none';
                    }
                }
            });

            applyDashboardCardVisibility();
        }

        function applyDashboardCardVisibility() {
            const enabled = getEnabledModules();
            const showAll = !enabled.length;
            document.querySelectorAll('.stat-card[data-module]').forEach(card => {
                const moduleId = card.dataset.module;
                card.style.display = (showAll || enabled.includes(moduleId)) ? '' : 'none';
            });
        }

        function openModuleSettings() {
            const enabled = getEnabledModules();
            const showAll = !enabled.length;
            const allModules = Object.keys(MODULE_INFO);

            let html = '<div style="margin-bottom:16px;color:var(--text-secondary);font-size:14px;">Включите модули, которые нужны вашему бизнесу. Отключённые модули скроются из меню.</div>';
            html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">';
            allModules.forEach(m => {
                const info = MODULE_INFO[m];
                const checked = showAll || enabled.includes(m) ? 'checked' : '';
                html += `<label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:8px;cursor:pointer;">
                    <input type="checkbox" name="crm_module" value="${m}" ${checked} style="width:18px;height:18px;accent-color:var(--primary);">
                    <div><div style="font-weight:600;"><i class="${info.icon}" style="color:var(--primary);margin-right:6px;"></i>${info.name}</div></div>
                </label>`;
            });
            html += '</div>';

            document.getElementById('moduleSettingsBody').innerHTML = html;
            openModal('moduleSettingsModal');
        }

        async function saveModuleSettings() {
            const selected = Array.from(document.querySelectorAll('input[name="crm_module"]:checked')).map(c => c.value);

            // Save to localStorage project
            const projects = JSON.parse(localStorage.getItem('cms_projects') || '[]');
            if (projects.length > 0) {
                projects[0].enabled_modules = JSON.stringify(selected);
                localStorage.setItem('cms_projects', JSON.stringify(projects));
            }

            // Save to API if online
            if (projectId) {
                const token = localStorage.getItem('cms_token');
                if (token) {
                    try {
                        await fetch(API_BASE + '/projects/' + projectId, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                            body: JSON.stringify({ enabled_modules: selected })
                        });
                    } catch(e) { /* offline */ }
                }
            }

            closeModal('moduleSettingsModal');
            applyModuleVisibility();
            toast('Модули обновлены', 'success');
        }

        // Modal
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        // Funnels
        async function loadFunnels() {
            const res = await api('GET', `/funnels/${projectId}`);
            if (res.success) {
                funnels = res.funnels;
                renderFunnels();
                updateFunnelSelects();
                loadDealsKanban();
            }
        }

        function renderFunnels() {
            // No longer renders separate list — funnels are managed via dropdown
        }

        async function saveFunnel() {
            const name = document.getElementById('funnelName').value;
            const description = document.getElementById('funnelDescription').value;

            if (!name) return toast('Введите название воронки', 'error');

            showLoading();
            try {
                const res = await api('POST', `/funnels/${projectId}`, { name, description });
                console.log('saveFunnel response:', res);
                if (res.success) {
                    closeModal('funnelModal');
                    document.getElementById('funnelName').value = '';
                    document.getElementById('funnelDescription').value = '';
                    loadFunnels();
                    toast('Воронка создана', 'success');
                } else {
                    toast(res.error || 'Ошибка создания воронки', 'error');
                }
            } catch (err) {
                console.error('saveFunnel error:', err);
                toast('Ошибка сети при создании воронки', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateFunnelSelects() {
            const options = funnels.map(f => `<option value="${f.id}">${escapeHtml(f.name)}</option>`).join('');
            document.getElementById('filterFunnel').innerHTML = (funnels.length ? '' : '<option value="">Создайте воронку</option>') + options;
            document.getElementById('dealFunnel').innerHTML = '<option value="">Выберите воронку</option>' + options;
            const delBtn = document.getElementById('deleteFunnelBtn');
            if (delBtn) delBtn.style.display = funnels.length > 0 ? '' : 'none';
        }

        function openAddStageModal() {
            document.getElementById('stageName').value = '';
            document.getElementById('stageColor').value = '#3b82f6';
            document.getElementById('stageIsWon').checked = false;
            document.getElementById('stageIsLost').checked = false;
            openModal('stageModal');
        }

        async function saveStage() {
            const name = document.getElementById('stageName').value.trim();
            const color = document.getElementById('stageColor').value;
            const is_won = document.getElementById('stageIsWon').checked;
            const is_lost = document.getElementById('stageIsLost').checked;

            if (!name) return toast('Введите название этапа', 'error');

            const funnelId = document.getElementById('filterFunnel').value;
            if (!funnelId) return toast('Сначала выберите воронку', 'error');

            showLoading();
            try {
                const res = await api('POST', `/funnels/${projectId}/${funnelId}/stages`, { name, color, is_won, is_lost });
                if (res.success) {
                    closeModal('stageModal');
                    loadFunnels();
                    toast('Этап добавлен', 'success');
                } else {
                    toast(res.error || 'Ошибка добавления этапа', 'error');
                }
            } catch (err) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteStage(funnelId, stageId, stageName) {
            if (!confirm(`Удалить этап "${stageName}"? Все сделки из этого этапа будут потеряны.`)) return;

            showLoading();
            try {
                const res = await api('DELETE', `/funnels/${projectId}/${funnelId}/stages/${stageId}`);
                if (res.success) {
                    loadFunnels();
                    toast('Этап удалён', 'success');
                } else {
                    toast(res.error || 'Ошибка удаления этапа', 'error');
                }
            } catch (err) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteCurrentFunnel() {
            const funnelId = document.getElementById('filterFunnel').value;
            if (!funnelId) return toast('Воронка не выбрана', 'error');

            const funnel = funnels.find(f => f.id === funnelId);
            if (!confirm(`Удалить воронку "${funnel?.name || ''}"? Все этапы и сделки будут удалены.`)) return;

            showLoading();
            try {
                const res = await api('DELETE', `/funnels/${projectId}/${funnelId}`);
                if (res.success) {
                    loadFunnels();
                    toast('Воронка удалена', 'success');
                } else {
                    toast(res.error || 'Ошибка удаления воронки', 'error');
                }
            } catch (err) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        function loadDealStages() {
            const funnelId = document.getElementById('dealFunnel').value;
            const funnel = funnels.find(f => f.id === funnelId);
            const stages = funnel?.stages || [];
            document.getElementById('dealStage').innerHTML = '<option value="">Выберите этап</option>' + stages.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
        }

        // Deals Kanban
        async function loadDealsKanban() {
            const funnelId = document.getElementById('filterFunnel').value;
            if (!funnelId && funnels.length) {
                document.getElementById('filterFunnel').value = funnels[0].id;
            }
            const selectedFunnelId = document.getElementById('filterFunnel').value || funnels[0]?.id;
            if (!selectedFunnelId) return;

            const res = await api('GET', `/funnels/${projectId}/${selectedFunnelId}`);
            if (res.success) {
                renderKanban(res.funnel);
            }
            loadSalesAnalytics();
        }

        async function loadSalesAnalytics() {
            try {
                const res = await api('GET', `/deals/${projectId}`);
                if (!res.success) return;
                const deals = res.deals || [];
                const total = deals.length;
                const won = deals.filter(d => d.status === 'won');
                const closed = deals.filter(d => d.status === 'won' || d.status === 'lost');
                const winRate = closed.length ? Math.round((won.length / closed.length) * 100) : 0;

                let avgDays = 0;
                const closedWithDates = closed.filter(d => d.created_at && d.closed_at);
                if (closedWithDates.length) {
                    const totalDays = closedWithDates.reduce((sum, d) => {
                        return sum + (new Date(d.closed_at) - new Date(d.created_at)) / (1000 * 60 * 60 * 24);
                    }, 0);
                    avgDays = Math.round(totalDays / closedWithDates.length);
                }

                const pipeline = deals.filter(d => d.status !== 'won' && d.status !== 'lost')
                    .reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);

                document.getElementById('salesStat-winRate').textContent = winRate + '%';
                document.getElementById('salesStat-avgTime').textContent = avgDays + ' дн.';
                document.getElementById('salesStat-pipeline').textContent = formatMoney(pipeline);
                document.getElementById('salesStat-count').textContent = total;
            } catch (e) {}
        }

        function renderKanban(funnel) {
            const kanban = document.getElementById('dealsKanban');
            if (!funnel || !funnel.stages || !funnel.stages.length) {
                kanban.innerHTML = '<div class="empty-state" style="grid-column:1/-1;padding:40px;"><i class="fas fa-columns"></i><h3>Нет этапов</h3><p>Добавьте этапы в воронку</p></div>';
                return;
            }

            // Update stats
            const allDeals = funnel.stages.flatMap(s => s.deals || []);
            const totalDeals = allDeals.length;
            const pipeline = allDeals.reduce((s, d) => s + (parseFloat(d.amount) || 0), 0);
            const won = allDeals.filter(d => d.won_at);
            const lost = allDeals.filter(d => d.lost_at);
            const closed = won.length + lost.length;
            const winRate = closed > 0 ? Math.round((won.length / closed) * 100) : 0;
            document.getElementById('salesStat-count').textContent = totalDeals;
            document.getElementById('salesStat-pipeline').textContent = formatMoney(pipeline);
            document.getElementById('salesStat-winRate').textContent = winRate + '%';

            kanban.innerHTML = funnel.stages.map(stage => {
                const stageTotal = (stage.deals || []).reduce((s, d) => s + (parseFloat(d.amount) || 0), 0);
                return `
                <div class="kanban-column" data-stage="${stage.id}">
                    <div class="kanban-header" style="position:relative;">
                        <h4><span class="dot" style="background: ${stage.color}"></span> ${escapeHtml(stage.name)} <span class="count">(${stage.deals?.length || 0})</span></h4>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="font-size:11px;color:var(--text-muted);">${formatMoney(stageTotal)}</span>
                            <button class="btn btn-sm" onclick="event.stopPropagation();deleteStage('${funnel.id}','${stage.id}','${escapeHtml(stage.name)}')" style="padding:2px 6px;font-size:11px;opacity:0.5;" title="Удалить этап"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="kanban-body" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');dropDeal(event, '${stage.id}')">
                        ${(stage.deals || []).map(deal => `
                            <div class="kanban-card" draggable="true" ondragstart="dragDeal(event, '${deal.id}')" onclick="openDealDetails('${deal.id}')" data-deal="${deal.id}">
                                <div class="kanban-card-title">${escapeHtml(deal.name)}</div>
                                <div class="kanban-card-meta">
                                    <span><i class="fas fa-ruble-sign"></i> ${formatMoney(deal.amount)}</span>
                                    ${deal.client_first_name ? `<span><i class="fas fa-user"></i> ${escapeHtml(deal.client_first_name)}</span>` : ''}
                                </div>
                                ${deal.probability ? `<div class="progress-bar" style="margin-top:8px;"><div class="fill" style="width:${deal.probability}%;"></div></div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="kanban-add" onclick="quickAddDeal('${stage.id}')">
                        <i class="fas fa-plus"></i> Добавить
                    </div>
                </div>
            `}).join('');
        }

        let draggedDealId = null;
        function dragDeal(e, dealId) { draggedDealId = dealId; }
        async function dropDeal(e, stageId) {
            e.preventDefault();
            if (!draggedDealId) return;

            await api('POST', `/funnels/${projectId}/deals/${draggedDealId}/move`, { stage_id: stageId });
            draggedDealId = null;
            loadDealsKanban();
        }

        function quickAddDeal(stageId) {
            document.getElementById('dealEditId').value = '';
            const funnelId = document.getElementById('filterFunnel').value || funnels[0]?.id;
            document.getElementById('dealFunnel').value = funnelId;
            loadDealStages();
            setTimeout(() => {
                document.getElementById('dealStage').value = stageId;
            }, 100);
            document.getElementById('dealModalTitle').textContent = 'Новая сделка';
            openModal('dealModal');
        }

        let currentDealData = null;

        async function saveDeal() {
            const editId = document.getElementById('dealEditId')?.value;
            const name = document.getElementById('dealName').value;
            const client_id = document.getElementById('dealClient').value;
            const amount = document.getElementById('dealAmount').value;
            const funnel_id = document.getElementById('dealFunnel').value;
            const stage_id = document.getElementById('dealStage').value;
            const assigned_to = document.getElementById('dealAssignee').value;
            const probability = document.getElementById('dealProbability')?.value || 50;
            const expected_close = document.getElementById('dealExpectedClose')?.value;
            const source = document.getElementById('dealSource')?.value;
            const notes = document.getElementById('dealNotes')?.value;

            if (!name) return toast('Введите название сделки', 'error');

            const data = {
                name, client_id: client_id || null, amount: parseFloat(amount) || 0,
                funnel_id: funnel_id || null, stage_id: stage_id || null,
                assigned_to: assigned_to || null, probability: parseInt(probability),
                expected_close_date: expected_close || null, source: source || null, notes: notes || null
            };

            showLoading();
            try {
                const res = editId
                    ? await api('PUT', `/funnels/${projectId}/deals/${editId}`, data)
                    : await api('POST', `/funnels/${projectId}/deals`, data);
                if (res.success) {
                    closeModal('dealModal');
                    resetDealForm();
                    loadDealsKanban();
                    loadFunnels();
                    toast(editId ? 'Сделка обновлена' : 'Сделка создана', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения сделки', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        function resetDealForm() {
            ['dealEditId', 'dealName', 'dealClient', 'dealAmount', 'dealFunnel', 'dealStage',
             'dealAssignee', 'dealProbability', 'dealExpectedClose', 'dealSource', 'dealNotes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = id === 'dealProbability' ? '50' : '';
            });
            document.getElementById('dealModalTitle').textContent = 'Новая сделка';
            document.getElementById('dealSaveBtn').textContent = 'Создать';
        }

        function openDealDetails(dealId) {
            // Find deal in funnels
            let deal = null;
            let stageName = '';
            let funnelName = '';

            for (const funnel of funnels) {
                for (const stage of (funnel.stages || [])) {
                    const found = (stage.deals || []).find(d => d.id === dealId);
                    if (found) {
                        deal = found;
                        stageName = stage.name;
                        funnelName = funnel.name;
                        break;
                    }
                }
                if (deal) break;
            }

            if (!deal) {
                toast('Сделка не найдена', 'error');
                return;
            }

            currentDealData = { ...deal, stage_name: stageName, funnel_name: funnelName };

            // Fill modal
            document.getElementById('dealDetailsTitle').textContent = deal.name;
            document.getElementById('dealDetailAmount').textContent = formatMoney(deal.amount);
            document.getElementById('dealDetailProbability').textContent = (deal.probability || 50) + '%';

            // Calculate days in work
            const createdDate = new Date(deal.created_at);
            const days = Math.floor((Date.now() - createdDate) / (1000 * 60 * 60 * 24));
            document.getElementById('dealDetailDays').textContent = days;

            document.getElementById('dealDetailClient').textContent = deal.client_first_name || '—';
            document.getElementById('dealDetailAssignee').textContent = deal.assigned_to_name || '—';
            document.getElementById('dealDetailStage').innerHTML = `<span class="badge badge-new">${escapeHtml(stageName)}</span>`;
            document.getElementById('dealDetailSource').textContent = deal.source || '—';
            document.getElementById('dealDetailExpectedClose').textContent = deal.expected_close_date ? formatDate(deal.expected_close_date) : '—';
            document.getElementById('dealDetailCreated').textContent = formatDate(deal.created_at);

            // Render timeline
            const timeline = document.getElementById('dealTimeline');
            timeline.innerHTML = `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <span class="timeline-date">${formatDate(deal.created_at)}</span>
                        <p>Сделка создана</p>
                    </div>
                </div>
                ${deal.stage_changed_at ? `
                <div class="timeline-item">
                    <div class="timeline-dot warning"></div>
                    <div class="timeline-content">
                        <span class="timeline-date">${formatDate(deal.stage_changed_at)}</span>
                        <p>Перемещена на этап "${escapeHtml(stageName)}"</p>
                    </div>
                </div>
                ` : ''}
            `;

            openModal('dealDetailsModal');
        }

        function editCurrentDeal() {
            if (!currentDealData) return;

            closeModal('dealDetailsModal');

            document.getElementById('dealEditId').value = currentDealData.id;
            document.getElementById('dealName').value = currentDealData.name || '';
            document.getElementById('dealClient').value = currentDealData.client_id || '';
            document.getElementById('dealAmount').value = currentDealData.amount || '';
            document.getElementById('dealProbability').value = currentDealData.probability || 50;
            document.getElementById('dealExpectedClose').value = currentDealData.expected_close_date || '';
            document.getElementById('dealSource').value = currentDealData.source || '';
            document.getElementById('dealNotes').value = currentDealData.notes || '';

            document.getElementById('dealModalTitle').textContent = 'Редактировать сделку';
            document.getElementById('dealSaveBtn').textContent = 'Сохранить';

            openModal('dealModal');
        }

        async function markDealWon() {
            if (!currentDealData) return;
            if (!await confirm('Отметить сделку как выигранную?', 'Выиграна')) return;

            const res = await api('POST', `/funnels/${projectId}/deals/${currentDealData.id}/win`);
            if (res.success) {
                closeModal('dealDetailsModal');
                loadDealsKanban();
                loadFunnels();
                toast('Сделка выиграна!', 'success');
            } else {
                toast(res.error || 'Ошибка', 'error');
            }
        }

        async function markDealLost() {
            if (!currentDealData) return;
            const reason = prompt('Причина проигрыша (опционально):');
            if (reason === null) return;

            const res = await api('POST', `/funnels/${projectId}/deals/${currentDealData.id}/lose`, { reason });
            if (res.success) {
                closeModal('dealDetailsModal');
                loadDealsKanban();
                loadFunnels();
                toast('Сделка закрыта', 'info');
            } else {
                toast(res.error || 'Ошибка', 'error');
            }
        }

        function addDealTask() {
            const taskName = prompt('Название задачи:');
            if (!taskName) return;
            // TODO: Create task linked to deal
            toast('Задача добавлена', 'success');
        }

        // Clients tab switching
        let currentClientsTab = 'users';
        function switchClientsTab(tab) {
            currentClientsTab = tab;
            ['users', 'segments', 'groups', 'tags'].forEach(t => {
                const panel = document.getElementById('clientsTabPanel' + t.charAt(0).toUpperCase() + t.slice(1));
                const btn = document.getElementById('clientsTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (panel) panel.style.display = t === tab ? 'block' : 'none';
                if (btn) {
                    if (t === tab) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });
            if (tab === 'segments') loadSegments();
            if (tab === 'groups') loadClientGroups();
            if (tab === 'tags') loadTags();
        }

        // Client Groups
        let clientGroups = JSON.parse(localStorage.getItem('client_groups') || '[]');

        function loadClientGroups() {
            renderClientGroups();
        }

        function renderClientGroups() {
            const container = document.getElementById('groupsList');
            if (!container) return;
            if (!clientGroups.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-object-group"></i><h3>Нет групп</h3><p>Создайте группу для ручной организации клиентов</p></div>';
                return;
            }
            container.innerHTML = clientGroups.map(g => `
                <div class="stat-card" style="border-left:4px solid ${g.color || '#6366f1'};">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                        <h4>${escapeHtml(g.name)}</h4>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteClientGroup('${g.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="value" style="font-size:24px;">${(g.members || []).length}</div>
                    <div class="label">клиентов</div>
                    ${g.description ? `<div style="font-size:12px;color:var(--text-muted);margin-top:4px;">${escapeHtml(g.description)}</div>` : ''}
                </div>
            `).join('');
        }

        function saveClientGroup() {
            const name = document.getElementById('groupName').value;
            if (!name) return toast('Введите название группы', 'error');

            const group = {
                id: Date.now().toString(),
                name,
                description: document.getElementById('groupDescription').value || '',
                color: document.getElementById('groupColor').value || '#6366f1',
                members: [],
                created_at: new Date().toISOString()
            };
            clientGroups.push(group);
            localStorage.setItem('client_groups', JSON.stringify(clientGroups));
            closeModal('groupModal');
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
            renderClientGroups();
            toast('Группа создана', 'success');
        }

        function deleteClientGroup(id) {
            if (!confirm('Удалить группу?')) return;
            clientGroups = clientGroups.filter(g => g.id !== id);
            localStorage.setItem('client_groups', JSON.stringify(clientGroups));
            renderClientGroups();
            toast('Группа удалена', 'info');
        }

        // Clients
        async function loadClients() {
            const res = await api('GET', `/clients/${projectId}`);
            if (res.success) {
                clients = res.clients;
                renderClients();
                updateClientSelects();
            }
        }

        function renderClients(filteredClients = null) {
            const data = filteredClients || clients;
            const tbody = document.getElementById('clientsTable');

            // Update stats
            document.getElementById('clientsTotal').textContent = clients.length;
            document.getElementById('clientsWithCourses').textContent = clients.filter(c => c.courses_count > 0).length;
            document.getElementById('clientsWithBookings').textContent = clients.filter(c => c.bookings_count > 0).length;
            document.getElementById('clientsWithOrders').textContent = clients.filter(c => c.total_orders > 0).length;

            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-users"></i><h3>Нет клиентов</h3></div></td></tr>';
                return;
            }

            const sourceLabels = {
                vk: { icon: 'fab fa-vk', label: 'ВКонтакте', color: '#4680C2' },
                telegram_bot: { icon: 'fab fa-telegram', label: 'TG-бот', color: '#26A5E4' },
                telegram_account: { icon: 'fab fa-telegram', label: 'TG аккаунт', color: '#26A5E4' },
                max_bot: { icon: 'fas fa-robot', label: 'МАКС-бот', color: '#8b5cf6' },
                max_account: { icon: 'fas fa-comments', label: 'МАКС', color: '#8b5cf6' },
                whatsapp: { icon: 'fab fa-whatsapp', label: 'WhatsApp', color: '#25D366' },
                tiktok: { icon: 'fab fa-tiktok', label: 'TikTok', color: '#ff0050' },
                instagram: { icon: 'fab fa-instagram', label: 'Instagram', color: '#E4405F' },
                website: { icon: 'fas fa-globe', label: 'Сайт', color: '#3b82f6' },
                referral: { icon: 'fas fa-user-friends', label: 'Рекомендация', color: '#10b981' },
                ads: { icon: 'fas fa-ad', label: 'Реклама', color: '#f59e0b' },
                social: { icon: 'fas fa-share-alt', label: 'Соцсети', color: '#6366f1' },
                cold: { icon: 'fas fa-snowflake', label: 'Холодный', color: '#94a3b8' },
                other: { icon: 'fas fa-ellipsis-h', label: 'Другой', color: '#64748b' }
            };

            tbody.innerHTML = data.map(c => {
                const tags = JSON.parse(c.tags || '[]');
                const src = sourceLabels[c.source] || null;
                return `
                <tr onclick="openClientCard('${c.id}')" style="cursor:pointer;">
                    <td><strong>${escapeHtml(c.first_name || '')} ${escapeHtml(c.last_name || '')}</strong></td>
                    <td>
                        ${c.email ? `<div style="font-size:12px;">${escapeHtml(c.email)}</div>` : ''}
                        ${c.phone ? `<div style="color: var(--text-muted);font-size:12px;display:flex;align-items:center;gap:4px;">${escapeHtml(c.phone)} <i class="fas fa-phone" onclick="event.stopPropagation();makeCall('${escapeHtml(c.phone)}')" style="color:var(--success);cursor:pointer;font-size:10px;" title="Позвонить"></i></div>` : ''}
                    </td>
                    <td>${src ? `<span style="display:inline-flex;align-items:center;gap:5px;font-size:12px;"><i class="${src.icon}" style="color:${src.color};"></i> ${src.label}</span>` : '<span style="color:var(--text-muted);">—</span>'}</td>
                    <td>${tags.length ? tags.slice(0, 2).map(t => `<span class="badge" style="margin-right:4px;">${escapeHtml(t)}</span>`).join('') : '-'}</td>
                    <td>${c.courses_count || 0} <span style="color:var(--text-muted);font-size:11px;">курс.</span></td>
                    <td>${c.bookings_count || 0} <span style="color:var(--text-muted);font-size:11px;">зап.</span></td>
                    <td>${c.total_orders || 0}</td>
                    <td>${formatMoney(c.total_spent || 0)}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn btn-sm btn-outline" onclick="editClient('${c.id}')"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        let clientsCache = [];
        async function filterClients() {
            const search = document.getElementById('searchClients')?.value.toLowerCase() || '';
            const tagFilter = document.getElementById('filterClientTag')?.value || '';
            const courseFilter = document.getElementById('filterClientCourse')?.value || '';
            const bookingFilter = document.getElementById('filterClientBooking')?.value || '';
            const orderFilter = document.getElementById('filterClientOrder')?.value || '';

            // Get extended client data if needed
            if (!clientsCache.length || clientsCache.length !== clients.length) {
                try {
                    const res = await api('GET', `/clients/${projectId}?extended=1`);
                    if (res.success) {
                        clientsCache = res.clients;
                        clients = res.clients;
                    }
                } catch (e) { clientsCache = clients; }
            }

            let filtered = clientsCache;

            // Search filter
            if (search) {
                filtered = filtered.filter(c =>
                    (c.first_name || '').toLowerCase().includes(search) ||
                    (c.last_name || '').toLowerCase().includes(search) ||
                    (c.email || '').toLowerCase().includes(search) ||
                    (c.phone || '').includes(search) ||
                    (c.company || '').toLowerCase().includes(search)
                );
            }

            // Tag filter
            if (tagFilter) {
                filtered = filtered.filter(c => {
                    const tags = JSON.parse(c.tags || '[]');
                    return tags.includes(tagFilter);
                });
            }

            // Course filter
            if (courseFilter) {
                if (courseFilter === 'has_course') filtered = filtered.filter(c => c.courses_count > 0);
                else if (courseFilter === 'no_course') filtered = filtered.filter(c => !c.courses_count);
                else if (courseFilter === 'completed_course') filtered = filtered.filter(c => c.completed_courses > 0);
                else if (courseFilter === 'in_progress') filtered = filtered.filter(c => c.courses_count > 0 && c.completed_courses < c.courses_count);
            }

            // Booking filter
            if (bookingFilter) {
                if (bookingFilter === 'has_booking') filtered = filtered.filter(c => c.bookings_count > 0);
                else if (bookingFilter === 'no_booking') filtered = filtered.filter(c => !c.bookings_count);
                else if (bookingFilter === 'upcoming') filtered = filtered.filter(c => c.upcoming_bookings > 0);
                else if (bookingFilter === 'visited') filtered = filtered.filter(c => c.visits_count > 0);
            }

            // Order filter
            if (orderFilter) {
                if (orderFilter === 'has_order') filtered = filtered.filter(c => c.total_orders > 0);
                else if (orderFilter === 'no_order') filtered = filtered.filter(c => !c.total_orders);
                else if (orderFilter === 'repeat') filtered = filtered.filter(c => c.total_orders > 1);
            }

            renderClients(filtered);
        }

        let currentClientData = null;

        async function openClientCard(clientId) {
            showLoading();
            try {
                const res = await api('GET', `/clients/${projectId}/${clientId}?full=1`);
                if (res.success && res.client) {
                    currentClientData = res.client;
                    showClientProfile(res.client);
                } else {
                    toast('Не удалось загрузить данные клиента', 'error');
                }
            } catch (e) {
                console.error('Failed to load client details', e);
                toast('Ошибка при загрузке данных клиента', 'error');
            } finally {
                hideLoading();
            }
        }

        function showClientProfile(client) {
            const tags = JSON.parse(client.tags || '[]');

            // Header
            document.getElementById('clientProfileName').textContent =
                `${client.first_name || ''} ${client.last_name || ''}`.trim() || 'Клиент';

            // Basic info
            document.getElementById('profileEmail').textContent = client.email || '—';
            document.getElementById('profilePhone').textContent = client.phone || '—';
            document.getElementById('profileCompany').textContent = client.company || '—';
            document.getElementById('profileSource').textContent = client.source || '—';
            document.getElementById('profileNotes').textContent = client.notes || '—';
            document.getElementById('profileCreatedAt').textContent = formatDate(client.created_at);
            document.getElementById('profileLastActivity').textContent = client.last_order_at ? formatDate(client.last_order_at) : '—';

            // Tags
            const tagsContainer = document.getElementById('profileTags');
            if (tagsContainer) {
                tagsContainer.innerHTML = tags.length
                    ? tags.map(t => `<span class="badge" style="margin-right:4px;">${escapeHtml(t)}</span>`).join('')
                    : '—';
            }

            // Stats
            document.getElementById('profileLTV').textContent = formatMoney(client.total_spent || 0);
            document.getElementById('profileOrdersCount').textContent = client.total_orders || 0;
            document.getElementById('profileBookingsCount').textContent = client.bookings_count || 0;

            // Populate orders tab
            const ordersTable = document.getElementById('profileOrdersTable');
            if (ordersTable) {
                ordersTable.innerHTML = (client.orders || []).length
                    ? client.orders.map(o => `
                        <tr>
                            <td><strong>${escapeHtml(o.order_number)}</strong></td>
                            <td>${formatMoney(o.total)}</td>
                            <td><span class="badge">${o.status}</span></td>
                            <td>${formatDate(o.created_at)}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Нет заказов</td></tr>';
            }

            // Populate bookings tab
            const bookingsTable = document.getElementById('profileBookingsTable');
            if (bookingsTable) {
                bookingsTable.innerHTML = (client.bookings || []).length
                    ? client.bookings.map(b => `
                        <tr>
                            <td>${escapeHtml(b.service_name || '-')}</td>
                            <td>${b.booking_date}</td>
                            <td>${b.start_time || '-'}</td>
                            <td><span class="badge">${b.status}</span></td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Нет записей</td></tr>';
            }

            // Populate trainings tab
            const trainingsTable = document.getElementById('profileTrainingsTable');
            if (trainingsTable) {
                trainingsTable.innerHTML = (client.courses || []).length
                    ? client.courses.map(c => `
                        <tr>
                            <td><strong>${escapeHtml(c.name)}</strong></td>
                            <td>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <div style="width:80px;background:#334155;border-radius:4px;height:6px;">
                                        <div style="width:${c.progress || 0}%;height:100%;background:var(--primary);border-radius:4px;"></div>
                                    </div>
                                    <span>${c.progress || 0}%</span>
                                </div>
                            </td>
                            <td><span class="badge ${c.progress >= 100 ? 'badge-success' : ''}">${c.progress >= 100 ? 'Завершён' : 'В процессе'}</span></td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);">Нет курсов</td></tr>';
            }

            // Populate activity timeline
            const activityTimeline = document.getElementById('profileActivityTimeline');
            if (activityTimeline) {
                const activities = [];

                // Add orders as activities
                (client.orders || []).forEach(o => {
                    activities.push({
                        date: o.created_at,
                        type: 'order',
                        title: `Заказ ${o.order_number}`,
                        description: `${formatMoney(o.total)} — ${o.status}`
                    });
                });

                // Add bookings as activities
                (client.bookings || []).forEach(b => {
                    activities.push({
                        date: b.created_at || b.booking_date,
                        type: 'booking',
                        title: `Запись: ${b.service_name || 'Услуга'}`,
                        description: `${b.booking_date} ${b.start_time || ''}`
                    });
                });

                // Sort by date descending
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));

                activityTimeline.innerHTML = activities.length
                    ? activities.slice(0, 10).map(a => `
                        <div class="timeline-item">
                            <div class="timeline-dot ${a.type === 'order' ? 'success' : 'primary'}"></div>
                            <div class="timeline-content">
                                <div class="timeline-date">${formatDate(a.date)}</div>
                                <div class="timeline-title">${escapeHtml(a.title)}</div>
                                <div class="timeline-desc">${escapeHtml(a.description)}</div>
                            </div>
                        </div>
                    `).join('')
                    : '<p style="color:var(--text-muted);text-align:center;">Нет активности</p>';
            }

            // Reset tabs
            switchClientTab('info');

            openModal('clientProfileModal');
        }

        async function saveClient() {
            const editId = document.getElementById('clientEditId')?.value;
            const first_name = document.getElementById('clientFirstName').value;
            const last_name = document.getElementById('clientLastName').value;
            const email = document.getElementById('clientEmail').value;
            const phone = document.getElementById('clientPhone').value;
            const company = document.getElementById('clientCompany').value;
            const source = document.getElementById('clientSource')?.value;
            const notes = document.getElementById('clientNotes')?.value;

            if (!first_name) return toast('Введите имя клиента', 'error');

            const data = { first_name, last_name, email, phone, company, source, notes };

            showLoading();
            try {
                const res = editId
                    ? await api('PUT', `/clients/${projectId}/${editId}`, data)
                    : await api('POST', `/clients/${projectId}`, data);
                if (res.success) {
                    closeModal('clientModal');
                    resetClientForm();
                    loadClients();
                    toast(editId ? 'Клиент обновлён' : 'Клиент добавлен', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения клиента', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        function resetClientForm() {
            ['clientEditId', 'clientFirstName', 'clientLastName', 'clientEmail', 'clientPhone',
             'clientCompany', 'clientSource', 'clientNotes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('clientModalTitle').textContent = 'Новый клиент';
            document.getElementById('clientSaveBtn').textContent = 'Добавить';
        }

        function switchClientTab(tabName) {
            const modal = document.getElementById('clientProfileModal');
            if (!modal) return;
            modal.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            modal.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');

            modal.querySelector(`[onclick="switchClientTab('${tabName}')"]`)?.classList.add('active');
            const tabContent = document.getElementById('clientTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (tabContent) tabContent.style.display = 'block';
        }

        function editClient(id) {
            const c = clients.find(cl => cl.id == id);
            if (!c) return toast('Клиент не найден', 'error');

            document.getElementById('clientEditId').value = c.id;
            document.getElementById('clientFirstName').value = c.first_name || '';
            document.getElementById('clientLastName').value = c.last_name || '';
            document.getElementById('clientEmail').value = c.email || '';
            document.getElementById('clientPhone').value = c.phone || '';
            document.getElementById('clientCompany').value = c.company || '';
            document.getElementById('clientSource').value = c.source || '';
            document.getElementById('clientNotes').value = c.notes || '';

            document.getElementById('clientModalTitle').textContent = 'Редактировать клиента';
            document.getElementById('clientSaveBtn').textContent = 'Сохранить';

            openModal('clientModal');
        }

        function editClientFromProfile() {
            if (!currentClientData) return;
            closeModal('clientProfileModal');
            editClient(currentClientData.id);
        }

        function createDealForClient() {
            if (!currentClientData) return;
            closeModal('clientProfileModal');
            document.getElementById('dealClient').value = currentClientData.id;
            openModal('dealModal');
        }

        function createBookingForClient() {
            if (!currentClientData) return;
            closeModal('clientProfileModal');
            loadServicesForBooking();
            const clientSelect = document.getElementById('bookingClient');
            if (clientSelect) clientSelect.value = currentClientData.id;
            openModal('bookingModal');
        }

        function exportClients() {
            const csv = ['first_name,last_name,email,phone,company,source,total_spent,total_orders'];
            clients.forEach(c => {
                csv.push([
                    c.first_name || '', c.last_name || '', c.email || '', c.phone || '',
                    c.company || '', c.source || '', c.total_spent || 0, c.total_orders || 0
                ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clients-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            toast('Экспорт завершён', 'success');
        }

        async function importClients() {
            const file = document.getElementById('importClientsFile').files[0];
            if (!file) return toast('Выберите CSV файл', 'error');

            const progress = document.getElementById('importClientsProgress');
            const bar = document.getElementById('importClientsBar');
            const status = document.getElementById('importClientsStatus');

            progress.style.display = 'block';
            bar.style.width = '10%';
            status.textContent = 'Чтение файла...';

            const text = await file.text();
            const lines = text.split('\n').filter(l => l.trim());

            if (lines.length < 2) {
                toast('Файл пуст или некорректен', 'error');
                progress.style.display = 'none';
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            let imported = 0;
            let skipped = 0;

            for (let i = 1; i < lines.length; i++) {
                bar.style.width = `${10 + (i / lines.length) * 85}%`;
                status.textContent = `Импорт: ${i}/${lines.length - 1}...`;

                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const data = {};
                headers.forEach((h, j) => { data[h] = values[j]; });

                if (!data.first_name && !data.email) {
                    skipped++;
                    continue;
                }

                try {
                    await api('POST', `/clients/${projectId}`, data);
                    imported++;
                } catch (e) {
                    skipped++;
                }
            }

            bar.style.width = '100%';
            status.textContent = `Готово! Импортировано: ${imported}, пропущено: ${skipped}`;

            setTimeout(() => {
                closeModal('importClientsModal');
                progress.style.display = 'none';
                bar.style.width = '0';
                loadClients();
                toast(`Импортировано ${imported} клиентов`, 'success');
            }, 2000);
        }

        function updateClientSelects() {
            const options = '<option value="">Выберите клиента</option>' + clients.map(c => `<option value="${c.id}">${escapeHtml(c.first_name || '')} ${escapeHtml(c.last_name || '')} ${c.company ? '(' + escapeHtml(c.company) + ')' : ''}</option>`).join('');
            document.getElementById('dealClient').innerHTML = options;
        }

        // Employees
        async function loadEmployees() {
            const res = await api('GET', `/employees/${projectId}`);
            if (res.success) {
                employees = res.employees;
                renderEmployees();
                updateEmployeeSelects();
            }
        }

        function renderEmployees() {
            const tbody = document.getElementById('employeesTable');
            if (!employees.length) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-user-tie"></i><h3>Нет сотрудников</h3></div></td></tr>';
                return;
            }

            const roles = { admin: 'Админ', manager: 'Менеджер', support: 'Поддержка' };
            tbody.innerHTML = employees.map(e => `
                <tr>
                    <td><strong>${escapeHtml(e.first_name)} ${escapeHtml(e.last_name)}</strong></td>
                    <td>${escapeHtml(e.position || '-')}</td>
                    <td>${escapeHtml(e.email)}</td>
                    <td><span class="badge badge-new">${roles[e.role] || e.role}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="editEmployee('${e.id}')"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function editEmployee(id) {
            const e = employees.find(emp => emp.id == id);
            if (!e) return toast('Сотрудник не найден', 'error');

            document.getElementById('employeeEditId').value = e.id;
            document.getElementById('employeeFirstName').value = e.first_name || '';
            document.getElementById('employeeLastName').value = e.last_name || '';
            document.getElementById('employeeEmail').value = e.email || '';
            document.getElementById('employeePosition').value = e.position || '';
            document.getElementById('employeeRole').value = e.role || 'manager';

            document.getElementById('employeeModalTitle').textContent = 'Редактировать сотрудника';
            document.getElementById('employeeSaveBtn').textContent = 'Сохранить';

            openModal('employeeModal');
        }

        function resetEmployeeForm() {
            document.getElementById('employeeEditId').value = '';
            ['employeeFirstName', 'employeeLastName', 'employeeEmail', 'employeePosition'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('employeeRole').value = 'manager';
            document.getElementById('employeeModalTitle').textContent = 'Новый сотрудник';
            document.getElementById('employeeSaveBtn').textContent = 'Добавить';
        }

        async function saveEmployee() {
            const editId = document.getElementById('employeeEditId').value;
            const first_name = document.getElementById('employeeFirstName').value;
            const last_name = document.getElementById('employeeLastName').value;
            const email = document.getElementById('employeeEmail').value;
            const position = document.getElementById('employeePosition').value;
            const role = document.getElementById('employeeRole').value;

            if (!first_name || !last_name || !email) return toast('Заполните обязательные поля', 'error');

            const data = { first_name, last_name, email, position, role };
            showLoading();
            try {
                const res = editId
                    ? await api('PUT', `/employees/${projectId}/${editId}`, data)
                    : await api('POST', `/employees/${projectId}`, data);
                if (res.success) {
                    closeModal('employeeModal');
                    resetEmployeeForm();
                    loadEmployees();
                    toast(editId ? 'Сотрудник обновлён' : 'Сотрудник добавлен', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения сотрудника', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateEmployeeSelects() {
            const options = '<option value="">Выберите сотрудника</option>' + employees.map(e => `<option value="${e.id}">${escapeHtml(e.first_name)} ${escapeHtml(e.last_name)}</option>`).join('');
            document.getElementById('dealAssignee').innerHTML = options;
            document.getElementById('taskAssignee').innerHTML = options;
        }

        // Tasks
        async function loadTasks() {
            const status = document.getElementById('filterTaskStatus').value;
            const params = status ? `?status=${status}` : '';
            const res = await api('GET', `/employees/${projectId}/tasks/list${params}`);
            if (res.success) {
                tasks = res.tasks;
                renderTasks();
            }
        }

        function renderTasks() {
            const tbody = document.getElementById('tasksTable');
            if (!tasks.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-tasks"></i><h3>Нет задач</h3></div></td></tr>';
                return;
            }

            const priorities = { low: ['Низкий', 'badge'], normal: ['Обычный', 'badge badge-new'], high: ['Высокий', 'badge badge-warning'], urgent: ['Срочный', 'badge badge-danger'] };
            const statuses = { pending: ['Ожидает', 'badge'], in_progress: ['В работе', 'badge badge-warning'], completed: ['Готово', 'badge badge-success'] };

            tbody.innerHTML = tasks.map(t => `
                <tr>
                    <td><strong>${escapeHtml(t.title)}</strong></td>
                    <td>${t.assignee_first_name ? escapeHtml(t.assignee_first_name + ' ' + (t.assignee_last_name || '')) : '-'}</td>
                    <td><span class="${priorities[t.priority]?.[1] || 'badge'}">${priorities[t.priority]?.[0] || t.priority}</span></td>
                    <td>${t.due_date ? new Date(t.due_date).toLocaleDateString('ru') : '-'}</td>
                    <td><span class="${statuses[t.status]?.[1] || 'badge'}">${statuses[t.status]?.[0] || t.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="toggleTaskStatus('${t.id}', '${t.status}')">
                            <i class="fas fa-${t.status === 'completed' ? 'undo' : 'check'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const assignee_id = document.getElementById('taskAssignee').value;
            const priority = document.getElementById('taskPriority').value;
            const due_date = document.getElementById('taskDueDate').value;

            if (!title) return toast('Введите название задачи', 'error');

            showLoading();
            try {
                const res = await api('POST', `/employees/${projectId}/tasks`, {
                    title, description, assignee_id: assignee_id || null, priority, due_date: due_date || null
                });
                if (res.success) {
                    closeModal('taskModal');
                    ['taskTitle', 'taskDescription', 'taskAssignee', 'taskDueDate'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    loadTasks();
                    toast('Задача создана', 'success');
                } else {
                    toast(res.error || 'Ошибка создания задачи', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        let taskCalendarDate = new Date();
        function switchTaskView(view) {
            document.getElementById('tasksListView').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('tasksCalendarView').style.display = view === 'calendar' ? 'block' : 'none';
            const listBtn = document.getElementById('taskViewList');
            const calBtn = document.getElementById('taskViewCalendar');
            if (view === 'list') {
                listBtn.style.background = 'var(--primary)'; listBtn.style.color = '#fff'; listBtn.className = 'btn btn-sm';
                calBtn.style.background = ''; calBtn.style.color = ''; calBtn.className = 'btn btn-sm btn-outline';
            } else {
                calBtn.style.background = 'var(--primary)'; calBtn.style.color = '#fff'; calBtn.className = 'btn btn-sm';
                listBtn.style.background = ''; listBtn.style.color = ''; listBtn.className = 'btn btn-sm btn-outline';
                renderTaskCalendar();
            }
        }

        function moveTaskCalendar(dir) {
            taskCalendarDate.setMonth(taskCalendarDate.getMonth() + dir);
            renderTaskCalendar();
        }

        function renderTaskCalendar() {
            const year = taskCalendarDate.getFullYear();
            const month = taskCalendarDate.getMonth();
            const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
            document.getElementById('taskCalendarMonth').textContent = `${monthNames[month]} ${year}`;
            const firstDay = new Date(year, month, 1).getDay() || 7;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const priorityColors = { urgent: 'var(--danger)', high: '#f59e0b', normal: 'var(--primary)', low: 'var(--text-muted)' };
            const dayNames = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
            let html = dayNames.map(d => `<div style="text-align:center;font-weight:600;padding:8px;font-size:12px;color:var(--text-muted);">${d}</div>`).join('');
            for (let i = 1; i < firstDay; i++) html += '<div style="padding:4px;min-height:80px;background:var(--bg-dark);border-radius:4px;"></div>';
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                const dayTasks = (tasks || []).filter(t => t.due_date && t.due_date.startsWith(dateStr));
                let taskHtml = dayTasks.slice(0, 3).map(t => {
                    const color = priorityColors[t.priority] || 'var(--primary)';
                    const done = t.status === 'completed' ? 'text-decoration:line-through;opacity:0.5;' : '';
                    return `<div style="font-size:10px;padding:2px 4px;margin-top:2px;border-radius:3px;background:${color}20;border-left:2px solid ${color};${done}" title="${escapeHtml(t.title)}">${escapeHtml(t.title.substring(0,20))}</div>`;
                }).join('');
                if (dayTasks.length > 3) taskHtml += `<div style="font-size:10px;color:var(--text-muted);">+${dayTasks.length - 3}</div>`;
                const bg = isToday ? 'background:rgba(59,130,246,0.08);border:1px solid var(--primary);' : 'background:var(--bg-card);border:1px solid var(--border-color);';
                html += `<div style="${bg}border-radius:4px;padding:4px;min-height:80px;"><div style="font-size:11px;font-weight:${isToday?'700':'500'};color:${isToday?'var(--primary)':'var(--text-primary)'};margin-bottom:2px;">${day}</div>${taskHtml}</div>`;
            }
            document.getElementById('taskCalendarGrid').innerHTML = html;
        }

        async function toggleTaskStatus(id, current) {
            const newStatus = current === 'completed' ? 'pending' : 'completed';
            try {
                const res = await api('PUT', `/employees/${projectId}/tasks/${id}`, { status: newStatus });
                if (res.success) loadTasks();
                else toast(res.error || 'Ошибка обновления задачи', 'error');
            } catch (e) {
                toast('Ошибка сети', 'error');
            }
        }

        // Orders
        async function loadOrders() {
            const status = document.getElementById('filterOrderStatus')?.value;
            const params = status ? `?status=${status}` : '';
            const res = await api('GET', `/orders/${projectId}${params}`);
            if (res.success) {
                orders = res.orders;
                renderOrders();
            }
        }

        function renderOrders() {
            const tbody = document.getElementById('ordersTable');
            if (!orders.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>Нет заказов</h3></div></td></tr>';
                return;
            }

            const statuses = {
                new: ['Новый', 'badge badge-new', ''],
                processing: ['В обработке', 'badge badge-warning', ''],
                confirmed: ['Согласован', 'badge', 'background:rgba(99,102,241,0.2);color:#6366f1'],
                assembled: ['Собран', 'badge', 'background:rgba(14,165,233,0.2);color:#0ea5e9'],
                shipped: ['Отправлен', 'badge badge-new', ''],
                delivered: ['Доставлен', 'badge badge-success', ''],
                cancelled: ['Отменён', 'badge badge-danger', ''],
                refund: ['Возврат', 'badge badge-danger', '']
            };
            const paymentStatuses = { pending: ['Ожидает', 'badge badge-warning'], paid: ['Оплачен', 'badge badge-success'], refunded: ['Возврат', 'badge badge-danger'] };
            const orderWorkflow = ['new', 'processing', 'confirmed', 'assembled', 'shipped', 'delivered'];

            function orderStepper(status) {
                if (status === 'cancelled' || status === 'refund') {
                    const lbl = status === 'cancelled' ? 'Отменён' : 'Возврат';
                    return '<div style="display:flex;align-items:center;gap:4px;margin-top:6px;"><span style="font-size:11px;color:var(--danger);"><i class="fas fa-times-circle"></i> ' + lbl + '</span></div>';
                }
                const idx = orderWorkflow.indexOf(status);
                let html = '<div style="display:flex;align-items:center;gap:2px;margin-top:6px;">';
                for (let i = 0; i < orderWorkflow.length; i++) {
                    const w = i <= idx ? 16 : 12;
                    const bg = i <= idx ? 'var(--primary)' : 'var(--border-color)';
                    const title = statuses[orderWorkflow[i]]?.[0] || orderWorkflow[i];
                    html += '<div style="width:' + w + 'px;height:4px;border-radius:2px;background:' + bg + ';" title="' + title + '"></div>';
                }
                html += '</div>';
                return html;
            }

            tbody.innerHTML = orders.map(o => {
                const st = statuses[o.status] || ['Неизвестно', 'badge', ''];
                const stStyle = st[2] ? ' style="' + st[2] + '"' : '';
                return '<tr>' +
                    '<td><strong>' + escapeHtml(o.order_number) + '</strong></td>' +
                    '<td>' + escapeHtml(o.customer_name || o.customer_email || '-') + '</td>' +
                    '<td>' + formatMoney(o.total) + '</td>' +
                    '<td><span class="' + st[1] + '"' + stStyle + '>' + st[0] + '</span>' + orderStepper(o.status) + '</td>' +
                    '<td><span class="' + (paymentStatuses[o.payment_status]?.[1] || 'badge') + '">' + (paymentStatuses[o.payment_status]?.[0] || o.payment_status) + '</span></td>' +
                    '<td>' + new Date(o.created_at).toLocaleDateString('ru') + '</td>' +
                    '<td><button class="btn btn-sm btn-outline" onclick="viewOrder(\'' + o.id + '\')"><i class="fas fa-eye"></i></button></td>' +
                    '</tr>';
            }).join('');
        }

        // Products
        async function loadProducts() {
            const res = await api('GET', `/products/${projectId}`);
            if (res.success) {
                products = res.products || [];
            }
            renderProducts();
        }

        function renderProducts() {
            const tbody = document.getElementById('productsTable');
            if (!products.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-box"></i><h3>Нет товаров</h3><p>Добавьте первый товар</p></div></td></tr>';
                return;
            }

            const baseUrl = window.location.origin + window.location.pathname;

            const getProductIcon = (type) => {
                switch(type) {
                    case 'digital': return 'fa-file-download';
                    case 'online': return 'fa-graduation-cap';
                    default: return 'fa-box';
                }
            };

            const getTypeBadge = (type) => {
                switch(type) {
                    case 'digital': return '<span class="badge" style="background:#8b5cf6;">Цифровой</span>';
                    case 'online': return '<span class="badge" style="background:#06b6d4;">Онлайн</span>';
                    default: return '';
                }
            };

            tbody.innerHTML = products.map(p => {
                const images = p.images || [];
                const variants = p.variants || [];
                const lowStock = p.track_inventory && p.stock <= (p.min_stock || 5);

                return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${images.length ? `
                                <img src="${images[0].url || images[0]}" style="width:40px;height:40px;object-fit:cover;border-radius:8px;">
                            ` : `
                                <div style="width: 40px; height: 40px; background: var(--bg-input); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${getProductIcon(p.product_type)}" style="color: var(--text-muted);"></i>
                                </div>
                            `}
                            <div>
                                <strong>${escapeHtml(p.name)}</strong>
                                ${p.brand ? `<div style="font-size:11px;color:var(--text-muted);">${escapeHtml(p.brand)}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${escapeHtml(p.sku || '-')}</td>
                    <td>
                        <strong>${formatMoney(p.price)}</strong>
                        ${(p.compare_at_price || p.old_price) ? `<span style="text-decoration:line-through;color:var(--text-muted);font-size:11px;margin-left:4px;">${formatMoney(p.compare_at_price || p.old_price)}</span>` : ''}
                    </td>
                    <td>
                        <span class="${lowStock ? 'text-danger' : ''}">${p.stock || 0}</span>
                        ${variants.length ? `<span style="color:var(--text-muted);font-size:11px;"> (${variants.length} вар.)</span>` : ''}
                    </td>
                    <td>
                        ${getTypeBadge(p.product_type)}
                        <span class="badge ${p.is_active ? 'badge-success' : 'badge-danger'}">${p.is_active ? 'Активен' : 'Скрыт'}</span>
                    </td>
                    <td>
                        ${p.url_slug ? `
                            <div style="display:flex;align-items:center;gap:4px;">
                                <a href="#product/${p.url_slug}" onclick="event.preventDefault();openProductCard('${p.id}')" style="color:var(--primary);font-size:12px;text-decoration:none;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${baseUrl}#product/${p.url_slug}">/${p.url_slug}</a>
                                <button class="btn btn-sm" onclick="event.stopPropagation();copyProductLink('${p.id}')" style="padding:2px 6px;font-size:11px;" title="Копировать ссылку"><i class="fas fa-copy"></i></button>
                            </div>
                        ` : '<span style="color:var(--text-muted);font-size:12px;">—</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="editProduct('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        // Product type selector
        function setupProductTypeSelector() {
            document.querySelectorAll('input[name="productType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.type-option').forEach(opt => {
                        opt.style.borderColor = 'var(--border-color)';
                    });
                    this.closest('.type-option').style.borderColor = 'var(--primary)';

                    // Toggle sections based on type
                    const isOnline = this.value === 'online';
                    const isPhysical = this.value === 'physical';
                    document.getElementById('onlineProductAccess').style.display = isOnline ? 'block' : 'none';
                    document.getElementById('productStockGroup').style.display = isPhysical ? 'block' : 'none';
                });
            });
        }

        // AI Backend URL
        const AI_API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000'
            : 'https://ai-tools-backend-d3zr.onrender.com';

        let editingProductId = null;

        async function saveProduct() {
            const name = document.getElementById('productName').value;
            const sku = document.getElementById('productSku').value;
            const price = document.getElementById('productPrice').value;
            const old_price = document.getElementById('productOldPrice').value;
            const stock = document.getElementById('productStock').value;
            const description = document.getElementById('productDescription').value;
            const category_id = document.getElementById('productCategory').value;
            const meta_title = document.getElementById('productMetaTitle').value;
            const meta_description = document.getElementById('productMetaDesc').value;
            const url_slug = document.getElementById('productSlug').value;
            const weight = document.getElementById('productWeight').value;
            const length = document.getElementById('productLength').value;
            const width = document.getElementById('productWidth').value;
            const height = document.getElementById('productHeight').value;
            const brand = document.getElementById('productBrand').value;

            // Inventory settings
            const track_inventory = document.getElementById('productTrackInventory').checked;
            const min_stock = document.getElementById('productMinStock').value;
            const allow_backorder = document.getElementById('productBackorder').checked;

            // Product type
            const product_type = document.querySelector('input[name="productType"]:checked')?.value || 'physical';

            if (!name || !price) {
                toast('Заполните название и цену', 'error');
                return;
            }

            const autoSlug = url_slug || name.toLowerCase().replace(/[а-яё]/gi, c => {
                const map = {'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'yo','ж':'zh','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'h','ц':'ts','ч':'ch','ш':'sh','щ':'sch','ъ':'','ы':'y','ь':'','э':'e','ю':'yu','я':'ya'};
                return map[c.toLowerCase()] || c;
            }).replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

            const productData = {
                name, sku, price: parseFloat(price), old_price: parseFloat(old_price) || null, compare_at_price: parseFloat(old_price) || null,
                stock: parseInt(stock) || 0, description, is_active: true,
                category_id: category_id || null,
                meta_title, meta_description, url_slug: autoSlug,
                weight: parseFloat(weight) || null,
                length: parseFloat(length) || null,
                width: parseFloat(width) || null,
                height: parseFloat(height) || null,
                brand: brand || null,
                product_type,
                track_inventory,
                min_stock: parseInt(min_stock) || 5,
                allow_backorder,
                images: productImages.map(img => img.url),
                variants: productVariants.filter(v => v.name)
            };

            showLoading();
            try {
                const method = editingProductId ? 'PUT' : 'POST';
                const url = editingProductId
                    ? `/products/${projectId}/${editingProductId}`
                    : `/products/${projectId}`;

                const res = await api(method, url, productData);

                if (res.success) {
                    closeModal('productModal');
                    clearProductForm();
                    loadProducts();
                    toast(editingProductId ? 'Товар обновлён' : 'Товар добавлен', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения товара', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        function copyProductLink(productId) {
            const p = products.find(x => x.id == productId);
            if (!p || !p.url_slug) return toast('Нет ссылки для копирования', 'error');
            const url = window.location.origin + window.location.pathname + '#product/' + p.url_slug;
            navigator.clipboard.writeText(url).then(() => toast('Ссылка скопирована', 'success')).catch(() => toast('Ошибка копирования', 'error'));
        }

        function openProductCard(productId) {
            const p = products.find(x => x.id == productId);
            if (!p) return;
            const images = p.images || [];
            const mainImg = images.length ? (images[0].url || images[0]) : '';
            const cardUrl = window.location.origin + window.location.pathname + '#product/' + (p.url_slug || p.id);

            const html = `
                <div style="max-width:500px;margin:0 auto;">
                    ${mainImg ? `<img src="${mainImg}" style="width:100%;max-height:300px;object-fit:cover;border-radius:12px;margin-bottom:16px;">` : ''}
                    <h2 style="margin-bottom:8px;">${escapeHtml(p.name)}</h2>
                    ${p.brand ? `<div style="color:var(--text-muted);margin-bottom:12px;">${escapeHtml(p.brand)}</div>` : ''}
                    <div style="display:flex;align-items:baseline;gap:12px;margin-bottom:16px;">
                        <span style="font-size:24px;font-weight:700;color:var(--primary);">${formatMoney(p.price)}</span>
                        ${(p.compare_at_price || p.old_price) ? `<span style="text-decoration:line-through;color:var(--text-muted);">${formatMoney(p.compare_at_price || p.old_price)}</span>` : ''}
                    </div>
                    ${p.description ? `<div style="color:var(--text-secondary);line-height:1.6;margin-bottom:16px;">${escapeHtml(p.description)}</div>` : ''}
                    <div style="display:flex;gap:8px;margin-bottom:16px;">
                        <span class="badge ${p.is_active ? 'badge-success' : 'badge-danger'}">${p.is_active ? 'В наличии' : 'Нет в наличии'}</span>
                        ${p.stock > 0 ? `<span class="badge">Остаток: ${p.stock}</span>` : ''}
                    </div>
                    <div style="background:var(--bg-input);border-radius:8px;padding:12px;display:flex;align-items:center;gap:8px;">
                        <input type="text" value="${cardUrl}" readonly style="flex:1;background:transparent;border:none;color:var(--text-primary);font-size:12px;">
                        <button class="btn btn-sm btn-primary" onclick="navigator.clipboard.writeText('${cardUrl}').then(()=>toast('Ссылка скопирована','success'))"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            `;

            // Reuse a dynamic modal
            let modal = document.getElementById('productCardPreviewModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'productCardPreviewModal';
                modal.innerHTML = `<div class="modal" style="max-width:560px;"><div class="modal-header"><h3>Карточка товара</h3><button class="modal-close" onclick="closeModal('productCardPreviewModal')">&times;</button></div><div class="modal-body" id="productCardPreviewBody"></div></div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('productCardPreviewBody').innerHTML = html;
            openModal('productCardPreviewModal');
        }

        function clearProductForm() {
            editingProductId = null;
            document.getElementById('productModalTitle').textContent = 'Новый товар';
            document.getElementById('productSaveBtn').textContent = 'Сохранить';
            ['productName', 'productSku', 'productPrice', 'productOldPrice', 'productStock',
             'productDescription', 'productMetaTitle', 'productMetaDesc', 'productSlug',
             'productWeight', 'productLength', 'productWidth', 'productHeight', 'productBrand',
             'productMinStock'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('productCategory').value = '';
            updateMetaCounters();

            // Clear extras
            productImages = [];
            productVariants = [];
            renderProductImages();
            renderProductVariants();
            document.getElementById('productTrackInventory').checked = false;
            document.getElementById('productBackorder').checked = false;
            toggleInventoryOptions();

            // Reset product type
            document.querySelector('input[name="productType"][value="physical"]').checked = true;
            document.querySelectorAll('.type-option').forEach(opt => opt.style.borderColor = 'var(--border-color)');
            document.querySelector('.type-option:first-child').style.borderColor = 'var(--primary)';
            document.getElementById('onlineProductAccess').style.display = 'none';
            document.getElementById('productStockGroup').style.display = 'block';
        }

        async function editProduct(id) {
            showLoading();
            try {
                const res = await api('GET', `/products/${projectId}/${id}`);
                if (!res.success) {
                    toast('Ошибка загрузки товара', 'error');
                    return;
                }

                const p = res.product;
                editingProductId = id;

                document.getElementById('productModalTitle').textContent = 'Редактировать товар';
                document.getElementById('productSaveBtn').textContent = 'Сохранить';
                document.getElementById('productName').value = p.name || '';
                document.getElementById('productSku').value = p.sku || '';
                document.getElementById('productPrice').value = p.price || '';
                document.getElementById('productOldPrice').value = p.compare_at_price || p.old_price || '';
                document.getElementById('productStock').value = p.stock || 0;
                document.getElementById('productDescription').value = p.description || '';
                document.getElementById('productCategory').value = p.category_id || '';
                document.getElementById('productMetaTitle').value = p.meta_title || '';
                document.getElementById('productMetaDesc').value = p.meta_description || '';
                document.getElementById('productSlug').value = p.url_slug || '';
                document.getElementById('productWeight').value = p.weight || '';
                document.getElementById('productLength').value = p.length || '';
                document.getElementById('productWidth').value = p.width || '';
                document.getElementById('productHeight').value = p.height || '';
                document.getElementById('productBrand').value = p.brand || '';

                // Load images
                productImages = (p.images || []).map(img => ({
                    id: img.id || Date.now(),
                    url: img.url || img,
                    existing: true
                }));
                renderProductImages();

                // Load variants
                productVariants = p.variants || [];
                renderProductVariants();

                // Load inventory settings
                const trackInventory = p.track_inventory || false;
                document.getElementById('productTrackInventory').checked = trackInventory;
                document.getElementById('productMinStock').value = p.min_stock || 5;
                document.getElementById('productBackorder').checked = p.allow_backorder || false;
                toggleInventoryOptions();

                updateMetaCounters();
                openModal('productModal');
            } finally {
                hideLoading();
            }
        }

        function updateMetaCounters() {
            const titleEl = document.getElementById('productMetaTitle');
            const descEl = document.getElementById('productMetaDesc');
            document.getElementById('metaTitleCount').textContent = titleEl?.value?.length || 0;
            document.getElementById('metaDescCount').textContent = descEl?.value?.length || 0;
        }

        // Setup meta counter listeners and product type selector
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('productMetaTitle')?.addEventListener('input', updateMetaCounters);
            document.getElementById('productMetaDesc')?.addEventListener('input', updateMetaCounters);
            setupProductTypeSelector();
        });

        // ===== AI Generation Functions =====

        async function generateProductDescription() {
            const name = document.getElementById('productName').value;
            if (!name) return toast('Сначала введите название товара', 'error');

            const btn = event.target.closest('button');
            const loader = document.getElementById('productDescLoading');

            btn.disabled = true;
            loader.style.display = 'block';

            try {
                const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';
                const price = document.getElementById('productPrice').value;

                const response = await fetch(`${AI_API}/api/ai/product-description`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        category: category !== '— Без категории —' ? category : null,
                        price: parseFloat(price) || null,
                        tone: 'professional'
                    })
                });

                const data = await response.json();

                if (data.success && data.description) {
                    document.getElementById('productDescription').value = data.description;
                } else {
                    toast(data.detail || 'Ошибка генерации описания', 'error');
                }
            } catch (error) {
                console.error('AI Description error:', error);
                toast('Ошибка подключения к AI сервису', 'error');
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }

        async function generateProductMeta() {
            const name = document.getElementById('productName').value;
            if (!name) return toast('Сначала введите название товара', 'error');

            const btn = event.target.closest('button');
            const loader = document.getElementById('productMetaLoading');

            btn.disabled = true;
            loader.style.display = 'block';

            try {
                const category = document.getElementById('productCategory').selectedOptions[0]?.text || '';
                const description = document.getElementById('productDescription').value;

                const response = await fetch(`${AI_API}/api/ai/product-meta`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        category: category !== '— Без категории —' ? category : null,
                        existing_description: description || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('productMetaTitle').value = data.meta_title || '';
                    document.getElementById('productMetaDesc').value = data.meta_description || '';

                    // Auto-generate slug from name if not present
                    if (!document.getElementById('productSlug').value) {
                        document.getElementById('productSlug').value = name
                            .toLowerCase()
                            .replace(/[^a-zа-яё0-9\s]/gi, '')
                            .replace(/\s+/g, '-')
                            .substring(0, 50);
                    }

                    updateMetaCounters();
                } else {
                    toast(data.detail || 'Ошибка генерации мета-тегов', 'error');
                }
            } catch (error) {
                console.error('AI Meta error:', error);
                toast('Ошибка подключения к AI сервису', 'error');
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }

        async function generateProductCard() {
            const name = document.getElementById('productName').value;
            if (!name) return toast('Сначала введите название товара', 'error');

            try {
                const response = await fetch(`${AI_API}/api/ai/product-card`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();

                if (data.status === 'placeholder') {
                    toast(data.message || 'Генерация завершена', 'success');
                }
            } catch (error) {
                toast('Функция генерации карточки будет доступна в следующем обновлении', 'info');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Удалить товар?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/products/${projectId}/${id}`);
                if (res.success) { loadProducts(); toast('Товар удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        function searchProducts() {
            // Simple client-side filter
            const query = document.getElementById('searchProducts').value.toLowerCase();
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(query) ||
                (p.sku && p.sku.toLowerCase().includes(query))
            );
            // Re-render with filtered list
            const originalProducts = products;
            products = filtered;
            renderProducts();
            products = originalProducts;
        }

        // ===== Product Images =====
        let productImages = [];

        function addProductImage() {
            document.getElementById('productImageInput').click();
        }

        function handleProductImage(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                productImages.push({
                    id: Date.now(),
                    url: e.target.result,
                    file: file
                });
                renderProductImages();
            };

            reader.readAsDataURL(file);
            input.value = '';
        }

        function renderProductImages() {
            const container = document.getElementById('productImagesContainer');
            container.innerHTML = productImages.map((img, idx) => `
                <div class="product-image-item" draggable="true" data-idx="${idx}" style="position:relative;width:80px;height:80px;">
                    <img src="${img.url}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
                    ${idx === 0 ? '<span style="position:absolute;top:4px;left:4px;background:var(--primary);color:#fff;font-size:9px;padding:2px 4px;border-radius:3px;">Главное</span>' : ''}
                    <button type="button" onclick="removeProductImage(${idx})" style="position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:#ef4444;color:#fff;border:none;cursor:pointer;font-size:10px;">×</button>
                </div>
            `).join('') + `
                <div class="image-placeholder" style="width:80px;height:80px;border:2px dashed var(--border-color);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);cursor:pointer;" onclick="addProductImage()">
                    <i class="fas fa-plus"></i>
                </div>
            `;

            // Setup drag and drop
            setupImageDragDrop();
        }

        function removeProductImage(idx) {
            productImages.splice(idx, 1);
            renderProductImages();
        }

        function setupImageDragDrop() {
            const items = document.querySelectorAll('.product-image-item');
            items.forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', item.dataset.idx);
                    item.style.opacity = '0.5';
                });
                item.addEventListener('dragend', () => item.style.opacity = '1');
                item.addEventListener('dragover', e => e.preventDefault());
                item.addEventListener('drop', e => {
                    e.preventDefault();
                    const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIdx = parseInt(item.dataset.idx);
                    if (fromIdx !== toIdx) {
                        const [movedImg] = productImages.splice(fromIdx, 1);
                        productImages.splice(toIdx, 0, movedImg);
                        renderProductImages();
                    }
                });
            });
        }

        // ===== Product Variants =====
        let productVariants = [];

        function addProductVariant() {
            productVariants.push({
                id: Date.now(),
                name: '',
                sku_suffix: '',
                price_modifier: 0,
                stock: 0,
                attributes: {}
            });
            renderProductVariants();
        }

        function renderProductVariants() {
            const container = document.getElementById('productVariantsContainer');
            container.innerHTML = productVariants.map((v, idx) => `
                <div class="variant-row" style="background:var(--bg-input);padding:12px;border-radius:8px;margin-bottom:10px;">
                    <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:10px;align-items:end;">
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:11px;">Название варианта</label>
                            <input type="text" value="${escapeHtml(v.name)}" onchange="updateVariant(${idx}, 'name', this.value)" placeholder="Размер M / Синий">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:11px;">SKU суффикс</label>
                            <input type="text" value="${escapeHtml(v.sku_suffix)}" onchange="updateVariant(${idx}, 'sku_suffix', this.value)" placeholder="-M">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:11px;">Цена ±</label>
                            <input type="number" value="${v.price_modifier || 0}" onchange="updateVariant(${idx}, 'price_modifier', this.value)" placeholder="0">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label style="font-size:11px;">Остаток</label>
                            <input type="number" value="${v.stock || 0}" onchange="updateVariant(${idx}, 'stock', this.value)" placeholder="0">
                        </div>
                        <button type="button" class="btn btn-sm" style="background:#ef4444;" onclick="removeVariant(${idx})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateVariant(idx, field, value) {
            if (productVariants[idx]) {
                productVariants[idx][field] = field === 'price_modifier' || field === 'stock' ? parseFloat(value) || 0 : value;
            }
        }

        function removeVariant(idx) {
            productVariants.splice(idx, 1);
            renderProductVariants();
        }

        // ===== Inventory Options =====
        function toggleInventoryOptions() {
            const track = document.getElementById('productTrackInventory').checked;
            document.getElementById('inventoryOptions').style.display = track ? 'block' : 'none';
        }

        function clearProductExtras() {
            productImages = [];
            productVariants = [];
            renderProductImages();
            renderProductVariants();
            document.getElementById('productTrackInventory').checked = false;
            toggleInventoryOptions();
        }

        // Dashboard Charts
        let dashboardPeriod = 'today';

        function setDashboardPeriod(period) {
            dashboardPeriod = period;
            ['today', 'week', 'month', 'year'].forEach(p => {
                const btn = document.getElementById('period' + p.charAt(0).toUpperCase() + p.slice(1));
                if (btn) btn.className = p === period ? 'btn btn-sm' : 'btn btn-sm btn-outline';
            });

            // Set date range based on period
            const now = new Date();
            const from = new Date();
            const to = new Date();

            switch(period) {
                case 'today':
                    break;
                case 'week':
                    from.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    from.setMonth(now.getMonth() - 1);
                    break;
                case 'year':
                    from.setFullYear(now.getFullYear() - 1);
                    break;
            }

            document.getElementById('dashboardDateFrom').value = from.toISOString().split('T')[0];
            document.getElementById('dashboardDateTo').value = to.toISOString().split('T')[0];
            refreshDashboard();
        }

        function refreshDashboard() {
            renderDashboard();
            toast('Данные обновлены', 'success', 2000);
        }

        function exportDashboard() {
            const data = {
                period: dashboardPeriod,
                stats: {
                    deals: document.getElementById('stat-deals')?.textContent,
                    won: document.getElementById('stat-won')?.textContent,
                    clients: document.getElementById('stat-clients')?.textContent,
                    orders: document.getElementById('stat-orders')?.textContent
                },
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            toast('Экспорт завершён', 'success');
        }

        function renderRevenueChart() {
            const container = document.getElementById('revenueChart');
            if (!container) return;

            // Generate sample data based on orders
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            const values = [];

            // Group orders by day of week
            const ordersByDay = [0, 0, 0, 0, 0, 0, 0];
            orders.forEach(o => {
                const date = new Date(o.created_at);
                const dayIndex = (date.getDay() + 6) % 7; // Monday = 0
                ordersByDay[dayIndex] += parseFloat(o.total) || 0;
            });

            const maxValue = Math.max(...ordersByDay, 1);

            container.innerHTML = ordersByDay.map((value, i) => {
                const height = Math.max(4, (value / maxValue) * 180);
                return `
                    <div class="chart-bar" style="height:${height}px;">
                        <div class="chart-bar-tooltip">${formatMoney(value)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderFunnelChart() {
            const container = document.getElementById('funnelChart');
            if (!container) return;

            if (!funnels.length) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px;">Нет воронок</div>';
                return;
            }

            // Use first funnel for visualization
            const funnel = funnels[0];
            const stages = funnel.stages || [];

            if (!stages.length) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px;">Нет этапов</div>';
                return;
            }

            const totalDeals = stages.reduce((sum, s) => sum + (s.deals?.length || 0), 0);

            container.innerHTML = stages.map((stage, i) => {
                const dealsCount = stage.deals?.length || 0;
                const percent = totalDeals > 0 ? Math.round((dealsCount / totalDeals) * 100) : 0;
                const width = totalDeals > 0 ? (dealsCount / totalDeals) * 100 : 0;

                return `
                    <div class="funnel-stage" style="background:var(--bg-input);">
                        <div class="funnel-stage-bg" style="width:${width}%;"></div>
                        <div class="funnel-stage-content">
                            <span class="funnel-stage-name">${escapeHtml(stage.name)}</span>
                            <span>
                                <span class="funnel-stage-value">${dealsCount}</span>
                                <span class="funnel-stage-percent">(${percent}%)</span>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Dashboard
        async function renderDashboard() {
            // Render charts
            renderRevenueChart();
            renderFunnelChart();
            // Basic stats
            document.getElementById('stat-deals').textContent = funnels.reduce((sum, f) => sum + (f.deals_count || 0), 0);
            document.getElementById('stat-clients').textContent = clients.length;
            document.getElementById('stat-orders').textContent = orders.length;
            document.getElementById('stat-products').textContent = products.length;

            const wonAmount = funnels.reduce((sum, f) => sum + (f.won_amount || 0), 0);
            document.getElementById('stat-won').textContent = formatMoney(wonAmount);

            // Load additional stats from various modules
            try {
                const statsRes = await api('GET', `/analytics/${projectId}/dashboard`);
                if (statsRes.success) {
                    document.getElementById('stat-tasks').textContent = statsRes.stats.tasks?.total || 0;
                    document.getElementById('stat-overdue').textContent = statsRes.stats.overdueTasks?.total || 0;
                }
            } catch (e) { console.log('Stats load failed', e); }

            // Load bookings count for today
            try {
                const today = new Date().toISOString().split('T')[0];
                const bookingsRes = await api('GET', `/bookings/${projectId}?date=${today}`);
                if (bookingsRes.success) {
                    document.getElementById('stat-bookings').textContent = bookingsRes.bookings?.length || 0;
                    renderTodayBookings(bookingsRes.bookings || []);
                }
            } catch (e) { console.log('Bookings load failed', e); }

            // Load calls count for today
            try {
                const callsRes = await api('GET', `/calls/${projectId}?today=1`);
                if (callsRes.success) {
                    document.getElementById('stat-calls').textContent = callsRes.calls?.length || 0;
                }
            } catch (e) { document.getElementById('stat-calls').textContent = '0'; }

            // Load webinars count
            try {
                const webinarsRes = await api('GET', `/learning/${projectId}/webinars?status=scheduled`);
                if (webinarsRes.success) {
                    document.getElementById('stat-webinars').textContent = webinarsRes.webinars?.length || 0;
                }
            } catch (e) { document.getElementById('stat-webinars').textContent = '0'; }

            // Load students count
            try {
                const accessRes = await api('GET', `/learning/${projectId}/access`);
                if (accessRes.success) {
                    document.getElementById('stat-students').textContent = accessRes.access?.length || 0;
                }
            } catch (e) { document.getElementById('stat-students').textContent = '0'; }

            // Load promo codes count
            try {
                const promosRes = await api('GET', `/ecommerce/${projectId}/promo-codes?active=1`);
                if (promosRes.success) {
                    document.getElementById('stat-promos').textContent = promosRes.promo_codes?.length || 0;
                }
            } catch (e) { document.getElementById('stat-promos').textContent = '0'; }

            // Recent deals
            const recentDeals = [];
            funnels.forEach(f => {
                (f.stages || []).forEach(s => {
                    (s.deals || []).forEach(d => recentDeals.push({ ...d, stage_name: s.name, funnel_name: f.name }));
                });
            });

            const tbody = document.getElementById('recentDeals');
            if (!recentDeals.length) {
                tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-handshake"></i><h3>Нет сделок</h3></div></td></tr>';
            } else {
                tbody.innerHTML = recentDeals.slice(0, 5).map(d => `
                    <tr onclick="openDealDetails('${d.id}')" style="cursor:pointer;">
                        <td><strong>${escapeHtml(d.name)}</strong></td>
                        <td>${d.client_first_name ? escapeHtml(d.client_first_name) : '-'}</td>
                        <td>${formatMoney(d.amount)}</td>
                        <td><span class="badge badge-new">${escapeHtml(d.stage_name || '-')}</span></td>
                    </tr>
                `).join('');
            }

            // Recent orders
            const ordersBody = document.getElementById('recentOrders');
            if (ordersBody) {
                const statuses = { new: ['Новый', 'badge badge-new'], processing: ['В работе', 'badge badge-warning'], shipped: ['Отправлен', 'badge badge-new'], completed: ['Готов', 'badge badge-success'] };
                if (!orders.length) {
                    ordersBody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>Нет заказов</h3></div></td></tr>';
                } else {
                    ordersBody.innerHTML = orders.slice(0, 5).map(o => `
                        <tr onclick="openOrderDetails('${o.id}')" style="cursor:pointer;">
                            <td><strong>${escapeHtml(o.order_number)}</strong></td>
                            <td>${formatMoney(o.total)}</td>
                            <td><span class="${statuses[o.status]?.[1] || 'badge'}">${statuses[o.status]?.[0] || o.status}</span></td>
                            <td>${new Date(o.created_at).toLocaleDateString('ru')}</td>
                        </tr>
                    `).join('');
                }
            }

            // Course activity
            loadCourseActivity();

            // Load AI insights
            loadAIInsights();
        }

        function renderTodayBookings(bookings) {
            const tbody = document.getElementById('todayBookings');
            if (!tbody) return;
            const statuses = { pending: ['Ожидает', 'badge-warning'], confirmed: ['Подтв.', 'badge-success'], completed: ['Завершено', 'badge-success'], cancelled: ['Отменено', 'badge-danger'] };
            if (!bookings.length) {
                tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-calendar-check"></i><h3>Нет записей</h3></div></td></tr>';
            } else {
                tbody.innerHTML = bookings.slice(0, 5).map(b => `
                    <tr onclick="switchSection('appointments')" style="cursor:pointer;">
                        <td><strong>${b.start_time}</strong></td>
                        <td>${escapeHtml(b.client_name || '-')}</td>
                        <td>${escapeHtml(b.service_name || '-')}</td>
                        <td><span class="badge ${statuses[b.status]?.[1] || ''}">${statuses[b.status]?.[0] || b.status}</span></td>
                    </tr>
                `).join('');
            }
        }

        async function loadCourseActivity() {
            const tbody = document.getElementById('courseActivity');
            if (!tbody) return;
            try {
                const res = await api('GET', `/courses/${projectId}`);
                if (!res.success || !res.courses?.length) {
                    tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-graduation-cap"></i><h3>Нет курсов</h3></div></td></tr>';
                    return;
                }
                tbody.innerHTML = res.courses.slice(0, 5).map(c => `
                    <tr onclick="switchSection('learning')" style="cursor:pointer;">
                        <td><strong>${escapeHtml(c.name)}</strong></td>
                        <td>${c.students_count || 0}</td>
                        <td>
                            <div style="background:#334155;border-radius:4px;height:6px;width:80px;display:inline-block;">
                                <div style="width:${c.avg_progress || 0}%;height:100%;background:var(--primary);border-radius:4px;"></div>
                            </div>
                            <span style="font-size:11px;margin-left:4px;">${c.avg_progress || 0}%</span>
                        </td>
                        <td>${c.completed_count || 0}</td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><p>Ошибка загрузки</p></div></td></tr>';
            }
        }

        function openOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                toast(`Заказ ${order.order_number}: ${formatMoney(order.total)} — ${order.status}`, 'info');
            }
        }

        async function loadAIInsights() {
            const container = document.getElementById('aiInsights');
            if (!container) return;

            container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Анализ данных...</div>';

            try {
                const res = await api('GET', `/analytics/${projectId}/ai-insights`);
                if (res.success && res.insights.length > 0) {
                    const icons = { success: 'check-circle', warning: 'exclamation-triangle', danger: 'times-circle', info: 'info-circle' };
                    const colors = { success: 'var(--success)', warning: 'var(--warning)', danger: 'var(--danger)', info: 'var(--primary)' };

                    container.innerHTML = res.insights.map(i => `
                        <div style="background: var(--bg-dark); padding: 16px; border-radius: 8px; border-left: 3px solid ${colors[i.type]};">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <i class="fas fa-${icons[i.type]}" style="color: ${colors[i.type]};"></i>
                                <strong>${escapeHtml(i.title)}</strong>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">${escapeHtml(i.description)}</p>
                            ${i.action ? `<button class="btn btn-sm btn-outline" style="margin-top: 12px;" onclick="alert('${escapeHtml(i.action)}')">${escapeHtml(i.action)}</button>` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted);"><i class="fas fa-check-circle" style="color: var(--success);"></i> Все показатели в норме</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="grid-column: 1/-1; color: var(--text-muted);">Не удалось загрузить рекомендации</div>';
            }
        }

        // Helpers
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Orders additional functions
        async function saveOrder() {
            const client_id = document.getElementById('orderClient').value;
            const total_amount = document.getElementById('orderAmount').value;
            const status = document.getElementById('orderStatus').value;
            const payment_status = document.getElementById('orderPaymentStatus').value;
            const shipping_address = document.getElementById('orderAddress').value;
            const notes = document.getElementById('orderNotes').value;

            if (!client_id || !total_amount) return toast('Заполните клиента и сумму', 'error');

            showLoading();
            try {
                const res = await api('POST', `/orders/${projectId}`, {
                    client_id, total_amount: parseFloat(total_amount), status, payment_status, shipping_address, notes
                });
                if (res.success) {
                    closeModal('orderModal');
                    ['orderAmount', 'orderAddress', 'orderNotes'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    loadOrders();
                    toast('Заказ создан', 'success');
                } else {
                    toast(res.error || 'Ошибка создания заказа', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        function viewOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            toast(`Заказ ${order.order_number}: ${formatMoney(order.total)} — ${order.status}`, 'info');
        }

        function searchOrders() {
            const query = document.getElementById('searchOrders').value.toLowerCase();
            const filtered = orders.filter(o =>
                (o.order_number && o.order_number.toLowerCase().includes(query)) ||
                (o.customer_name && o.customer_name.toLowerCase().includes(query)) ||
                (o.customer_email && o.customer_email.toLowerCase().includes(query))
            );
            const originalOrders = orders;
            orders = filtered;
            renderOrders();
            orders = originalOrders;
        }

        // Segments
        let segments = [];

        async function loadSegments() {
            const res = await api('GET', `/segments/${projectId}`);
            if (res.success) {
                segments = res.segments;
                renderSegments();
            }
        }

        function renderSegments() {
            const container = document.getElementById('segmentsList');
            if (!segments.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-layer-group"></i><h3>Нет сегментов</h3><p>Создайте первый сегмент для группировки клиентов</p></div>';
                return;
            }

            container.innerHTML = segments.map(s => `
                <div class="stat-card" style="border-left: 4px solid ${s.color || '#6366f1'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <h4>${escapeHtml(s.name)}</h4>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteSegment('${s.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="value" style="font-size: 24px;">${s.members_count || 0}</div>
                    <div class="label">клиентов</div>
                    ${s.is_dynamic ? '<span class="badge badge-new" style="margin-top: 8px;">Динамический</span>' : ''}
                </div>
            `).join('');
        }

        const segmentFieldDefs = {
            has_orders: { label: 'Имеет заказ', group: 'Заказы', type: 'boolean' },
            total_spent: { label: 'Сумма заказов', group: 'Заказы', type: 'number' },
            total_orders: { label: 'Кол-во заказов', group: 'Заказы', type: 'number' },
            last_order_days: { label: 'Последний заказ (дн. назад)', group: 'Заказы', type: 'number' },
            gender: { label: 'Пол', group: 'Профиль', type: 'enum', options: [['male','Мужской'],['female','Женский'],['unknown','Не указан']] },
            has_email: { label: 'Имеет email', group: 'Профиль', type: 'boolean' },
            has_phone: { label: 'Имеет телефон', group: 'Профиль', type: 'boolean' },
            has_telegram: { label: 'Подключен Telegram', group: 'Мессенджеры', type: 'boolean' },
            has_whatsapp: { label: 'Подключен WhatsApp', group: 'Мессенджеры', type: 'boolean' },
            has_max: { label: 'Подключен MAX', group: 'Мессенджеры', type: 'boolean' },
            source: { label: 'Источник', group: 'Источник', type: 'enum', options: [['vk','ВКонтакте'],['telegram_bot','Телеграм-бот'],['telegram_account','Телеграм аккаунт'],['max_bot','МАКС-бот'],['max_account','МАКС аккаунт'],['whatsapp','WhatsApp'],['tiktok','TikTok'],['instagram','Instagram'],['website','Сайт'],['referral','Рекомендация'],['ads','Реклама'],['other','Другой']] },
            inactive_days: { label: 'Дней без активности', group: 'Активность', type: 'number' },
            has_bookings: { label: 'Имеет бронирования', group: 'Активность', type: 'boolean' },
            loyalty_points: { label: 'Бонусные баллы', group: 'Профиль', type: 'number' }
        };

        let segmentConditionCount = 0;

        function addSegmentCondition() {
            const container = document.getElementById('segmentConditions');
            const idx = segmentConditionCount++;
            const row = document.createElement('div');
            row.className = 'segment-condition-row';
            row.id = `segCondRow_${idx}`;
            row.style.cssText = 'display:flex;gap:8px;align-items:center;margin-bottom:8px;';

            let fieldOptions = '';
            let lastGroup = '';
            for (const [key, def] of Object.entries(segmentFieldDefs)) {
                if (def.group !== lastGroup) {
                    if (lastGroup) fieldOptions += '</optgroup>';
                    fieldOptions += `<optgroup label="${def.group}">`;
                    lastGroup = def.group;
                }
                fieldOptions += `<option value="${key}">${def.label}</option>`;
            }
            if (lastGroup) fieldOptions += '</optgroup>';

            row.innerHTML = `
                <select onchange="onSegCondFieldChange(${idx})" id="segCondField_${idx}" style="flex:1;">${fieldOptions}</select>
                <select id="segCondOp_${idx}" style="width:100px;"></select>
                <span id="segCondValWrap_${idx}" style="width:120px;"></span>
                <button type="button" class="btn btn-sm btn-outline btn-danger" onclick="removeSegmentCondition(${idx})" style="flex-shrink:0;"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(row);
            onSegCondFieldChange(idx);
        }

        function onSegCondFieldChange(idx) {
            const field = document.getElementById(`segCondField_${idx}`).value;
            const def = segmentFieldDefs[field];
            const opEl = document.getElementById(`segCondOp_${idx}`);
            const valWrap = document.getElementById(`segCondValWrap_${idx}`);
            if (def.type === 'boolean') {
                opEl.innerHTML = '<option value="eq">Равно</option>';
                valWrap.innerHTML = '<select id="segCondVal_' + idx + '" style="width:100%;"><option value="true">Да</option><option value="false">Нет</option></select>';
            } else if (def.type === 'number') {
                opEl.innerHTML = '<option value="gt">Больше</option><option value="lt">Меньше</option><option value="eq">Равно</option><option value="gte">≥</option><option value="lte">≤</option>';
                valWrap.innerHTML = '<input type="number" id="segCondVal_' + idx + '" placeholder="Значение" style="width:100%;">';
            } else if (def.type === 'enum') {
                opEl.innerHTML = '<option value="eq">Равно</option><option value="neq">Не равно</option>';
                const opts = def.options.map(([v, l]) => `<option value="${v}">${l}</option>`).join('');
                valWrap.innerHTML = '<select id="segCondVal_' + idx + '" style="width:100%;">' + opts + '</select>';
            }
        }

        function removeSegmentCondition(idx) {
            const row = document.getElementById(`segCondRow_${idx}`);
            if (row) row.remove();
        }

        function getSegmentConditions() {
            const rules = [];
            document.querySelectorAll('[id^="segCondRow_"]').forEach(row => {
                const idx = row.id.split('_')[1];
                const field = document.getElementById(`segCondField_${idx}`)?.value;
                const operator = document.getElementById(`segCondOp_${idx}`)?.value;
                const val = document.getElementById(`segCondVal_${idx}`)?.value;
                if (field && val !== undefined && val !== '') {
                    const def = segmentFieldDefs[field];
                    rules.push({
                        field, operator,
                        value: def.type === 'number' ? parseInt(val) : val
                    });
                }
            });
            return rules;
        }

        async function saveSegment() {
            const name = document.getElementById('segmentName').value;
            const description = document.getElementById('segmentDescription').value;
            const color = document.getElementById('segmentColor').value;
            const is_dynamic = document.getElementById('segmentDynamic').checked;

            if (!name) return toast('Введите название сегмента', 'error');

            let rules = [];
            let logic = 'and';
            if (is_dynamic) {
                rules = getSegmentConditions();
                logic = document.getElementById('segmentLogic').value;
            }

            showLoading();
            try {
                const res = await api('POST', `/segments/${projectId}`, {
                    name, description, color, is_dynamic, rules, logic
                });
                if (res.success) {
                    closeModal('segmentModal');
                    ['segmentName', 'segmentDescription'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    document.getElementById('segmentDynamic').checked = false;
                    document.getElementById('segmentConditions').innerHTML = '';
                    segmentConditionCount = 0;
                    loadSegments();
                    toast('Сегмент создан', 'success');
                } else {
                    toast(res.error || 'Ошибка создания сегмента', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteSegment(id) {
            if (!confirm('Удалить сегмент?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/segments/${projectId}/${id}`);
                if (res.success) { loadSegments(); toast('Сегмент удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Services
        let services = [];

        async function loadServices() {
            const res = await api('GET', `/services/${projectId}`);
            if (res.success) {
                services = res.services;
                renderServices();
            }
        }

        function renderServices() {
            const container = document.getElementById('servicesList');
            if (!container) return;
            if (!services.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-concierge-bell"></i><h3>Нет услуг</h3><p>Добавьте первую услугу</p></div>';
                return;
            }

            container.innerHTML = services.map(s => `
                <div class="stat-card">
                    <h4 style="margin-bottom: 8px;">${escapeHtml(s.name)}</h4>
                    <div class="value primary">${formatMoney(s.price)}</div>
                    <div class="label">${s.duration ? s.duration + ' ч' : 'Не указано'}</div>
                    ${s.category ? '<span class="badge badge-new" style="margin-top: 8px;">' + escapeHtml(s.category) + '</span>' : ''}
                    <div style="margin-top: 12px;">
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteService('${s.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function toggleServiceGroup() {
            const type = document.getElementById('serviceType').value;
            document.getElementById('serviceGroupSettings').style.display = type === 'group' ? 'block' : 'none';
        }

        function togglePromoProducts() {
            const appliesTo = document.getElementById('promoAppliesTo').value;
            document.getElementById('promoProductsGroup').style.display =
                (appliesTo === 'categories' || appliesTo === 'products') ? 'block' : 'none';
        }

        function generatePromoCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('promoCode').value = code;
        }

        function generateBulkPromos() {
            const count = prompt('Сколько промокодов сгенерировать?', '10');
            if (count && parseInt(count) > 0) {
                toast(`Будет сгенерировано ${count} промокодов`, 'info');
                // TODO: Implement bulk generation
            }
        }

        async function saveService() {
            const name = document.getElementById('serviceName').value;
            const category = document.getElementById('serviceCategory').value;
            const price = document.getElementById('servicePrice').value;
            const duration = document.getElementById('serviceDuration').value;
            const description = document.getElementById('serviceDescription').value;
            const type = document.getElementById('serviceType')?.value || 'individual';
            const buffer_time = document.getElementById('serviceBuffer')?.value || 0;
            const max_clients = document.getElementById('serviceMaxClients')?.value || 1;
            const online_booking = document.getElementById('serviceOnlineBooking')?.checked ?? true;

            if (!name) return toast('Введите название услуги');

            showLoading();
            try {
                const res = await api('POST', `/services/${projectId}`, {
                    name, category,
                    price: parseFloat(price) || 0,
                    duration: parseInt(duration) || 60,
                    description, type,
                    buffer_time: parseInt(buffer_time) || 0,
                    max_clients: type === 'group' ? parseInt(max_clients) : 1,
                    online_booking
                });
                if (res.success) {
                    closeModal('serviceModal');
                    ['serviceName', 'serviceCategory', 'servicePrice', 'serviceDuration', 'serviceDescription'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    loadServices();
                    toast('Услуга добавлена', 'success');
                } else {
                    toast(res.error || 'Ошибка добавления услуги', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteService(id) {
            if (!confirm('Удалить услугу?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/services/${projectId}/${id}`);
                if (res.success) { loadServices(); toast('Услуга удалена', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Courses
        let courses = [];

        async function loadCourses() {
            const res = await api('GET', `/courses/${projectId}`);
            if (res.success) {
                courses = res.courses;
                renderCourses();
            }
        }

        function renderCourses() {
            const container = document.getElementById('coursesList');
            if (!container) return;
            if (!courses.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-graduation-cap"></i><h3>Нет курсов</h3><p>Создайте первый курс</p></div>';
                return;
            }

            const levels = { beginner: 'Начинающий', intermediate: 'Средний', advanced: 'Продвинутый' };

            container.innerHTML = courses.map(c => `
                <div class="stat-card">
                    <h4 style="margin-bottom: 8px;">${escapeHtml(c.name)}</h4>
                    <div class="value success">${formatMoney(c.price)}</div>
                    <div class="label">${c.duration ? c.duration + ' ч' : 'Не указано'}</div>
                    <span class="badge badge-new" style="margin-top: 8px;">${levels[c.level] || c.level}</span>
                    <div style="margin-top: 12px;">
                        <button class="btn btn-sm btn-outline" onclick="editCourse('${c.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteCourse('${c.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function saveCourse() {
            const editId = document.getElementById('courseEditId').value;
            const name = document.getElementById('courseName').value;
            const price = document.getElementById('coursePrice').value;
            const level = document.getElementById('courseLevel').value;
            const duration = document.getElementById('courseDuration').value;
            const description = document.getElementById('courseDescription').value;

            if (!name) return toast('Введите название курса', 'error');

            const data = { name, price: parseFloat(price) || 0, level, duration: parseInt(duration) || null, description };
            showLoading();
            try {
                const res = editId
                    ? await api('PUT', `/courses/${projectId}/${editId}`, data)
                    : await api('POST', `/courses/${projectId}`, data);
                if (res.success) {
                    closeModal('courseModal');
                    resetCourseForm();
                    loadCourses();
                    toast(editId ? 'Курс обновлён' : 'Курс создан', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения курса', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        function editCourse(id) {
            const c = courses.find(cr => cr.id == id);
            if (!c) return toast('Курс не найден', 'error');

            document.getElementById('courseEditId').value = c.id;
            document.getElementById('courseName').value = c.name || '';
            document.getElementById('coursePrice').value = c.price || '';
            document.getElementById('courseLevel').value = c.level || 'beginner';
            document.getElementById('courseDuration').value = c.duration || '';
            document.getElementById('courseDescription').value = c.description || '';

            document.getElementById('courseModalTitle').textContent = 'Редактировать курс';
            document.getElementById('courseSaveBtn').textContent = 'Сохранить';

            openModal('courseModal');
        }

        function resetCourseForm() {
            document.getElementById('courseEditId').value = '';
            ['courseName', 'coursePrice', 'courseDuration', 'courseDescription'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('courseLevel').value = 'beginner';
            document.getElementById('courseModalTitle').textContent = 'Новый курс';
            document.getElementById('courseSaveBtn').textContent = 'Сохранить';
        }

        async function deleteCourse(id) {
            if (!confirm('Удалить курс?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/courses/${projectId}/${id}`);
                if (res.success) { loadCourses(); toast('Курс удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Payments
        let payments = [];

        async function loadPayments() {
            const status = document.getElementById('filterPaymentStatus')?.value;
            const params = status ? `?status=${status}` : '';
            const res = await api('GET', `/payments/${projectId}${params}`);
            if (res.success) {
                payments = res.payments;
                renderPayments();
            }
        }

        function renderPayments() {
            const tbody = document.getElementById('paymentsTable');
            if (!tbody) return;
            if (!payments.length) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-credit-card"></i><h3>Нет платежей</h3></div></td></tr>';
                return;
            }

            const statuses = { pending: ['Ожидает', 'badge badge-warning'], completed: ['Успешно', 'badge badge-success'], failed: ['Ошибка', 'badge badge-danger'], refunded: ['Возврат', 'badge badge-danger'] };

            tbody.innerHTML = payments.map(p => `
                <tr>
                    <td><strong>${p.id.slice(0, 8)}</strong></td>
                    <td>${p.order_number || '-'}</td>
                    <td>${formatMoney(p.amount)}</td>
                    <td><span class="${statuses[p.status]?.[1] || 'badge'}">${statuses[p.status]?.[0] || p.status}</span></td>
                    <td>${new Date(p.created_at).toLocaleDateString('ru')}</td>
                </tr>
            `).join('');
        }

        // Segment modal toggle
        document.getElementById('segmentDynamic')?.addEventListener('change', function() {
            document.getElementById('segmentRulesContainer').style.display = this.checked ? 'block' : 'none';
            if (this.checked && !document.querySelectorAll('[id^="segCondRow_"]').length) {
                addSegmentCondition();
            }
        });

        // Update select options for order modal
        function updateOrderClientSelect() {
            document.getElementById('orderClient').innerHTML = '<option value="">Выберите клиента</option>' +
                clients.map(c => `<option value="${c.id}">${escapeHtml(c.first_name)} ${escapeHtml(c.last_name || '')}</option>`).join('');
        }

        // ============================================================
        // amoCRM-like Features
        // ============================================================

        // Calls
        // UIS Integration
        let uisConnected = false;
        let callActive = false;
        let callTimerInterval = null;
        let callSeconds = 0;

        function initUIS() {
            const settings = JSON.parse(localStorage.getItem('uis_settings') || '{}');
            if (settings.api_key) {
                document.getElementById('uisApiKey').value = settings.api_key;
                document.getElementById('uisVirtualNumber').value = settings.virtual_number || '';
                if (settings.connected) {
                    uisConnected = true;
                    updateUISStatus(true);
                }
            }
            const webhookUrl = window.location.origin + '/api/webhook/uis/' + projectId;
            document.getElementById('uisWebhookUrl').value = webhookUrl;
            loadRecentCalls();
        }

        function connectUIS() {
            const apiKey = document.getElementById('uisApiKey').value;
            const virtualNumber = document.getElementById('uisVirtualNumber').value;
            if (!apiKey) return toast('Введите API ключ UIS', 'error');

            localStorage.setItem('uis_settings', JSON.stringify({
                api_key: apiKey, virtual_number: virtualNumber, connected: true
            }));
            uisConnected = true;
            updateUISStatus(true);
            toast('UIS телефония подключена', 'success');
        }

        function disconnectUIS() {
            const settings = JSON.parse(localStorage.getItem('uis_settings') || '{}');
            settings.connected = false;
            localStorage.setItem('uis_settings', JSON.stringify(settings));
            uisConnected = false;
            updateUISStatus(false);
            toast('UIS телефония отключена', 'info');
        }

        function updateUISStatus(connected) {
            const el = document.getElementById('uisConnectionStatus');
            el.innerHTML = connected
                ? '<i class="fas fa-circle" style="font-size:8px;color:var(--success);"></i> Подключено'
                : '<i class="fas fa-circle" style="font-size:8px;color:var(--text-muted);"></i> Не подключено';
            document.getElementById('uisDisconnectBtn').style.display = connected ? '' : 'none';
        }

        function toggleCallWidget() {
            const panel = document.getElementById('callWidgetPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function makeCall(phone) {
            if (!phone) return toast('Введите номер телефона', 'error');
            if (callActive) return toast('Звонок уже активен', 'warning');

            callActive = true;
            callSeconds = 0;

            const clientName = findClientByPhone(phone);
            document.getElementById('callActiveName').textContent = clientName || phone;
            document.getElementById('callActiveInfo').style.display = 'block';
            document.getElementById('callWidgetDialer').style.display = 'none';
            document.getElementById('callWidgetEndBtn').style.display = 'block';

            // Open widget if not visible
            document.getElementById('callWidgetPanel').style.display = 'block';

            callTimerInterval = setInterval(() => {
                callSeconds++;
                const m = Math.floor(callSeconds / 60);
                const s = callSeconds % 60;
                document.getElementById('callActiveTimer').textContent = `${m}:${s.toString().padStart(2, '0')}`;
            }, 1000);

            toast(`Звоним: ${clientName || phone}`, 'info');

            // Save to recent
            const recent = JSON.parse(localStorage.getItem('call_recent') || '[]');
            recent.unshift({ phone, name: clientName, time: new Date().toISOString(), direction: 'outgoing' });
            localStorage.setItem('call_recent', JSON.stringify(recent.slice(0, 20)));
        }

        function makeCallFromWidget() {
            const phone = document.getElementById('callWidgetPhone').value;
            makeCall(phone);
        }

        function endCall() {
            callActive = false;
            clearInterval(callTimerInterval);
            document.getElementById('callActiveInfo').style.display = 'none';
            document.getElementById('callWidgetDialer').style.display = 'block';
            document.getElementById('callWidgetEndBtn').style.display = 'none';
            document.getElementById('callWidgetPhone').value = '';
            toast(`Звонок завершён (${document.getElementById('callActiveTimer').textContent})`, 'info');
            loadRecentCalls();
        }

        function findClientByPhone(phone) {
            const clean = phone.replace(/\D/g, '');
            const c = clients.find(cl => cl.phone && cl.phone.replace(/\D/g, '').includes(clean));
            return c ? `${c.first_name || ''} ${c.last_name || ''}`.trim() : null;
        }

        function loadRecentCalls() {
            const recent = JSON.parse(localStorage.getItem('call_recent') || '[]');
            const container = document.getElementById('callWidgetRecent');
            if (!container) return;
            if (!recent.length) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:12px;font-size:12px;">Нет звонков</div>';
                return;
            }
            container.innerHTML = recent.slice(0, 10).map(r => `
                <div style="display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''" onclick="document.getElementById('callWidgetPhone').value='${escapeHtml(r.phone)}'">
                    <i class="fas fa-phone${r.direction === 'incoming' ? '-volume' : ''}" style="color:${r.direction === 'incoming' ? 'var(--success)' : 'var(--primary)'};font-size:12px;width:16px;"></i>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(r.name || r.phone)}</div>
                        <div style="font-size:11px;color:var(--text-muted);">${new Date(r.time).toLocaleString('ru', {hour:'2-digit',minute:'2-digit',day:'numeric',month:'short'})}</div>
                    </div>
                    <button onclick="event.stopPropagation();makeCall('${escapeHtml(r.phone)}')" style="background:var(--success);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:11px;"><i class="fas fa-phone"></i></button>
                </div>
            `).join('');
        }

        function simulateIncomingCall(phone, name) {
            document.getElementById('incomingCallerName').textContent = name || 'Неизвестный';
            document.getElementById('incomingCallerPhone').textContent = phone;
            document.getElementById('incomingCallPopup').style.display = 'block';

            const recent = JSON.parse(localStorage.getItem('call_recent') || '[]');
            recent.unshift({ phone, name, time: new Date().toISOString(), direction: 'incoming' });
            localStorage.setItem('call_recent', JSON.stringify(recent.slice(0, 20)));
        }

        function answerIncomingCall() {
            const phone = document.getElementById('incomingCallerPhone').textContent;
            document.getElementById('incomingCallPopup').style.display = 'none';
            makeCall(phone);
        }

        function rejectIncomingCall() {
            document.getElementById('incomingCallPopup').style.display = 'none';
            toast('Звонок отклонён', 'info');
        }

        async function loadCalls() {
            const res = await api('GET', `/calls/${projectId}`);
            if (res.success) {
                renderCalls(res.calls || []);
                // Update stats
                const total = res.calls?.length || 0;
                const answered = res.calls?.filter(c => c.status === 'completed').length || 0;
                const missed = res.calls?.filter(c => c.status === 'missed').length || 0;
                const avgDuration = total > 0 ? Math.round(res.calls.reduce((sum, c) => sum + (c.duration || 0), 0) / total) : 0;
                document.getElementById('callsTotal').textContent = total;
                document.getElementById('callsAnswered').textContent = answered;
                document.getElementById('callsMissed').textContent = missed;
                document.getElementById('callsDuration').textContent = formatDuration(avgDuration);
            }
        }

        function renderCalls(calls) {
            const tbody = document.getElementById('callsTable');
            if (!calls.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-phone"></i><h3>Нет звонков</h3></div></td></tr>';
                return;
            }
            const statuses = { completed: ['Завершён', 'badge-success'], missed: ['Пропущен', 'badge-danger'], initiated: ['Инициирован', 'badge-warning'] };
            tbody.innerHTML = calls.map(c => `
                <tr>
                    <td>${new Date(c.created_at).toLocaleString('ru')}</td>
                    <td><span class="badge ${c.direction === 'incoming' ? 'badge-new' : ''}">${c.direction === 'incoming' ? '↓ Входящий' : '↑ Исходящий'}</span></td>
                    <td>${c.client_first_name || c.phone_to || '-'}</td>
                    <td>${c.employee_first_name || '-'}</td>
                    <td>${formatDuration(c.duration || 0)}</td>
                    <td><span class="badge ${statuses[c.status]?.[1] || ''}">${statuses[c.status]?.[0] || c.status}</span></td>
                    <td>${c.recording_url ? `<button class="btn btn-sm btn-outline" onclick="window.open('${c.recording_url}')"><i class="fas fa-play"></i></button>` : ''}</td>
                </tr>
            `).join('');
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Regulations (SLA)
        let regulationsData = [];
        let regEditorBlocks = [];
        let regBlockCount = 0;

        async function loadRegulations() {
            const res = await api('GET', `/regulations/${projectId}`);
            if (res.success) {
                regulationsData = res.regulations || [];
                renderRegulations(regulationsData);
            }
        }

        function renderRegulations(regulations) {
            const container = document.getElementById('regulationsGrid');
            if (!regulations.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-book"></i><h3>Нет регламентов</h3><p>Создайте первый регламент</p></div>';
                return;
            }

            container.innerHTML = regulations.map(r => {
                const content = r.content ? (typeof r.content === 'string' ? JSON.parse(r.content) : r.content) : [];
                const desc = r.description || (content.length ? content.filter(b => b.type === 'text').map(b => b.content?.replace(/<[^>]+>/g, '')).join(' ').slice(0, 80) : 'Нет описания');
                const accessBadge = r.access_all ? 'Все' : (r.access?.length || 0) + ' чел.';
                const updatedAt = r.updated_at ? new Date(r.updated_at).toLocaleDateString('ru', {day:'numeric',month:'short',year:'numeric'}) : '';
                return `
                <div class="stat-card" style="cursor:pointer;" onclick="openRegulationEditor('${r.id}')">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                        <div>
                            <h4 style="margin-bottom:4px;">${escapeHtml(r.name)}</h4>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.4;">${escapeHtml(desc)}${desc.length >= 80 ? '...' : ''}</div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;">
                        <div style="display:flex;gap:8px;align-items:center;">
                            <span class="badge"><i class="fas fa-users" style="margin-right:4px;"></i>${accessBadge}</span>
                            ${updatedAt ? `<span style="font-size:11px;color:var(--text-muted);">${updatedAt}</span>` : ''}
                        </div>
                        <div style="display:flex;gap:4px;" onclick="event.stopPropagation();">
                            <button class="btn btn-sm btn-outline" onclick="openRegulationEditor('${r.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline btn-danger" onclick="deleteRegulation('${r.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function openRegulationEditor(id) {
            regEditorBlocks = [];
            regBlockCount = 0;
            document.getElementById('regEditorId').value = id || '';
            document.getElementById('regEditorName').value = '';
            document.getElementById('regEditorDescription').value = '';
            document.getElementById('regAccessAll').checked = true;
            document.getElementById('regEditorBlocks').innerHTML = '';
            switchRegTab('content');

            if (id) {
                const reg = regulationsData.find(r => r.id == id);
                if (reg) {
                    document.getElementById('regEditorTitle').textContent = 'Редактировать регламент';
                    document.getElementById('regEditorName').value = reg.name || '';
                    document.getElementById('regEditorDescription').value = reg.description || '';
                    const content = reg.content ? (typeof reg.content === 'string' ? JSON.parse(reg.content) : reg.content) : [];
                    content.forEach(block => addRegulationBlock(block.type, block));
                    document.getElementById('regAccessAll').checked = reg.access_all !== false;
                    renderRegAccessList(reg.access || []);
                }
            } else {
                document.getElementById('regEditorTitle').textContent = 'Новый регламент';
                addRegulationBlock('text');
                renderRegAccessList([]);
            }

            openModal('regulationEditorModal');
        }

        function switchRegTab(tab) {
            document.getElementById('regContentTab').style.display = tab === 'content' ? 'block' : 'none';
            document.getElementById('regAccessTab').style.display = tab === 'access' ? 'block' : 'none';
            document.getElementById('regTabContent').style.background = tab === 'content' ? 'var(--primary)' : '';
            document.getElementById('regTabContent').style.color = tab === 'content' ? '#fff' : '';
            document.getElementById('regTabAccess').style.background = tab === 'access' ? 'var(--primary)' : '';
            document.getElementById('regTabAccess').style.color = tab === 'access' ? '#fff' : '';
        }

        function toggleRegBlockMenu() {
            const menu = document.getElementById('regBlockMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            document.querySelectorAll('.reg-inline-block-menu').forEach(m => m.remove());
        }

        function addRegulationBlock(type, data, insertBeforeIdx) {
            const idx = regBlockCount++;
            const container = document.getElementById('regEditorBlocks');
            const blockEl = document.createElement('div');
            blockEl.id = `regBlock_${idx}`;
            blockEl.className = 'reg-block-wrapper';
            blockEl.setAttribute('data-type', type);

            const actionsHtml = `<div class="reg-block-actions">
                <button type="button" onclick="moveRegBlock(${idx},-1)" title="Вверх"><i class="fas fa-chevron-up"></i></button>
                <button type="button" onclick="moveRegBlock(${idx},1)" title="Вниз"><i class="fas fa-chevron-down"></i></button>
                <button type="button" onclick="removeRegBlock(${idx})" title="Удалить" style="color:var(--danger);"><i class="fas fa-trash"></i></button>
            </div>`;
            const insertBtn = `<button type="button" class="reg-block-insert-btn" onclick="regInsertBlockBefore(${idx})" title="Добавить блок">+</button>`;

            let contentHtml = '';
            const alertColors = { info: '#3b82f6', warning: '#f59e0b', success: '#22c55e', danger: '#ef4444' };
            const alertIcons = { info: 'info-circle', warning: 'exclamation-triangle', success: 'check-circle', danger: 'times-circle' };

            switch(type) {
                case 'text':
                    contentHtml = `<div contenteditable="true" id="regBlockContent_${idx}" style="min-height:40px;padding:12px;border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);line-height:1.6;outline:none;" placeholder="Введите текст...">${data?.content || ''}</div>`;
                    break;
                case 'heading': {
                    const level = data?.level || 2;
                    const sizes = { 1: '28px', 2: '22px', 3: '18px' };
                    contentHtml = `<div style="display:flex;align-items:center;gap:8px;">
                        <select id="regBlockLevel_${idx}" style="width:60px;padding:4px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-input);color:var(--text-primary);font-size:12px;" onchange="document.getElementById('regBlockContent_${idx}').style.fontSize={1:'28px',2:'22px',3:'18px'}[this.value]">
                            <option value="1" ${level==1?'selected':''}>H1</option>
                            <option value="2" ${level==2?'selected':''}>H2</option>
                            <option value="3" ${level==3?'selected':''}>H3</option>
                        </select>
                        <input type="text" id="regBlockContent_${idx}" placeholder="Заголовок..." value="${escapeHtml(data?.content || '')}" style="flex:1;border:none;border-bottom:2px solid var(--border-color);background:transparent;color:var(--text-primary);padding:8px 0;font-size:${sizes[level]};font-weight:700;outline:none;">
                    </div>`;
                    break;
                }
                case 'task':
                    contentHtml = `<div style="display:flex;align-items:center;gap:8px;border:1px solid var(--border-color);border-radius:8px;padding:12px;">
                        <input type="checkbox" id="regBlockCheck_${idx}" style="flex-shrink:0;width:18px;height:18px;cursor:pointer;" ${data?.checked ? 'checked' : ''}>
                        <input type="text" id="regBlockContent_${idx}" placeholder="Описание задачи..." value="${escapeHtml(data?.content || '')}" style="flex:1;border:none;border-bottom:1px solid var(--border-color);background:transparent;color:var(--text-primary);padding:4px 0;outline:none;">
                        <input type="text" id="regBlockAssignee_${idx}" placeholder="Ответственный" value="${escapeHtml(data?.assignee || '')}" style="width:130px;border:none;border-bottom:1px solid var(--border-color);background:transparent;color:var(--text-secondary);padding:4px 0;outline:none;font-size:12px;">
                        <input type="date" id="regBlockDeadline_${idx}" value="${data?.deadline || ''}" style="width:130px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-input);color:var(--text-primary);padding:4px;font-size:12px;">
                    </div>`;
                    break;
                case 'checklist': {
                    const items = data?.items || [{ text: '', checked: false }];
                    let itemsHtml = '';
                    items.forEach((item, i) => {
                        itemsHtml += `<div class="reg-checklist-item" data-item="${i}">
                            <input type="checkbox" ${item.checked ? 'checked' : ''}>
                            <input type="text" value="${escapeHtml(item.text || '')}" placeholder="Пункт...">
                            <button type="button" onclick="removeChecklistItem(${idx}, this)" title="Удалить"><i class="fas fa-times"></i></button>
                        </div>`;
                    });
                    contentHtml = `<div style="border:1px solid var(--border-color);border-radius:8px;padding:12px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><i class="fas fa-tasks" style="color:var(--primary);"></i><strong>Чеклист</strong></div>
                        <div id="regBlockItems_${idx}">${itemsHtml}</div>
                        <button type="button" class="btn btn-sm btn-outline" onclick="addChecklistItem(${idx})" style="margin-top:8px;"><i class="fas fa-plus"></i> Добавить пункт</button>
                    </div>`;
                    break;
                }
                case 'quote':
                    contentHtml = `<div style="border-left:4px solid var(--primary);background:var(--bg-input);border-radius:0 8px 8px 0;padding:16px 16px 16px 20px;">
                        <div contenteditable="true" id="regBlockContent_${idx}" style="min-height:30px;color:var(--text-secondary);font-style:italic;line-height:1.6;outline:none;" placeholder="Цитата...">${data?.content || ''}</div>
                    </div>`;
                    break;
                case 'alert': {
                    const variant = data?.variant || 'info';
                    const color = alertColors[variant];
                    const icon = alertIcons[variant];
                    contentHtml = `<div id="regBlockAlert_${idx}" style="border:1px solid ${color}33;background:${color}11;border-radius:8px;padding:12px 16px;border-left:4px solid ${color};">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <i class="fas fa-${icon}" style="color:${color};"></i>
                            <select id="regBlockVariant_${idx}" style="border:none;background:transparent;color:var(--text-primary);font-weight:600;font-size:12px;cursor:pointer;outline:none;" onchange="updateAlertVariant(${idx}, this.value)">
                                <option value="info" ${variant=='info'?'selected':''}>Информация</option>
                                <option value="warning" ${variant=='warning'?'selected':''}>Внимание</option>
                                <option value="success" ${variant=='success'?'selected':''}>Успех</option>
                                <option value="danger" ${variant=='danger'?'selected':''}>Важно</option>
                            </select>
                        </div>
                        <div contenteditable="true" id="regBlockContent_${idx}" style="min-height:24px;color:var(--text-primary);line-height:1.5;outline:none;" placeholder="Текст уведомления...">${data?.content || ''}</div>
                    </div>`;
                    break;
                }
                case 'image':
                    contentHtml = `<div style="border:1px solid var(--border-color);border-radius:8px;padding:12px;">
                        ${data?.url ? `<img src="${data.url}" style="max-width:100%;border-radius:8px;margin-bottom:8px;">` : ''}
                        <input type="text" id="regBlockContent_${idx}" placeholder="URL изображения" value="${data?.url || ''}" style="width:100%;margin-bottom:4px;" onchange="this.previousElementSibling?.tagName==='IMG'?this.previousElementSibling.src=this.value:null">
                        <input type="text" id="regBlockCaption_${idx}" placeholder="Подпись (необязательно)" value="${data?.caption || ''}" style="width:100%;font-size:12px;">
                    </div>`;
                    break;
                case 'video':
                    contentHtml = `<div style="border:1px solid var(--border-color);border-radius:8px;padding:12px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><i class="fas fa-video" style="color:var(--primary);"></i><strong>Видео</strong></div>
                        <input type="text" id="regBlockContent_${idx}" placeholder="YouTube / Vimeo URL" value="${data?.url || ''}" style="width:100%;">
                    </div>`;
                    break;
                case 'table': {
                    const rows = data?.rows || [['', ''], ['', '']];
                    let tableHtml = `<div style="border:1px solid var(--border-color);border-radius:8px;padding:12px;overflow-x:auto;">
                        <div style="display:flex;gap:4px;margin-bottom:8px;">
                            <button type="button" class="btn btn-sm btn-outline" onclick="regTableAddRow(${idx})"><i class="fas fa-plus"></i> Строка</button>
                            <button type="button" class="btn btn-sm btn-outline" onclick="regTableAddCol(${idx})"><i class="fas fa-plus"></i> Столбец</button>
                        </div>
                        <table id="regBlockTable_${idx}" style="width:100%;">`;
                    rows.forEach((row, ri) => {
                        tableHtml += '<tr>';
                        row.forEach((cell, ci) => {
                            tableHtml += `<td><input type="text" value="${escapeHtml(cell)}" style="width:100%;border:1px solid var(--border-color);border-radius:4px;padding:4px 8px;background:var(--bg-input);color:var(--text-primary);font-size:12px;" data-row="${ri}" data-col="${ci}"></td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</table></div>';
                    contentHtml = tableHtml;
                    break;
                }
                case 'file':
                    contentHtml = `<div style="border:1px solid var(--border-color);border-radius:8px;padding:12px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><i class="fas fa-paperclip" style="color:var(--primary);"></i><strong>Файл</strong></div>
                        <input type="text" id="regBlockContent_${idx}" placeholder="URL файла" value="${data?.url || ''}" style="width:100%;margin-bottom:4px;">
                        <input type="text" id="regBlockFileName_${idx}" placeholder="Название файла" value="${escapeHtml(data?.name || '')}" style="width:100%;font-size:12px;">
                    </div>`;
                    break;
                case 'code':
                    contentHtml = `<textarea id="regBlockContent_${idx}" rows="4" style="width:100%;font-family:monospace;font-size:13px;background:var(--bg-dark);color:var(--success);padding:12px;border:1px solid var(--border-color);border-radius:8px;resize:vertical;" placeholder="// Код...">${data?.content || ''}</textarea>`;
                    break;
                case 'divider':
                    contentHtml = `<hr style="border:none;border-top:2px solid var(--border-color);margin:16px 0;">`;
                    break;
            }

            blockEl.innerHTML = `${actionsHtml}<div class="reg-block-content">${contentHtml}</div>${insertBtn}`;

            if (typeof insertBeforeIdx === 'number') {
                const refEl = document.getElementById(`regBlock_${insertBeforeIdx}`);
                if (refEl) {
                    container.insertBefore(blockEl, refEl);
                    const refArrIdx = regEditorBlocks.findIndex(b => b.idx === insertBeforeIdx);
                    regEditorBlocks.splice(refArrIdx, 0, { idx, type });
                } else {
                    container.appendChild(blockEl);
                    regEditorBlocks.push({ idx, type });
                }
            } else {
                container.appendChild(blockEl);
                regEditorBlocks.push({ idx, type });
            }

            // Hide all block menus
            document.getElementById('regBlockMenu').style.display = 'none';
            document.querySelectorAll('.reg-inline-block-menu').forEach(m => m.remove());
        }

        function removeRegBlock(idx) {
            const el = document.getElementById(`regBlock_${idx}`);
            if (el) el.remove();
            regEditorBlocks = regEditorBlocks.filter(b => b.idx !== idx);
        }

        function regTableAddRow(blockIdx) {
            const table = document.getElementById(`regBlockTable_${blockIdx}`);
            if (!table) return;
            const cols = table.rows[0]?.cells.length || 2;
            const row = table.insertRow();
            const ri = table.rows.length - 1;
            for (let ci = 0; ci < cols; ci++) {
                const td = row.insertCell();
                td.innerHTML = `<input type="text" style="width:100%;border:1px solid var(--border-color);border-radius:4px;padding:4px 8px;background:var(--bg-input);color:var(--text-primary);font-size:12px;" data-row="${ri}" data-col="${ci}">`;
            }
        }

        function regTableAddCol(blockIdx) {
            const table = document.getElementById(`regBlockTable_${blockIdx}`);
            if (!table) return;
            for (let ri = 0; ri < table.rows.length; ri++) {
                const td = table.rows[ri].insertCell();
                td.innerHTML = `<input type="text" style="width:100%;border:1px solid var(--border-color);border-radius:4px;padding:4px 8px;background:var(--bg-input);color:var(--text-primary);font-size:12px;" data-row="${ri}" data-col="${table.rows[ri].cells.length - 1}">`;
            }
        }

        function addChecklistItem(blockIdx) {
            const container = document.getElementById(`regBlockItems_${blockIdx}`);
            if (!container) return;
            const itemEl = document.createElement('div');
            itemEl.className = 'reg-checklist-item';
            itemEl.innerHTML = `<input type="checkbox"><input type="text" placeholder="Пункт..."><button type="button" onclick="removeChecklistItem(${blockIdx}, this)" title="Удалить"><i class="fas fa-times"></i></button>`;
            container.appendChild(itemEl);
            itemEl.querySelector('input[type="text"]').focus();
        }

        function removeChecklistItem(blockIdx, btn) {
            const item = btn.closest('.reg-checklist-item');
            if (item) item.remove();
        }

        function moveRegBlock(idx, direction) {
            const arrIdx = regEditorBlocks.findIndex(b => b.idx === idx);
            if (arrIdx < 0) return;
            const newArrIdx = arrIdx + direction;
            if (newArrIdx < 0 || newArrIdx >= regEditorBlocks.length) return;
            const el = document.getElementById(`regBlock_${idx}`);
            const container = document.getElementById('regEditorBlocks');
            if (!el) return;
            if (direction === -1 && el.previousElementSibling) {
                container.insertBefore(el, el.previousElementSibling);
            } else if (direction === 1 && el.nextElementSibling) {
                container.insertBefore(el.nextElementSibling, el);
            }
            [regEditorBlocks[arrIdx], regEditorBlocks[newArrIdx]] = [regEditorBlocks[newArrIdx], regEditorBlocks[arrIdx]];
        }

        function regInsertBlockBefore(idx) {
            document.querySelectorAll('.reg-inline-block-menu').forEach(m => m.remove());
            const blockEl = document.getElementById(`regBlock_${idx}`);
            if (!blockEl) return;
            const menu = document.createElement('div');
            menu.className = 'reg-inline-block-menu';
            menu.style.cssText = 'position:relative;margin:8px 0 8px 36px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;padding:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;flex-wrap:wrap;gap:4px;';
            const types = [
                { t: 'text', i: 'paragraph', l: 'Текст' }, { t: 'heading', i: 'heading', l: 'Заголовок' },
                { t: 'task', i: 'check-square', l: 'Задача' }, { t: 'checklist', i: 'tasks', l: 'Чеклист' },
                { t: 'quote', i: 'quote-right', l: 'Цитата' }, { t: 'alert', i: 'exclamation-circle', l: 'Уведомление' },
                { t: 'image', i: 'image', l: 'Изображение' }, { t: 'video', i: 'video', l: 'Видео' },
                { t: 'table', i: 'table', l: 'Таблица' }, { t: 'file', i: 'paperclip', l: 'Файл' },
                { t: 'code', i: 'code', l: 'Код' }, { t: 'divider', i: 'minus', l: 'Разделитель' }
            ];
            types.forEach(({ t, i, l }) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm btn-outline';
                btn.innerHTML = `<i class="fas fa-${i}"></i> ${l}`;
                btn.onclick = () => { menu.remove(); addRegulationBlock(t, null, idx); };
                menu.appendChild(btn);
            });
            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.className = 'btn btn-sm';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.style.marginLeft = 'auto';
            closeBtn.onclick = () => menu.remove();
            menu.appendChild(closeBtn);
            blockEl.parentNode.insertBefore(menu, blockEl);
        }

        function updateAlertVariant(blockIdx, variant) {
            const colors = { info: '#3b82f6', warning: '#f59e0b', success: '#22c55e', danger: '#ef4444' };
            const icons = { info: 'info-circle', warning: 'exclamation-triangle', success: 'check-circle', danger: 'times-circle' };
            const alertEl = document.getElementById(`regBlockAlert_${blockIdx}`);
            if (!alertEl) return;
            const color = colors[variant] || colors.info;
            alertEl.style.borderColor = color + '33';
            alertEl.style.background = color + '11';
            alertEl.style.borderLeftColor = color;
            const iconEl = alertEl.querySelector('.fas');
            if (iconEl) { iconEl.className = `fas fa-${icons[variant] || icons.info}`; iconEl.style.color = color; }
        }

        function getRegEditorBlocksData() {
            const blocks = [];
            regEditorBlocks.forEach(({ idx, type }) => {
                const el = document.getElementById(`regBlock_${idx}`);
                if (!el) return;
                switch (type) {
                    case 'text':
                        blocks.push({ type: 'text', content: document.getElementById(`regBlockContent_${idx}`)?.innerHTML || '' });
                        break;
                    case 'heading':
                        blocks.push({ type: 'heading', level: parseInt(document.getElementById(`regBlockLevel_${idx}`)?.value || '2'), content: document.getElementById(`regBlockContent_${idx}`)?.value || '' });
                        break;
                    case 'task':
                        blocks.push({ type: 'task', content: document.getElementById(`regBlockContent_${idx}`)?.value || '', checked: document.getElementById(`regBlockCheck_${idx}`)?.checked || false, assignee: document.getElementById(`regBlockAssignee_${idx}`)?.value || '', deadline: document.getElementById(`regBlockDeadline_${idx}`)?.value || '' });
                        break;
                    case 'checklist': {
                        const itemsContainer = document.getElementById(`regBlockItems_${idx}`);
                        const items = [];
                        if (itemsContainer) {
                            itemsContainer.querySelectorAll('.reg-checklist-item').forEach(itemEl => {
                                items.push({ text: itemEl.querySelector('input[type="text"]')?.value || '', checked: itemEl.querySelector('input[type="checkbox"]')?.checked || false });
                            });
                        }
                        blocks.push({ type: 'checklist', items });
                        break;
                    }
                    case 'quote':
                        blocks.push({ type: 'quote', content: document.getElementById(`regBlockContent_${idx}`)?.innerHTML || '' });
                        break;
                    case 'alert':
                        blocks.push({ type: 'alert', variant: document.getElementById(`regBlockVariant_${idx}`)?.value || 'info', content: document.getElementById(`regBlockContent_${idx}`)?.innerHTML || '' });
                        break;
                    case 'image':
                        blocks.push({ type: 'image', url: document.getElementById(`regBlockContent_${idx}`)?.value || '', caption: document.getElementById(`regBlockCaption_${idx}`)?.value || '' });
                        break;
                    case 'video':
                        blocks.push({ type: 'video', url: document.getElementById(`regBlockContent_${idx}`)?.value || '' });
                        break;
                    case 'table': {
                        const table = document.getElementById(`regBlockTable_${idx}`);
                        if (!table) break;
                        const rows = [];
                        for (const row of table.rows) {
                            const cells = [];
                            for (const cell of row.cells) {
                                cells.push(cell.querySelector('input')?.value || '');
                            }
                            rows.push(cells);
                        }
                        blocks.push({ type: 'table', rows });
                        break;
                    }
                    case 'file':
                        blocks.push({ type: 'file', url: document.getElementById(`regBlockContent_${idx}`)?.value || '', name: document.getElementById(`regBlockFileName_${idx}`)?.value || '' });
                        break;
                    case 'code':
                        blocks.push({ type: 'code', content: document.getElementById(`regBlockContent_${idx}`)?.value || '' });
                        break;
                    case 'divider':
                        blocks.push({ type: 'divider' });
                        break;
                }
            });
            return blocks;
        }

        function getRegAccessData() {
            const accessAll = document.getElementById('regAccessAll').checked;
            const access = [];
            document.querySelectorAll('.reg-access-item').forEach(el => {
                const checkbox = el.querySelector('input[type="checkbox"]');
                if (checkbox?.checked) {
                    const level = el.querySelector('select')?.value || 'view';
                    access.push({ employee_id: checkbox.value, level });
                }
            });
            return { access_all: accessAll, access };
        }

        function renderRegAccessList(currentAccess) {
            const container = document.getElementById('regAccessList');
            const accessMap = {};
            (currentAccess || []).forEach(a => { accessMap[a.employee_id] = a.level; });

            const employeeList = (typeof employees !== 'undefined' && employees.length) ? employees : [
                { id: '1', name: 'Менеджер 1' },
                { id: '2', name: 'Менеджер 2' },
                { id: '3', name: 'Менеджер 3' }
            ];

            container.innerHTML = employeeList.map(emp => `
                <div class="reg-access-item" style="display:flex;align-items:center;gap:12px;padding:8px;border-bottom:1px solid var(--border-color);">
                    <input type="checkbox" value="${emp.id}" ${accessMap[emp.id] ? 'checked' : ''}>
                    <span style="flex:1;">${escapeHtml(emp.name || emp.first_name || 'Сотрудник ' + emp.id)}</span>
                    <select style="width:160px;padding:4px 8px;font-size:12px;">
                        <option value="view" ${accessMap[emp.id] === 'view' ? 'selected' : ''}>Просмотр</option>
                        <option value="edit" ${accessMap[emp.id] === 'edit' ? 'selected' : ''}>Редактирование</option>
                    </select>
                </div>
            `).join('');
        }

        function toggleRegAccessAll() {
            const all = document.getElementById('regAccessAll').checked;
            document.getElementById('regAccessList').style.opacity = all ? '0.5' : '1';
            document.getElementById('regAccessList').style.pointerEvents = all ? 'none' : '';
        }

        async function saveRegulationContent() {
            const name = document.getElementById('regEditorName').value;
            if (!name) return toast('Введите название регламента', 'error');

            const id = document.getElementById('regEditorId').value;
            const description = document.getElementById('regEditorDescription').value;
            const content = getRegEditorBlocksData();
            const { access_all, access } = getRegAccessData();

            showLoading();
            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/regulations/${projectId}/${id}` : `/regulations/${projectId}`;
                const res = await api(method, url, {
                    name, description, content: JSON.stringify(content),
                    access_all, access: JSON.stringify(access),
                    updated_at: new Date().toISOString()
                });

                if (res.success) {
                    closeModal('regulationEditorModal');
                    loadRegulations();
                    toast(id ? 'Регламент обновлён' : 'Регламент создан', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения', 'error');
                }
            } catch (err) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteRegulation(id) {
            if (!await confirm('Удалить регламент?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/regulations/${projectId}/${id}`);
                if (res.success) { loadRegulations(); toast('Регламент удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Goals (KPI)
        async function loadGoals() {
            const period = document.getElementById('goalsPeriod')?.value || 'month';
            const res = await api('GET', `/goals/${projectId}?period_type=${period}`);
            if (res.success) {
                renderGoals(res.goals || []);
            }
            // Load leaderboard
            const leaderRes = await api('GET', `/goals/${projectId}/leaderboard/revenue`);
            if (leaderRes.success) {
                renderLeaderboard(leaderRes.leaderboard || []);
            }
        }

        function renderGoals(goals) {
            const el = document.getElementById('goalsList');
            if (!goals.length) {
                el.innerHTML = '<div class="stat-card"><div class="empty-state" style="padding:20px;"><i class="fas fa-bullseye"></i><p>Нет целей на этот период</p></div></div>';
                return;
            }
            el.innerHTML = goals.map(g => {
                const percent = g.target_value > 0 ? Math.round((g.current_value / g.target_value) * 100) : 0;
                return `
                    <div class="stat-card">
                        <div class="value">${percent}%</div>
                        <div class="label">${escapeHtml(g.employee_first_name || 'Общая цель')}</div>
                        <div style="margin-top:10px; background:#334155; border-radius:4px; height:8px; overflow:hidden;">
                            <div style="width:${Math.min(percent, 100)}%; height:100%; background:${percent >= 100 ? 'var(--success)' : 'var(--primary)'}"></div>
                        </div>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">${formatMoney(g.current_value)} / ${formatMoney(g.target_value)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderLeaderboard(leaders) {
            const tbody = document.getElementById('leaderboardTable');
            if (!leaders.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state" style="padding:20px;"><p>Нет данных</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = leaders.map((l, i) => `
                <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td>${escapeHtml(l.first_name)} ${escapeHtml(l.last_name || '')}</td>
                    <td>${formatMoney(l.revenue || 0)}</td>
                    <td>${l.deals_won || 0}</td>
                    <td>${l.conversion || 0}%</td>
                    <td>
                        <div style="background:#334155; border-radius:4px; height:8px; width:100px;">
                            <div style="width:${l.progress || 0}%; height:100%; background:var(--primary);"></div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Lead Distribution
        async function loadLeadDistribution() {
            const res = await api('GET', `/lead-distribution/${projectId}/queue`);
            if (res.success) {
                renderLeadQueue(res.queue || []);
                document.getElementById('leadsInQueue').textContent = res.queue?.filter(q => q.status === 'pending').length || 0;
                document.getElementById('leadsAssigned').textContent = res.queue?.filter(q => q.status === 'assigned').length || 0;
                document.getElementById('leadsExpired').textContent = res.queue?.filter(q => q.status === 'expired').length || 0;
            }
        }

        function renderLeadQueue(queue) {
            const tbody = document.getElementById('leadQueueTable');
            if (!queue.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-random"></i><h3>Очередь пуста</h3></div></td></tr>';
                return;
            }
            const statuses = { pending: ['В очереди', 'badge-warning'], assigned: ['Назначен', 'badge-success'], expired: ['Просрочен', 'badge-danger'] };
            tbody.innerHTML = queue.map(q => `
                <tr>
                    <td>${escapeHtml(q.deal_name || q.deal_id)}</td>
                    <td>${q.source || '-'}</td>
                    <td>${q.assigned_to_name || '-'}</td>
                    <td>${q.expires_at ? new Date(q.expires_at).toLocaleString('ru') : '-'}</td>
                    <td><span class="badge ${statuses[q.status]?.[1] || ''}">${statuses[q.status]?.[0] || q.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="assignLead('${q.id}')"><i class="fas fa-user-plus"></i></button></td>
                </tr>
            `).join('');
        }

        async function assignLead(queueId) {
            try {
                const res = await api('POST', `/lead-distribution/${projectId}/distribute`);
                if (res.success) { loadLeadDistribution(); toast('Лид назначен', 'success'); }
                else toast(res.error || 'Ошибка назначения', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
        }

        // Tags
        async function loadTags() {
            const entityType = document.getElementById('tagsEntity')?.value || 'deal';
            const res = await api('GET', `/tags/${projectId}?entity_type=${entityType}`);
            if (res.success) {
                renderTags(res.tags || []);
            }
        }

        function renderTags(tags) {
            const el = document.getElementById('tagsList');
            if (!tags.length) {
                el.innerHTML = '<div class="stat-card"><div class="empty-state" style="padding:20px;"><i class="fas fa-tags"></i><p>Нет тегов</p></div></div>';
                return;
            }
            el.innerHTML = tags.map(t => `
                <div class="stat-card" style="cursor:pointer; border-left: 4px solid ${t.color || '#94a3b8'};">
                    <div class="value" style="font-size:18px;">${escapeHtml(t.name)}</div>
                    <div class="label">${t.usage_count || 0} использований</div>
                    <button class="btn btn-sm btn-outline" style="margin-top:10px;" onclick="deleteTag('${t.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function deleteTag(id) {
            if (!confirm('Удалить тег?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/tags/${projectId}/${id}`);
                if (res.success) { loadTags(); toast('Тег удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Employee Analytics
        async function loadEmployeeAnalytics() {
            const period = document.getElementById('analyticsPeriod')?.value || 'month';
            const res = await api('GET', `/employee-analytics/${projectId}/overview`);
            if (res.success && res.employees) {
                const emps = res.employees;
                const totalDealsWon = emps.reduce((s, e) => s + (e.deals_won || 0), 0);
                const totalRevenue = emps.reduce((s, e) => s + (e.revenue || 0), 0);
                const totalCalls = emps.reduce((s, e) => s + (e.calls_total || 0), 0);
                const totalDeals = emps.reduce((s, e) => s + (e.deals_created || 0), 0);
                const conversion = totalDeals > 0 ? Math.round((totalDealsWon / totalDeals) * 100) : 0;
                document.getElementById('analyticsDeals').textContent = totalDealsWon;
                document.getElementById('analyticsRevenue').textContent = formatMoney(totalRevenue);
                document.getElementById('analyticsCalls').textContent = totalCalls;
                document.getElementById('analyticsConversion').textContent = conversion + '%';
            }
            // Load employee list
            const empRes = await api('GET', `/employee-analytics/${projectId}/performance`);
            if (empRes.success) {
                renderEmployeeAnalytics(empRes.employees || []);
            }
        }

        function renderEmployeeAnalytics(emps) {
            const tbody = document.getElementById('employeeAnalyticsTable');
            if (!emps.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><p>Нет данных</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = emps.map(e => `
                <tr>
                    <td>${escapeHtml(e.first_name)} ${escapeHtml(e.last_name || '')}</td>
                    <td><span class="badge ${e.status === 'online' ? 'badge-success' : ''}">${e.status || 'offline'}</span></td>
                    <td>${e.deals_count || 0}</td>
                    <td>${e.calls_count || 0}</td>
                    <td>${e.conversion || 0}%</td>
                    <td>${e.last_activity ? new Date(e.last_activity).toLocaleString('ru') : '-'}</td>
                </tr>
            `).join('');
        }

        // ============================================================
        // InSales-like Features
        // ============================================================

        // Brands
        async function loadBrands() {
            const res = await api('GET', `/ecommerce/${projectId}/brands`);
            if (res.success) {
                renderBrands(res.brands || []);
            }
        }

        function renderBrands(brands) {
            const el = document.getElementById('brandsList');
            if (!brands.length) {
                el.innerHTML = '<div class="stat-card"><div class="empty-state" style="padding:20px;"><i class="fas fa-building"></i><p>Нет брендов</p></div></div>';
                return;
            }
            el.innerHTML = brands.map(b => `
                <div class="stat-card">
                    ${b.logo ? `<img src="${b.logo}" style="width:60px;height:60px;object-fit:contain;margin-bottom:10px;">` : '<i class="fas fa-building" style="font-size:40px;opacity:0.3;margin-bottom:10px;"></i>'}
                    <div class="value" style="font-size:16px;">${escapeHtml(b.name)}</div>
                    <div class="label">${b.products_count || 0} товаров</div>
                    <button class="btn btn-sm btn-outline" style="margin-top:10px;" onclick="deleteBrand('${b.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function deleteBrand(id) {
            if (!confirm('Удалить бренд?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/ecommerce/${projectId}/brands/${id}`);
                if (res.success) { loadBrands(); toast('Бренд удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Promo Codes
        async function loadPromoCodes() {
            const res = await api('GET', `/ecommerce/${projectId}/promo-codes`);
            if (res.success) {
                renderPromoCodes(res.promo_codes || []);
            }
        }

        function renderPromoCodes(codes) {
            const tbody = document.getElementById('promoCodesTable');
            if (!codes.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-percent"></i><h3>Нет промокодов</h3></div></td></tr>';
                return;
            }
            tbody.innerHTML = codes.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.code)}</strong></td>
                    <td>${c.type === 'percent' ? c.value + '%' : formatMoney(c.value)}</td>
                    <td>${c.uses_count || 0}</td>
                    <td>${c.max_uses || '∞'}</td>
                    <td>${c.start_date ? new Date(c.start_date).toLocaleDateString('ru') : '-'} - ${c.end_date ? new Date(c.end_date).toLocaleDateString('ru') : '∞'}</td>
                    <td><span class="badge ${c.is_active ? 'badge-success' : ''}">${c.is_active ? 'Активен' : 'Выключен'}</span></td>
                    <td><button class="btn btn-sm btn-outline" onclick="deletePromoCode('${c.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deletePromoCode(id) {
            if (!confirm('Удалить промокод?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/ecommerce/${projectId}/promo-codes/${id}`);
                if (res.success) { loadPromoCodes(); toast('Промокод удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Collections
        async function loadCollections() {
            const res = await api('GET', `/ecommerce/${projectId}/collections`);
            if (res.success) {
                renderCollections(res.collections || []);
            }
        }

        function renderCollections(collections) {
            const el = document.getElementById('collectionsList');
            if (!collections.length) {
                el.innerHTML = '<div class="stat-card"><div class="empty-state" style="padding:20px;"><i class="fas fa-th-large"></i><p>Нет коллекций</p></div></div>';
                return;
            }
            el.innerHTML = collections.map(c => `
                <div class="stat-card">
                    ${c.image ? `<img src="${c.image}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;margin-bottom:10px;">` : ''}
                    <div class="value" style="font-size:16px;">${escapeHtml(c.name)}</div>
                    <div class="label">${c.products_count || 0} товаров</div>
                    <button class="btn btn-sm btn-outline" style="margin-top:10px;" onclick="deleteCollection('${c.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function deleteCollection(id) {
            if (!confirm('Удалить коллекцию?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/ecommerce/${projectId}/collections/${id}`);
                if (res.success) { loadCollections(); toast('Коллекция удалена', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // ============================================================
        // YClients-like Features
        // ============================================================

        // Bookings
        async function loadBookings() {
            const date = document.getElementById('bookingsDate')?.value || new Date().toISOString().split('T')[0];
            const res = await api('GET', `/bookings/${projectId}?date=${date}`);
            if (res.success) {
                renderBookings(res.bookings || []);
                document.getElementById('bookingsToday').textContent = res.bookings?.length || 0;
                document.getElementById('bookingsConfirmed').textContent = res.bookings?.filter(b => b.status === 'confirmed').length || 0;
                document.getElementById('bookingsPending').textContent = res.bookings?.filter(b => b.status === 'pending').length || 0;
            }
        }

        function renderBookings(bookings) {
            const tbody = document.getElementById('bookingsTable');
            if (!bookings.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-calendar-check"></i><h3>Нет записей</h3></div></td></tr>';
                return;
            }
            tbody.innerHTML = bookings.map(b => `
                <tr>
                    <td>${b.booking_date} ${b.start_time}</td>
                    <td>${escapeHtml(b.client_name || '-')}</td>
                    <td>${escapeHtml(b.service_name || '-')}</td>
                    <td>${escapeHtml(b.employee_name || '-')}</td>
                    <td>${b.price ? formatMoney(b.price) : '-'}</td>
                    <td>${getBookingStatusBadge(b.status)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="confirmBooking('${b.id}')"><i class="fas fa-check"></i></button>
                        <button class="btn btn-sm btn-outline" onclick="cancelBooking('${b.id}')"><i class="fas fa-times"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function confirmBooking(id) {
            await api('PUT', `/bookings/${projectId}/${id}`, { status: 'confirmed' });
            loadBookings();
        }

        async function cancelBooking(id) {
            if (!confirm('Отменить запись?')) return;
            showLoading();
            try {
                const res = await api('PUT', `/bookings/${projectId}/${id}`, { status: 'cancelled' });
                if (res.success) { loadBookings(); toast('Запись отменена', 'success'); }
                else toast(res.error || 'Ошибка отмены', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Schedules
        async function loadSchedules() {
            const res = await api('GET', `/bookings/${projectId}/schedules`);
            if (res.success) {
                renderSchedules(res.schedules || []);
            }
        }

        function renderSchedules(schedules) {
            const tbody = document.getElementById('schedulesTable');
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            // Group by employee
            const byEmployee = {};
            schedules.forEach(s => {
                if (!byEmployee[s.employee_id]) byEmployee[s.employee_id] = { name: s.employee_name, days: {} };
                byEmployee[s.employee_id].days[s.day_of_week] = s;
            });

            if (!Object.keys(byEmployee).length) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-calendar-alt"></i><h3>Нет расписаний</h3></div></td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(byEmployee).map(([empId, emp]) => `
                <tr>
                    <td>${escapeHtml(emp.name || 'Сотрудник')}</td>
                    ${[1,2,3,4,5,6,7].map(d => {
                        const sched = emp.days[d];
                        return `<td style="font-size:12px;">${sched && sched.is_working ? sched.start_time + '-' + sched.end_time : '<span style="color:var(--text-muted)">-</span>'}</td>`;
                    }).join('')}
                    <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');
        }

        // ============================================================
        // GetCourse-like Features
        // ============================================================

        // Webinars
        let webinars = [];
        let currentWebinarData = null;

        async function loadWebinars() {
            const res = await api('GET', `/learning/${projectId}/webinars`);
            if (res.success) {
                webinars = res.webinars || [];
                renderWebinars(webinars);
                document.getElementById('webinarsUpcoming').textContent = webinars.filter(w => w.status === 'scheduled').length;
                document.getElementById('webinarsLive').textContent = webinars.filter(w => w.status === 'live').length;
                document.getElementById('webinarsCompleted').textContent = webinars.filter(w => w.status === 'completed').length;
                document.getElementById('webinarsParticipants').textContent = webinars.reduce((sum, w) => sum + (w.registrations_count || w.registrations || 0), 0);
            }
        }

        function renderWebinars(webinarsList) {
            const tbody = document.getElementById('webinarsTable');
            if (!tbody) return;
            if (!webinarsList.length) {
                tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-video"></i><h3>Нет вебинаров</h3><p>Создайте первый вебинар</p></div></td></tr>';
                return;
            }
            const statuses = {
                scheduled: ['Запланирован', 'badge-warning'],
                live: ['В эфире', 'badge-danger'],
                completed: ['Завершён', 'badge-success'],
                cancelled: ['Отменён', '']
            };
            tbody.innerHTML = webinarsList.map(w => `
                <tr onclick="openWebinarDetails('${w.id}')" style="cursor:pointer;">
                    <td><strong>${escapeHtml(w.title)}</strong></td>
                    <td><span class="badge">${w.type === 'auto' ? 'Авто' : 'Живой'}</span></td>
                    <td>${w.scheduled_at ? new Date(w.scheduled_at).toLocaleString('ru') : (w.start_time ? formatDate(w.start_time) : '-')}</td>
                    <td>${escapeHtml(w.host_name || '-')}</td>
                    <td>${w.registrations_count || w.registrations || 0}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="btn btn-sm btn-outline" onclick="copyWebinarLink('${w.id}')" title="Скопировать ссылку">
                            <i class="fas fa-link"></i>
                        </button>
                    </td>
                    <td><span class="badge ${statuses[w.status]?.[1] || ''}">${statuses[w.status]?.[0] || w.status}</span></td>
                    <td onclick="event.stopPropagation();">
                        ${w.status === 'scheduled' ? `<button class="btn btn-sm btn-primary" onclick="startWebinar('${w.id}')"><i class="fas fa-play"></i></button>` : ''}
                        ${w.status === 'live' ? `<button class="btn btn-sm btn-outline" style="color:#ef4444;" onclick="stopWebinar('${w.id}')"><i class="fas fa-stop"></i></button>` : ''}
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deleteWebinar('${w.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterWebinars() {
            const type = document.getElementById('filterWebinarType')?.value || '';
            const status = document.getElementById('filterWebinarStatus')?.value || '';

            let filtered = webinars;
            if (type) filtered = filtered.filter(w => w.type === type);
            if (status) filtered = filtered.filter(w => w.status === status);

            renderWebinars(filtered);
        }

        function filterWebinarsByStatus(status) {
            document.getElementById('filterWebinarStatus').value = status;
            filterWebinars();
        }

        async function openWebinarDetails(webinarId) {
            const webinar = webinars.find(w => w.id == webinarId);
            if (!webinar) return;

            currentWebinarData = webinar;

            // Create dynamic details modal
            const existing = document.getElementById('webinarDetailsModal');
            if (existing) existing.remove();

            const statusBadges = {
                scheduled: '<span class="badge badge-warning">Запланирован</span>',
                live: '<span class="badge badge-danger"><i class="fas fa-circle" style="font-size:8px;"></i> В эфире</span>',
                completed: '<span class="badge badge-success">Завершён</span>'
            };

            const modal = document.createElement('div');
            modal.className = 'modal-overlay open';
            modal.id = 'webinarDetailsModal';
            modal.innerHTML = `
                <div class="modal" style="max-width:700px;">
                    <div class="modal-header">
                        <h3>${escapeHtml(webinar.title)}</h3>
                        <button class="modal-close" onclick="document.getElementById('webinarDetailsModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                        <div style="display:flex;gap:10px;margin-bottom:20px;">
                            ${statusBadges[webinar.status] || ''}
                            <span class="badge">${webinar.type === 'auto' ? 'Автовебинар' : 'Живой вебинар'}</span>
                            ${webinar.platform ? `<span class="badge">${webinar.platform}</span>` : ''}
                        </div>

                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:20px;">
                            <div class="stat-card">
                                <div class="value">${webinar.registrations_count || webinar.registrations || 0}</div>
                                <div class="label">Регистраций</div>
                            </div>
                            <div class="stat-card primary">
                                <div class="value">${webinar.attendees_count || 0}</div>
                                <div class="label">Присутствовали</div>
                            </div>
                            <div class="stat-card success">
                                <div class="value">${webinar.duration_minutes || webinar.duration || 60} мин</div>
                                <div class="label">Длительность</div>
                            </div>
                        </div>

                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
                            <div>
                                <p style="color:var(--text-muted);font-size:12px;">Дата и время</p>
                                <p style="font-weight:500;">${webinar.scheduled_at ? new Date(webinar.scheduled_at).toLocaleString('ru') : '-'}</p>
                            </div>
                            <div>
                                <p style="color:var(--text-muted);font-size:12px;">Ведущий</p>
                                <p style="font-weight:500;">${escapeHtml(webinar.host_name || 'Не назначен')}</p>
                            </div>
                        </div>

                        ${webinar.description ? `
                        <div style="margin-bottom:20px;">
                            <p style="color:var(--text-muted);font-size:12px;">Описание</p>
                            <p>${escapeHtml(webinar.description)}</p>
                        </div>
                        ` : ''}

                        ${webinar.recording_url ? `
                        <div style="background:#1e293b;padding:12px;border-radius:8px;margin-bottom:20px;">
                            <p style="color:var(--text-muted);font-size:12px;margin-bottom:8px;"><i class="fas fa-film"></i> Запись вебинара</p>
                            <a href="${escapeHtml(webinar.recording_url)}" target="_blank" style="color:var(--primary);">${escapeHtml(webinar.recording_url)}</a>
                        </div>
                        ` : ''}

                        <div style="background:#1e293b;padding:12px;border-radius:8px;">
                            <p style="color:var(--text-muted);font-size:12px;margin-bottom:8px;"><i class="fas fa-link"></i> Ссылка для участников</p>
                            <div style="display:flex;gap:8px;">
                                <input type="text" value="${location.origin}/webinar/${webinar.id}" readonly style="flex:1;font-size:12px;">
                                <button class="btn btn-sm btn-primary" onclick="copyWebinarLink('${webinar.id}')"><i class="fas fa-copy"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline btn-danger" onclick="deleteWebinar('${webinar.id}');document.getElementById('webinarDetailsModal').remove();"><i class="fas fa-trash"></i> Удалить</button>
                        ${webinar.status === 'scheduled' ? `<button class="btn btn-primary" onclick="startWebinar('${webinar.id}');document.getElementById('webinarDetailsModal').remove();"><i class="fas fa-play"></i> Запустить</button>` : ''}
                        ${webinar.status === 'live' ? `<button class="btn" style="background:#ef4444;" onclick="stopWebinar('${webinar.id}');document.getElementById('webinarDetailsModal').remove();"><i class="fas fa-stop"></i> Остановить</button>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function startWebinar(id) {
            showLoading();
            try {
                const res = await api('PUT', `/learning/${projectId}/webinars/${id}/status`, { status: 'live' });
                if (res.success) {
                    loadWebinars();
                    toast('Вебинар запущен!', 'success');
                }
            } finally {
                hideLoading();
            }
        }

        async function stopWebinar(id) {
            if (!await confirm('Завершить вебинар?', 'Завершение')) return;
            showLoading();
            try {
                const res = await api('PUT', `/learning/${projectId}/webinars/${id}/status`, { status: 'completed' });
                if (res.success) {
                    loadWebinars();
                    toast('Вебинар завершён', 'info');
                }
            } finally {
                hideLoading();
            }
        }

        async function deleteWebinar(id) {
            if (!await confirm('Удалить вебинар?', 'Удаление')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/learning/${projectId}/webinars/${id}`);
                if (res.success) { loadWebinars(); toast('Вебинар удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Quizzes
        async function loadQuizzes() {
            const res = await api('GET', `/learning/${projectId}/quizzes`);
            if (res.success) {
                renderQuizzes(res.quizzes || []);
            }
        }

        function renderQuizzes(quizzes) {
            const tbody = document.getElementById('quizzesTable');
            if (!quizzes.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-question-circle"></i><h3>Нет тестов</h3></div></td></tr>';
                return;
            }
            tbody.innerHTML = quizzes.map(q => `
                <tr>
                    <td><strong>${escapeHtml(q.title)}</strong></td>
                    <td>${escapeHtml(q.course_name || '-')}</td>
                    <td>${q.questions_count || 0}</td>
                    <td>${q.attempts_count || 0}</td>
                    <td>${q.avg_score || 0}%</td>
                    <td><button class="btn btn-sm btn-outline" onclick="deleteQuiz('${q.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deleteQuiz(id) {
            if (!confirm('Удалить тест?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/learning/${projectId}/quizzes/${id}`);
                if (res.success) { loadQuizzes(); toast('Тест удалён', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // Certificates
        let certificates = [];
        let certTemplates = [];

        async function loadCertificates() {
            const res = await api('GET', `/learning/${projectId}/certificates`);
            if (res.success) {
                certificates = res.certificates || [];
                renderCertificates(certificates);
                document.getElementById('certificatesIssued').textContent = certificates.length;

                // Load templates from localStorage
                certTemplates = JSON.parse(localStorage.getItem(`cert_templates_${projectId}`) || '[]');
                updateCertTemplateSelects();
            }
        }

        function renderCertificates(certs) {
            const tbody = document.getElementById('certificatesTable');
            if (!tbody) return;
            if (!certs.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-certificate"></i><h3>Нет сертификатов</h3><p>Выдайте первый сертификат</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = certs.map(c => `
                <tr>
                    <td>
                        <strong>${escapeHtml(c.certificate_number || c.number || c.id?.slice(0,8) || '-')}</strong>
                    </td>
                    <td>${escapeHtml(c.client_name || c.student_name || '-')}</td>
                    <td>${escapeHtml(c.course_name || '-')}</td>
                    <td>${escapeHtml(c.template_name || 'По умолчанию')}</td>
                    <td>${c.issued_at ? formatDate(c.issued_at) : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="downloadCertificate('${c.id}')" title="Скачать PDF"><i class="fas fa-download"></i></button>
                        <button class="btn btn-sm btn-outline" onclick="verifyCertificate('${c.certificate_number || c.number || c.id}')" title="Проверить"><i class="fas fa-check-circle"></i></button>
                        <button class="btn btn-sm btn-outline" onclick="shareCertificate('${c.id}')" title="Поделиться"><i class="fas fa-share-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function updateCertTemplateSelects() {
            const options = certTemplates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
            const el = document.getElementById('certTemplate');
            if (el) el.innerHTML = '<option value="">По умолчанию</option>' + options;
        }

        function downloadCertificate(certId) {
            toast('Генерация PDF...', 'info');
            // Simulate PDF generation
            setTimeout(() => {
                toast('PDF сертификата загружен', 'success');
            }, 1500);
        }

        function verifyCertificate(certNumber) {
            const cert = certificates.find(c =>
                (c.certificate_number || c.number || c.id) === certNumber
            );

            if (cert) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay open';
                modal.id = 'certVerifyModal';
                modal.innerHTML = `
                    <div class="modal" style="max-width:450px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-check-circle" style="color:var(--success);"></i> Сертификат подтверждён</h3>
                            <button class="modal-close" onclick="document.getElementById('certVerifyModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body" style="text-align:center;">
                            <div style="width:80px;height:80px;background:rgba(16,185,129,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
                                <i class="fas fa-certificate" style="font-size:36px;color:var(--success);"></i>
                            </div>
                            <h4>Сертификат #${escapeHtml(certNumber)}</h4>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;text-align:left;margin-top:20px;">
                                <div>
                                    <p style="color:var(--text-muted);font-size:12px;">Владелец</p>
                                    <p style="font-weight:500;">${escapeHtml(cert.client_name || cert.student_name || '-')}</p>
                                </div>
                                <div>
                                    <p style="color:var(--text-muted);font-size:12px;">Курс</p>
                                    <p style="font-weight:500;">${escapeHtml(cert.course_name || '-')}</p>
                                </div>
                                <div>
                                    <p style="color:var(--text-muted);font-size:12px;">Дата выдачи</p>
                                    <p style="font-weight:500;">${cert.issued_at ? formatDate(cert.issued_at) : '-'}</p>
                                </div>
                                <div>
                                    <p style="color:var(--text-muted);font-size:12px;">Статус</p>
                                    <p><span class="badge badge-success">Действителен</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="document.getElementById('certVerifyModal').remove()">Закрыть</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                toast('Сертификат не найден', 'error');
            }
        }

        function shareCertificate(certId) {
            const url = `${location.origin}/certificate/verify/${certId}`;
            navigator.clipboard.writeText(url);
            toast('Ссылка для проверки скопирована', 'success');
        }

        function generateCertNumber() {
            const prefix = 'CERT';
            const year = new Date().getFullYear();
            const num = String(certificates.length + 1).padStart(4, '0');
            document.getElementById('certNumber').value = `${prefix}-${year}-${num}`;
        }

        function updateCertPreview() {
            const bg = document.getElementById('certTemplateBg').value;
            const text = document.getElementById('certTemplateText').value;
            const border = document.getElementById('certTemplateBorder').value;
            const canvas = document.getElementById('certPreviewCanvas');

            if (!canvas) return;

            canvas.style.background = bg;
            canvas.querySelectorAll('.cert-draggable').forEach(el => el.style.color = text);

            // Update border style
            const borderStyles = {
                classic: `8px double ${text}50`,
                modern: `2px solid ${text}30`,
                minimal: 'none',
                gold: '6px double #d4af37'
            };
            canvas.style.border = borderStyles[border] || 'none';
        }

        // ============================================================
        // Integrations
        // ============================================================

        // Provider settings
        const providerConfigs = {
            delivery: {
                pochta: { name: 'Почта России', fields: [
                    { key: 'api_key', label: 'API ключ', type: 'password' },
                    { key: 'tracking_url', label: 'URL отслеживания', type: 'text', placeholder: 'https://www.pochta.ru/tracking#' }
                ]},
                cdek: { name: 'СДЭК', fields: [
                    { key: 'account', label: 'Account (идентификатор)', type: 'text' },
                    { key: 'password', label: 'Secure password', type: 'password' },
                    { key: 'test_mode', label: 'Тестовый режим', type: 'toggle' }
                ]},
                boxberry: { name: 'Boxberry', fields: [
                    { key: 'api_token', label: 'API токен', type: 'password' },
                    { key: 'partner_id', label: 'ID партнёра', type: 'text' }
                ]},
                dpd: { name: 'DPD', fields: [
                    { key: 'client_number', label: 'Номер клиента', type: 'text' },
                    { key: 'client_key', label: 'Ключ клиента', type: 'password' }
                ]}
            },
            payment: {
                yoomoney: { name: 'ЮMoney', fields: [
                    { key: 'wallet_id', label: 'ID кошелька', type: 'text' },
                    { key: 'secret_key', label: 'Секретный ключ', type: 'password' }
                ]},
                yokassa: { name: 'ЮKassa', fields: [
                    { key: 'shop_id', label: 'ID магазина', type: 'text' },
                    { key: 'secret_key', label: 'Секретный ключ', type: 'password' }
                ]},
                tinkoff: { name: 'Тинькофф', fields: [
                    { key: 'terminal_key', label: 'Terminal Key', type: 'text' },
                    { key: 'password', label: 'Пароль', type: 'password' }
                ]},
                robokassa: { name: 'Робокасса', fields: [
                    { key: 'login', label: 'Логин', type: 'text' },
                    { key: 'password1', label: 'Пароль #1', type: 'password' },
                    { key: 'password2', label: 'Пароль #2', type: 'password' }
                ]},
                prodamus: { name: 'Продамус', fields: [
                    { key: 'api_key', label: 'API ключ', type: 'password' },
                    { key: 'shop_id', label: 'ID магазина', type: 'text' }
                ]}
            }
        };

        let currentProviderType = '';
        let currentProviderId = '';

        function openProviderSettings(type, provider) {
            currentProviderType = type;
            currentProviderId = provider;
            const config = providerConfigs[type]?.[provider];
            if (!config) return;

            document.getElementById('providerSettingsTitle').textContent = config.name + ' — Настройки';
            const storageKey = `${type}_settings`;
            const saved = JSON.parse(localStorage.getItem(storageKey) || '{}')[provider] || {};

            let html = '';
            config.fields.forEach(f => {
                const val = saved[f.key] || '';
                if (f.type === 'toggle') {
                    html += `<div class="form-group"><label style="display:flex;align-items:center;gap:8px;font-weight:normal;"><input type="checkbox" id="prov_${f.key}" ${val ? 'checked' : ''}> ${f.label}</label></div>`;
                } else {
                    html += `<div class="form-group"><label>${f.label}</label><input type="${f.type === 'password' ? 'password' : 'text'}" id="prov_${f.key}" value="${escapeHtml(val)}" placeholder="${f.placeholder || ''}"></div>`;
                }
            });

            html += `<div style="padding:8px 12px;border-radius:8px;background:${saved._connected ? 'rgba(16,185,129,0.1)' : 'rgba(100,116,139,0.1)'};display:flex;align-items:center;gap:8px;margin-top:8px;">
                <i class="fas fa-circle" style="font-size:8px;color:${saved._connected ? 'var(--success)' : 'var(--text-muted)'};"></i>
                <span style="font-size:13px;">${saved._connected ? 'Подключено' : 'Не подключено'}</span>
            </div>`;

            document.getElementById('providerSettingsBody').innerHTML = html;
            openModal('providerSettingsModal');
        }

        function saveProviderSettings() {
            const config = providerConfigs[currentProviderType]?.[currentProviderId];
            if (!config) return;

            const storageKey = `${currentProviderType}_settings`;
            const allSettings = JSON.parse(localStorage.getItem(storageKey) || '{}');
            const data = {};

            config.fields.forEach(f => {
                const el = document.getElementById(`prov_${f.key}`);
                data[f.key] = f.type === 'toggle' ? el.checked : el.value;
            });
            data._connected = true;
            allSettings[currentProviderId] = data;
            localStorage.setItem(storageKey, JSON.stringify(allSettings));

            const statusEl = document.getElementById(`${currentProviderType}Status_${currentProviderId}`);
            if (statusEl) {
                statusEl.textContent = 'Подключено';
                statusEl.style.color = 'var(--success)';
            }

            closeModal('providerSettingsModal');
            toast(`${config.name} — настройки сохранены`, 'success');
        }

        function testProviderConnection() {
            const config = providerConfigs[currentProviderType]?.[currentProviderId];
            if (!config) return;
            toast(`Проверка подключения к ${config.name}...`, 'info');
            setTimeout(() => {
                toast(`${config.name} — соединение успешно`, 'success');
            }, 1500);
        }

        function initProviderStatuses() {
            ['delivery', 'payment'].forEach(type => {
                const saved = JSON.parse(localStorage.getItem(`${type}_settings`) || '{}');
                for (const [provider, data] of Object.entries(saved)) {
                    if (data._connected) {
                        const el = document.getElementById(`${type}Status_${provider}`);
                        if (el) {
                            el.textContent = 'Подключено';
                            el.style.color = 'var(--success)';
                        }
                    }
                }
            });
        }

        async function loadIntegrations() {
            const res = await api('GET', `/integrations/${projectId}`);
            if (res.success) {
                renderIntegrations(res.integrations || []);
                document.getElementById('integrationsActive').textContent = res.integrations?.filter(i => i.is_active).length || 0;
                document.getElementById('integrationsWebhooks').textContent = res.integrations?.filter(i => i.type === 'webhook').length || 0;
                document.getElementById('integrationsForms').textContent = res.integrations?.filter(i => i.type === 'web_form').length || 0;
            }
        }

        function renderIntegrations(integrations) {
            const tbody = document.getElementById('integrationsTable');
            if (!integrations.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-plug"></i><h3>Нет интеграций</h3></div></td></tr>';
                return;
            }
            const types = { webhook: 'Вебхук', web_form: 'Веб-форма', widget: 'Виджет', telegram: 'Telegram', email: 'Email' };
            tbody.innerHTML = integrations.map(i => `
                <tr>
                    <td><strong>${escapeHtml(i.name)}</strong></td>
                    <td>${types[i.type] || i.type}</td>
                    <td>${i.stats_leads || 0}</td>
                    <td>${i.last_request_at ? new Date(i.last_request_at).toLocaleString('ru') : '-'}</td>
                    <td><span class="badge ${i.is_active ? 'badge-success' : ''}">${i.is_active ? 'Активна' : 'Выключена'}</span></td>
                    <td><button class="btn btn-sm btn-outline" onclick="deleteIntegration('${i.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deleteIntegration(id) {
            if (!confirm('Удалить интеграцию?')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/integrations/${projectId}/${id}`);
                if (res.success) { loadIntegrations(); toast('Интеграция удалена', 'success'); }
                else toast(res.error || 'Ошибка удаления', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        // ============================================================
        // Save Functions for All Modals
        // ============================================================

        // Save Regulation (SLA)
        // saveRegulation is now saveRegulationContent (in regulation editor section)

        // Save Goal (KPI)
        async function saveGoal() {
            const employee_id = document.getElementById('goalEmployee').value;
            const metric_type = document.getElementById('goalMetric').value;
            const target_value = document.getElementById('goalTarget').value;
            const period_type = document.getElementById('goalPeriodType').value;
            const period_start = document.getElementById('goalStart').value;
            const period_end = document.getElementById('goalEnd').value;

            if (!target_value) return toast('Введите целевое значение', 'error');

            // Default dates for period
            let start = period_start, end = period_end;
            if (!start || !end) {
                const now = new Date();
                if (period_type === 'month') {
                    start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                } else if (period_type === 'quarter') {
                    const q = Math.floor(now.getMonth() / 3);
                    start = new Date(now.getFullYear(), q * 3, 1).toISOString().split('T')[0];
                    end = new Date(now.getFullYear(), q * 3 + 3, 0).toISOString().split('T')[0];
                } else {
                    start = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                    end = new Date(now.getFullYear(), 11, 31).toISOString().split('T')[0];
                }
            }

            showLoading();
            try {
                const res = await api('POST', `/goals/${projectId}`, {
                    employee_id: employee_id || null, metric_type,
                    target_value: parseFloat(target_value), period_type, period_start: start, period_end: end
                });
                if (res.success) {
                    closeModal('goalModal');
                    document.getElementById('goalTarget').value = '';
                    loadGoals();
                    toast('Цель создана', 'success');
                } else {
                    toast(res.error || 'Ошибка создания цели', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Save Distribution Settings
        async function saveDistributionSettings() {
            const funnel_id = document.getElementById('distFunnel').value;
            const distribution_type = document.getElementById('distType').value;
            const response_timeout_minutes = document.getElementById('distTimeout').value;
            const max_leads_per_employee = document.getElementById('distMaxLeads').value;
            const auto_reassign = document.getElementById('distAutoReassign').checked ? 1 : 0;
            const working_hours_only = document.getElementById('distWorkingHours').checked ? 1 : 0;

            showLoading();
            try {
                const res = await api('POST', `/lead-distribution/${projectId}/settings`, {
                    funnel_id: funnel_id || null, distribution_type,
                    response_timeout_minutes: parseInt(response_timeout_minutes) || 30,
                    max_leads_per_employee: max_leads_per_employee ? parseInt(max_leads_per_employee) : null,
                    auto_reassign, working_hours_only
                });
                if (res.success) {
                    closeModal('distributionModal');
                    loadLeadDistribution();
                    toast('Настройки сохранены', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Save Tag
        async function saveTag() {
            const name = document.getElementById('tagName').value;
            const color = document.getElementById('tagColor').value;
            const entity_type = document.getElementById('tagEntityType').value;

            if (!name) return toast('Введите название тега', 'error');

            showLoading();
            try {
                const res = await api('POST', `/tags/${projectId}`, { name, color, entity_type });
                if (res.success) {
                    closeModal('tagModal');
                    document.getElementById('tagName').value = '';
                    loadTags();
                    toast('Тег создан', 'success');
                } else {
                    toast(res.error || 'Ошибка создания тега', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Save Brand
        async function saveBrand() {
            const name = document.getElementById('brandName').value;
            const logo = document.getElementById('brandLogo').value;
            const website = document.getElementById('brandWebsite').value;
            const description = document.getElementById('brandDescription').value;

            if (!name) return toast('Введите название бренда', 'error');

            showLoading();
            try {
                const res = await api('POST', `/ecommerce/${projectId}/brands`, { name, logo, website, description });
                if (res.success) {
                    closeModal('brandModal');
                    ['brandName', 'brandLogo', 'brandWebsite', 'brandDescription'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    loadBrands();
                    toast('Бренд создан', 'success');
                } else {
                    toast(res.error || 'Ошибка создания бренда', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Save Promo Code
        async function savePromoCode() {
            const code = document.getElementById('promoCode').value.toUpperCase();
            const type = document.getElementById('promoType').value;
            const value = document.getElementById('promoValue').value;
            const min_order_amount = document.getElementById('promoMinOrder').value;
            const max_uses = document.getElementById('promoMaxUses').value;
            const start_date = document.getElementById('promoStart').value;
            const end_date = document.getElementById('promoEnd').value;

            if (!code || !value) return toast('Введите код и значение скидки', 'error');

            showLoading();
            try {
                const res = await api('POST', `/ecommerce/${projectId}/promo-codes`, {
                    code, type, value: parseFloat(value),
                    min_order_amount: parseFloat(min_order_amount) || 0,
                    max_uses: max_uses ? parseInt(max_uses) : null,
                    applies_to: document.getElementById('promoAppliesTo').value || 'all',
                    start_date: start_date || null, end_date: end_date || null
                });
                if (res.success) {
                    closeModal('promoModal');
                    ['promoCode', 'promoValue', 'promoMinOrder', 'promoMaxUses', 'promoStart', 'promoEnd'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    loadPromoCodes();
                    toast('Промокод создан', 'success');
                } else {
                    toast(res.error || 'Ошибка создания промокода', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Save Collection
        async function saveCollection() {
            const name = document.getElementById('collectionName').value;
            const image = document.getElementById('collectionImage').value;
            const type = document.getElementById('collectionType').value;
            const description = document.getElementById('collectionDescription').value;

            if (!name) return toast('Введите название коллекции', 'error');

            showLoading();
            try {
                const res = await api('POST', `/ecommerce/${projectId}/collections`, { name, image, type, description });
                if (res.success) {
                    closeModal('collectionModal');
                    ['collectionName', 'collectionImage', 'collectionDescription'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    loadCollections();
                    toast('Коллекция создана', 'success');
                } else {
                    toast(res.error || 'Ошибка создания коллекции', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Booking Status Badge Helper
        function getBookingStatusBadge(status) {
            const map = {
                confirmed: ['Подтверждено', 'badge-success'],
                pending: ['Ожидает', 'badge-warning'],
                completed: ['Завершено', 'badge-info'],
                cancelled: ['Отменено', 'badge-danger'],
                'no-show': ['Не пришёл', 'badge-muted']
            };
            const [label, cls] = map[status] || [status || 'Неизвестно', ''];
            return `<span class="badge ${cls}">${label}</span>`;
        }

        // Booking Conflict Detection
        async function checkBookingConflict(employee_id, booking_date, start_time, duration, editId) {
            if (!employee_id || !booking_date || !start_time) return false;
            try {
                const res = await api('GET', `/bookings/${projectId}?from=${booking_date}&to=${booking_date}`);
                if (!res.success) return false;
                const bookings = (res.bookings || []).filter(b =>
                    b.employee_id == employee_id && b.status !== 'cancelled' && (!editId || b.id != editId)
                );
                const newStart = parseInt(start_time.split(':')[0]) * 60 + parseInt(start_time.split(':')[1] || 0);
                const newEnd = newStart + (parseInt(duration) || 60);
                return bookings.some(b => {
                    const bStart = parseInt(b.start_time?.split(':')[0] || 0) * 60 + parseInt(b.start_time?.split(':')[1] || 0);
                    const bEnd = bStart + (parseInt(b.duration) || 60);
                    return newStart < bEnd && newEnd > bStart;
                });
            } catch (e) { return false; }
        }

        // Save Booking
        let currentBookingData = null;

        async function saveBooking() {
            const editId = document.getElementById('bookingEditId')?.value;
            const service_id = document.getElementById('bookingService').value;
            const employee_id = document.getElementById('bookingEmployee').value;
            const client_id = document.getElementById('bookingClient').value;
            const booking_date = document.getElementById('bookingDate').value;
            const start_time = document.getElementById('bookingTime').value;
            const duration = document.getElementById('bookingDuration').value;
            const client_name = document.getElementById('bookingClientName').value;
            const client_phone = document.getElementById('bookingClientPhone').value;
            const comment = document.getElementById('bookingComment').value;
            const send_reminder = document.getElementById('bookingSendReminder').checked;
            const reminder_time = document.getElementById('bookingReminderTime').value;

            if (!service_id || !booking_date || !start_time) {
                return toast('Выберите услугу, дату и время', 'error');
            }

            const hasConflict = await checkBookingConflict(employee_id, booking_date, start_time, duration, editId);
            if (hasConflict) {
                toast('Внимание: у специалиста уже есть запись в это время!', 'warning');
            }

            showLoading();
            try {
                const method = editId ? 'PUT' : 'POST';
                const url = editId ? `/bookings/${projectId}/${editId}` : `/bookings/${projectId}`;

                const res = await api(method, url, {
                    service_id, employee_id: employee_id || null, client_id: client_id || null,
                    booking_date, start_time, duration: parseInt(duration),
                    client_name, client_phone, comment,
                    send_reminder, reminder_time
                });

                if (res.success) {
                    closeModal('bookingModal');
                    resetBookingForm();
                    loadBookingsCalendar();
                    toast(editId ? 'Запись обновлена' : 'Запись создана', 'success');
                } else {
                    toast(res.error || 'Ошибка создания записи', 'error');
                }
            } finally {
                hideLoading();
            }
        }

        function resetBookingForm() {
            document.getElementById('bookingEditId').value = '';
            document.getElementById('bookingModalTitle').textContent = 'Новая запись';
            document.getElementById('bookingSaveBtn').textContent = 'Записать';
            ['bookingDate', 'bookingTime', 'bookingClientName', 'bookingClientPhone', 'bookingComment'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('bookingService').value = '';
            document.getElementById('bookingEmployee').value = '';
            document.getElementById('bookingClient').value = '';
            document.getElementById('bookingDuration').value = '60';
            document.getElementById('bookingSendReminder').checked = true;
        }

        function fillClientInfo() {
            const clientId = document.getElementById('bookingClient').value;
            if (!clientId) return;

            const client = clients.find(c => c.id == clientId);
            if (client) {
                document.getElementById('bookingClientName').value = `${client.first_name || ''} ${client.last_name || ''}`.trim();
                document.getElementById('bookingClientPhone').value = client.phone || '';
            }
        }

        function updateBookingDuration() {
            const serviceId = document.getElementById('bookingService').value;
            if (!serviceId) return;

            const service = services.find(s => s.id == serviceId);
            if (service && service.duration) {
                document.getElementById('bookingDuration').value = service.duration;
            }
        }

        async function openBookingDetails(bookingId) {
            showLoading();
            try {
                const res = await api('GET', `/bookings/${projectId}/${bookingId}`);
                if (res.success && res.booking) {
                    currentBookingData = res.booking;
                    const b = res.booking;

                    document.getElementById('detailsClientName').textContent = b.client_name || '—';
                    document.getElementById('detailsClientPhone').textContent = b.client_phone || '—';
                    document.getElementById('detailsService').textContent = b.service_name || '—';
                    document.getElementById('detailsEmployee').textContent = b.employee_name || 'Не назначен';
                    document.getElementById('detailsDateTime').textContent = `${b.booking_date} в ${b.start_time}`;
                    document.getElementById('detailsPrice').textContent = b.price ? formatMoney(b.price) : '—';
                    document.getElementById('detailsComment').textContent = b.comment || 'Нет комментария';

                    document.getElementById('detailsStatus').innerHTML = getBookingStatusBadge(b.status);

                    openModal('bookingDetailsModal');
                }
            } finally {
                hideLoading();
            }
        }

        async function confirmCurrentBooking() {
            if (!currentBookingData) return;
            await api('PUT', `/bookings/${projectId}/${currentBookingData.id}`, { status: 'confirmed' });
            closeModal('bookingDetailsModal');
            loadBookingsCalendar();
            toast('Запись подтверждена', 'success');
        }

        async function cancelCurrentBooking() {
            if (!currentBookingData) return;
            if (!await confirm('Отменить эту запись?', 'Отмена записи')) return;
            showLoading();
            try {
                const res = await api('PUT', `/bookings/${projectId}/${currentBookingData.id}`, { status: 'cancelled' });
                if (res.success) {
                    closeModal('bookingDetailsModal');
                    loadBookingsCalendar();
                    toast('Запись отменена', 'success');
                } else toast(res.error || 'Ошибка отмены', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        async function completeCurrentBooking() {
            if (!currentBookingData) return;
            showLoading();
            try {
                const res = await api('PUT', `/bookings/${projectId}/${currentBookingData.id}`, { status: 'completed' });
                if (res.success) {
                    closeModal('bookingDetailsModal');
                    loadBookingsCalendar();
                    toast('Запись завершена', 'success');
                } else toast(res.error || 'Ошибка', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        async function editCurrentBooking() {
            if (!currentBookingData) return;
            closeModal('bookingDetailsModal');
            await loadServicesForBooking();

            const b = currentBookingData;
            document.getElementById('bookingEditId').value = b.id;
            document.getElementById('bookingModalTitle').textContent = 'Редактировать запись';
            document.getElementById('bookingSaveBtn').textContent = 'Сохранить';
            document.getElementById('bookingService').value = b.service_id || '';
            document.getElementById('bookingEmployee').value = b.employee_id || '';
            document.getElementById('bookingClient').value = b.client_id || '';
            document.getElementById('bookingDate').value = b.booking_date || '';
            document.getElementById('bookingTime').value = b.start_time || '';
            document.getElementById('bookingDuration').value = b.duration || '60';
            document.getElementById('bookingClientName').value = b.client_name || '';
            document.getElementById('bookingClientPhone').value = b.client_phone || '';
            document.getElementById('bookingComment').value = b.comment || '';

            openModal('bookingModal');
        }

        async function sendBookingReminder() {
            if (!currentBookingData) return;

            showLoading();
            try {
                const res = await api('POST', `/bookings/${projectId}/${currentBookingData.id}/reminder`);
                if (res.success) {
                    toast('Напоминание отправлено', 'success');
                } else {
                    toast(res.error || 'Не удалось отправить напоминание', 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // Save Schedule
        async function saveSchedule() {
            const employee_id = document.getElementById('scheduleEmployee').value;
            if (!employee_id) return toast('Выберите сотрудника', 'error');

            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const schedules = [];

            days.forEach((day, index) => {
                const is_working = document.getElementById('sched' + day).checked ? 1 : 0;
                const start_time = document.getElementById('sched' + day + 'Start').value;
                const end_time = document.getElementById('sched' + day + 'End').value;
                schedules.push({ day_of_week: index + 1, is_working, start_time, end_time });
            });

            showLoading();
            try {
                const res = await api('POST', `/bookings/${projectId}/schedules/${employee_id}`, {
                    schedules
                });
                if (res.success) {
                    closeModal('scheduleModal');
                    loadSchedules();
                    toast('Расписание сохранено', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения расписания', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Save Webinar
        async function saveWebinar() {
            const title = document.getElementById('webinarTitle').value;
            const course_id = document.getElementById('webinarCourse').value;
            const host_id = document.getElementById('webinarHost').value;
            const scheduled_at = document.getElementById('webinarDate').value;
            const duration_minutes = document.getElementById('webinarDuration').value;
            const platform = document.getElementById('webinarPlatform').value;
            const description = document.getElementById('webinarDescription').value;

            if (!title || !scheduled_at) return toast('Введите название и дату', 'error');

            showLoading();
            try {
                const res = await api('POST', `/learning/${projectId}/webinars`, {
                    title, course_id: course_id || null, host_id: host_id || null,
                    scheduled_at, duration_minutes: parseInt(duration_minutes) || 60, platform, description,
                    type: 'live'
                });

                if (res.success) {
                    closeModal('webinarModal');
                    ['webinarTitle', 'webinarDate', 'webinarDescription'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    loadWebinars();
                    toast('Вебинар создан', 'success');
                } else {
                    toast(res.error || 'Ошибка создания вебинара', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Save Quiz
        async function saveQuiz() {
            const title = document.getElementById('quizTitle').value;
            const course_id = document.getElementById('quizCourse').value;
            const passing_score = document.getElementById('quizPassingScore').value;
            const time_limit_minutes = document.getElementById('quizTimeLimit').value;
            const attempts_allowed = document.getElementById('quizAttempts').value;
            const shuffle_questions = document.getElementById('quizShuffle').checked ? 1 : 0;
            const description = document.getElementById('quizDescription').value;

            if (!title || !course_id) return toast('Введите название и выберите курс', 'error');

            showLoading();
            try {
                const res = await api('POST', `/learning/${projectId}/quizzes`, {
                    title, course_id, passing_score: parseInt(passing_score) || 70,
                    time_limit_minutes: time_limit_minutes ? parseInt(time_limit_minutes) : null,
                    attempts_allowed: parseInt(attempts_allowed) || 3, shuffle_questions, description
                });
                if (res.success) {
                    closeModal('quizModal');
                    document.getElementById('quizTitle').value = '';
                    document.getElementById('quizDescription').value = '';
                    loadQuizzes();
                    toast('Тест создан', 'success');
                } else {
                    toast(res.error || 'Ошибка создания теста', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Save Integration
        async function saveIntegration() {
            const name = document.getElementById('integrationName').value;
            const type = document.getElementById('integrationType').value;
            const funnel_id = document.getElementById('integrationFunnel').value;

            if (!name) return toast('Введите название интеграции', 'error');

            showLoading();
            try {
                const res = await api('POST', `/integrations/${projectId}`, {
                    name, type, settings: { funnel_id: funnel_id || null }
                });
                if (res.success) {
                    closeModal('integrationModal');
                    document.getElementById('integrationName').value = '';
                    loadIntegrations();
                    if (res.integration) {
                        if (type === 'webhook' || type === 'web_form') {
                            toast('Интеграция создана!\n\nURL для отправки данных:\n' + window.location.origin + '/api/integrations/' + projectId + '/incoming/' + res.integration.id, 'success');
                        } else if (type === 'widget') {
                            toast('Интеграция создана!\n\nКод виджета доступен в настройках интеграции.', 'success');
                        }
                    }
                } else {
                    toast(res.error || 'Ошибка создания интеграции', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Toggle integration fields based on type
        function toggleIntegrationFields() {
            const type = document.getElementById('integrationType').value;
            document.getElementById('integrationUrlGroup').style.display = (type === 'webhook' || type === 'web_form') ? 'block' : 'none';
            document.getElementById('integrationWidgetGroup').style.display = type === 'widget' ? 'block' : 'none';
        }

        // ============================================================
        // Populate Select Dropdowns
        // ============================================================

        function populateSelects() {
            // Funnels
            const funnelOptions = '<option value="">Все воронки</option>' + funnels.map(f => `<option value="${f.id}">${escapeHtml(f.name)}</option>`).join('');
            ['regulationFunnel', 'distFunnel', 'integrationFunnel'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = funnelOptions;
            });

            // Employees for forms
            const empOptions = '<option value="">Выберите сотрудника</option>' + employees.map(e => `<option value="${e.id}">${escapeHtml(e.first_name)} ${escapeHtml(e.last_name || '')}</option>`).join('');
            ['goalEmployee', 'bookingEmployee', 'scheduleEmployee', 'webinarHost'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = (id === 'goalEmployee' ? '<option value="">Общая цель (все)</option>' : '<option value="">Выберите</option>') +
                    employees.map(e => `<option value="${e.id}">${escapeHtml(e.first_name)} ${escapeHtml(e.last_name || '')}</option>`).join('');
            });

            // Employees for filters
            const empFilterOptions = '<option value="">Все менеджеры</option>' + employees.map(e => `<option value="${e.id}">${escapeHtml(e.first_name)} ${escapeHtml(e.last_name || '')}</option>`).join('');
            ['filterDealEmployee', 'scheduleEmployee', 'analyticsEmployee'].forEach(id => {
                const el = document.getElementById(id);
                if (el && id.includes('filter')) el.innerHTML = empFilterOptions;
            });
            const filterDealEmp = document.getElementById('filterDealEmployee');
            if (filterDealEmp) filterDealEmp.innerHTML = empFilterOptions;

            // Clients
            const clientOptions = '<option value="">Выберите клиента</option>' + clients.map(c => `<option value="${c.id}">${escapeHtml(c.first_name)} ${escapeHtml(c.last_name || '')}</option>`).join('');
            ['bookingClient'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = clientOptions;
            });

            // Load tags for filters
            loadTagsForFilters();
        }

        async function loadTagsForFilters() {
            try {
                // Client tags
                const clientTagsRes = await api('GET', `/tags/${projectId}?entity_type=client`);
                if (clientTagsRes.success) {
                    const el = document.getElementById('filterClientTag');
                    if (el) {
                        el.innerHTML = '<option value="">Все теги</option>' +
                            (clientTagsRes.tags || []).map(t => `<option value="${escapeHtml(t.name)}">${escapeHtml(t.name)}</option>`).join('');
                    }
                }

                // Deal tags
                const dealTagsRes = await api('GET', `/tags/${projectId}?entity_type=deal`);
                if (dealTagsRes.success) {
                    const el = document.getElementById('filterDealTag');
                    if (el) {
                        el.innerHTML = '<option value="">Все теги</option>' +
                            (dealTagsRes.tags || []).map(t => `<option value="${escapeHtml(t.name)}">${escapeHtml(t.name)}</option>`).join('');
                    }
                }
            } catch (e) { console.log('Tags load failed', e); }
        }

        async function openNewBookingModal() {
            resetBookingForm();
            await loadServicesForBooking();
            openModal('bookingModal');
        }

        // Load services for booking modal
        async function loadServicesForBooking() {
            const res = await api('GET', `/services/${projectId}`);
            if (res.success) {
                const el = document.getElementById('bookingService');
                if (el) {
                    el.innerHTML = '<option value="">Выберите услугу</option>' +
                        (res.services || []).map(s => `<option value="${s.id}">${escapeHtml(s.name)} - ${formatMoney(s.price || 0)}</option>`).join('');
                }
            }
        }

        // Load courses for quiz/webinar modals
        async function loadCoursesForModals() {
            const res = await api('GET', `/courses/${projectId}`);
            if (res.success) {
                const courseOptions = '<option value="">Выберите курс</option>' +
                    (res.courses || []).map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
                ['quizCourse', 'webinarCourse'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = id === 'webinarCourse' ? '<option value="">Без курса</option>' +
                        (res.courses || []).map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('') : courseOptions;
                });
            }
        }

        // ============================================================
        // NEW SECTIONS: Categories, Filters, Selections, Specialists, Rooms, Trainings, Lessons
        // ============================================================

        // Product Type Toggle
        document.querySelectorAll('input[name="productType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const onlineSection = document.getElementById('onlineProductAccess');
                const stockGroup = document.getElementById('productStockGroup');
                if (this.value === 'online') {
                    onlineSection.style.display = 'block';
                    stockGroup.style.display = 'none';
                } else {
                    onlineSection.style.display = 'none';
                    stockGroup.style.display = 'block';
                }
            });
        });

        function toggleProductAccessOptions() {
            const type = document.getElementById('productAccessType').value;
            document.getElementById('accessTrainingSelect').style.display = type === 'training' ? 'block' : 'none';
            document.getElementById('accessLessonSelect').style.display = type === 'lesson' ? 'block' : 'none';
            document.getElementById('accessGroupSelect').style.display = type === 'group' ? 'block' : 'none';
        }

        // Categories
        let categories = [];
        async function loadCategories() {
            const res = await api('GET', `/ecommerce/${projectId}/categories`);
            if (res.success) {
                categories = res.categories || [];
                renderCategories();
                populateCategorySelects();
            }
        }

        function renderCategories() {
            const container = document.getElementById('categoriesTree');
            if (!container) return;

            const buildTree = (parentId = null) => {
                const children = categories.filter(c => c.parent_id === parentId);
                if (!children.length) return '';
                return children.map(cat => `
                    <div class="category-item" onclick="editCategory('${cat.id}')">
                        <span><i class="fas fa-folder"></i> ${escapeHtml(cat.name)}</span>
                        <span class="badge">${categories.filter(c => c.parent_id === cat.id).length} подкат.</span>
                    </div>
                    <div class="category-children">${buildTree(cat.id)}</div>
                `).join('');
            };
            container.innerHTML = buildTree() || '<p style="color:var(--text-muted);">Нет категорий. Нажмите "Добавить категорию"</p>';
        }

        function populateCategorySelects() {
            const options = '<option value="">— Без категории —</option>' +
                categories.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
            ['productCategory', 'categoryParent', 'filterProductCategory'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = options;
            });
        }

        function editCategory(id) {
            const c = categories.find(cat => cat.id == id);
            if (!c) return toast('Категория не найдена', 'error');

            document.getElementById('categoryEditId').value = c.id;
            document.getElementById('categoryName').value = c.name || '';
            document.getElementById('categoryParent').value = c.parent_id || '';
            document.getElementById('categoryDescription').value = c.description || '';

            document.getElementById('categoryModalTitle').textContent = 'Редактировать категорию';
            openModal('categoryModal');
        }

        function resetCategoryForm() {
            document.getElementById('categoryEditId').value = '';
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryParent').value = '';
            document.getElementById('categoryDescription').value = '';
            document.getElementById('categoryModalTitle').textContent = 'Новая категория';
        }

        async function saveCategory() {
            const editId = document.getElementById('categoryEditId').value;
            const name = document.getElementById('categoryName').value;
            if (!name) return toast('Введите название категории', 'error');

            const data = {
                name,
                parent_id: document.getElementById('categoryParent').value || null,
                description: document.getElementById('categoryDescription').value
            };

            showLoading();
            try {
                const res = editId
                    ? await api('PUT', `/products/${projectId}/categories/${editId}`, data)
                    : await api('POST', `/products/${projectId}/categories`, data);
                if (res.success) {
                    closeModal('categoryModal');
                    resetCategoryForm();
                    loadCategories();
                    toast(editId ? 'Категория обновлена' : 'Категория создана', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения категории', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Product Filters
        let productFilters = [];
        async function loadProductFilters() {
            // Load from localStorage for now
            productFilters = JSON.parse(localStorage.getItem(`filters_${projectId}`) || '[]');
            renderProductFilters();
        }

        function renderProductFilters() {
            const grid = document.getElementById('customFiltersGrid');
            if (!grid) return;
            grid.innerHTML = productFilters.map(f => `
                <div class="card" style="cursor:pointer;" onclick="openFilterEditor('${f.id}')">
                    <div class="card-body">
                        <h4><i class="fas fa-sliders-h"></i> ${escapeHtml(f.name)}</h4>
                        <p style="color:var(--text-muted);">${f.values?.length || 0} значений</p>
                    </div>
                </div>
            `).join('');
        }

        function toggleCustomFilter() {
            const isCustom = document.getElementById('filterType').value === 'custom';
            document.getElementById('customFilterName').style.display = isCustom ? 'block' : 'none';
        }

        function openFilterEditor(filterId) {
            const filter = productFilters.find(f => f.id === filterId);
            if (filter) {
                document.getElementById('filterType').value = 'custom';
                toggleCustomFilter();
                const nameEl = document.getElementById('filterCustomName');
                if (nameEl) nameEl.value = filter.name || '';
                document.getElementById('filterValues').value = (filter.values || []).join('\n');
                document.getElementById('filterMultiple').checked = filter.multiple || false;
            }
            openModal('productFilterModal');
        }

        function saveProductFilter() {
            const type = document.getElementById('filterType').value;
            const name = type === 'custom' ? document.getElementById('filterCustomName').value : type;
            const values = document.getElementById('filterValues').value.split('\n').filter(v => v.trim());

            if (!name) return toast('Введите название фильтра');

            const filter = {
                id: Date.now().toString(),
                name,
                values,
                multiple: document.getElementById('filterMultiple').checked
            };

            productFilters.push(filter);
            localStorage.setItem(`filters_${projectId}`, JSON.stringify(productFilters));
            closeModal('productFilterModal');
            loadProductFilters();
        }

        // Selections (former Collections)
        let selections = [];
        async function loadSelections() {
            const res = await api('GET', `/ecommerce/${projectId}/collections`);
            if (res.success) {
                selections = res.collections || [];
                renderSelections();
            }
        }

        function renderSelections() {
            const container = document.getElementById('selectionsList');
            if (!container) return;
            container.innerHTML = selections.map(s => `
                <div class="stat-card" onclick="editSelection('${s.id}')" style="cursor:pointer;">
                    <div class="value">${s.products_count || 0}</div>
                    <div class="label">${escapeHtml(s.name)}</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted);">Нет подборок</p>';
        }

        function editSelection(id) {
            const s = selections.find(sel => sel.id == id);
            if (!s) return toast('Подборка не найдена', 'error');

            document.getElementById('selectionEditId').value = s.id;
            document.getElementById('selectionName').value = s.name || '';
            document.getElementById('selectionDescription').value = s.description || '';
            document.getElementById('selectionType').value = s.type || 'manual';

            document.getElementById('selectionModalTitle').textContent = 'Редактировать подборку';
            openModal('selectionModal');
        }

        function resetSelectionForm() {
            document.getElementById('selectionEditId').value = '';
            document.getElementById('selectionName').value = '';
            document.getElementById('selectionDescription').value = '';
            document.getElementById('selectionType').value = 'manual';
            document.getElementById('selectionModalTitle').textContent = 'Новая подборка';
        }

        async function saveSelection() {
            const editId = document.getElementById('selectionEditId').value;
            const name = document.getElementById('selectionName').value;
            if (!name) return toast('Введите название подборки', 'error');

            const data = {
                name,
                description: document.getElementById('selectionDescription').value,
                type: document.getElementById('selectionType').value
            };

            showLoading();
            try {
                const res = editId
                    ? await api('PUT', `/ecommerce/${projectId}/collections/${editId}`, data)
                    : await api('POST', `/ecommerce/${projectId}/collections`, data);
                if (res.success) {
                    closeModal('selectionModal');
                    resetSelectionForm();
                    loadSelections();
                    toast(editId ? 'Подборка обновлена' : 'Подборка создана', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения подборки', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Specialists
        let specialists = [];
        async function loadSpecialists() {
            const res = await api('GET', `/bookings/${projectId}/employees`);
            if (res.success) {
                specialists = res.employees || [];
                renderSpecialists();
                populateSpecialistSelects();
            }
        }

        function renderSpecialists() {
            const container = document.getElementById('specialistsList');
            if (!container) return;
            container.innerHTML = specialists.map(s => {
                const linkedCount = (s.linked_services || []).length;
                const linkedNames = (s.linked_services || []).map(sid => {
                    const svc = services.find(sv => sv.id == sid);
                    return svc ? escapeHtml(svc.name) : '';
                }).filter(Boolean).join(', ');
                return `
                <div class="stat-card" onclick="editSpecialist('${s.id}')" style="cursor:pointer;">
                    <div style="font-size:32px;margin-bottom:10px;"><i class="fas fa-user-md"></i></div>
                    <div class="label">${escapeHtml(s.name || s.first_name + ' ' + (s.last_name || ''))}</div>
                    <div style="font-size:12px;color:var(--text-muted);">${escapeHtml(s.position || '')}</div>
                    ${linkedCount > 0 ? `<div style="font-size:11px;color:var(--primary);margin-top:6px;" title="${linkedNames}"><i class="fas fa-concierge-bell"></i> ${linkedCount} услуг${linkedCount === 1 ? 'а' : linkedCount < 5 ? 'и' : ''}</div>` : ''}
                </div>`;
            }).join('') || '<p style="color:var(--text-muted);">Нет специалистов</p>';
        }

        async function loadSpecialistServiceCheckboxes(selectedIds) {
            const container = document.getElementById('specialistServicesCheckboxes');
            if (!container) return;
            let svcList = services;
            if (!svcList.length) {
                const res = await api('GET', `/services/${projectId}`);
                if (res.success) svcList = res.services || [];
            }
            if (!svcList.length) {
                container.innerHTML = '<span style="color:var(--text-muted);font-size:12px;">Нет доступных услуг</span>';
                return;
            }
            container.innerHTML = svcList.map(s => `
                <label><input type="checkbox" value="${s.id}" ${(selectedIds || []).includes(s.id) || (selectedIds || []).includes(String(s.id)) ? 'checked' : ''}> ${escapeHtml(s.name)}</label>
            `).join('');
        }

        function populateSpecialistSelects() {
            const options = '<option value="">Все специалисты</option>' +
                specialists.map(s => `<option value="${s.id}">${escapeHtml(s.name || s.first_name)}</option>`).join('');
            ['filterBookingSpecialist', 'scheduleEmployee'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = options;
            });
        }

        function editSpecialist(id) {
            const s = specialists.find(sp => sp.id == id);
            if (!s) return toast('Специалист не найден', 'error');

            document.getElementById('specialistEditId').value = s.id;
            document.getElementById('specialistFirstName').value = s.first_name || '';
            document.getElementById('specialistLastName').value = s.last_name || '';
            document.getElementById('specialistPosition').value = s.position || '';
            const bioEl = document.getElementById('specialistBio');
            if (bioEl) bioEl.value = s.bio || '';

            loadSpecialistServiceCheckboxes(s.linked_services || []);
            document.getElementById('specialistModalTitle').textContent = 'Редактировать специалиста';
            openModal('specialistModal');
        }

        function resetSpecialistForm() {
            document.getElementById('specialistEditId').value = '';
            ['specialistFirstName', 'specialistLastName', 'specialistPosition', 'specialistBio'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            loadSpecialistServiceCheckboxes([]);
            document.getElementById('specialistModalTitle').textContent = 'Добавить специалиста';
        }

        async function saveSpecialist() {
            const editId = document.getElementById('specialistEditId').value;
            const first_name = document.getElementById('specialistFirstName').value;
            if (!first_name) return toast('Введите имя специалиста', 'error');

            const checkedServices = [...document.querySelectorAll('#specialistServicesCheckboxes input[type=checkbox]:checked')].map(cb => cb.value);
            const data = {
                first_name,
                last_name: document.getElementById('specialistLastName').value,
                position: document.getElementById('specialistPosition').value,
                department: 'services',
                linked_services: checkedServices
            };

            showLoading();
            try {
                const res = editId
                    ? await api('PUT', `/employees/${projectId}/${editId}`, data)
                    : await api('POST', `/employees/${projectId}`, data);
                if (res.success) {
                    closeModal('specialistModal');
                    resetSpecialistForm();
                    loadSpecialists();
                    loadEmployees();
                    toast(editId ? 'Специалист обновлён' : 'Специалист добавлен', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения специалиста', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Rooms
        let rooms = [];
        async function loadRooms() {
            rooms = JSON.parse(localStorage.getItem(`rooms_${projectId}`) || '[]');
            renderRooms();
        }

        function renderRooms() {
            const container = document.getElementById('roomsList');
            if (!container) return;
            container.innerHTML = rooms.map(r => `
                <div class="stat-card" onclick="editRoom('${r.id}')" style="cursor:pointer;">
                    <div style="font-size:32px;margin-bottom:10px;"><i class="fas fa-door-open"></i></div>
                    <div class="label">${escapeHtml(r.name)}</div>
                    <div style="font-size:12px;color:var(--text-muted);">Вместимость: ${r.capacity}</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted);">Нет помещений</p>';
        }

        function editRoom(id) {
            const r = rooms.find(rm => rm.id == id);
            if (!r) return toast('Помещение не найдено', 'error');

            document.getElementById('roomEditId').value = r.id;
            document.getElementById('roomName').value = r.name || '';
            document.getElementById('roomCapacity').value = r.capacity || 1;
            document.getElementById('roomDescription').value = r.description || '';

            document.getElementById('roomModalTitle').textContent = 'Редактировать помещение';
            openModal('roomModal');
        }

        function resetRoomForm() {
            document.getElementById('roomEditId').value = '';
            document.getElementById('roomName').value = '';
            document.getElementById('roomCapacity').value = '1';
            document.getElementById('roomDescription').value = '';
            document.getElementById('roomModalTitle').textContent = 'Добавить помещение';
        }

        function saveRoom() {
            const editId = document.getElementById('roomEditId').value;
            const name = document.getElementById('roomName').value;
            if (!name) return toast('Введите название помещения', 'error');

            const data = {
                name,
                capacity: document.getElementById('roomCapacity').value || 1,
                description: document.getElementById('roomDescription').value
            };

            if (editId) {
                const idx = rooms.findIndex(r => r.id == editId);
                if (idx !== -1) rooms[idx] = { ...rooms[idx], ...data };
            } else {
                rooms.push({ id: Date.now().toString(), ...data });
            }

            localStorage.setItem(`rooms_${projectId}`, JSON.stringify(rooms));
            closeModal('roomModal');
            resetRoomForm();
            loadRooms();
            toast(editId ? 'Помещение обновлено' : 'Помещение добавлено', 'success');
        }

        // Trainings (courses restructured)
        let trainings = [];
        let currentTrainingData = null;

        async function loadTrainings() {
            const res = await api('GET', `/courses/${projectId}`);
            if (res.success) {
                trainings = res.courses || [];
                renderTrainings();
                populateTrainingSelects();
                document.getElementById('trainingsTotal').textContent = trainings.length;
                document.getElementById('trainingsStudents').textContent =
                    trainings.reduce((sum, t) => sum + (t.students_count || 0), 0);
            }
        }

        function renderTrainings() {
            const container = document.getElementById('trainingsList');
            if (!container) return;
            container.innerHTML = trainings.map(t => `
                <div class="stat-card" onclick="openTrainingDetails('${t.id}')" style="cursor:pointer;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <span class="badge ${t.is_published ? 'badge-success' : ''}">${t.is_published ? 'Опубликован' : 'Черновик'}</span>
                        <span style="font-size:12px;color:var(--text-muted);">${t.lessons_count || 0} уроков</span>
                    </div>
                    <div class="label" style="font-size:16px;font-weight:600;">${escapeHtml(t.name)}</div>
                    <div style="margin-top:10px;display:flex;justify-content:space-between;font-size:12px;">
                        <span><i class="fas fa-users"></i> ${t.students_count || 0}</span>
                        <span><i class="fas fa-chart-line"></i> ${t.avg_progress || 0}%</span>
                    </div>
                    <div style="margin-top:8px;height:4px;background:#334155;border-radius:2px;">
                        <div style="width:${t.avg_progress || 0}%;height:100%;background:var(--primary);border-radius:2px;"></div>
                    </div>
                </div>
            `).join('') || '<p style="color:var(--text-muted);">Нет тренингов</p>';
        }

        function populateTrainingSelects() {
            const options = trainings.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
            ['lessonTraining', 'filterLessonTraining', 'certTemplateTraining', 'certTraining',
             'productAccessTraining', 'autoWebinarTraining'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<option value="">— Выберите —</option>' + options;
            });
        }

        async function saveTraining() {
            const editId = document.getElementById('trainingEditId')?.value;
            const name = document.getElementById('trainingName').value;
            if (!name) return toast('Введите название тренинга', 'error');

            showLoading();
            try {
                const method = editId ? 'PUT' : 'POST';
                const url = editId ? `/courses/${projectId}/${editId}` : `/courses/${projectId}`;

                const res = await api(method, url, {
                    name,
                    description: document.getElementById('trainingDescription').value,
                    type: document.getElementById('trainingAccessType').value,
                    access_days: document.getElementById('trainingAccessDays').value || 0,
                    drip_content: document.getElementById('trainingDrip').value,
                    sequential_access: document.getElementById('trainingSequentialAccess').checked,
                    auto_certificate: document.getElementById('trainingAutoCertificate').checked,
                    certificate_template_id: document.getElementById('trainingCertTemplate').value || null,
                    is_published: document.getElementById('trainingPublished').checked
                });

                if (res.success) {
                    closeModal('trainingModal');
                    resetTrainingForm();
                    loadTrainings();
                    toast(editId ? 'Тренинг обновлён' : 'Тренинг создан', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения тренинга', 'error');
                }
            } finally {
                hideLoading();
            }
        }

        function resetTrainingForm() {
            document.getElementById('trainingEditId').value = '';
            document.getElementById('trainingModalTitle').textContent = 'Новый тренинг';
            document.getElementById('trainingSaveBtn').textContent = 'Создать тренинг';
            ['trainingName', 'trainingDescription', 'trainingAccessDays'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('trainingAccessType').value = 'purchase';
            document.getElementById('trainingDrip').value = '0';
            document.getElementById('trainingSequentialAccess').checked = false;
            document.getElementById('trainingAutoCertificate').checked = false;
            document.getElementById('trainingCertTemplate').value = '';
            document.getElementById('autoCertTemplateGroup').style.display = 'none';
            document.getElementById('trainingPublished').checked = false;
        }

        function toggleAutoCertTemplate() {
            const checked = document.getElementById('trainingAutoCertificate').checked;
            document.getElementById('autoCertTemplateGroup').style.display = checked ? 'block' : 'none';
            if (checked) populateAutoCertTemplateSelect();
        }

        function populateAutoCertTemplateSelect() {
            const select = document.getElementById('trainingCertTemplate');
            const currentVal = select.value;
            const templates = typeof certTemplates !== 'undefined' ? certTemplates : JSON.parse(localStorage.getItem(`cert_templates_${projectId}`) || '[]');
            select.innerHTML = '<option value="">По умолчанию</option>' +
                templates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
            if (currentVal) select.value = currentVal;
        }

        async function openTrainingDetails(trainingId) {
            showLoading();
            try {
                const res = await api('GET', `/courses/${projectId}/${trainingId}?full=1`);
                if (res.success && res.course) {
                    currentTrainingData = res.course;
                    const t = res.course;

                    document.getElementById('trainingDetailsTitle').textContent = t.name;
                    document.getElementById('trainingStudentsCount').textContent = t.students_count || 0;
                    document.getElementById('trainingLessonsCount').textContent = t.lessons_count || 0;
                    document.getElementById('trainingCertificatesIssued').textContent = t.certificates_count || 0;

                    const accessTypes = { purchase: 'После покупки', group: 'По группе', free: 'Бесплатный' };
                    document.getElementById('trainingAccessInfo').textContent = accessTypes[t.type] || t.type || '—';
                    document.getElementById('trainingStatusInfo').innerHTML =
                        `<span class="badge ${t.is_published ? 'badge-success' : ''}">${t.is_published ? 'Опубликован' : 'Черновик'}</span>`;

                    // Render lessons
                    renderTrainingLessons(t.lessons || []);

                    // Render students
                    renderTrainingStudents(t.students || []);

                    // Render analytics
                    renderTrainingAnalytics(t);

                    switchTrainingTab('lessons');
                    openModal('trainingDetailsModal');
                }
            } finally {
                hideLoading();
            }
        }

        function switchTrainingTab(tabName) {
            const modal = document.getElementById('trainingDetailsModal');
            modal.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            modal.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');

            modal.querySelector(`[onclick="switchTrainingTab('${tabName}')"]`)?.classList.add('active');
            document.getElementById('trainingTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).style.display = 'block';
        }

        function renderTrainingLessons(lessons) {
            const container = document.getElementById('trainingLessonsList');
            container.innerHTML = lessons.length ? lessons.map((l, idx) => `
                <div class="lesson-item" style="display:flex;align-items:center;gap:15px;padding:12px;background:var(--bg-input);border-radius:8px;margin-bottom:8px;">
                    <div style="width:24px;height:24px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;">${idx + 1}</div>
                    <div style="flex:1;">
                        <div style="font-weight:500;">${escapeHtml(l.title)}</div>
                        <div style="font-size:12px;color:var(--text-muted);">${l.type || 'video'} · ${l.duration || 0} мин</div>
                    </div>
                    <div style="font-size:12px;color:var(--text-muted);">${l.completed_count || 0} завершили</div>
                    <button class="btn btn-sm btn-outline" onclick="editLesson('${l.id}')"><i class="fas fa-edit"></i></button>
                </div>
            `).join('') : '<p style="color:var(--text-muted);text-align:center;">Нет уроков. Добавьте первый урок.</p>';
        }

        function renderTrainingStudents(students) {
            const tbody = document.getElementById('trainingStudentsTable');
            tbody.innerHTML = students.length ? students.map(s => {
                const progressColor = s.progress >= 100 ? 'var(--success)' : s.progress >= 50 ? 'var(--primary)' : s.progress > 0 ? 'var(--warning)' : '#334155';
                const statusLabel = s.progress >= 100 ? 'Завершил' : s.progress > 0 ? 'В процессе' : 'Не начал';
                const statusClass = s.progress >= 100 ? 'badge-success' : s.progress > 0 ? 'badge-warning' : '';
                const quizScore = s.quiz_score != null ? `${s.quiz_score}%` : '\u2014';
                const quizColor = s.quiz_score != null ? (s.quiz_score >= 80 ? 'var(--success)' : s.quiz_score >= 50 ? 'var(--warning)' : 'var(--danger)') : 'var(--text-muted)';
                return `
                <tr>
                    <td>
                        <strong>${escapeHtml(s.name || s.email)}</strong>
                        ${s.email ? `<div style="font-size:11px;color:var(--text-muted);">${escapeHtml(s.email)}</div>` : ''}
                    </td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div style="width:80px;background:#334155;border-radius:4px;height:8px;">
                                <div style="width:${s.progress || 0}%;height:100%;background:${progressColor};border-radius:4px;transition:width 0.3s;"></div>
                            </div>
                            <span style="font-size:12px;font-weight:500;">${s.progress || 0}%</span>
                        </div>
                        ${s.completed_lessons != null && s.total_lessons ? `<div style="font-size:10px;color:var(--text-muted);margin-top:2px;">${s.completed_lessons}/${s.total_lessons} уроков</div>` : ''}
                    </td>
                    <td>${formatDate(s.enrolled_at)}</td>
                    <td style="font-size:12px;">${s.last_active_at ? formatDate(s.last_active_at) : '<span style="color:var(--text-muted);">\u2014</span>'}</td>
                    <td style="font-weight:500;color:${quizColor};">${quizScore}</td>
                    <td><span class="badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="unenrollStudent('${s.id}')"><i class="fas fa-user-minus"></i></button>
                    </td>
                </tr>`;
            }).join('') : '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);">Нет студентов</td></tr>';
        }

        function renderTrainingAnalytics(training) {
            const students = training.students || [];
            const total = students.length || 1;
            const completed = students.filter(s => s.progress >= 100).length;
            const dropped = students.filter(s => s.progress > 0 && s.progress < 20 && !s.active).length;
            const avgProgress = students.length ? Math.round(students.reduce((sum, s) => sum + (s.progress || 0), 0) / total) : 0;

            document.getElementById('analyticsCompletionRate').textContent = `${Math.round(completed / total * 100)}%`;
            document.getElementById('analyticsAvgProgress').textContent = `${avgProgress}%`;
            document.getElementById('analyticsDropoffRate').textContent = `${Math.round(dropped / total * 100)}%`;

            // Lesson progress chart
            const lessons = training.lessons || [];
            const chartContainer = document.getElementById('lessonProgressChart');
            chartContainer.innerHTML = lessons.map(l => {
                const percent = training.students_count ? Math.round((l.completed_count || 0) / training.students_count * 100) : 0;
                return `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:150px;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(l.title)}</div>
                        <div style="flex:1;background:#334155;border-radius:4px;height:16px;">
                            <div style="width:${percent}%;height:100%;background:var(--primary);border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:10px;color:#fff;">${percent}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editTrainingFromDetails() {
            if (!currentTrainingData) return;
            closeModal('trainingDetailsModal');

            const t = currentTrainingData;
            document.getElementById('trainingEditId').value = t.id;
            document.getElementById('trainingModalTitle').textContent = 'Редактировать тренинг';
            document.getElementById('trainingSaveBtn').textContent = 'Сохранить';
            document.getElementById('trainingName').value = t.name || '';
            document.getElementById('trainingDescription').value = t.description || '';
            document.getElementById('trainingAccessType').value = t.type || 'purchase';
            document.getElementById('trainingAccessDays').value = t.access_days || 0;
            document.getElementById('trainingDrip').value = t.drip_content || '0';
            document.getElementById('trainingSequentialAccess').checked = t.sequential_access || false;
            document.getElementById('trainingAutoCertificate').checked = t.auto_certificate || false;
            document.getElementById('trainingCertTemplate').value = t.certificate_template_id || '';
            document.getElementById('autoCertTemplateGroup').style.display = t.auto_certificate ? 'block' : 'none';
            populateAutoCertTemplateSelect();
            document.getElementById('trainingPublished').checked = t.is_published || false;

            openModal('trainingModal');
        }

        function addLessonToTraining() {
            closeModal('trainingDetailsModal');
            document.getElementById('lessonTraining').value = currentTrainingData?.id || '';
            openModal('lessonModal');
        }

        function enrollStudentModal() {
            // Populate client select
            const clientSelect = document.getElementById('enrollClient');
            clientSelect.innerHTML = '<option value="">— Выберите —</option>' +
                clients.map(c => `<option value="${c.id}">${escapeHtml((c.first_name || '') + ' ' + (c.last_name || ''))}</option>`).join('');

            document.getElementById('enrollStartDate').value = new Date().toISOString().split('T')[0];
            openModal('enrollStudentModal');
        }

        async function enrollStudent() {
            const clientId = document.getElementById('enrollClient').value;
            if (!clientId || !currentTrainingData) return toast('Выберите клиента', 'error');

            showLoading();
            try {
                const res = await api('POST', `/learning/${projectId}/enroll`, {
                    course_id: currentTrainingData.id,
                    client_id: clientId,
                    start_date: document.getElementById('enrollStartDate').value,
                    send_notification: document.getElementById('enrollSendNotification').checked
                });

                if (res.success) {
                    closeModal('enrollStudentModal');
                    openTrainingDetails(currentTrainingData.id);
                    toast('Студент записан на тренинг', 'success');
                } else {
                    toast(res.error || 'Ошибка записи', 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function unenrollStudent(enrollmentId) {
            if (!await confirm('Отчислить студента с тренинга?', 'Отчисление')) return;
            showLoading();
            try {
                const res = await api('DELETE', `/learning/${projectId}/enroll/${enrollmentId}`);
                if (res.success) {
                    openTrainingDetails(currentTrainingData.id);
                    toast('Студент отчислен', 'success');
                } else toast(res.error || 'Ошибка', 'error');
            } catch (e) { toast('Ошибка сети', 'error'); }
            finally { hideLoading(); }
        }

        async function duplicateTraining() {
            if (!currentTrainingData) return;

            showLoading();
            try {
                const res = await api('POST', `/courses/${projectId}/${currentTrainingData.id}/duplicate`);
                if (res.success) {
                    closeModal('trainingDetailsModal');
                    loadTrainings();
                    toast('Тренинг дублирован', 'success');
                }
            } finally {
                hideLoading();
            }
        }

        // Legacy function for backward compatibility
        function editTraining(id) {
            openTrainingDetails(id);
        }

        // Lessons
        let lessons = [];
        async function loadLessons() {
            const res = await api('GET', `/learning/${projectId}/lessons`);
            if (res.success) {
                lessons = res.lessons || [];
                renderLessons();
            }
        }

        function renderLessons() {
            const tbody = document.getElementById('lessonsTable');
            if (!tbody) return;
            tbody.innerHTML = lessons.map((l, i) => {
                const training = trainings.find(t => t.id === l.course_id);
                return `
                <tr onclick="editLesson('${l.id}')" style="cursor:pointer;">
                    <td>${l.order_index || i + 1}</td>
                    <td>${escapeHtml(l.title)}</td>
                    <td>${training ? escapeHtml(training.name) : '-'}</td>
                    <td><span class="badge">${l.type || 'video'}</span></td>
                    <td>${l.duration || '-'} мин</td>
                    <td>${l.completed_count || 0}</td>
                    <td><button class="btn btn-sm btn-outline"><i class="fas fa-edit"></i></button></td>
                </tr>
            `}).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);">Нет уроков</td></tr>';
        }

        function toggleLessonContent() {
            const type = document.getElementById('lessonType').value;
            document.getElementById('lessonVideoGroup').style.display = type === 'video' ? 'block' : 'none';
            document.getElementById('lessonTextGroup').style.display = (type === 'text' || type === 'homework') ? 'block' : 'none';
        }

        function editLesson(id) {
            const l = lessons.find(ls => ls.id == id);
            if (!l) return toast('Урок не найден', 'error');

            document.getElementById('lessonEditId').value = l.id;
            document.getElementById('lessonTraining').value = l.course_id || '';
            document.getElementById('lessonName').value = l.title || '';
            document.getElementById('lessonType').value = l.type || 'video';
            document.getElementById('lessonContent').value = l.content || '';
            document.getElementById('lessonVideoUrl').value = l.video_url || '';
            document.getElementById('lessonDuration').value = l.duration || '';
            document.getElementById('lessonOrder').value = l.order_index || 1;
            toggleLessonContent();

            document.getElementById('lessonModalTitle').textContent = 'Редактировать урок';
            document.getElementById('lessonSaveBtn').textContent = 'Сохранить';
            openModal('lessonModal');
        }

        function resetLessonForm() {
            document.getElementById('lessonEditId').value = '';
            ['lessonName', 'lessonContent', 'lessonVideoUrl', 'lessonDuration'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('lessonTraining').value = '';
            document.getElementById('lessonType').value = 'video';
            document.getElementById('lessonOrder').value = '1';
            toggleLessonContent();
            document.getElementById('lessonModalTitle').textContent = 'Новый урок';
            document.getElementById('lessonSaveBtn').textContent = 'Сохранить';
        }

        async function saveLesson() {
            const editId = document.getElementById('lessonEditId').value;
            const training = document.getElementById('lessonTraining').value;
            const name = document.getElementById('lessonName').value;
            if (!training || !name) return toast('Заполните обязательные поля', 'error');

            const data = {
                course_id: training,
                title: name,
                type: document.getElementById('lessonType').value,
                content: document.getElementById('lessonContent').value,
                video_url: document.getElementById('lessonVideoUrl').value,
                duration: document.getElementById('lessonDuration').value,
                order_index: document.getElementById('lessonOrder').value
            };

            showLoading();
            try {
                const res = editId
                    ? await api('PUT', `/learning/${projectId}/lessons/${editId}`, data)
                    : await api('POST', `/learning/${projectId}/lessons`, data);
                if (res.success) {
                    closeModal('lessonModal');
                    resetLessonForm();
                    loadLessons();
                    toast(editId ? 'Урок обновлён' : 'Урок создан', 'success');
                } else {
                    toast(res.error || 'Ошибка сохранения урока', 'error');
                }
            } catch (e) {
                toast('Ошибка сети', 'error');
            } finally {
                hideLoading();
            }
        }

        // Bookings Calendar
        let bookingsWeekStart = new Date();
        bookingsWeekStart.setDate(bookingsWeekStart.getDate() - bookingsWeekStart.getDay() + 1);

        let calendarBookings = [];

        async function loadBookingsCalendar() {
            const header = document.getElementById('bookingsCalendarHeader');
            const body = document.getElementById('bookingsCalendarBody');
            if (!header || !body) return;

            // Set date input
            const dateInput = document.getElementById('bookingsWeekStart');
            if (dateInput) dateInput.value = bookingsWeekStart.toISOString().split('T')[0];

            // Calculate week end
            const weekEnd = new Date(bookingsWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            // Load bookings for the week
            const fromDate = bookingsWeekStart.toISOString().split('T')[0];
            const toDate = weekEnd.toISOString().split('T')[0];
            const res = await api('GET', `/bookings/${projectId}?from=${fromDate}&to=${toDate}`);
            calendarBookings = res.success ? (res.bookings || []) : [];

            // Update stats
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = calendarBookings.filter(b => b.booking_date === today);
            document.getElementById('bookingsToday').textContent = todayBookings.length;
            document.getElementById('bookingsConfirmed').textContent = calendarBookings.filter(b => b.status === 'confirmed').length;
            document.getElementById('bookingsPending').textContent = calendarBookings.filter(b => b.status === 'pending').length;
            document.getElementById('bookingsRevenue').textContent = formatMoney(calendarBookings.reduce((sum, b) => sum + (b.price || 0), 0));

            // Generate header with dates
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            const todayDate = new Date().toISOString().split('T')[0];
            header.innerHTML = '<th style="width:60px;">Время</th>' +
                days.map((d, i) => {
                    const date = new Date(bookingsWeekStart);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = dateStr === todayDate;
                    return `<th style="${isToday ? 'background:var(--primary);color:#fff;' : ''}">${d}<br><small>${date.getDate()}.${date.getMonth()+1}</small></th>`;
                }).join('');

            // Generate time slots (9:00 - 21:00)
            let rows = '';
            for (let hour = 9; hour <= 20; hour++) {
                rows += `<tr>
                    <td class="time-cell">${hour}:00</td>
                    ${days.map((_, i) => {
                        const date = new Date(bookingsWeekStart);
                        date.setDate(date.getDate() + i);
                        const dateStr = date.toISOString().split('T')[0];

                        // Find bookings for this slot
                        const slotBookings = calendarBookings.filter(b => {
                            if (b.booking_date !== dateStr) return false;
                            const bookingHour = parseInt(b.start_time?.split(':')[0] || 0);
                            return bookingHour === hour;
                        });

                        if (slotBookings.length > 0) {
                            const booking = slotBookings[0];
                            const statusColors = {
                                pending: '#f59e0b',
                                confirmed: '#10b981',
                                completed: '#6b7280',
                                cancelled: '#ef4444'
                            };
                            return `<td class="slot-cell booked" onclick="openBookingDetails('${booking.id}')" style="background:${statusColors[booking.status] || '#3b82f6'}20;border-left:3px solid ${statusColors[booking.status] || '#3b82f6'};">
                                <div style="font-size:11px;font-weight:500;">${escapeHtml(booking.client_name || 'Клиент')}</div>
                                <div style="font-size:10px;color:var(--text-muted);">${escapeHtml(booking.service_name || '')}</div>
                                <div style="margin-top:2px;">${getBookingStatusBadge(booking.status)}</div>
                                ${slotBookings.length > 1 ? `<div style="font-size:9px;color:var(--primary);">+${slotBookings.length - 1}</div>` : ''}
                            </td>`;
                        }

                        return `<td class="slot-cell" onclick="openBookingSlot(${hour}, ${i})"></td>`;
                    }).join('')}
                </tr>`;
            }
            body.innerHTML = rows;
        }

        function moveBookingsWeek(direction) {
            bookingsWeekStart.setDate(bookingsWeekStart.getDate() + (direction * 7));
            loadBookingsCalendar();
        }

        async function openBookingSlot(hour, dayIndex) {
            resetBookingForm();
            await loadServicesForBooking();

            const date = new Date(bookingsWeekStart);
            date.setDate(date.getDate() + dayIndex);

            document.getElementById('bookingDate').value = date.toISOString().split('T')[0];
            document.getElementById('bookingTime').value = `${hour.toString().padStart(2, '0')}:00`;

            openModal('bookingModal');
        }

        function copyWebinarLink(id) {
            const url = `${location.origin}/webinar/${id}`;
            navigator.clipboard.writeText(url);
            toast('Ссылка скопирована', 'success');
        }

        async function saveAutoWebinar() {
            const name = document.getElementById('autoWebinarName').value;
            const video = document.getElementById('autoWebinarVideo').value;
            if (!name || !video) return toast('Заполните обязательные поля', 'error');

            showLoading();
            try {
                const res = await api('POST', `/learning/${projectId}/webinars`, {
                    title: name,
                    type: 'auto',
                    video_url: video,
                    duration: document.getElementById('autoWebinarDuration').value,
                    chat_simulation: document.getElementById('autoWebinarChat').checked
                });

                if (res.success) {
                    closeModal('autoWebinarModal');
                    loadWebinars();
                    toast('Автовебинар создан', 'success');
                } else {
                    toast(res.error || 'Ошибка создания автовебинара', 'error');
                }
            } finally {
                hideLoading();
            }
        }

        function saveCertificateTemplate() {
            const name = document.getElementById('certTemplateName').value;
            if (!name) return toast('Введите название шаблона', 'error');

            const bgColor = document.getElementById('certTemplateBg')?.value || '#1a1a2e';
            const textColor = document.getElementById('certTemplateText')?.value || '#ffffff';
            const borderStyle = document.getElementById('certTemplateBorder')?.value || 'classic';

            const templates = JSON.parse(localStorage.getItem(`cert_templates_${projectId}`) || '[]');
            templates.push({
                id: Date.now().toString(),
                name,
                training_id: document.getElementById('certTemplateTraining').value,
                bg_color: bgColor,
                text_color: textColor,
                border_style: borderStyle
            });
            localStorage.setItem(`cert_templates_${projectId}`, JSON.stringify(templates));
            certTemplates = templates;
            updateCertTemplateSelects();
            closeModal('certificateTemplateModal');
            toast('Шаблон сертификата сохранён', 'success');
        }

        async function issueCertificate() {
            const student = document.getElementById('certStudent').value;
            const training = document.getElementById('certTraining').value;
            if (!student || !training) return toast('Выберите студента и тренинг', 'error');

            showLoading();
            try {
                const res = await api('POST', `/learning/${projectId}/certificates/issue`, {
                    client_id: student,
                    course_id: training,
                    template_id: document.getElementById('certTemplate').value
                });

                if (res.success) {
                    closeModal('issueCertificateModal');
                    loadCertificates();
                    toast('Сертификат выдан', 'success');
                } else {
                    toast(res.error || 'Ошибка выдачи сертификата', 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // XML Import
        async function importXml() {
            const file = document.getElementById('xmlFile').files[0];
            const url = document.getElementById('xmlUrl').value;

            if (!file && !url) return toast('Выберите файл или укажите URL', 'error');

            const progress = document.getElementById('xmlProgress');
            const bar = document.getElementById('xmlProgressBar');
            const text = document.getElementById('xmlProgressText');

            progress.style.display = 'block';
            bar.style.width = '10%';
            text.textContent = 'Загрузка...';

            // Simulate progress for now
            setTimeout(() => { bar.style.width = '30%'; text.textContent = 'Парсинг XML...'; }, 500);
            setTimeout(() => { bar.style.width = '60%'; text.textContent = 'Импорт товаров...'; }, 1500);
            setTimeout(() => {
                bar.style.width = '100%';
                text.textContent = 'Готово!';
                setTimeout(() => {
                    closeModal('importXmlModal');
                    progress.style.display = 'none';
                    bar.style.width = '0';
                    loadProducts();
                }, 1000);
            }, 3000);
        }

        // Update Promo Codes table with more features
        function renderPromoCodesExtended() {
            const tbody = document.getElementById('promoCodesTable');
            if (!tbody) return;
            // Extended promo codes rendering handled by existing loadPromoCodes
        }

        // Extend section loading
        const originalSwitchSection = typeof switchSection !== 'undefined' ? switchSection : null;
        if (originalSwitchSection) {
            const extendedSwitchSection = function(section) {
                originalSwitchSection(section);
                switch(section) {
                    case 'categories': loadCategories(); break;
                    case 'product-filters': loadProductFilters(); break;
                    case 'selections': loadSelections(); break;
                    case 'specialists': loadSpecialists(); break;
                    case 'rooms': loadRooms(); break;
                    case 'trainings': loadTrainings(); break;
                    case 'lessons': loadLessons(); break;
                    case 'bookings': loadBookingsCalendar(); break;
                }
            };
            window.switchSection = extendedSwitchSection;
        }

        // Event listeners for filters
        document.getElementById('tagsEntity')?.addEventListener('change', loadTags);
        document.getElementById('analyticsPeriod')?.addEventListener('change', loadEmployeeAnalytics);
        document.getElementById('goalsPeriod')?.addEventListener('change', loadGoals);
        document.getElementById('bookingsDate')?.addEventListener('change', loadBookings);

        // Initialize new sections
        document.getElementById('autoWebinarScheduled')?.addEventListener('change', function() {
            document.getElementById('autoWebinarSchedule').style.display = this.checked ? 'block' : 'none';
        });

        // Start
        init();
    </script>
</body>
</html>
