<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);
            min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 24px; text-align: center;
        }
        .icon { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; font-size: 40px; }
        .icon.loading { background: var(--tg-theme-button-color); }
        .icon.waiting { background: #ff9800; }
        .icon.success { background: #4caf50; }
        h1 { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
        .channel-name { color: var(--tg-theme-button-color); font-size: 20px; margin-bottom: 8px; }
        .description { color: var(--tg-theme-hint-color); font-size: 15px; margin-bottom: 24px; max-width: 300px; }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 14px 32px; background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color); border: none; border-radius: 12px;
            font-size: 16px; font-weight: 500; cursor: pointer; text-decoration: none;
        }
        .btn:hover { opacity: 0.9; }
        .spinner { width: 48px; height: 48px; border: 4px solid var(--tg-theme-hint-color); border-top-color: var(--tg-theme-button-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error { color: #dc3545; margin-top: 16px; }
        .screen { display: none; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }
        .dots { display: inline-block; width: 20px; text-align: left; }
        @keyframes dots { 0% { content: ''; } 33% { content: '.'; } 66% { content: '..'; } 100% { content: '...'; } }
    </style>
</head>
<body>
    <!-- Screen 1: Loading -->
    <div class="screen active" id="screenLoading">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <!-- Screen 2: Go to channel -->
    <div class="screen" id="screenSubscribe">
        <div class="icon waiting">üì¢</div>
        <h2 class="channel-name" id="channelName"></h2>
        <p class="description">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞</p>
        <a class="btn" id="openChannelBtn" href="#">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª</a>
        <p style="margin-top: 16px; color: var(--tg-theme-hint-color); font-size: 13px;" id="checkingText"></p>
    </div>

    <!-- Screen 3: Checking subscription -->
    <div class="screen" id="screenChecking">
        <div class="spinner"></div>
        <h1>–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É</h1>
        <p class="description">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª ‚Äî –º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏–º</p>
        <a class="btn" id="openChannelBtn2" href="#" style="background:#ff9800;">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª –µ—â—ë —Ä–∞–∑</a>
    </div>

    <!-- Screen 4: Success -->
    <div class="screen" id="screenSuccess">
        <div class="icon success">‚úì</div>
        <h1>–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å!</h1>
        <p class="description" id="successText">–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É</p>
    </div>

    <!-- Screen 5: Error -->
    <div class="screen" id="screenError">
        <div class="icon loading">‚ö†</div>
        <h1>–û—à–∏–±–∫–∞</h1>
        <p class="error" id="errorText"></p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Apply theme
        if (tg.themeParams) {
            const r = document.documentElement;
            if (tg.themeParams.bg_color) r.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
            if (tg.themeParams.text_color) r.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
            if (tg.themeParams.hint_color) r.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color);
            if (tg.themeParams.button_color) r.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
            if (tg.themeParams.button_text_color) r.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
        }

        const startParam = tg.initDataUnsafe?.start_param || '';
        const user = tg.initDataUnsafe?.user;
        const API = window.location.origin;

        let visitId = null;
        let channelData = null;
        let checkInterval = null;
        let ymReady = false;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
            showScreen('screenError');
        }

        // ‚îÄ‚îÄ Yandex Metrika ‚îÄ‚îÄ
        function initMetrika(counterId) {
            if (!counterId) return;
            const id = Number(counterId);
            if (!id) return;

            window.ym = window.ym || function() { (window.ym.a = window.ym.a || []).push(arguments); };
            window.ym.l = +new Date();

            const s = document.createElement('script');
            s.src = 'https://mc.yandex.ru/metrika/tag.js';
            s.async = true;
            document.head.appendChild(s);

            s.onload = () => {
                ym(id, 'init', {
                    clickmap: false, trackLinks: false, accurateTrackBounce: true,
                    params: { telegram_id: user?.id, utm_source: channelData?.utm?.source, utm_campaign: channelData?.utm?.campaign }
                });
                ymReady = true;
                console.log('[YM] Initialized counter:', id);
            };
        }

        function fireMetrikaGoal(goalName) {
            if (!ymReady || !window.ym) return;
            const id = Number(channelData?.metrika?.counter_id);
            if (!id || !goalName) return;

            ym(id, 'reachGoal', goalName, {
                telegram_id: user?.id,
                utm_source: channelData?.utm?.source,
                utm_campaign: channelData?.utm?.campaign
            });
            console.log('[YM] Goal fired:', goalName, 'counter:', id);
        }

        // ‚îÄ‚îÄ Main flow ‚îÄ‚îÄ
        async function init() {
            if (!startParam) { showError('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞'); return; }

            try {
                // 1. Get link info
                const infoRes = await fetch(API + '/api/track/info/' + startParam);
                const info = await infoRes.json();
                if (!info.success) { showError(info.error || '–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }

                channelData = info;
                const channelUrl = 'https://t.me/' + info.channel.username;

                // 2. Init Metrika (link-level counter)
                initMetrika(info.metrika?.counter_id);

                // 3. Record visit
                const visitRes = await fetch(API + '/api/track/visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shortCode: startParam, initData: tg.initData,
                        telegramId: user?.id, username: user?.username, firstName: user?.first_name
                    })
                });
                const visitData = await visitRes.json();
                if (visitData.success) visitId = visitData.visitId;

                // 4. Setup UI
                document.getElementById('channelName').textContent = info.channel.title;
                document.getElementById('openChannelBtn').href = channelUrl;
                document.getElementById('openChannelBtn2').href = channelUrl;

                // 5. Auto-open channel
                showScreen('screenSubscribe');

                // Open channel link via Telegram
                try {
                    tg.openTelegramLink(channelUrl);
                } catch (e) {
                    // Fallback: just show the button
                    console.log('Could not auto-open, showing button');
                }

                // 6. Start polling for subscription
                startSubscriptionCheck(info.channel.id);

                // Open channel button handlers
                document.getElementById('openChannelBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    try { tg.openTelegramLink(channelUrl); } catch(err) { window.open(channelUrl, '_blank'); }
                    showScreen('screenChecking');
                });
                document.getElementById('openChannelBtn2').addEventListener('click', (e) => {
                    e.preventDefault();
                    try { tg.openTelegramLink(channelUrl); } catch(err) { window.open(channelUrl, '_blank'); }
                });

            } catch (e) {
                console.error('Init error:', e);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            }
        }

        function startSubscriptionCheck(channelId) {
            if (!user?.id) return;
            let attempts = 0;

            checkInterval = setInterval(async () => {
                attempts++;
                try {
                    const res = await fetch(API + `/api/track/check-subscription?channelId=${channelId}&telegramId=${user.id}`);
                    const data = await res.json();

                    if (data.subscribed) {
                        clearInterval(checkInterval);
                        onSubscribed();
                    } else if (attempts > 5) {
                        // Show checking screen after a few attempts
                        showScreen('screenChecking');
                    }
                } catch (e) {
                    console.error('Check error:', e);
                }
            }, 2500);

            // Stop after 5 minutes
            setTimeout(() => { if (checkInterval) clearInterval(checkInterval); }, 300000);
        }

        async function onSubscribed() {
            // 1. Fire Metrika goal
            const goalName = channelData?.metrika?.goal_name;
            if (goalName) {
                fireMetrikaGoal(goalName);
            }

            // 2. Record subscription in DB
            try {
                await fetch(API + '/api/track/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shortCode: startParam, initData: tg.initData,
                        telegramId: user?.id, username: user?.username,
                        firstName: user?.first_name, visitId
                    })
                });
            } catch (e) { console.error('Subscribe record error:', e); }

            // 3. Show success screen
            document.getElementById('successText').textContent =
                `–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ ${channelData?.channel?.title || '–∫–∞–Ω–∞–ª'}!`;
            showScreen('screenSuccess');

            // 4. Close mini app after delay
            setTimeout(() => { try { tg.close(); } catch(e) {} }, 3000);
        }

        init();
    </script>
</body>
</html>
